---
phase: 03-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mobile/lib/core/services/analytics_service.dart
  - apps/mobile/lib/features/digest/providers/digest_provider.dart
  - apps/mobile/lib/features/digest/screens/digest_screen.dart
  - apps/mobile/lib/features/digest/screens/closure_screen.dart
  - packages/api/app/services/analytics_service.py
  - packages/api/app/routers/analytics.py
autonomous: true

must_haves:
  truths:
    - "Opening the digest screen sends a 'digest_open' analytics event"
    - "Performing an action (read/save/dismiss) on a digest article sends a 'digest_action' event with action type, content_id, and position"
    - "Completing the digest (closure) sends a 'digest_closure' event with closure time, articles breakdown, and streak count"
    - "Backend stores all digest events in analytics_events table"
  artifacts:
    - path: "apps/mobile/lib/core/services/analytics_service.dart"
      provides: "Digest-specific tracking methods"
      contains: "trackDigestOpen"
    - path: "packages/api/app/services/analytics_service.py"
      provides: "Digest analytics query methods"
      contains: "get_digest_completion_rate"
  key_links:
    - from: "apps/mobile/lib/features/digest/screens/digest_screen.dart"
      to: "analytics_service.dart"
      via: "trackDigestOpen call on screen mount"
      pattern: "trackDigestOpen"
    - from: "apps/mobile/lib/features/digest/screens/closure_screen.dart"
      to: "analytics_service.dart"
      via: "trackDigestClosure call on completion"
      pattern: "trackDigestClosure"
---

<objective>
Add digest-specific analytics events for MoC (Measure of Closure) metrics.

Purpose: Story 10.16 — Track user engagement with digest feature to measure if the "closure" hypothesis works. Events: digest_open, digest_action (per article), digest_closure. Backend gets query helpers for basic metrics (completion rate, avg closure time).
Output: Extended AnalyticsService (mobile + backend) with digest event tracking wired into digest screens.
</objective>

<execution_context>
@/Users/laurinboujon/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/laurinboujon/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@apps/mobile/lib/core/services/analytics_service.dart
@apps/mobile/lib/features/digest/providers/digest_provider.dart
@apps/mobile/lib/features/digest/screens/digest_screen.dart
@apps/mobile/lib/features/digest/screens/closure_screen.dart
@packages/api/app/services/analytics_service.py
@packages/api/app/routers/analytics.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add digest tracking methods to mobile AnalyticsService</name>
  <files>
    apps/mobile/lib/core/services/analytics_service.dart
  </files>
  <action>
    Add three new methods to the existing AnalyticsService class:

    1. `trackDigestOpen({required String digestDate, required int articleCount})`:
       - Event type: 'digest_open'
       - Data: session_id, digest_date, article_count, timestamp

    2. `trackDigestAction({required String contentId, required String action, required int position, required String sourceId})`:
       - Event type: 'digest_action'
       - Data: session_id, content_id, action (read/save/not_interested), position (1-5), source_id
       - Actions match existing DigestAction enum values

    3. `trackDigestClosure({required int closureTimeSeconds, required int articlesRead, required int articlesSaved, required int articlesDismissed, required int closureStreak})`:
       - Event type: 'digest_closure'
       - Data: session_id, closure_time_seconds, articles_read, articles_saved, articles_dismissed, closure_streak

    Follow the same pattern as existing `trackArticleRead` and `trackFeedScroll` methods. All calls go through `_logEvent` which POSTs to `/analytics/events`.
  </action>
  <verify>
    - `flutter analyze` shows no errors in analytics_service.dart
    - Methods follow same async pattern as existing tracking methods
  </verify>
  <done>
    AnalyticsService has trackDigestOpen, trackDigestAction, trackDigestClosure methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire digest analytics into screens and add backend metrics</name>
  <files>
    apps/mobile/lib/features/digest/screens/digest_screen.dart
    apps/mobile/lib/features/digest/screens/closure_screen.dart
    apps/mobile/lib/features/digest/providers/digest_provider.dart
    packages/api/app/services/analytics_service.py
    packages/api/app/routers/analytics.py
  </files>
  <action>
    **Mobile — Wire events into digest flow:**

    1. In `digest_screen.dart`:
       - Import analytics_provider
       - On successful digest load (when data is available), call:
         `ref.read(analyticsServiceProvider).trackDigestOpen(digestDate: digest.date, articleCount: digest.articles.length)`
       - Track only once per screen mount (use a flag like existing feed_screen.dart pattern)

    2. In `digest_provider.dart`:
       - In the `performAction` method (or equivalent that handles article actions), after successful API call:
         `analyticsService.trackDigestAction(contentId: contentId, action: action.name, position: position, sourceId: sourceId)`
       - The provider needs access to AnalyticsService via ref — pass via constructor or read from ref

    3. In `closure_screen.dart`:
       - After successful completion data loads (_completionData available), call:
         `ref.read(analyticsServiceProvider).trackDigestClosure(closureTimeSeconds: data.closureTimeSeconds, articlesRead: data.articlesRead, articlesSaved: data.articlesSaved, articlesDismissed: data.articlesDismissed, closureStreak: data.closureStreak)`

    **Backend — Add digest metrics helpers:**

    4. In `analytics_service.py`, add two methods:
       - `get_digest_completion_rate(days: int = 7) -> float`: Query analytics_events for digest_closure events vs digest_open events over last N days. Return ratio.
       - `get_avg_closure_time(days: int = 7) -> float`: Average closure_time_seconds from digest_closure events.

    5. In `analytics.py` router, add endpoint:
       - `GET /analytics/digest-metrics` — returns `{completion_rate: float, avg_closure_time_seconds: float, total_closures: int}` for last 7 days
       - Protected by `get_current_user_id` dependency

    AVOID: Don't modify the existing _logEvent transport or the EventCreate schema — they already handle arbitrary event_data dicts.
  </action>
  <verify>
    - `flutter analyze` passes
    - `cd packages/api && python -c "from app.services.analytics_service import AnalyticsService; print('OK')"` — import succeeds
    - Backend endpoint compiles (check with `python -c "from app.routers.analytics import router"`)
  </verify>
  <done>
    Digest screens fire analytics events on open, action, and closure. Backend has digest metrics endpoint returning completion rate and average closure time.
  </done>
</task>

</tasks>

<verification>
- `flutter analyze` — no errors
- Backend imports cleanly: `python -c "from app.routers.analytics import router; from app.services.analytics_service import AnalyticsService"`
- Analytics events follow same pattern as existing trackArticleRead, trackFeedScroll
</verification>

<success_criteria>
- 3 new digest events tracked: digest_open, digest_action, digest_closure
- Events wired into actual digest UI flow (screen mount, action, completion)
- Backend /analytics/digest-metrics endpoint returns completion rate and avg closure time
- No disruption to existing analytics (feed scroll, article read events still work)
</success_criteria>

<output>
After completion, create `.planning/phases/03-polish/03-02-SUMMARY.md`
</output>
