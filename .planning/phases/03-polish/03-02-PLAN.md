---
phase: 03-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/api/app/schemas/analytics.py
  - packages/api/app/services/analytics_service.py
  - apps/mobile/lib/core/services/analytics_service.dart
autonomous: true

must_haves:
  truths:
    - "A single content_interaction event type handles all content actions (read, save, dismiss, pass) across all surfaces (feed, digest)"
    - "Each content_interaction event carries surface, content_id, source_id, topics, position, time_spent_seconds, session_id"
    - "The event schema includes a nullable atomic_themes field for forward-compatibility with Camembert"
    - "Session-level events (digest_session, feed_session) have surface-specific shapes but reference the same session_id"
    - "Mobile AnalyticsService exposes a unified trackContentInteraction method"
  artifacts:
    - path: "packages/api/app/schemas/analytics.py"
      provides: "Pydantic schemas for unified content_interaction events"
      contains: "ContentInteractionPayload"
      exports: ["InteractionAction", "InteractionSurface", "ContentInteractionPayload", "DigestSessionPayload", "FeedSessionPayload"]
    - path: "packages/api/app/services/analytics_service.py"
      provides: "Backend analytics service with validation helpers"
      contains: "log_content_interaction"
    - path: "apps/mobile/lib/core/services/analytics_service.dart"
      provides: "Mobile analytics with unified tracking methods"
      contains: "trackContentInteraction"
  key_links:
    - from: "apps/mobile/lib/core/services/analytics_service.dart"
      to: "/api/analytics/events"
      via: "_logEvent POST call"
      pattern: "content_interaction"
    - from: "packages/api/app/schemas/analytics.py"
      to: "packages/api/app/services/analytics_service.py"
      via: "Pydantic validation of event payloads"
      pattern: "ContentInteractionPayload"
---

<objective>
Create the unified content_interaction analytics schema and service methods (backend + mobile).

Purpose: CONTEXT.md LOCKED DECISION — All content interactions use ONE event type (`content_interaction`) with a `surface` field distinguishing feed vs digest. This replaces the fragmented approach (separate `article_read`, `feed_scroll` events). Session-level events (`digest_session`, `feed_session`) remain surface-specific but reference the unified interactions underneath.
Output: Backend Pydantic schemas, extended AnalyticsService (Python + Dart) with unified tracking methods. Ready for wiring into screens in Plan 03.
</objective>

<execution_context>
@/Users/laurinboujon/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/laurinboujon/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-polish/03-CONTEXT.md
@.planning/phases/03-polish/03-RESEARCH.md
@packages/api/app/services/analytics_service.py
@packages/api/app/routers/analytics.py
@packages/api/app/models/analytics.py
@apps/mobile/lib/core/services/analytics_service.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backend Pydantic schemas and extend AnalyticsService</name>
  <files>
    packages/api/app/schemas/analytics.py
    packages/api/app/services/analytics_service.py
  </files>
  <action>
    1. Create `packages/api/app/schemas/analytics.py` with:

       ```python
       from enum import Enum
       from pydantic import BaseModel, Field
       from typing import Optional
       from uuid import UUID


       class InteractionAction(str, Enum):
           """Actions possibles sur un contenu."""
           READ = "read"
           SAVE = "save"
           DISMISS = "dismiss"
           PASS = "pass"


       class InteractionSurface(str, Enum):
           """Surface d'interaction."""
           FEED = "feed"
           DIGEST = "digest"


       class ContentInteractionPayload(BaseModel):
           """Payload pour un événement content_interaction.
           
           Schema unifié suivant les patterns GAFAM:
           - Un seul type d'événement pour toutes les interactions contenu
           - Le champ 'surface' distingue le contexte
           - Forward-compatible avec atomic_themes (Camembert)
           """
           action: InteractionAction
           surface: InteractionSurface
           content_id: UUID
           source_id: UUID
           topics: list[str] = Field(default_factory=list)
           atomic_themes: list[str] | None = None  # Forward-compatible for Camembert
           position: int | None = None  # 1-5 for digest, rank for feed
           time_spent_seconds: int = 0
           session_id: str | None = None

           class Config:
               from_attributes = True


       class DigestSessionPayload(BaseModel):
           """Payload pour un événement digest_session."""
           session_id: str
           digest_date: str
           articles_read: int = 0
           articles_saved: int = 0
           articles_dismissed: int = 0
           articles_passed: int = 0
           total_time_seconds: int = 0
           closure_achieved: bool = False
           streak: int = 0


       class FeedSessionPayload(BaseModel):
           """Payload pour un événement feed_session."""
           session_id: str
           scroll_depth_percent: float = 0.0
           items_viewed: int = 0
           items_interacted: int = 0
           total_time_seconds: int = 0
       ```

    2. In `packages/api/app/services/analytics_service.py`, add methods:
       - `log_content_interaction(user_id, payload: ContentInteractionPayload, device_id=None)`:
         - Validate payload via Pydantic, call existing `log_event` with event_type="content_interaction" and event_data=payload.model_dump(mode="json")
       - `log_digest_session(user_id, payload: DigestSessionPayload, device_id=None)`:
         - Same pattern, event_type="digest_session"
       - `log_feed_session(user_id, payload: FeedSessionPayload, device_id=None)`:
         - Same pattern, event_type="feed_session"
       - Import the schemas at top of file

    Use `list[]` not `List` (Python 3.12 constraint from CLAUDE.md). Use `str | None` not `Optional[str]`.
    
    AVOID: Do NOT modify the existing `log_event` method — it's the transport layer. Do NOT remove existing event methods (`get_dau`, `get_recent_events`) — they still work.
    AVOID: Do NOT create separate event types per surface (no `digest_read`, `feed_read`). One `content_interaction` type with `surface` field per CONTEXT.md.
  </action>
  <verify>
    - `cd packages/api && python -c "from app.schemas.analytics import ContentInteractionPayload, InteractionAction, InteractionSurface; print('OK')"`
    - `cd packages/api && python -c "from app.services.analytics_service import AnalyticsService; print('OK')"`
    - Pydantic schema validates correctly: `python -c "from app.schemas.analytics import ContentInteractionPayload; p = ContentInteractionPayload(action='read', surface='digest', content_id='00000000-0000-0000-0000-000000000001', source_id='00000000-0000-0000-0000-000000000002'); print(p.model_dump())"`
  </verify>
  <done>
    ContentInteractionPayload, DigestSessionPayload, FeedSessionPayload schemas exist. AnalyticsService has log_content_interaction, log_digest_session, log_feed_session methods that validate payloads before storing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend mobile AnalyticsService with unified tracking methods</name>
  <files>
    apps/mobile/lib/core/services/analytics_service.dart
  </files>
  <action>
    Add new unified methods to the existing AnalyticsService class. Keep existing methods (trackArticleRead, trackFeedScroll, etc.) as-is — mark them with `@Deprecated('Use trackContentInteraction instead')` comments but don't remove.

    1. Add `trackContentInteraction()`:
       ```dart
       /// Enregistre une interaction contenu unifiée (feed ou digest)
       /// Remplace les méthodes fragmentées (trackArticleRead, etc.)
       Future<void> trackContentInteraction({
         required String action,     // read, save, dismiss, pass
         required String surface,    // feed, digest
         required String contentId,
         required String sourceId,
         List<String> topics = const [],
         int? position,
         int timeSpentSeconds = 0,
       }) async {
         await _logEvent('content_interaction', {
           'session_id': _sessionId,
           'action': action,
           'surface': surface,
           'content_id': contentId,
           'source_id': sourceId,
           'topics': topics,
           'atomic_themes': null,  // Forward-compatible for Camembert
           'position': position,
           'time_spent_seconds': timeSpentSeconds,
         });
       }
       ```

    2. Add `trackDigestSession()`:
       ```dart
       /// Enregistre une session digest complète
       Future<void> trackDigestSession({
         required String digestDate,
         required int articlesRead,
         required int articlesSaved,
         required int articlesDismissed,
         required int articlesPassed,
         required int totalTimeSeconds,
         required bool closureAchieved,
         required int streak,
       }) async {
         await _logEvent('digest_session', {
           'session_id': _sessionId,
           'digest_date': digestDate,
           'articles_read': articlesRead,
           'articles_saved': articlesSaved,
           'articles_dismissed': articlesDismissed,
           'articles_passed': articlesPassed,
           'total_time_seconds': totalTimeSeconds,
           'closure_achieved': closureAchieved,
           'streak': streak,
         });
       }
       ```

    3. Add `trackFeedSession()`:
       ```dart
       /// Enregistre une session feed complète
       Future<void> trackFeedSession({
         required double scrollDepthPercent,
         required int itemsViewed,
         required int itemsInteracted,
         required int totalTimeSeconds,
       }) async {
         await _logEvent('feed_session', {
           'session_id': _sessionId,
           'scroll_depth_percent': scrollDepthPercent,
           'items_viewed': itemsViewed,
           'items_interacted': itemsInteracted,
           'total_time_seconds': totalTimeSeconds,
         });
       }
       ```

    AVOID: Don't DELETE existing trackArticleRead/trackFeedScroll methods — they may be called elsewhere. Mark deprecated. New code uses the unified methods.
  </action>
  <verify>
    - `cd apps/mobile && flutter analyze` shows no new errors in analytics_service.dart
    - New methods follow same async pattern as existing tracking methods
    - `content_interaction` event type used (not separate types per surface)
  </verify>
  <done>
    Mobile AnalyticsService has trackContentInteraction (unified), trackDigestSession, trackFeedSession methods. Old methods marked deprecated. All use _logEvent transport.
  </done>
</task>

</tasks>

<verification>
- Backend schemas import cleanly and validate sample payloads
- Mobile analytics service compiles with no errors
- Single `content_interaction` event type used for all content actions
- `atomic_themes` field present and nullable in both backend schema and mobile event payload
- Existing analytics methods preserved (backward compatible)
</verification>

<success_criteria>
- Unified `content_interaction` event type with action enum (read/save/dismiss/pass) and surface enum (feed/digest)
- Forward-compatible `atomic_themes: null` field in schema
- Backend Pydantic validation for event payloads
- Mobile unified tracking methods ready for wiring
- No disruption to existing analytics (deprecated but not removed)
</success_criteria>

<output>
After completion, create `.planning/phases/03-polish/03-02-SUMMARY.md`
</output>
