---
phase: 03-polish
plan: 03
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/api/tests/test_digest_selector.py
  - packages/api/tests/test_digest_service.py
autonomous: true

must_haves:
  truths:
    - "DigestSelector correctly selects 5 articles from scored candidates"
    - "Source diversity constraint enforced: max 2 articles per source"
    - "Decay factor 0.70 reduces score for repeated sources"
    - "Minimum 3 different sources in digest output"
    - "Fallback to curated sources when user pool < 5"
  artifacts:
    - path: "packages/api/tests/test_digest_selector.py"
      provides: "Unit tests for DigestSelector selection and diversity logic"
      min_lines: 100
    - path: "packages/api/tests/test_digest_service.py"
      provides: "Unit tests for DigestService actions and completion"
      min_lines: 50
  key_links:
    - from: "packages/api/tests/test_digest_selector.py"
      to: "packages/api/app/services/digest_selector.py"
      via: "imports and tests DigestSelector._select_with_diversity"
      pattern: "DigestSelector|_select_with_diversity|select_digest_articles"
---

<objective>
Write comprehensive unit tests for DigestSelector and DigestService.

Purpose: Story 10.17 — Verify the digest selection algorithm, diversity constraints, and service logic. TDD approach: write tests describing expected behavior, then verify they pass against existing implementation. These tests serve as safety net for the performance optimization in Plan 04.
Output: Test files covering selection, diversity, fallback, actions, and completion.
</objective>

<execution_context>
@/Users/laurinboujon/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/laurinboujon/.config/opencode/get-shit-done/templates/summary.md
@/Users/laurinboujon/.config/opencode/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@packages/api/app/services/digest_selector.py
@packages/api/app/services/digest_service.py
@packages/api/app/schemas/digest.py
@packages/api/app/models/digest.py
@packages/api/tests/conftest.py
</context>

<feature>
  <name>DigestSelector and DigestService Tests</name>
  <files>packages/api/tests/test_digest_selector.py, packages/api/tests/test_digest_service.py</files>
  <behavior>
    DigestSelector._select_with_diversity():
    - Given 10 scored articles from 5 sources → selects exactly 5
    - Given 10 articles from 1 source → applies decay 0.70^count, still selects 5 with max 2 from that source
    - Given 3 articles total → returns 3 (incomplete, triggers fallback in calling code)
    - Given articles with varied scores → higher-scored articles selected first
    - Diversity constraint: no source has more than 2 articles in result
    - Min 3 sources: if 5 articles from 2 sources available, pulls from at least 3

    DigestService:
    - get_or_create_digest: returns existing digest if today's exists, creates new if not
    - perform_action: updates article action (read/save/not_interested)
    - complete_digest: marks digest complete, returns completion stats
  </behavior>
  <implementation>
    Tests use pytest-asyncio with mocked AsyncSession.
    Follow existing test patterns in conftest.py.
    Mock database calls, test business logic in isolation.
    
    For DigestSelector, test the _select_with_diversity method by:
    - Creating mock ScoredArticle dataclass instances with known scores and source_ids
    - Calling the method directly
    - Asserting on output count, source distribution, score ordering
    
    For DigestService, test by:
    - Mocking db queries (select returns mock results)
    - Testing action validation (valid/invalid action types)
    - Testing completion flow (all articles must have action)
  </implementation>
</feature>

<verification>
- `cd packages/api && python -m pytest tests/test_digest_selector.py tests/test_digest_service.py -v` — all tests pass
- Tests cover: selection count, diversity constraint, decay factor, fallback, actions, completion
</verification>

<success_criteria>
- test_digest_selector.py: 6+ test cases covering selection, diversity, decay, min-sources, fallback, edge cases
- test_digest_service.py: 4+ test cases covering get/create, action, completion, validation
- All tests pass against existing implementation
- Tests serve as regression safety net for Plan 04 (performance)
</success_criteria>

<output>
After completion, create `.planning/phases/03-polish/03-03-SUMMARY.md`
</output>
