---
phase: 03-polish
plan: 04
type: tdd
wave: 1
depends_on: []
files_modified:
  - packages/api/tests/test_digest_selector.py
  - packages/api/tests/test_digest_service.py
autonomous: true

must_haves:
  truths:
    - "DigestSelector correctly selects 5 articles from scored candidates"
    - "Source diversity constraint enforced: max 2 articles per source"
    - "Decay factor 0.70 reduces score for repeated sources"
    - "Minimum 3 different sources in digest output"
    - "Fallback to curated sources when user pool is insufficient"
    - "Method returns 4-tuples (content, score, reason, breakdown)"
  artifacts:
    - path: "packages/api/tests/test_digest_selector.py"
      provides: "Unit tests for DigestSelector selection and diversity logic"
      min_lines: 100
    - path: "packages/api/tests/test_digest_service.py"
      provides: "Unit tests for DigestService actions and completion"
      min_lines: 50
  key_links:
    - from: "packages/api/tests/test_digest_selector.py"
      to: "packages/api/app/services/digest_selector.py"
      via: "imports and tests DigestSelector._select_with_diversity"
      pattern: "DigestSelector|_select_with_diversity"
    - from: "packages/api/tests/test_digest_service.py"
      to: "packages/api/app/services/digest_service.py"
      via: "imports and tests DigestService methods"
      pattern: "DigestService"
---

<objective>
Write comprehensive unit tests for DigestSelector and DigestService.

Purpose: Story 10.17 — Verify the digest selection algorithm, diversity constraints, and service logic. TDD approach: write tests describing expected behavior, then verify they pass against existing implementation. These tests serve as safety net for the performance optimization in Plan 05.
Output: Test files covering selection, diversity, fallback, actions, and completion.
</objective>

<execution_context>
@/Users/laurinboujon/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/laurinboujon/.config/opencode/get-shit-done/templates/summary.md
@/Users/laurinboujon/.config/opencode/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-polish/03-RESEARCH.md
@packages/api/app/services/digest_selector.py
@packages/api/app/services/digest_service.py
@packages/api/app/schemas/digest.py
@packages/api/app/models/digest.py
@packages/api/app/models/enums.py
@packages/api/tests/conftest.py
</context>

<feature>
  <name>DigestSelector and DigestService Tests</name>
  <files>packages/api/tests/test_digest_selector.py, packages/api/tests/test_digest_service.py</files>
  <behavior>
    DigestSelector._select_with_diversity():
    - Given 10 scored articles from 5 sources → selects exactly 5
    - Given 10 articles from 1 source → applies decay 0.70^count, max 2 from that source
    - Given 3 articles total → returns 3 (incomplete, triggers fallback in calling code)
    - Given articles with varied scores → higher-scored articles selected first (before decay)
    - Diversity constraint: no source has more than 2 articles in result
    - Returns 4-tuples: (content, decayed_score, reason_string, breakdown_list)
    - Decay formula: score * (0.70 ^ source_count_so_far) for each source repeat

    DigestService:
    - get_or_create_digest: returns existing digest if today's exists, creates new if not
    - perform_action: updates article action (read/save/not_interested), validates action type
    - complete_digest: marks digest complete, returns completion stats

    CRITICAL: The `_select_with_diversity` method signature returns 4-tuples, NOT 3-tuples.
    Earlier tests may use 3-tuple unpacking — this will cause ValueError. Always unpack 4 values.
  </behavior>
  <implementation>
    Tests use pytest-asyncio with mocked AsyncSession. Follow the established pattern from RESEARCH.md:

    ```python
    @pytest.fixture
    def mock_session():
        return AsyncMock(spec=AsyncSession)

    @pytest.fixture
    def selector(mock_session, mock_rec_service):
        sel = DigestSelector(mock_session)
        sel.rec_service = mock_rec_service
        return sel

    def make_content(source=None, topics=None):
        content = Mock()
        content.id = uuid4()
        content.source = source or make_source()
        content.source_id = content.source.id
        content.published_at = datetime.now(timezone.utc)
        content.topics = topics
        content.content_type = None
        return content

    def make_source(name="Test", theme="tech"):
        source = Mock()
        source.id = uuid4()
        source.name = name
        source.theme = theme
        source.is_curated = False
        source.reliability_score = None
        return source
    ```

    Test cases for _select_with_diversity:
    1. test_selects_exactly_target_count — 10 candidates, target 5, returns 5
    2. test_diversity_max_two_per_source — 10 articles from 2 sources, max 2 each
    3. test_decay_factor_applied — verify scores decrease with repeated source
    4. test_minimum_three_sources — when enough sources available, result has ≥3 sources
    5. test_returns_four_tuple — each result is (content, score, reason, breakdown)
    6. test_fewer_candidates_than_target — 3 candidates, target 5, returns 3
    7. test_higher_scores_selected_first — before decay, highest scores picked
    8. test_single_source_decay — all from same source, only 2 selected, scores decayed

    Test cases for DigestService:
    1. test_perform_action_valid — updates action successfully
    2. test_complete_digest_returns_stats — returns correct breakdown
    3. test_get_or_create_existing — returns existing when today's digest exists
  </implementation>
</feature>

<verification>
- `cd packages/api && python -m pytest tests/test_digest_selector.py tests/test_digest_service.py -v` — all tests pass
- Tests cover: selection count, diversity constraint, decay factor, min-sources, fallback, 4-tuple return, score ordering
- No import errors or fixture issues
</verification>

<success_criteria>
- test_digest_selector.py: 6+ test cases covering selection, diversity, decay, min-sources, 4-tuple return, edge cases
- test_digest_service.py: 3+ test cases covering actions, completion stats, get/create
- All tests pass against existing implementation
- Tests serve as regression safety net for Plan 05 (performance optimization)
</success_criteria>

<output>
After completion, create `.planning/phases/03-polish/03-04-SUMMARY.md`
</output>
