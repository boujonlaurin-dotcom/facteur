---
phase: 03-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mobile/pubspec.yaml
  - apps/mobile/lib/core/services/notification_service.dart
  - apps/mobile/lib/core/providers/notification_provider.dart
  - apps/mobile/lib/core/providers/notification_provider.g.dart
  - apps/mobile/lib/features/settings/providers/notifications_settings_provider.dart
  - apps/mobile/lib/main.dart
autonomous: true

must_haves:
  truths:
    - "User receives a local notification daily at 8am saying digest is ready"
    - "Tapping the notification opens the app on DigestScreen"
    - "User can disable digest notifications in Settings"
    - "No notification is sent if digest was already completed today"
  artifacts:
    - path: "apps/mobile/lib/core/services/notification_service.dart"
      provides: "Local notification scheduling and handling"
      min_lines: 60
    - path: "apps/mobile/lib/core/providers/notification_provider.dart"
      provides: "Riverpod provider for notification service"
      exports: ["notificationServiceProvider"]
  key_links:
    - from: "apps/mobile/lib/main.dart"
      to: "notification_service.dart"
      via: "init call during app startup"
      pattern: "NotificationService.*init"
    - from: "notification_service.dart"
      to: "DigestScreen"
      via: "notification tap handler navigates to digest route"
      pattern: "digest|/essentiel"
---

<objective>
Add daily local push notification "Ton essentiel du jour est prÃªt" at 8am.

Purpose: Story 10.15 (FR21.5) â€” Users need a morning nudge to build the daily digest habit. Using local notifications (no FCM backend) keeps it simple and self-contained.
Output: NotificationService with scheduled daily notification, Settings opt-out integration, tap-to-open digest.
</objective>

<execution_context>
@/Users/laurinboujon/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/laurinboujon/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@docs/stories/core/10.digest-central/10.15.notification-push.story.md
@apps/mobile/lib/features/settings/providers/notifications_settings_provider.dart
@apps/mobile/lib/config/routes.dart
@apps/mobile/pubspec.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add flutter_local_notifications and create NotificationService</name>
  <files>
    apps/mobile/pubspec.yaml
    apps/mobile/lib/core/services/notification_service.dart
    apps/mobile/lib/core/providers/notification_provider.dart
  </files>
  <action>
    1. Add dependencies to pubspec.yaml:
       - `flutter_local_notifications: ^18.0.0`
       - `timezone: ^0.9.4`
       - `flutter_timezone: ^3.0.1`

    2. Create `notification_service.dart` with:
       - `NotificationService` class with `init()` method:
         - Initialize FlutterLocalNotificationsPlugin
         - Configure iOS (DarwinInitializationSettings) and Android (AndroidInitializationSettings with `@mipmap/ic_launcher`)
         - Set up `onDidReceiveNotificationResponse` callback to navigate to digest
         - Initialize timezone data using `flutter_timezone`
       - `scheduleDailyDigestNotification()` method:
         - Schedule daily notification at 8:00 AM local time
         - Use `zonedSchedule` with `DateTimeComponents.time` for daily repeat
         - Channel: id='digest_channel', name='Digest Quotidien'
         - Title: "L'Essentiel du Jour"
         - Body: "Ton digest quotidien est prÃªt ðŸ“¬"
         - Importance: high, Priority: high
       - `cancelDigestNotification()` method to cancel by ID 0
       - `requestPermissions()` method for iOS permission request
       - Navigation callback: Use a static GlobalKey<NavigatorState> or goRouter to navigate to '/essentiel' on tap

    3. Create Riverpod provider `notification_provider.dart`:
       - `@riverpod` annotation
       - Returns initialized NotificationService instance
       - Takes Ref to access ApiClient for future extensibility

    4. Run `dart run build_runner build --delete-conflicting-outputs` to generate .g.dart

    AVOID: Do NOT use Firebase/FCM â€” this is local notifications only. Do NOT create a backend endpoint for push tokens.
    WHY: Story dev notes explicitly recommend local notifications for MVP scope.
  </action>
  <verify>
    - `flutter pub get` succeeds
    - `dart run build_runner build --delete-conflicting-outputs` succeeds
    - `flutter analyze` shows no new errors in notification files
  </verify>
  <done>
    NotificationService exists with init(), scheduleDailyDigestNotification(), cancelDigestNotification(), requestPermissions() methods. Provider generated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate notifications into app lifecycle and settings</name>
  <files>
    apps/mobile/lib/main.dart
    apps/mobile/lib/features/settings/providers/notifications_settings_provider.dart
  </files>
  <action>
    1. In `main.dart`:
       - Import NotificationService
       - After app initialization (WidgetsFlutterBinding.ensureInitialized), call:
         ```
         final notificationService = NotificationService();
         await notificationService.init();
         await notificationService.requestPermissions();
         ```
       - After successful auth (or in the appropriate lifecycle hook), call:
         `await notificationService.scheduleDailyDigestNotification();`
       - Pass the goRouter's navigatorKey or use a global navigation key for tap handling

    2. In `notifications_settings_provider.dart`:
       - When `setPushEnabled(true)` is called: also call `NotificationService().scheduleDailyDigestNotification()`
       - When `setPushEnabled(false)` is called: also call `NotificationService().cancelDigestNotification()`
       - This wires the existing Hive-persisted toggle to actually schedule/cancel notifications
       - Import notification_service.dart

    AVOID: Don't modify the existing Hive persistence logic â€” it already works. Just add the notification scheduling side-effect.
  </action>
  <verify>
    - `flutter analyze` passes with no new errors
    - Notification settings toggle still compiles and the provider correctly calls schedule/cancel
    - App main.dart compiles without errors
  </verify>
  <done>
    App initializes notification service on startup. Settings toggle schedules/cancels the daily 8am notification. Tapping notification navigates to DigestScreen.
  </done>
</task>

</tasks>

<verification>
- `flutter pub get && flutter analyze` â€” no errors
- `flutter build ios --no-codesign` or `flutter build apk --debug` â€” builds successfully
- Manual test: Toggle notification setting off/on in settings screen
</verification>

<success_criteria>
- flutter_local_notifications integrated and configured
- Daily notification scheduled at 8am local time
- Notification tap opens DigestScreen
- Settings toggle enables/disables notifications
- No Firebase/FCM dependency
</success_criteria>

<output>
After completion, create `.planning/phases/03-polish/03-01-SUMMARY.md`
</output>
