---
phase: 03-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mobile/pubspec.yaml
  - apps/mobile/lib/core/services/notification_service.dart
  - apps/mobile/lib/core/providers/notification_provider.dart
  - apps/mobile/lib/core/providers/notification_provider.g.dart
  - apps/mobile/lib/main.dart
  - apps/mobile/lib/features/settings/providers/notifications_settings_provider.dart
autonomous: true

must_haves:
  truths:
    - "User receives a local notification daily at 8am saying digest is ready"
    - "Tapping the notification opens the app on DigestScreen"
    - "User can disable digest notifications in Settings"
  artifacts:
    - path: "apps/mobile/lib/core/services/notification_service.dart"
      provides: "Local notification scheduling and handling"
      min_lines: 60
    - path: "apps/mobile/lib/core/providers/notification_provider.dart"
      provides: "Riverpod provider for notification service"
      exports: ["notificationServiceProvider"]
  key_links:
    - from: "apps/mobile/lib/main.dart"
      to: "notification_service.dart"
      via: "init call during app startup"
      pattern: "NotificationService.*init"
    - from: "notification_service.dart"
      to: "DigestScreen"
      via: "notification tap handler navigates to digest route"
      pattern: "digest|/essentiel"
    - from: "notifications_settings_provider.dart"
      to: "notification_service.dart"
      via: "toggle calls schedule/cancel"
      pattern: "scheduleDailyDigestNotification|cancelDigestNotification"
---

<objective>
Add daily local push notification "Ton essentiel du jour est prêt" at 8am Europe/Paris.

Purpose: Story 10.15 (FR21.5) — Users need a morning nudge to build the daily digest habit. Using local notifications (no FCM backend) keeps it simple and self-contained.
Output: NotificationService with scheduled daily notification, Settings opt-out integration, tap-to-open digest.
</objective>

<execution_context>
@/Users/laurinboujon/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/laurinboujon/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-polish/03-RESEARCH.md
@docs/stories/core/10.digest-central/10.15.notification-push.story.md
@apps/mobile/lib/features/settings/providers/notifications_settings_provider.dart
@apps/mobile/lib/config/routes.dart
@apps/mobile/pubspec.yaml
@apps/mobile/lib/main.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add flutter_local_notifications v20 and create NotificationService</name>
  <files>
    apps/mobile/pubspec.yaml
    apps/mobile/lib/core/services/notification_service.dart
    apps/mobile/lib/core/providers/notification_provider.dart
  </files>
  <action>
    1. Add dependencies to pubspec.yaml:
       - `flutter_local_notifications: ^20.0.0`
       - `timezone: ^0.9.4`
       - `flutter_timezone: ^3.0.1`

    2. Create `notification_service.dart` with a `NotificationService` class:
       - `init()` method:
         - Initialize timezone data with `tz_data.initializeTimeZones()`
         - Create `FlutterLocalNotificationsPlugin` instance
         - Configure Android: `AndroidInitializationSettings('@mipmap/ic_launcher')`
         - Configure iOS: `DarwinInitializationSettings(requestAlertPermission: true, requestBadgePermission: true, requestSoundPermission: true)`
         - Call `_plugin.initialize(settings: settings, onDidReceiveNotificationResponse: _onNotificationTapped)`
         - CRITICAL: v20 uses NAMED parameter `settings:` — NOT positional. All `zonedSchedule` params are also named (`id:`, `title:`, `body:`, `scheduledDate:`)

       - `scheduleDailyDigestNotification()` method:
         - Android channel: id='digest_channel', name='Digest quotidien', channelDescription='Notification quotidienne quand votre digest est prêt'
         - Importance.high, Priority.high
         - Call `_plugin.zonedSchedule(id: 0, title: "Votre digest est prêt !", body: "5 articles sélectionnés pour vous ce matin", scheduledDate: _nextInstanceOf8AM(), androidScheduleMode: AndroidScheduleMode.inexactAllowWhileIdle, matchDateTimeComponents: DateTimeComponents.time, notificationDetails: details)`
         - `_nextInstanceOf8AM()`: get Europe/Paris timezone, create TZDateTime for today at 8:00, if before now add 1 day

       - `cancelDigestNotification()` — cancel by ID 0
       
       - `requestPermission()` — for Android 13+ call `resolvePlatformSpecificImplementation<AndroidFlutterLocalNotificationsPlugin>()?.requestNotificationsPermission()`

       - `_onNotificationTapped(NotificationResponse response)` — navigate to digest route. Accept a `GlobalKey<NavigatorState>` or go_router reference in constructor for navigation.

    3. Create Riverpod provider `notification_provider.dart`:
       - `@riverpod` annotation
       - Returns NotificationService instance
       - Run `dart run build_runner build --delete-conflicting-outputs` to generate .g.dart

    AVOID: Do NOT use Firebase/FCM — local notifications only. Do NOT use positional parameters with v20 API — they changed to named parameters (see RESEARCH.md Pitfall 2).
    WHY: Story dev notes recommend local for MVP. v20 breaking change from v18.
  </action>
  <verify>
    - `cd apps/mobile && flutter pub get` succeeds
    - `cd apps/mobile && dart run build_runner build --delete-conflicting-outputs` succeeds
    - `cd apps/mobile && flutter analyze` shows no new errors in notification files
  </verify>
  <done>
    NotificationService exists with init(), scheduleDailyDigestNotification(), cancelDigestNotification(), requestPermission() methods. All using v20 named parameter API. Provider generated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate notifications into app lifecycle and settings toggle</name>
  <files>
    apps/mobile/lib/main.dart
    apps/mobile/lib/features/settings/providers/notifications_settings_provider.dart
  </files>
  <action>
    1. In `main.dart`:
       - Import NotificationService
       - After `WidgetsFlutterBinding.ensureInitialized()`, add:
         ```dart
         final notificationService = NotificationService();
         await notificationService.init();
         await notificationService.requestPermission();
         await notificationService.scheduleDailyDigestNotification();
         ```
       - Pass go_router's navigatorKey or a GlobalKey to NotificationService for tap-to-navigate behavior

    2. In `notifications_settings_provider.dart`:
       - Import notification_service.dart
       - When `setPushEnabled(true)` is called: also call `NotificationService().scheduleDailyDigestNotification()`
       - When `setPushEnabled(false)` is called: also call `NotificationService().cancelDigestNotification()`
       - This wires the existing Hive-persisted toggle to actually schedule/cancel notifications

    AVOID: Don't modify the existing Hive persistence logic — it already works. Just add the notification scheduling side-effect.
  </action>
  <verify>
    - `cd apps/mobile && flutter analyze` passes with no new errors
    - Settings toggle calls schedule/cancel on the NotificationService
    - App main.dart initializes notification service before runApp
  </verify>
  <done>
    App initializes notification service on startup, schedules daily 8am notification. Settings toggle enables/disables notification. Tapping notification navigates to DigestScreen.
  </done>
</task>

</tasks>

<verification>
- `cd apps/mobile && flutter pub get && flutter analyze` — no errors
- `cd apps/mobile && flutter build apk --debug` — builds successfully (or `flutter build ios --no-codesign` on macOS)
- Notification service uses v20 named parameter API throughout
- Settings toggle wired to schedule/cancel
</verification>

<success_criteria>
- flutter_local_notifications ^20.0.0 integrated and configured
- Daily notification scheduled at 8am Europe/Paris timezone
- Notification tap opens DigestScreen via go_router
- Settings toggle enables/disables notifications
- No Firebase/FCM dependency
</success_criteria>

<output>
After completion, create `.planning/phases/03-polish/03-01-SUMMARY.md`
</output>
