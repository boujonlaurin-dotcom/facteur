---
phase: 02-frontend
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mobile/lib/features/digest/widgets/digest_briefing_section.dart
  - apps/mobile/lib/features/feed/widgets/feed_card.dart
  - apps/mobile/lib/features/digest/screens/digest_screen.dart
  - apps/mobile/lib/features/digest/widgets/digest_feed_card.dart
autonomous: true

must_haves:
  truths:
    - "Digest screen uses BriefingSection design with premium container (gradient, 24px radius, shadow)"
    - "Footer uses FeedCard existing footer (no new footer) with Save and NotInterested buttons"
    - "No 'Read' button - reading marked automatically on article tap"
    - "Progress bar is segmented (5 segments) and integrated in header"
    - "Header uses Feed-style with 'L'Essentiel du Jour' title"
    - "Not Interested opens PersonalizationSheet (same as Feed)"
    - "5 articles displayed with rank badges N°1 to N°5"
  artifacts:
    - path: "apps/mobile/lib/features/digest/widgets/digest_briefing_section.dart"
      provides: "BriefingSection adapted for 5 articles with Save/NotInterested"
      exports: ["DigestBriefingSection"]
    - path: "apps/mobile/lib/features/digest/widgets/digest_feed_card.dart"
      provides: "FeedCard wrapper with Save/NotInterested callbacks"
      exports: ["DigestFeedCard"]
  key_links:
    - from: "digest_briefing_section.dart"
      to: "feed_card.dart"
      via: "Composition with onSave and onNotInterested callbacks"
      pattern: "FeedCard.*onSave.*onNotInterested"
    - from: "digest_feed_card.dart"
      to: "personalization_sheet.dart"
      via: "showModalBottomSheet with PersonalizationSheet"
      pattern: "PersonalizationSheet"
    - from: "digest_briefing_section.dart"
      to: "digest_provider.dart"
      via: "applyAction calls for save/not_interested"
      pattern: "digestProvider.*applyAction"
---

<objective>
Refactor DigestScreen to reuse the existing BriefingSection component with proper integration of Save/NotInterested actions in FeedCard footer, removing the redundant "Read" button and creating an elegant segmented progress bar.

Purpose: Align the digest UI with the premium BriefingSection design already established in the Feed, ensuring visual consistency and proper reuse of existing components rather than reinventing UI patterns.

Output: New DigestBriefingSection widget that reuses BriefingSection patterns, adapted FeedCard with integrated action buttons in footer, and refactored DigestScreen using these components.
</objective>

<execution_context>
@/Users/laurinboujon/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/laurinboujon/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-frontend/02-frontend-UI_REWORK_CONTEXT.md

## Critical Reference Files (MUST STUDY)

### 1. BriefingSection (Component to Reuse)
@apps/mobile/lib/features/feed/widgets/briefing_section.dart
- Container with gradient, borderRadius 24, shadow
- Header with "L'Essentiel du Jour", reading time, progress badge
- _buildRankedCard with N°1, N°2, N°3 badges
- Uses FeedCard with onPersonalize callback
- Collapsed state when all consumed

### 2. FeedCard (Footer to Extend)
@apps/mobile/lib/features/feed/widgets/feed_card.dart
- Lines 125-210: Footer implementation
- Currently has: Source logo/name/recency + onPersonalize button
- Must add: Save button + NotInterested button in same footer
- Keep height compact (~40px)

### 3. PersonalizationSheet (NotInterested Action)
@apps/mobile/lib/features/feed/widgets/personalization_sheet.dart
- Opens on "Personalize" tap
- Shows "Moins de [source]" and "Moins sur [theme]" options
- Calls feedProvider.notifier.muteSource/muteTheme
- Must be reused for "Not Interested" action

### 4. Current DigestScreen (To Refactor)
@apps/mobile/lib/features/digest/screens/digest_screen.dart
- Currently uses ListView with DigestCard
- Has "Votre Essentiel" custom header
- Must be refactored to use DigestBriefingSection

## Design Specifications

### Container Design (Copy from BriefingSection)
```dart
Container(
  decoration: BoxDecoration(
    gradient: LinearGradient(
      begin: Alignment.topLeft,
      end: Alignment.bottomRight,
      colors: isDark 
        ? [Color(0xFF1A1918), Color(0xFF2C2A29)]
        : [colors.backgroundSecondary, colors.backgroundPrimary],
    ),
    borderRadius: BorderRadius.circular(24),
    border: Border.all(
      color: colors.primary.withValues(alpha: isDark ? 0.3 : 0.15),
      width: 1,
    ),
    boxShadow: [
      BoxShadow(
        color: Colors.black.withValues(alpha: isDark ? 0.2 : 0.05),
        blurRadius: 15,
        offset: Offset(0, 8),
      ),
    ],
  ),
)
```

### Footer Actions Design
- Save button: PhosphorIcons.bookmark() / PhosphorIcons.bookmark(fill)
- NotInterested button: PhosphorIcons.eyeSlash()
- Both in existing footer Row, right side
- Compact size (icon 20px, padding 6px)

### Progress Bar Design
```dart
// In header, compact segmented bar
Row(
  children: List.generate(5, (index) {
    final isFilled = index < readCount;
    return Container(
      width: 8,
      height: 4,
      margin: EdgeInsets.only(right: 2),
      decoration: BoxDecoration(
        color: isFilled 
          ? (isDone ? colors.success : colors.primary)
          : colors.backgroundSecondary,
        borderRadius: BorderRadius.circular(2),
      ),
    );
  }),
)
```

## Anti-Patterns (DO NOT DO)
❌ Create a new footer below FeedCard
❌ Add "Read" button (redundant with tap)
❌ Create new PersonalizationSheet
❌ Change BriefingSection container design
❌ Increase footer height
❌ Use animations for progress bar
❌ Change "L'Essentiel du Jour" title
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend FeedCard with Save/NotInterested callbacks</name>
  <files>apps/mobile/lib/features/feed/widgets/feed_card.dart</files>
  <action>
Read the current FeedCard implementation (especially lines 125-210 for the footer).

Add optional callbacks for Save and NotInterested actions:
1. Add to constructor:
   ```dart
   final VoidCallback? onSave;
   final VoidCallback? onNotInterested;
   final bool isSaved; // To show filled/unfilled bookmark
   ```

2. Modify the footer (around line 195-210) to include the action buttons:
   ```dart
   // Replace the single onPersonalize button with:
   Row(
     mainAxisSize: MainAxisSize.min,
     children: [
       // Save button
       if (onSave != null)
         InkWell(
           onTap: onSave,
           borderRadius: BorderRadius.circular(12),
           child: Container(
             padding: EdgeInsets.all(6),
             child: Icon(
               isSaved 
                 ? PhosphorIcons.bookmark(PhosphorIconsStyle.fill)
                 : PhosphorIcons.bookmark(),
               size: 20,
               color: isSaved ? colors.primary : colors.textSecondary,
             ),
           ),
         ),
       
       SizedBox(width: 8),
       
       // NotInterested button
       if (onNotInterested != null)
         InkWell(
           onTap: onNotInterested,
           borderRadius: BorderRadius.circular(12),
           child: Container(
             padding: EdgeInsets.all(6),
             child: Icon(
               PhosphorIcons.eyeSlash(),
               size: 20,
               color: colors.textSecondary,
             ),
           ),
         ),
     ],
   )
   ```

3. Keep the source info on the left side compact - use Flexible if needed to prevent overflow

4. Ensure footer height stays ~40px (don't increase vertical padding)
  </action>
  <verify>FeedCard compiles without errors and footer shows new buttons when callbacks provided</verify>
  <done>FeedCard accepts onSave, onNotInterested, and isSaved parameters with compact footer design</done>
</task>

<task type="auto">
  <name>Task 2: Create DigestBriefingSection widget</name>
  <files>apps/mobile/lib/features/digest/widgets/digest_briefing_section.dart</files>
  <action>
Create a new widget based on BriefingSection but adapted for 5 articles and digest-specific features:

1. Copy the structure from `apps/mobile/lib/features/feed/widgets/briefing_section.dart`

2. Adapt for 5 articles:
   - Change all references from `briefing.length` (3) to 5
   - Update progress calculations for X/5
   - Keep _buildRankedCard but adapt for 5 items

3. Replace FeedCard with extended version:
   ```dart
   // Instead of:
   FeedCard(
     content: item.content,
     onTap: () => onItemTap(item),
     onPersonalize: onPersonalize != null ? () => onPersonalize!(item) : null,
   )
   
   // Use:
   FeedCard(
     content: item.content,
     onTap: () => onItemTap(item),
     onSave: () => onSave?.call(item),
     onNotInterested: () => onNotInterested?.call(item),
     isSaved: item.isSaved,
   )
   ```

4. Add new callbacks to constructor:
   ```dart
   final void Function(DigestItem) onItemTap;
   final void Function(DigestItem)? onSave;
   final void Function(DigestItem)? onNotInterested;
   final List<DigestItem> items;
   ```

5. Update header with segmented progress bar:
   ```dart
   // Replace _buildProgressBadge with segmented bar
   Column(
     crossAxisAlignment: CrossAxisAlignment.end,
     children: [
       Text('$readCount/5', style: ...),
       SizedBox(height: 4),
       Row(
         children: List.generate(5, (index) {
           final isFilled = index < readCount;
           return Container(
             width: 8,
             height: 4,
             margin: EdgeInsets.only(right: 2),
             decoration: BoxDecoration(
               color: isFilled 
                 ? (isDone ? colors.success : colors.primary)
                 : colors.backgroundSecondary,
               borderRadius: BorderRadius.circular(2),
             ),
           );
         }),
       ),
     ],
   )
   ```

6. Keep all the premium styling:
   - Gradient background
   - BorderRadius.circular(24)
   - BoxShadow
   - Border with primary color
   - Dark/light adaptive colors

7. Add proper imports for digest models
  </action>
  <verify>Widget compiles and can display 5 items with new footer actions</verify>
  <done>DigestBriefingSection created with 5 articles, segmented progress bar, and Save/NotInterested in footer</done>
</task>

<task type="auto">
  <name>Task 3: Refactor DigestScreen to use DigestBriefingSection</name>
  <files>apps/mobile/lib/features/digest/screens/digest_screen.dart</files>
  <action>
Refactor DigestScreen to use the new DigestBriefingSection:

1. Replace imports:
   - Remove: `digest_card.dart`, `progress_bar.dart`
   - Add: `digest_briefing_section.dart`
   - Add: `personalization_sheet.dart` from feed

2. Replace the body content:
   ```dart
   // Remove the ListView with DigestCard
   // Replace with:
   
   CustomScrollView(
     slivers: [
       // Header like Feed
       SliverToBoxAdapter(
         child: Padding(
           padding: EdgeInsets.symmetric(
             horizontal: FacteurSpacing.space6,
             vertical: FacteurSpacing.space4,
           ),
           child: Center(child: FacteurLogo(size: 32)),
         ),
       ),
       
       // Digest Briefing Section
       SliverToBoxAdapter(
         child: Padding(
           padding: EdgeInsets.symmetric(horizontal: 16),
           child: Consumer(builder: (context, ref, child) {
             final digestAsync = ref.watch(digestProvider);
             
             return digestAsync.when(
               data: (digest) => DigestBriefingSection(
                 items: digest.items,
                 onItemTap: (item) => _openArticle(item),
                 onSave: (item) => _handleSave(item),
                 onNotInterested: (item) => _handleNotInterested(item, context),
               ),
               loading: () => CircularProgressIndicator(),
               error: (err, stack) => ErrorWidget(...),
             );
           }),
         ),
       ),
     ],
   )
   ```

3. Implement action handlers:
   ```dart
   void _handleSave(DigestItem item) {
     HapticFeedback.lightImpact();
     ref.read(digestProvider.notifier).applyAction(
       item.contentId, 
       item.isSaved ? 'unsave' : 'save'
     );
   }
   
   void _handleNotInterested(DigestItem item, BuildContext context) {
     HapticFeedback.lightImpact();
     // Open PersonalizationSheet (same as Feed)
     showModalBottomSheet(
       context: context,
       backgroundColor: Colors.transparent,
       isScrollControlled: true,
       builder: (_) => PersonalizationSheet(
         content: _convertToContent(item), // Helper to convert DigestItem to Content
       ),
     );
   }
   
   void _openArticle(DigestItem item) {
     // Mark as read automatically
     ref.read(digestProvider.notifier).applyAction(item.contentId, 'read');
     // Navigate to article
     context.push('/feed/content/${item.contentId}');
   }
   ```

4. Remove old app bar "Votre Essentiel" - use Feed-style header instead

5. Keep the completion detection logic (ref.listen for isCompleted)

6. Add helper to convert DigestItem to Content for PersonalizationSheet:
   ```dart
   Content _convertToContent(DigestItem item) {
     return Content(
       id: item.contentId,
       title: item.title,
       // ... map other fields
     );
   }
   ```
  </action>
  <verify>DigestScreen displays DigestBriefingSection with 5 articles and actions work</verify>
  <done>DigestScreen refactored to use DigestBriefingSection with Feed-style header</done>
</task>

<task type="auto">
  <name>Task 4: Test and verify integration</name>
  <files>apps/mobile/lib/features/digest/screens/digest_screen.dart</files>
  <action>
Test the complete integration:

1. Run flutter analyze:
   ```bash
   cd apps/mobile && flutter analyze lib/features/digest/
   ```
   - Must have 0 errors

2. Verify visual consistency:
   - Container has gradient, 24px radius, shadow
   - Header shows "L'Essentiel du Jour" (not "Votre Essentiel")
   - Progress bar shows 5 segments
   - 5 articles with N°1 to N°5 badges
   - Footer has Save and NotInterested buttons (no Read button)
   - Cards dim when read (opacity 0.6)

3. Test actions:
   - Tap Save → icon fills, haptic feedback
   - Tap NotInterested → PersonalizationSheet opens
   - Tap article → opens detail + marks as read automatically
   - Progress bar updates when articles marked read

4. Test edge cases:
   - All 5 articles read → shows collapsed state
   - Article saved → bookmark icon filled
   - Dark/light theme → colors adapt correctly

5. Check no regression:
   - FeedScreen still works
   - BriefingSection in Feed still works (until decommissioned)
   - Navigation between digest and feed works
  </action>
  <verify>All tests pass, flutter analyze clean, UI matches specifications</verify>
  <done>Integration complete and verified, DigestBriefingSection working correctly</done>
</task>

</tasks>

<verification>
1. **Visual verification:**
   - Container: gradient, borderRadius 24, shadow, border
   - Header: "L'Essentiel du Jour", reading time, 5-segment progress bar
   - 5 cards with N°1-5 badges
   - Footer: source info (left) + Save + NotInterested (right)
   - No "Read" button visible
   - Read articles have opacity 0.6

2. **Functional verification:**
   - Save button toggles bookmark icon
   - NotInterested opens PersonalizationSheet
   - Article tap marks as read + opens detail
   - Progress bar updates when articles processed
   - Completion state shows collapsed view

3. **Code verification:**
   - flutter analyze passes with 0 errors
   - No new footer created (uses FeedCard footer)
   - PersonalizationSheet reused from feed
   - BriefingSection patterns followed

4. **Integration verification:**
   - DigestScreen uses CustomScrollView with Slivers
   - Feed-style header with FacteurLogo
   - Works with existing digestProvider
   - Navigation to closure screen still works
</verification>

<success_criteria>
- DigestBriefingSection displays 5 articles in premium container
- FeedCard footer extended with Save/NotInterested (no new footer)
- "Read" button removed (automatic on tap)
- Segmented progress bar (5 segments) in header
- Header uses Feed-style "L'Essentiel du Jour"
- Not Interested reuses PersonalizationSheet
- flutter analyze passes with 0 errors
- Visual match with BriefingSection from Feed
- All actions functional with haptic feedback
</success_criteria>

<output>
After completion, create `.planning/phases/02-frontend/02-07-SUMMARY.md`

Next step will be Phase 2 Plan 08: Decommission old BriefingSection from Feed
</output>
