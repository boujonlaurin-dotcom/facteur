---
phase: 02-frontend
plan: 04
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - apps/mobile/lib/features/feed/screens/feed_screen.dart
  - apps/mobile/lib/shared/widgets/navigation/shell_scaffold.dart
  - apps/mobile/lib/config/routes.dart
  - apps/mobile/lib/features/digest/screens/digest_screen.dart
  - apps/mobile/lib/features/digest/screens/closure_screen.dart
  - apps/mobile/lib/features/gamification/widgets/streak_indicator.dart
autonomous: true
must_haves:
  truths:
    - "Feed becomes secondary 'Explorer plus' destination"
    - "Bottom navigation shows 'Essentiel' and 'Explorer' tabs"
    - "User can switch between digest and feed at any time"
    - "Feed retains all existing functionality"
    - "Digest is default landing screen for authenticated users"
    - "Streak indicator visible in both digest and feed"
  artifacts:
    - path: "apps/mobile/lib/shared/widgets/navigation/shell_scaffold.dart"
      provides: "Updated bottom navigation with Essentiel/Explorer tabs"
      exports: ["ShellScaffold"]
  key_links:
    - from: "shell_scaffold.dart"
      to: "digest_screen.dart"
      via: "Bottom nav tab 0"
      pattern: "DigestScreen"
    - from: "shell_scaffold.dart"
      to: "feed_screen.dart"
      via: "Bottom nav tab 1"
      pattern: "FeedScreen"
    - from: "closure_screen.dart"
      to: "feed_screen.dart"
      via: "Explorer plus button"
      pattern: "context\\.go.*feed"
---

<objective>
Implement feed relegation to "Explorer plus" status and update navigation flow.

Purpose: Complete the digest-first pivot by making the feed secondary while preserving it as an "Explorer plus" option. Update navigation to support seamless switching between digest and feed.

Output: Updated navigation structure with digest as primary destination and feed as secondary explorer view.
</objective>

<execution_context>
@/Users/laurinboujon/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/laurinboujon/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-frontend/02-01-PLAN.md
@.planning/phases/02-frontend/02-02-PLAN.md
@.planning/phases/02-frontend/02-03-PLAN.md

**Current navigation structure (from apps/mobile/lib/config/routes.dart):**

ShellRoute with bottom navigation contains:
- Feed (tab 0) - currently default
- Progress (tab 1) - redirected to feed (disabled in MVP)
- Settings (tab 2)

**Required changes:**

New structure:
- Essentiel/Digest (tab 0) - new default
- Explorer/Feed (tab 1) - relegated but accessible
- Settings (tab 2) - unchanged

**Existing shell scaffold (from apps/mobile/lib/shared/widgets/navigation/shell_scaffold.dart):**
- BottomNavigationBar with 3 items (currently feed, progress-disabled, settings)
- IndexedStack for screen switching
- StreakIndicator in app bar (for feed screen)

**Feed screen (from apps/mobile/lib/features/feed/screens/feed_screen.dart):**
- Complete implementation exists
- Welcome banner shown on first visit
- Content cards with personalization
- Must remain fully functional

**Requirements (from REQUIREMENTS.md):**
- UI-07: "Explorer plus" button to access relegated feed
- Feed must remain accessible but secondary
- No regression in existing feed functionality

**Navigation flow:**
1. User opens app → Digest screen (if authenticated and onboarded)
2. User completes digest → Closure screen with "Explorer plus" button
3. User taps "Explorer plus" → Feed screen
4. User can switch back via bottom nav "Essentiel" tab
5. User can always access feed via "Explorer" tab

**Anti-regression principle:**
- FeedScreen code remains unchanged
- Feed API endpoints unchanged
- All existing feed features work exactly as before
- Only navigation priority changes
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update shell scaffold navigation tabs</name>
  <files>apps/mobile/lib/shared/widgets/navigation/shell_scaffold.dart</files>
  <action>
Update bottom navigation to support digest and feed tabs:

1. Modify ShellScaffold to support 3 tabs:
   - Tab 0: Essentiel (DigestScreen)
   - Tab 1: Explorer (FeedScreen) 
   - Tab 2: Paramètres (SettingsScreen)

2. Update bottom navigation items:
   ```dart
   BottomNavigationBarItem(
     icon: Icon(PhosphorIcons.article()),
     activeIcon: Icon(PhosphorIcons.article(PhosphorIconsStyle.fill)),
     label: 'Essentiel',
   ),
   BottomNavigationBarItem(
     icon: Icon(PhosphorIcons.compass()),
     activeIcon: Icon(PhosphorIcons.compass(PhosphorIconsStyle.fill)),
     label: 'Explorer',
   ),
   BottomNavigationBarItem(
     icon: Icon(PhosphorIcons.gear()),
     activeIcon: Icon(PhosphorIcons.gear(PhosphorIconsStyle.fill)),
     label: 'Paramètres',
   ),
   ```

3. Update IndexedStack children:
   - Index 0: DigestScreen (import from features/digest)
   - Index 1: FeedScreen (existing)
   - Index 2: SettingsScreen (existing)

4. Update _calculateSelectedIndex for new routes:
   - /digest → index 0
   - /feed → index 1
   - /settings/* → index 2

5. Handle navigation state preservation:
   - Maintain separate Navigator states for each tab
   - Use existing IndexedStack approach
   - Keep currentIndex synchronized with router location
  </action>
  <verify>Bottom nav shows 3 tabs and switching works correctly</verify>
  <done>Shell scaffold has Essentiel/Explorer/Paramètres tabs with correct routing</done>
</task>

<task type="auto">
  <name>Task 2: Update auth redirect to digest</name>
  <files>apps/mobile/lib/config/routes.dart</files>
  <action>
Change default authenticated route from feed to digest:

1. Find all feed redirects in redirect logic:
   - Search for: RoutePaths.feed in redirect function
   - Current: authState.needsOnboarding ? RoutePaths.onboarding : RoutePaths.feed

2. Update redirects to use digest:
   ```dart
   // Old:
   return authState.needsOnboarding
       ? RoutePaths.onboarding
       : RoutePaths.feed;
   
   // New:
   return authState.needsOnboarding
       ? RoutePaths.onboarding
       : RoutePaths.digest;
   ```

3. Update onboarding conclusion redirect:
   - Find: context.go('${RoutePaths.feed}?welcome=true')
   - Change to: context.go('${RoutePaths.digest}?first=true')

4. Update email confirmation redirect:
   - Same pattern: change feed to digest

5. Update login redirect:
   - After login success, go to digest not feed

6. Keep feed for specific cases:
   - Deep links to /feed should still work
   - Explicit navigation to feed should work
   - Only default/redirect behavior changes
  </action>
  <verify>Logging in navigates to /digest instead of /feed</verify>
  <done>Authenticated users land on digest screen by default</done>
</task>

<task type="auto">
  <name>Task 3: Add digest to shell route</name>
  <files>apps/mobile/lib/config/routes.dart</files>
  <action>
Integrate digest route into ShellRoute:

1. Add digest route inside ShellRoute (at tab 0 position):
   ```dart
   ShellRoute(
     builder: (context, state, child) => ShellScaffold(child: child),
     routes: [
       // Tab 0: Essentiel (Digest)
       GoRoute(
         path: RoutePaths.digest,
         name: RouteNames.digest,
         builder: (context, state) => const DigestScreen(),
       ),
       
       // Tab 1: Explorer (Feed)
       GoRoute(
         path: RoutePaths.feed,
         name: RouteNames.feed,
         builder: (context, state) => const FeedScreen(),
         routes: [
           // Nested content detail (keep existing)
           GoRoute(
             path: 'content/:id',
             name: RouteNames.contentDetail,
             parentNavigatorKey: NotificationService.navigatorKey,
             pageBuilder: (context, state) { ... },
           ),
         ],
       ),
       
       // Tab 2: Settings (existing)
       GoRoute(
         path: RoutePaths.settings,
         name: RouteNames.settings,
         builder: (context, state) => const SettingsScreen(),
         routes: [ ... ],
       ),
     ],
   ),
   ```

2. Remove standalone digest route (if added outside ShellRoute in 02-01):
   - Digest should only exist inside ShellRoute now
   - Remove any duplicate route definitions

3. Keep closure route outside ShellRoute:
   - ClosureScreen should NOT have bottom nav visible
   - Keep as separate route (already done in 02-03)

4. Test route matching:
   - /digest → matches ShellRoute + shows digest tab
   - /feed → matches ShellRoute + shows explorer tab
   - /digest/closure → matches separate route (full screen)
  </action>
  <verify>Digest route works inside shell with bottom navigation visible</verify>
  <done>Digest screen integrated into shell route as primary tab</done>
</task>

<task type="auto">
  <name>Task 4: Update streak indicator visibility</name>
  <files>apps/mobile/lib/shared/widgets/navigation/shell_scaffold.dart
apps/mobile/lib/features/digest/screens/digest_screen.dart</files>
  <action>
Ensure streak indicator shows in both digest and feed:

1. In ShellScaffold, check current route:
   - If on digest OR feed route, show StreakIndicator
   - Use ref.watch(routerProvider) to get current location

2. Update app bar logic:
   ```dart
   final currentRoute = GoRouter.of(context).location;
   final showStreak = currentRoute.startsWith(RoutePaths.digest) || 
                      currentRoute.startsWith(RoutePaths.feed);
   ```

3. Alternative: Add streak to both screens individually:
   - Add StreakIndicator to DigestScreen app bar (in 02-01)
   - Keep existing StreakIndicator in FeedScreen
   - More explicit control over positioning

4. Recommended approach:
   - Move streak to ShellScaffold app bar for consistency
   - Show on both digest and feed screens
   - Hide on settings screen

5. Ensure streak updates:
   - StreakProvider fetches latest data on app launch
   - Updates after digest completion (via closure screen)
   - Real-time sync with backend
  </action>
  <verify>Streak indicator visible on both digest and feed screens</verify>
  <done>Streak indicator consistently displayed in both primary screens</done>
</task>

<task type="auto">
  <name>Task 5: Add "first digest" welcome experience</name>
  <files>apps/mobile/lib/features/digest/screens/digest_screen.dart</files>
  <action>
Add welcome overlay for first-time digest users:

1. Add first-time detection:
   - Check query param: state.uri.queryParameters['first']
   - Or check shared preference: hasSeenDigestWelcome
   - Store flag after showing welcome

2. Create welcome overlay/modal:
   - Similar to FeedScreen's WelcomeBanner
   - Show quick tutorial or tips
   - Title: "Bienvenue dans votre Essentiel"
   - Content: Brief explanation of 5 articles, actions, completion

3. Welcome content:
   ```
   "Votre Essentiel contient 5 articles sélectionnés pour vous.
   
   • Lisez, sauvegardez ou passez chaque article
   • Complétez les 5 pour maintenir votre série
   • Explorez plus après votre Essentiel"
   ```

4. UI design:
   - Modal with backgroundPrimary
   - Facteur logo at top
   - Bullet points with icons
   - PrimaryButton: "Commencer"
   - Dismissible via button or backdrop tap

5. Reuse patterns from:
   - apps/mobile/lib/features/feed/widgets/welcome_banner.dart
   - Similar animation and styling
  </action>
  <verify>First-time users see welcome modal before digest content</verify>
  <done>Welcome experience guides first-time digest users</done>
</task>

<task type="auto">
  <name>Task 6: Test navigation flows end-to-end</name>
  <files>apps/mobile/lib/config/routes.dart</files>
  <action>
Verify all navigation paths work correctly:

1. Test primary flows:
   - Fresh login → Digest screen (check)
   - Complete digest → Closure → Feed via Explorer plus
   - Switch tabs via bottom nav (Essentiel ↔ Explorer)
   - Settings tab accessible from both

2. Test edge cases:
   - Deep link to /feed while on digest
   - Deep link to /digest while on feed
   - Back button behavior on each screen
   - Refresh while on closure screen

3. Test with different states:
   - Incomplete digest (3/5 articles)
   - Completed digest (navigated to closure)
   - No digest yet (loading state)

4. Verify no regressions:
   - Feed screen still works fully
   - Content detail opens correctly
   - Personalization sheet opens
   - All existing feed features intact

5. Document any issues:
   - Note any animation glitches
   - Check state persistence across tab switches
   - Verify provider refresh on navigation

6. Manual test steps:
   ```
   1. Fresh install → login → should see digest
   2. Process 2 articles → switch to feed → switch back
   3. Complete all 5 → see closure → tap Explorer plus
   4. On feed → switch to Essentiel → verify digest state
   5. Kill app → reopen → should restore to last tab
   ```
  </action>
  <verify>All 5 test scenarios pass without issues</verify>
  <done>All navigation flows tested and working correctly</done>
</task>

</tasks>

<verification>
1. Run `flutter analyze` - must pass with 0 errors
2. Test authentication flow:
   - Login → should navigate to /digest
   - Bottom nav shows "Essentiel" as active tab
3. Test tab switching:
   - Tap "Explorer" → Feed screen visible
   - Tap "Essentiel" → Digest screen visible
   - Tab state preserved during switching
4. Test completion flow:
   - Complete digest → Closure screen
   - Tap "Explorer plus" → Feed screen
   - Can switch back to Essentiel
5. Verify feed functionality:
   - All cards display correctly
   - Personalization works
   - No visual or functional regressions
6. Check streak indicator visible on both screens
</verification>

<success_criteria>
- Bottom navigation shows Essentiel/Explorer/Paramètres tabs
- Digest is default landing screen for authenticated users
- User can switch between digest and feed via bottom nav
- Feed retains all existing functionality with no regressions
- "Explorer plus" button navigates from closure to feed
- Streak indicator visible in both digest and feed screens
- All navigation flows work end-to-end without issues
</success_criteria>

<output>
After completion, create `.planning/phases/02-frontend/02-04-SUMMARY.md`
</output>
