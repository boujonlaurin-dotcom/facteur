---
phase: 02-frontend
plan: 15
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/api/app/services/digest_service.py
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "Digest items include recommendation_reason with scoring breakdown"
    - "Frontend receives breakdown data from API"
    - "Personalization sheet shows 'Pourquoi cet article?' with score details"
  artifacts:
    - path: "packages/api/app/services/digest_service.py"
      provides: "Force regeneration endpoint or logic to rebuild digest with breakdown"
---

<objective>
Fix missing scoring breakdown data in digest items.

Purpose: Digests generated before plan 02-11 don't have breakdown data stored. The DigestPersonalizationSheet shows "Information non disponible" because `recommendation_reason` is null.

Output: Working scoring transparency with breakdown visible in the UI.
</objective>

<execution_context>
@/Users/laurinboujon/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
## Problem Analysis

### Current State
1. DigestPersonalizationSheet checks `if (reason == null)` and shows "Information non disponible"
2. Backend tries to rebuild `recommendation_reason` from stored `breakdown` data
3. Old digests (before 02-11) have `breakdown: []` or missing breakdown field
4. Result: `recommendation_reason` is null, UI shows fallback

### Root Cause
The digest was generated before the scoring transparency feature (plan 02-11) was implemented. The database stores:
```json
{
  "content_id": "...",
  "rank": 1,
  "reason": "Source suivie : Mediapart",
  "source_name": "Mediapart",
  "score": 245.0
  // Missing: "breakdown": [...]
}
```

### Solution Options

**Option A: Force regenerate digest** (Recommended for testing)
- Use existing force regenerate functionality
- New digest will have breakdown data
- Quick to test

**Option B: Backfill breakdown data** (Complex)
- Would require re-running scoring algorithm on old digests
- Overkill for testing

**Option C: Graceful fallback** (Already implemented)
- Shows "Information non disponible" when no data
- Acceptable for old digests

## Implementation

The app already has a force regenerate feature. We just need to ensure it works and test with a fresh digest.

Check the force regenerate endpoint/button in the app.
</context>

<tasks>

<task type="auto">
  <name>Verify force regenerate functionality and add diagnostic logging</name>
  <files>packages/api/app/services/digest_service.py</files>
  <action>
    1. First, verify the force regenerate API endpoint exists and works:
       - Check `packages/api/app/routers/digest.py` for force regenerate endpoint
       - Should be POST /api/digest/generate or similar

    2. Add diagnostic logging to verify breakdown is being generated:
       In `digest_service.py` around line 415-424 where breakdown is stored:
       ```python
       # Store breakdown if available
       if item.breakdown:
           logger.info(
               "Storing breakdown for digest item",
               content_id=str(item.content.id),
               breakdown_count=len(item.breakdown),
               breakdown_labels=[b.label for b in item.breakdown[:3]]
           )
           item_data["breakdown"] = [...]
       else:
           logger.warning(
               "No breakdown available for digest item",
               content_id=str(item.content.id),
               content_title=item.content.title[:50]
           )
       ```

    3. Also add logging when rebuilding from stored data (around line 508-517):
       ```python
       breakdown_data = item_data.get("breakdown", [])
       if breakdown_data:
           logger.info(
               "Rebuilt breakdown from stored data",
               content_id=content_id,
               breakdown_count=len(breakdown_data)
           )
       else:
           logger.warning(
               "No breakdown data in stored item",
               content_id=content_id
           )
       ```

    4. Test the force regenerate endpoint:
       ```bash
       curl -X POST "https://your-api/api/digest/generate" \
         -H "Authorization: Bearer YOUR_TOKEN"
       ```

    5. Check logs to verify breakdown is being generated and stored
  </action>
  <verify>
    - Force regenerate endpoint works
    - Logs show breakdown being generated and stored
    - New digest has breakdown data
  </verify>
  <done>
    Force regenerate working, breakdown data being generated and stored
  </done>
</task>

<task type="checkpoint:human-verify">
  <name>Test digest with fresh data</name>
  <what-built>
    Added diagnostic logging and verified force regenerate functionality. The system now logs when breakdown data is stored and when it's missing.
  </what-built>
  <how-to-verify>
    **To test the scoring transparency:**

    1. **Force regenerate your digest:**
       - Open the app
       - Go to Essentiel tab
       - Look for the refresh/regenerate button (or use the API directly)
       - Tap to generate a fresh digest

    2. **Check that new digest has breakdown data:**
       - After regeneration, check the logs for:
         ```
         "Storing breakdown for digest item" with breakdown_count > 0
         ```

    3. **Test the personalization sheet:**
       - Tap "moins voir..." on any article
       - Should now show "Pourquoi cet article?" with:
         * Total score (e.g., "245 pts")
         * Breakdown list (Theme: +70, Source: +40, etc.)
         * Personalization options at bottom

    4. **If still showing "Information non disponible":**
       - Check logs for "No breakdown available" or "No breakdown data"
       - This indicates the DigestSelector isn't generating breakdown
       - We'll need to investigate DigestSelector._score_candidates()

    **Run these commands to verify:**
    ```bash
    # Check Flutter code compiles
    cd apps/mobile && flutter analyze

    # Check API logs after force regenerate
    # Look for breakdown storage messages
    ```
  </how-to-verify>
  <resume-signal>
    Type "works" if the personalization sheet now shows scoring breakdown.
    Type "still-broken" if it still shows "Information non disponible" after force regenerate.
  </resume-signal>
</task>

</tasks>

<verification>
- Force regenerate API works
- Logs confirm breakdown is being generated
- Fresh digest has recommendation_reason data
- Personalization sheet shows scoring breakdown correctly
</verification>

<success_criteria>
- User can force regenerate digest
- New digest includes breakdown data for all items
- Tapping "moins voir..." shows "Pourquoi cet article?" with score details
- No "Information non disponible" message on fresh digests
</success_criteria>

<output>
After completion, create `.planning/phases/02-frontend/02-15-SUMMARY.md`
</output>
