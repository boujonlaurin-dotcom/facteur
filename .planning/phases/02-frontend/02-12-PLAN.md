---
phase: 02-frontend
plan: 12
type: execute
wave: 2
depends_on:
  - 02-11
files_modified:
  - apps/mobile/lib/features/digest/models/digest_models.dart
  - apps/mobile/lib/features/digest/models/digest_models.freezed.dart
  - apps/mobile/lib/features/digest/models/digest_models.g.dart
  - apps/mobile/lib/features/digest/widgets/digest_briefing_section.dart
  - apps/mobile/lib/features/digest/widgets/digest_personalization_sheet.dart
  - apps/mobile/lib/features/digest/screens/digest_screen.dart
autonomous: true
must_haves:
  truths:
    - "User can long-press any digest article to see 'Pourquoi cet article?'"
    - "Reasoning sheet shows detailed breakdown with points (+/-) and labels"
    - "Total score displayed prominently in sheet header"
    - "Breakdown includes all scoring factors (Theme, Source, Topics, Recency, etc.)"
    - "Visual distinction between positive (green/up) and negative (red/down) contributions"
  artifacts:
    - path: "apps/mobile/lib/features/digest/models/digest_models.dart"
      provides: "DigestScoreBreakdown and DigestRecommendationReason models"
      contains: "class DigestScoreBreakdown|DigestRecommendationReason"
    - path: "apps/mobile/lib/features/digest/widgets/digest_personalization_sheet.dart"
      provides: "Bottom sheet UI for scoring breakdown"
      contains: "Pourquoi cet article|scoreTotal|breakdown"
    - path: "apps/mobile/lib/features/digest/widgets/digest_briefing_section.dart"
      provides: "Long-press handler to show reasoning sheet"
      contains: "onLongPress|_showReasoningSheet"
  key_links:
    - from: "DigestBriefingSection FeedCard"
      to: "DigestPersonalizationSheet"
      via: "onLongPress handler"
    - from: "API recommendation_reason"
      to: "Frontend models"
      via: "JSON serialization in Freezed models"
    - from: "DigestScoreBreakdown.isPositive"
      to: "UI color coding"
      via: "Green for positive, red for negative contributions"
---

<objective>
Create UI for "Pourquoi cet article?" feature allowing users to see detailed scoring breakdown of why each digest article was selected.

Purpose: Build user trust through algorithmic transparency by showing exactly how scores are calculated (theme matches, source affinity, topic alignment, recency, quality).
Output: Long-press gesture on digest articles opens bottom sheet with full scoring breakdown.
</objective>

<execution_context>
@/Users/laurinboujon/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/laurinboujon/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-frontend/02-11-SUMMARY.md
@.planning/IMPLEMENTATION_PLAN_2026-02-06.md

## Backend Dependency (Plan 02-11)

This plan depends on 02-11 completing first. Backend will provide:
- `recommendation_reason` field in DigestItem with:
  - `label`: String (top-level summary)
  - `score_total`: double (sum of all contributions)
  - `breakdown`: Array of score contributions with:
    - `label`: String (human-readable reason)
    - `points`: double (numeric contribution)
    - `is_positive`: bool (true = bonus, false = penalty)

## Reference: Feed Implementation

The feed already has this feature working. Reference files:
- `apps/mobile/lib/features/feed/models/content_model.dart` (lines 16-61)
  - ScoreContribution class
  - RecommendationReason class
- `apps/mobile/lib/features/feed/widgets/feed_card.dart` (look for _showScoreBreakdown)

## Existing Pattern to Follow

```dart
// Feed's ScoreContribution
class ScoreContribution {
  final String label;
  final double points;
  final bool isPositive;
  
  factory ScoreContribution.fromJson(Map<String, dynamic> json) {
    return ScoreContribution(
      label: (json['label'] as String?) ?? 'Facteur',
      points: (json['points'] as num?)?.toDouble() ?? 0.0,
      isPositive: (json['is_positive'] as bool?) ?? true,
    );
  }
}

// Feed's RecommendationReason
class RecommendationReason {
  final String label;
  final double scoreTotal;
  final List<ScoreContribution> breakdown;
  
  factory RecommendationReason.fromJson(Map<String, dynamic> json) {
    final breakdownJson = json['breakdown'];
    return RecommendationReason(
      label: (json['label'] as String?) ?? 'Recommandé',
      scoreTotal: (json['score_total'] as num?)?.toDouble() ?? 0.0,
      breakdown: (breakdownJson is List)
          ? breakdownJson
              .whereType<Map<String, dynamic>>()
              .map((e) => ScoreContribution.fromJson(e))
              .toList()
          : const [],
    );
  }
}
```

## Visual Design Reference

From IMPLEMENTATION_PLAN_2026-02-06.md:

```
┌──────────────────────────────────────────┐
│  ? Pourquoi cet article ?      245 pts   │  ← Header with total
├──────────────────────────────────────────┤
│  ↗ Thème matché : Tech          +70      │  ← Green/up for positive
│  ↗ Source de confiance          +40      │
│  ↗ Sous-thème : IA              +60      │
│  ↗ Article récent (< 24h)       +25      │
│  ↗ Précision thématique         +20      │
│  ↗ Source qualitative           +10      │
│  ↘ Fiabilité source faible      -30      │  ← Red/down for negative
├──────────────────────────────────────────┤
│  [Actions: Mute source/theme]            │
└──────────────────────────────────────────┘
```

## Key Components

1. **DigestScoreBreakdown** - Model for individual contribution
2. **DigestRecommendationReason** - Model for full reasoning
3. **DigestPersonalizationSheet** - Bottom sheet UI component
4. **DigestBriefingSection** - Add onLongPress handler to FeedCard
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Freezed Models with Scoring Classes</name>
  <files>apps/mobile/lib/features/digest/models/digest_models.dart</files>
  <action>
    Add two new model classes to digest_models.dart following Freezed patterns:

    1. **DigestScoreBreakdown** - Individual scoring contribution:
    ```dart
    @freezed
    class DigestScoreBreakdown with _$DigestScoreBreakdown {
      const factory DigestScoreBreakdown({
        required String label,
        required double points,
        @JsonKey(name: 'is_positive') required bool isPositive,
      }) = _DigestScoreBreakdown;

      factory DigestScoreBreakdown.fromJson(Map<String, dynamic> json) =>
          _$DigestScoreBreakdownFromJson(json);
    }
    ```

    2. **DigestRecommendationReason** - Complete reasoning:
    ```dart
    @freezed
    class DigestRecommendationReason with _$DigestRecommendationReason {
      const factory DigestRecommendationReason({
        required String label,
        @JsonKey(name: 'score_total') required double scoreTotal,
        required List<DigestScoreBreakdown> breakdown,
      }) = _DigestRecommendationReason;

      factory DigestRecommendationReason.fromJson(Map<String, dynamic> json) =>
          _$DigestRecommendationReasonFromJson(json);
    }
    ```

    3. **Update DigestItem** - Add optional recommendationReason field:
    ```dart
    @freezed
    class DigestItem with _$DigestItem {
      const factory DigestItem({
        // ... existing fields ...
        @Default('') String reason,  // Keep for backward compatibility
        @JsonKey(name: 'recommendation_reason')
        DigestRecommendationReason? recommendationReason,
      }) = _DigestItem;
      
      factory DigestItem.fromJson(Map<String, dynamic> json) =>
          _$DigestItemFromJson(json);
    }
    ```

    Note: Keep the existing `reason` String field for backward compatibility. Add `recommendationReason` as optional nullable field.
  </action>
  <verify>
    Run: `cd apps/mobile && flutter pub run build_runner build --delete-conflicting-outputs`
    Should complete without errors and generate:
    - digest_models.freezed.dart (updated)
    - digest_models.g.dart (updated)
  </verify>
  <done>
    DigestScoreBreakdown and DigestRecommendationReason classes added
    DigestItem updated with recommendationReason field
    Code generation completes without errors
    All generated files (.freezed.dart, .g.dart) are updated
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DigestPersonalizationSheet Widget</name>
  <files>apps/mobile/lib/features/digest/widgets/digest_personalization_sheet.dart</files>
  <action>
    Create new widget file for the scoring breakdown bottom sheet:

    1. **File:** `apps/mobile/lib/features/digest/widgets/digest_personalization_sheet.dart`

    2. **Structure:**
    ```dart
    import 'package:flutter/material.dart';
    import 'package:phosphor_flutter/phosphor_flutter.dart';
    import '../../../core/theme/facteur_theme.dart';
    import '../models/digest_models.dart';
    
    class DigestPersonalizationSheet extends StatelessWidget {
      final DigestItem item;
      
      const DigestPersonalizationSheet({
        super.key,
        required this.item,
      });
      
      @override
      Widget build(BuildContext context) {
        final colors = context.facteurColors;
        final reason = item.recommendationReason;
        
        if (reason == null) {
          return _buildNoReasonView(context, colors);
        }
        
        return Container(
          padding: const EdgeInsets.only(top: 24, bottom: 40, left: 20, right: 20),
          decoration: BoxDecoration(
            color: colors.backgroundSecondary,
            borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.stretch,
            children: [
              // Header with drag handle
              _buildDragHandle(colors),
              const SizedBox(height: 20),
              
              // Title row with icon and total score
              _buildHeader(context, colors, reason),
              const SizedBox(height: 24),
              
              // Breakdown list
              ...reason.breakdown.map((contribution) => 
                _buildContributionRow(context, colors, contribution)
              ),
              
              // Divider and actions
              if (item.source != null) ...[
                const SizedBox(height: 16),
                Divider(color: colors.border),
                const SizedBox(height: 16),
                _buildActions(context, colors, item),
              ],
            ],
          ),
        );
      }
      
      // Implement helper methods:
      // - _buildDragHandle(): Visual drag handle at top
      // - _buildHeader(): Icon + "Pourquoi cet article?" + score badge
      // - _buildContributionRow(): Icon (trendUp/trendDown) + label + points
      // - _buildActions(): Mute source/theme buttons (reuse PersonalizationSheet pattern)
      // - _buildNoReasonView(): Empty state when no reason available
    }
    ```

    3. **Visual requirements:**
       - Header icon: `PhosphorIcons.question(PhosphorIconsStyle.bold)` in primary color
       - Title: "Pourquoi cet article?" (18px, bold)
       - Score badge: Container with primary background, shows "${scoreTotal.toInt()} pts"
       - Contribution rows: 
         - Icon: `trendUp` (green/success) for positive, `trendDown` (red/error) for negative
         - Label: 15px, textSecondary color
         - Points: Right-aligned, textPrimary, with +/- prefix
       - Use existing FacteurColors, FacteurSpacing, FacteurRadius from theme

    4. **Actions section:**
       - "Moins de [source_name]" button → mute source
       - "Moins sur le thème [theme]" button → mute theme
       - Reuse logic from feed's PersonalizationSheet

    5. **Edge cases:**
       - Handle null recommendationReason gracefully
       - Handle empty breakdown list
       - Handle missing source info
  </action>
  <verify>
    Run: `cd apps/mobile && flutter analyze lib/features/digest/widgets/digest_personalization_sheet.dart`
    Should show: "No issues found!"
  </verify>
  <done>
    DigestPersonalizationSheet widget created with:
    - Header showing title and total score
    - List of contributions with icons and colors
    - Actions for muting source/theme
    - Proper theming using FacteurColors
    - Null safety for missing data
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate Long-Press Handler in DigestBriefingSection</name>
  <files>apps/mobile/lib/features/digest/widgets/digest_briefing_section.dart</files>
  <action>
    Update DigestBriefingSection to show reasoning sheet on long-press:

    1. **Import the new sheet:**
    ```dart
    import 'digest_personalization_sheet.dart';
    ```

    2. **Find the FeedCard usage** in the article builder (likely in _buildArticleCard or similar)

    3. **Wrap FeedCard with GestureDetector** for long-press:
    ```dart
    GestureDetector(
      onTap: () => onItemTap?.call(item),
      onLongPress: () => _showReasoningSheet(context, item),
      child: FeedCard(
        // ... existing props ...
      ),
    )
    ```

    4. **Add _showReasoningSheet method:**
    ```dart
    void _showReasoningSheet(BuildContext context, DigestItem item) {
      // Don't show if no reasoning available
      if (item.recommendationReason == null) return;
      
      showModalBottomSheet(
        context: context,
        backgroundColor: Colors.transparent,
        isScrollControlled: true,  // Allows sheet to expand with content
        builder: (context) => DigestPersonalizationSheet(item: item),
      );
    }
    ```

    5. **Add haptic feedback** on long-press (optional but nice):
    ```dart
    import 'package:flutter/services.dart';
    
    onLongPress: () {
      HapticFeedback.mediumImpact();
      _showReasoningSheet(context, item);
    },
    ```

    6. **Alternative: Add info button** in addition to long-press:
       - Consider adding an info icon button in the card footer
       - Or use the existing "Not Interested" button area
       - Long-press is the primary interaction as per IMPLEMENTATION_PLAN
  </action>
  <verify>
    Run: `cd apps/mobile && flutter analyze lib/features/digest/widgets/digest_briefing_section.dart`
    Should show: "No issues found!"
  </verify>
  <done>
    DigestBriefingSection has onLongPress handler on FeedCard
    Long-press opens DigestPersonalizationSheet
    Haptic feedback triggers on long-press
    Sheet only shows when recommendationReason is available
  </done>
</task>

<task type="auto">
  <name>Task 4: Test Integration and Edge Cases</name>
  <files>apps/mobile/lib/features/digest/screens/digest_screen.dart</files>
  <action>
    Verify end-to-end integration:

    1. **Update DigestScreen** if needed to ensure proper context availability
       - Make sure DigestScreen has access to Scaffold for bottom sheet
       - No changes likely needed if using showModalBottomSheet

    2. **Test scenarios to verify:**
       - Long-press on article with full reasoning → Sheet opens with breakdown
       - Long-press on article without reasoning → Nothing happens (graceful)
       - Check that regular tap (open article) still works
       - Verify sheet closes properly with back button or tap outside

    3. **Visual verification:**
       - Positive contributions show trendUp icon in green
       - Negative contributions show trendDown icon in red
       - Total score badge is prominent in header
       - French labels are properly displayed

    4. **Run code generation** one more time to ensure everything is in sync:
    ```bash
    cd apps/mobile
    flutter pub run build_runner build --delete-conflicting-outputs
    ```

    5. **Final analyze check:**
    ```bash
    flutter analyze
    ```
    Must show: 0 errors, 0 warnings
  </action>
  <verify>
    Run full test suite:
    ```bash
    cd apps/mobile && flutter analyze && echo "✅ ANALYZE PASSED"
    ```
    
    Check for any runtime issues by reviewing:
    - JSON serialization works (no "type 'Null' is not a subtype" errors)
    - Bottom sheet renders without overflow
    - Navigation still works correctly
  </verify>
  <done>
    flutter analyze passes with 0 errors
    Long-press on digest article opens reasoning sheet
    Sheet displays correctly with all scoring contributions
    Regular article tap still works for reading
    No overflow or layout issues
  </done>
</task>

</tasks>

<verification>
1. Manual test: Long-press on digest article → Sheet opens with "Pourquoi cet article?"
2. Verify breakdown items: Should see 4-8 contributions with labels and points
3. Check colors: Positive items green with trendUp, negative red with trendDown
4. Verify total score: Displayed in header badge
5. Test actions: Mute source/theme buttons work (if implemented in Task 2)
6. Edge case: Article without reasoning → Long-press does nothing (no crash)
</verification>

<success_criteria>
- User can long-press any digest article to open "Pourquoi cet article?" sheet
- Sheet shows header with title and total score (e.g., "245 pts")
- Breakdown list displays all scoring contributions with:
  - Label (e.g., "Thème matché : Tech")
  - Points with +/- prefix (e.g., "+70")
  - Trend icon (up for positive, down for negative)
  - Color coding (green for positive, red for negative)
- French labels match backend responses exactly
- Actions section allows muting source/theme (if implemented)
- Backward compatible: Articles without reasoning don't crash
- flutter analyze passes with 0 errors
- Code generation produces valid .freezed.dart and .g.dart files
</success_criteria>

<output>
After completion, create `.planning/phases/02-frontend/02-12-SUMMARY.md`
</output>
