---
phase: 02-frontend
plan: 14
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mobile/lib/features/digest/screens/digest_screen.dart
  - apps/mobile/lib/features/digest/widgets/digest_personalization_sheet.dart
  - apps/mobile/lib/features/digest/widgets/not_interested_confirmation_sheet.dart
  - apps/mobile/lib/features/feed/widgets/personalization_sheet.dart
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "Tapping 'moins voir...' shows unified sheet matching Feed pattern"
    - "Sheet shows 'Pourquoi cet article?' with scoring breakdown"
    - "Sheet includes personalization options at bottom (mute source/theme)"
    - "Design matches Feed PersonalizationSheet exactly"
    - "Code reuses existing PersonalizationSheet or follows same pattern"
  artifacts:
    - path: "apps/mobile/lib/features/digest/screens/digest_screen.dart"
      provides: "Updated _handleNotInterested using unified approach"
    - path: "apps/mobile/lib/features/digest/widgets/digest_personalization_sheet.dart"
      provides: "Either removed or aligned with Feed pattern"
  key_links:
    - from: "digest_screen.dart"
      to: "PersonalizationSheet pattern"
      pattern: "Unified sheet with scoring + personalization actions"
---

<objective>
Align Digest personalization UI with Feed personalization to have ONE consistent system across the platform.

Purpose: The current Digest has separate confirmation + personalization sheets, creating unnecessary complexity and UX inconsistency. The Feed already has the perfect pattern ("Pourquoi cet article?" with scoring + mute options). We need to adapt Digest to use the same unified approach.

Output: Digest "moins voir..." action shows the same unified sheet as Feed, with scoring breakdown and personalization options combined.
</objective>

<execution_context>
@/Users/laurinboujon/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@apps/mobile/lib/features/feed/widgets/personalization_sheet.dart
@apps/mobile/lib/features/digest/screens/digest_screen.dart
@apps/mobile/lib/features/digest/widgets/digest_personalization_sheet.dart
@apps/mobile/lib/features/digest/widgets/not_interested_confirmation_sheet.dart

## Current State

### Feed PersonalizationSheet (Target Pattern)
- Title: "Pourquoi cet article ?" with question icon
- Score badge: "135 pts" in top right
- Breakdown list: Theme (+70), Source confiance (+40), etc. with trend icons
- Divider
- "PERSONNALISER MON FLUX" section
- Actions: "Moins de [Source]", "Moins sur le thème [Theme]"

### Current Digest (Problem)
- Separate `NotInterestedConfirmationSheet`: Simple confirmation "Masquer cet article ?"
- Separate `DigestPersonalizationSheet`: Complex separate implementation
- Two-step UX: Confirm first, then see personalization options

### What User Wants
Digest should show the SAME unified sheet as Feed when tapping "moins voir...":
- Show scoring breakdown ("Pourquoi cet article?")
- Include personalization options at bottom
- One sheet, not two
- Consistent with Feed pattern

## Architecture Decision

**Option A (Preferred):** Extend/adapt existing `PersonalizationSheet` to work with Digest items
- Pros: Maximum code reuse, single source of truth
- Cons: May need abstraction for Content vs DigestItem

**Option B:** Create unified `DigestPersonalizationSheet` that matches Feed pattern exactly
- Pros: Clear separation, easy to implement
- Cons: Some code duplication

**Recommendation:** Option B for now - create a unified Digest sheet that visually matches Feed PersonalizationSheet, then optionally refactor to share code later.

## Implementation Notes

The Digest already has scoring data available (from 02-11 backend changes):
- `DigestItem.recommendationReason` contains breakdown
- Can reuse same visual pattern as Feed

When user taps "moins voir...":
1. Apply the not_interested action immediately (like Feed does)
2. Show unified sheet with:
   - Scoring breakdown (why article was selected)
   - Personalization options (mute source/theme)
</context>

<tasks>

<task type="auto">
  <name>Remove separate confirmation flow and create unified Digest personalization</name>
  <files>
    apps/mobile/lib/features/digest/screens/digest_screen.dart
    apps/mobile/lib/features/digest/widgets/not_interested_confirmation_sheet.dart
    apps/mobile/lib/features/digest/widgets/digest_personalization_sheet.dart
  </files>
  <action>
    Simplify Digest personalization to match Feed pattern:

    1. **Remove NotInterestedConfirmationSheet entirely:**
       - Delete the file `not_interested_confirmation_sheet.dart`
       - Remove its import from digest_screen.dart

    2. **Simplify DigestPersonalizationSheet to match Feed pattern:**
       - Modify to show unified "Pourquoi cet article?" sheet
       - Include scoring breakdown at top (like Feed)
       - Include personalization actions at bottom (like Feed)
       - Remove separate confirmation step
       - Match visual design exactly:
         * Title: "Pourquoi cet article ?" with PhosphorIcons.question
         * Score badge: "{total} pts" in colored container
         * Breakdown list with trendUp/trendDown icons
         * "PERSONNALISER MON FLUX" header
         * Action items with eyeSlash icons

    3. **Update _handleNotInterested:**
       - Apply action immediately (no confirmation)
       - Show unified DigestPersonalizationSheet
       - Sheet combines scoring transparency + personalization options

    New flow:
    ```dart
    void _handleNotInterested(DigestItem item) {
      HapticFeedback.lightImpact();
      
      // Apply action immediately
      ref.read(digestProvider.notifier).applyAction(
        item.contentId,
        'not_interested',
      );
      
      // Show unified sheet (scoring + personalization)
      showModalBottomSheet<void>(
        context: context,
        backgroundColor: Colors.transparent,
        isScrollControlled: true,
        builder: (_) => DigestPersonalizationSheet(item: item),
      );
    }
    ```

    4. **Update DigestPersonalizationSheet structure:**
       - Header: Question icon + "Pourquoi cet article?" + score badge
       - Body: Breakdown items with trend icons (reuse from Feed pattern)
       - Divider
       - Actions section: "PERSONNALISER MON FLUX"
       - Action: "Moins de {source.name}" → mutes source
       - Action: "Moins sur le thème {theme}" → mutes theme (if available)

    5. **Use digestProvider for personalization actions** (like Feed uses feedProvider)
  </action>
  <verify>
    - not_interested_confirmation_sheet.dart deleted
    - DigestPersonalizationSheet shows unified sheet matching Feed pattern
    - _handleNotInterested applies action immediately and shows unified sheet
    - flutter analyze passes with 0 errors
  </verify>
  <done>
    Digest personalization aligned with Feed: unified sheet with scoring + personalization
  </done>
</task>

<task type="auto">
  <name>Test and verify Feed pattern match</name>
  <files>apps/mobile/lib/features/digest/widgets/digest_personalization_sheet.dart</files>
  <action>
    Verify the Digest sheet visually matches Feed PersonalizationSheet:

    1. Compare side-by-side with Feed's personalization_sheet.dart:
       - Same padding (top: 24, bottom: 40, horizontal: 20)
       - Same border radius (20px top)
       - Same background color (backgroundSecondary)
       - Same icon sizes and colors
       - Same text styles (font sizes, weights, colors)
       - Same layout structure

    2. Test data flow:
       - Scoring breakdown displays correctly
       - Personalization actions work
       - Source name displays correctly
       - Theme/topic muting works (if applicable)

    3. Run flutter analyze to ensure no errors
  </action>
  <verify>
    - Visual comparison shows matching design
    - All actions functional
    - flutter analyze passes
  </verify>
  <done>
    Digest sheet visually matches Feed sheet, all functionality working
  </done>
</task>

</tasks>

<verification>
- NotInterestedConfirmationSheet removed
- DigestPersonalizationSheet unified (scoring + personalization in one sheet)
- Design matches Feed PersonalizationSheet exactly
- _handleNotInterested applies action immediately, no confirmation step
- flutter analyze passes with 0 errors
</verification>

<success_criteria>
- Tapping "moins voir..." shows unified "Pourquoi cet article?" sheet
- Sheet includes scoring breakdown (total points, contributions)
- Sheet includes personalization options (mute source/theme)
- Visual design matches Feed PersonalizationSheet
- No separate confirmation step
- Code is simpler, not more complex
</success_criteria>

<output>
After completion, create `.planning/phases/02-frontend/02-14-SUMMARY.md`
</output>
