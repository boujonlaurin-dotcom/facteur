---
phase: 02-frontend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mobile/lib/features/digest/screens/digest_screen.dart
  - apps/mobile/lib/features/digest/widgets/digest_card.dart
  - apps/mobile/lib/features/digest/widgets/progress_bar.dart
  - apps/mobile/lib/features/digest/models/digest_models.dart
  - apps/mobile/lib/features/digest/providers/digest_provider.dart
  - apps/mobile/lib/features/digest/repositories/digest_repository.dart
  - apps/mobile/lib/config/routes.dart
autonomous: true
must_haves:
  truths:
    - "User sees 5 article cards when opening digest screen"
    - "Progress bar shows X/5 articles processed"
    - "Digest cards display article title, thumbnail, source, and selection reason"
    - "Cards match existing FeedCard visual design"
    - "Screen loads digest from /api/digest endpoint"
  artifacts:
    - path: "apps/mobile/lib/features/digest/screens/digest_screen.dart"
      provides: "Main digest screen with list of 5 articles"
      exports: ["DigestScreen"]
    - path: "apps/mobile/lib/features/digest/widgets/digest_card.dart"
      provides: "Digest article card (adapted from FeedCard)"
      exports: ["DigestCard"]
    - path: "apps/mobile/lib/features/digest/widgets/progress_bar.dart"
      provides: "Progress indicator X/5"
      exports: ["ProgressBar"]
    - path: "apps/mobile/lib/features/digest/models/digest_models.dart"
      provides: "Freezed models for Digest API response"
      exports: ["DigestResponse", "DigestItem"]
    - path: "apps/mobile/lib/features/digest/providers/digest_provider.dart"
      provides: "Riverpod state management for digest"
      exports: ["digestProvider"]
    - path: "apps/mobile/lib/features/digest/repositories/digest_repository.dart"
      provides: "API client for /api/digest endpoint"
      exports: ["DigestRepository"]
  key_links:
    - from: "digest_screen.dart"
      to: "digest_provider.dart"
      via: "Riverpod ref.watch(digestProvider)"
      pattern: "ref\\.watch\\(digestProvider"
    - from: "digest_provider.dart"
      to: "digest_repository.dart"
      via: "DigestRepository.getDigest()"
      pattern: "DigestRepository"
    - from: "digest_repository.dart"
      to: "/api/digest"
      via: "dio.get('/digest')"
      pattern: "get\\('/digest'"
    - from: "digest_card.dart"
      to: "digest_screen.dart"
      via: "ListView.builder itemBuilder"
      pattern: "DigestCard\\("
---

<objective>
Create the main digest screen with 5 article cards and a progress bar.

Purpose: This is the entry point for the digest-first experience. Users must immediately see their 5 curated articles with clear progress indication.

Output: Complete digest screen implementation with reusable components, Riverpod state management, and API integration.
</objective>

<execution_context>
@/Users/laurinboujon/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/laurinboujon/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-03-SUMMARY.md

**Existing UI patterns to reuse (MANDATORY):**

From apps/mobile/lib/features/feed/widgets/feed_card.dart:
- FacteurCard wrapper with padding, borderRadius
- Thumbnail with CachedNetworkImage (16:9 aspect ratio)
- Title styling (displaySmall, 20px, fontWeight.w700)
- Source display with logo + name pattern
- Content type icon pattern (video = PhosphorIcons.filmStrip)
- Footer with backgroundSecondary and top border

From apps/mobile/lib/config/theme.dart:
- FacteurColors (primary, backgroundSecondary, textPrimary, textSecondary, success)
- FacteurSpacing.space1, space2, space3, space4, space6
- FacteurRadius.small

**API Schema (from packages/api/app/schemas/digest.py):**

DigestItem fields:
- content_id: UUID
- title: str
- url: str
- thumbnail_url: Optional[str]
- description: Optional[str]
- content_type: ContentType enum
- duration_seconds: Optional[int]
- published_at: datetime
- source: SourceMini (name, logo_url, theme)
- rank: int (1-5)
- reason: str (selection reason text)
- is_read: bool
- is_saved: bool
- is_dismissed: bool

DigestResponse fields:
- digest_id: UUID
- user_id: UUID
- target_date: date
- generated_at: datetime
- items: List[DigestItem] (always 5)
- is_completed: bool
- completed_at: Optional[datetime]

**Navigation:**
Add new route to apps/mobile/lib/config/routes.dart:
- RouteNames.digest = 'digest'
- RoutePaths.digest = '/digest'
- Add GoRoute in ShellRoute before Feed

**Dependencies met:**
- Phase 1 complete: API endpoints at /api/digest ready
- FeedCard pattern exists for visual reference
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create digest models (Freezed)</name>
  <files>apps/mobile/lib/features/digest/models/digest_models.dart</files>
  <action>
Create Freezed models matching the API schemas exactly:

1. Create digest_models.dart with:
   - @freezed class DigestResponse
   - @freezed class DigestItem
   - ContentType enum (reuse from content_model.dart or define locally)
   - SourceMini model for nested source data
   - JSON serialization with @JsonSerializable

2. Fields must match API exactly:
   - All UUIDs as String
   - Datetimes as DateTime
   - Enums with @JsonKey
   - Optional fields marked with ?

3. Add toJson/fromJson methods for API serialization

Use same patterns as apps/mobile/lib/features/feed/models/content_model.dart
  </action>
  <verify>flutter analyze --no-fatal-infos | grep -v "info" | wc -l returns 0 errors</verify>
  <done>Digest models compile without errors and match API schema fields</done>
</task>

<task type="auto">
  <name>Task 2: Create digest repository</name>
  <files>apps/mobile/lib/features/digest/repositories/digest_repository.dart</files>
  <action>
Create repository for /api/digest API calls:

1. Create digest_repository.dart with:
   - class DigestRepository
   - Constructor taking Dio client
   - Method: Future<DigestResponse> getDigest({DateTime? targetDate})
   - Method: Future<DigestResponse> getDigestById(String digestId)

2. API call pattern:
   - GET /api/digest (with optional ?target_date= param)
   - Parse response into DigestResponse model
   - Handle 404 (no digest yet), 503 (generation failed)
   - Throw appropriate exceptions

3. Reuse patterns from:
   - apps/mobile/lib/features/feed/repositories/feed_repository.dart
   - apps/mobile/lib/core/api/api_client.dart for Dio instance

4. Add error handling with try/catch and rethrow as domain exceptions
  </action>
  <verify>Repository has no analysis errors and follows feed_repository patterns</verify>
  <done>Repository can fetch digest from API and return typed DigestResponse</done>
</task>

<task type="auto">
  <name>Task 3: Create digest Riverpod provider</name>
  <files>apps/mobile/lib/features/digest/providers/digest_provider.dart</files>
  <action>
Create Riverpod state management for digest:

1. Create digest_provider.dart with:
   - @riverpod class DigestNotifier extends _$DigestNotifier
   - State type: AsyncValue&lt;DigestResponse&gt;
   - Method: Future<void> loadDigest({DateTime? date})
   - Method: void updateItemAction(String contentId, String action)
   - Method: Future<void> refreshDigest()

2. Provider should:
   - Use DigestRepository via ref.watch
   - Cache digest data in state
   - Provide computed properties (processedCount, progress)
   - Handle loading, error, and data states

3. Reuse patterns from:
   - apps/mobile/lib/features/feed/providers/feed_provider.dart
   - Use AsyncValue.guard for async operations

4. Export provider and notifier for use in UI
  </action>
  <verify>Provider generates .g.dart file without errors (flutter pub run build_runner build)</verify>
  <done>Riverpod provider loads digest and manages state correctly</done>
</task>

<task type="auto">
  <name>Task 4: Create progress bar widget</name>
  <files>apps/mobile/lib/features/digest/widgets/progress_bar.dart</files>
  <action>
Create ProgressBar widget showing X/5 progress:

1. Create progress_bar.dart with:
   - class ProgressBar extends StatelessWidget
   - Parameters: int processedCount, int totalCount (default 5)
   - Visual: horizontal bar with filled/unfilled segments

2. Design requirements:
   - Height: 4px
   - Filled color: colors.primary
   - Unfilled color: colors.backgroundSecondary
   - 5 segments representing articles
   - Show "X/5" text on right side
   - Use existing color tokens from theme

3. Animation:
   - AnimatedContainer for smooth progress changes
   - Duration: 300ms
   - Curve: Curves.easeInOut

4. Make it reusable - no business logic, just presentation
  </action>
  <verify>ProgressBar renders correctly in widget tests or preview</verify>
  <done>Progress bar displays 5 segments with animated fill based on count</done>
</task>

<task type="auto">
  <name>Task 5: Create digest card widget</name>
  <files>apps/mobile/lib/features/digest/widgets/digest_card.dart</files>
  <action>
Create DigestCard widget adapted from FeedCard:

1. Create digest_card.dart with:
   - class DigestCard extends StatelessWidget
   - Parameters: DigestItem item, VoidCallback? onTap, VoidCallback? onAction
   - Reuse visual patterns from FeedCard

2. Visual design (REUSE EXACTLY from FeedCard):
   - FacteurCard wrapper
   - Thumbnail with 16:9 aspect ratio using CachedNetworkImage
   - Title: displaySmall style, 20px, maxLines: 2
   - Source row: logo (16x16) + name + recency
   - Reason badge showing selection reason text
   - Footer with backgroundSecondary background

3. Add rank indicator (1-5):
   - Small badge showing "1", "2", etc.
   - Position: top-left of card
   - Style: primary color background, white text

4. Action states:
   - Dim card if is_read or is_dismissed (opacity 0.6)
   - Show "Lu" or "Masqu√©" badge if processed
   - Same patterns as FeedCard's "Lu" badge

5. Do NOT add action buttons here - those go in separate plan (02-02)
  </action>
  <verify>DigestCard visually matches FeedCard with rank badge and reason display</verify>
  <done>Digest card reuses FeedCard patterns with rank indicator and selection reason</done>
</task>

<task type="auto">
  <name>Task 6: Create digest screen</name>
  <files>apps/mobile/lib/features/digest/screens/digest_screen.dart</files>
  <action>
Create main DigestScreen with list of 5 cards:

1. Create digest_screen.dart with:
   - class DigestScreen extends ConsumerWidget
   - App bar: "Votre Essentiel" + ProgressBar
   - Body: ListView with 5 DigestCard items
   - Bottom: subtle hint text about completion

2. App bar design:
   - Title: "Votre Essentiel" (use Fraunces font family)
   - Leading: StreakIndicator (existing widget)
   - Bottom: PreferredSize with ProgressBar
   - Background: colors.backgroundPrimary

3. List implementation:
   - ConsumerWidget watching digestProvider
   - Handle AsyncValue states: loading, error, data
   - ListView.separated with space3 padding
   - 5 cards with space3 between each

4. Empty/error states:
   - Loading: show shimmer or circular indicator
   - Error: display error with retry button
   - Empty: show message (should never happen - always 5 items)

5. Navigation handling:
   - onTap card: navigate to content detail (reuse existing route)
   - Pass content data via extra parameter
   - Use existing ContentDetailScreen route

6. Integration:
   - Use ref.watch(digestProvider) to get digest
   - Call ref.read(digestProvider.notifier).loadDigest() on init
   - Show refresh indicator on pull-to-refresh
  </action>
  <verify>Screen displays 5 cards and progress bar when loaded</verify>
  <done>Digest screen loads and displays 5 articles with progress indicator</done>
</task>

<task type="auto">
  <name>Task 7: Add digest route to navigation</name>
  <files>apps/mobile/lib/config/routes.dart</files>
  <action>
Add digest route to existing router configuration:

1. Update RouteNames class:
   - Add: static const String digest = 'digest'

2. Update RoutePaths class:
   - Add: static const String digest = '/digest'

3. Add GoRoute in ShellRoute (after onboarding conclusion):
   ```dart
   GoRoute(
     path: RoutePaths.digest,
     name: RouteNames.digest,
     builder: (context, state) => const DigestScreen(),
   ),
   ```

4. Update redirect logic:
   - After onboarding complete, redirect to digest (not feed)
   - Find: context.go('${RoutePaths.feed}?welcome=true')
   - Change to: context.go(RoutePaths.digest)
   - Or add query param: context.go('${RoutePaths.digest}?first=true')

5. Make digest the default authenticated route:
   - Update redirect logic for authenticated users
   - If no specific route, go to digest instead of feed
   - Keep feed as fallback for deep links

6. Import DigestScreen at top of file
  </action>
  <verify>Router has no analysis errors and digest route is registered</verify>
  <done>Digest screen accessible at /digest and becomes default authenticated route</done>
</task>

</tasks>

<verification>
1. Run `flutter analyze` - must pass with 0 errors
2. Run `flutter pub run build_runner build` - must generate providers without errors
3. Build app and navigate to /digest - must show 5 article cards
4. Progress bar shows correct X/5 count
5. Cards visually match FeedCard patterns
6. Screen loads data from /api/digest endpoint
</verification>

<success_criteria>
- User sees 5 article cards when opening digest screen
- Progress bar displays X/5 articles processed
- Each card shows title, thumbnail, source, and selection reason
- Visual design matches existing FeedCard exactly
- Screen loads digest data from /api/digest API
- Route registered at /digest and accessible
</success_criteria>

<output>
After completion, create `.planning/phases/02-frontend/02-01-SUMMARY.md`
</output>
