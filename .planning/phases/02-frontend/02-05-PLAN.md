---
phase: 02-frontend
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mobile/lib/features/digest/screens/digest_screen.dart
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "App no longer crashes after login"
    - "Digest screen loads successfully and displays 5 articles"
    - "First-time welcome check works correctly on app startup"
  artifacts:
    - path: "apps/mobile/lib/features/digest/screens/digest_screen.dart"
      provides: "Fixed Flutter lifecycle - _checkFirstTimeWelcome() called safely"
      min_lines: 1
  key_links:
    - from: "digest_screen.dart initState()"
      to: "didChangeDependencies() or addPostFrameCallback"
      via: "lifecycle method fix"
      pattern: "didChangeDependencies|addPostFrameCallback"
---

<objective>
Fix the critical Flutter lifecycle issue causing app crashes after login.

Purpose: The `_checkFirstTimeWelcome()` method is being called from `initState()` but it accesses `GoRouterState.of(context).uri` which requires a mounted context. This violates Flutter's widget lifecycle rules and causes the app to crash immediately after login.

Output: Fixed lifecycle implementation that safely calls `_checkFirstTimeWelcome()` after the widget is mounted, allowing the digest screen to load and display articles.
</objective>

<execution_context>
@/Users/laurinboujon/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/phases/02-frontend/02-frontend-UAT.md

## Gap Being Fixed

**Truth:** "Digest screen loads and displays 5 articles with progress bar"  
**Status:** Failed - Blocker  
**Root Cause:** GoRouterState.of(context) called in initState() before widget mounted

**Problem Location:**
- File: `apps/mobile/lib/features/digest/screens/digest_screen.dart`
- Line: 36
- Issue: `_checkFirstTimeWelcome()` called from `initState()` uses `GoRouterState.of(context).uri`

**Required Fix:**
Move `_checkFirstTimeWelcome()` call from `initState()` to `didChangeDependencies()` or wrap in `WidgetsBinding.instance.addPostFrameCallback()`

## Lifecycle Context

In Flutter:
- `initState()`: Called once when widget is inserted into tree. Context is NOT yet available for InheritedWidget lookups like `GoRouterState.of(context)`.
- `didChangeDependencies()`: Called after initState when InheritedWidgets have been established. Context IS available here.
- `addPostFrameCallback()`: Schedules code to run after the current frame completes, when widget is fully mounted.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Flutter Lifecycle Issue in DigestScreen</name>
  <files>apps/mobile/lib/features/digest/screens/digest_screen.dart</files>
  <action>
Read the current implementation of DigestScreen, specifically:
1. The `initState()` method around line 36
2. The `_checkFirstTimeWelcome()` method implementation
3. How it uses `GoRouterState.of(context).uri`

Fix the lifecycle violation by moving the `_checkFirstTimeWelcome()` call from `initState()` to `didChangeDependencies()`:

1. Remove or comment out the `_checkFirstTimeWelcome()` call from `initState()`
2. Add an override for `didChangeDependencies()` if not already present
3. Move the `_checkFirstTimeWelcome()` call to `didChangeDependencies()`
4. Add a flag `_hasCheckedWelcome` to ensure the check only runs once (preventing multiple dialogs)

Implementation pattern:
```dart
bool _hasCheckedWelcome = false;

@override
void didChangeDependencies() {
  super.didChangeDependencies();
  if (!_hasCheckedWelcome) {
    _hasCheckedWelcome = true;
    _checkFirstTimeWelcome();
  }
}
```

Alternative (if didChangeDependencies already has logic):
Use `WidgetsBinding.instance.addPostFrameCallback()` in `initState()` instead:
```dart
@override
void initState() {
  super.initState();
  WidgetsBinding.instance.addPostFrameCallback((_) {
    _checkFirstTimeWelcome();
  });
}
```

Choose the approach that fits best with existing code structure.
  </action>
  <verify>
1. Run `flutter analyze` in apps/mobile directory - should show no errors related to digest_screen.dart
2. Verify the file compiles without errors
3. Check that `GoRouterState.of(context)` is no longer called in initState
  </verify>
  <done>
- `_checkFirstTimeWelcome()` is no longer called directly from `initState()`
- Either moved to `didChangeDependencies()` or wrapped in `addPostFrameCallback()`
- First-time welcome check only runs once (flag prevents re-execution)
- `flutter analyze` passes with no errors for digest_screen.dart
  </done>
</task>

</tasks>

<verification>
## Automated Verification

1. **Static Analysis:**
   ```bash
   cd apps/mobile && flutter analyze lib/features/digest/screens/digest_screen.dart
   ```
   Expected: No errors or warnings

2. **Compilation Check:**
   ```bash
   cd apps/mobile && flutter build apk --debug --target lib/main.dart 2>&1 | head -50
   ```
   Expected: Build completes without errors related to digest_screen.dart

## Manual Verification (to perform after automated fix)

1. Launch the app in debug mode
2. Log in with a test account
3. **Verify:** App does NOT crash after login
4. **Verify:** Digest screen loads and displays the "Votre Essentiel" title
5. **Verify:** Progress bar is visible at top
6. **Verify:** Article cards are displayed (or loading state if no articles)

## Success Indicators

- ✅ No crash after login
- ✅ Digest screen renders successfully
- ✅ First-time welcome modal appears (for new users) or skips (for returning users)
- ✅ 5 article slots are visible with progress indicator
</verification>

<success_criteria>
1. `flutter analyze` passes for digest_screen.dart with no errors
2. App launches without crashing after login
3. Digest screen loads and displays UI elements (title, progress bar, article list area)
4. First-time welcome check logic remains functional (runs once on app startup)
</success_criteria>

<output>
After completion, create `.planning/phases/02-frontend/02-05-SUMMARY.md`

**Summary Format:**
- Changes made to digest_screen.dart
- Verification results from flutter analyze
- Link to updated UAT.md when test 1 passes
</output>
