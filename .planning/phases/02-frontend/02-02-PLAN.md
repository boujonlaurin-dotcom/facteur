---
phase: 02-frontend
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/mobile/lib/features/digest/widgets/article_action_bar.dart
  - apps/mobile/lib/features/digest/widgets/not_interested_sheet.dart
  - apps/mobile/lib/features/digest/repositories/digest_repository.dart
  - apps/mobile/lib/features/digest/providers/digest_provider.dart
  - apps/mobile/lib/features/digest/screens/digest_screen.dart
  - apps/mobile/lib/features/feed/repositories/personalization_repository.dart
  - apps/mobile/lib/core/ui/notification_service.dart
autonomous: true
must_haves:
  truths:
    - "Each digest card has 3 action buttons: Read, Save, Not Interested"
    - "Read action marks article as consumed and updates streak"
    - "Save action bookmarks article for later"
    - "Not Interested triggers source mute via Personalization"
    - "Actions have immediate visual feedback (button state change)"
    - "Card opacity changes when article is processed"
  artifacts:
    - path: "apps/mobile/lib/features/digest/widgets/article_action_bar.dart"
      provides: "3-action button bar for digest cards"
      exports: ["ArticleActionBar"]
    - path: "apps/mobile/lib/features/digest/widgets/not_interested_sheet.dart"
      provides: "Bottom sheet for not_interested confirmation"
      exports: ["NotInterestedSheet"]
  key_links:
    - from: "article_action_bar.dart"
      to: "digest_provider.dart"
      via: "onAction callback -> applyAction()"
      pattern: "ref\\.read\\(digestProvider\\.notifier\\)\\.applyAction"
    - from: "digest_repository.dart"
      to: "/api/digest/{id}/action"
      via: "POST request"
      pattern: "post\\('/digest.*action'"
    - from: "not_interested_sheet.dart"
      to: "personalization_repository.dart"
      via: "muteSource() call"
      pattern: "PersonalizationRepository"
---

<objective>
Implement article action buttons (Read/Save/Not Interested) with full API integration and Personalization system wiring.

Purpose: Enable users to interact with each article, track their progress, and personalize their experience through the digest flow.

Output: Complete action system with visual feedback, API calls, and Personalization integration for the "not_interested" action.
</objective>

<execution_context>
@/Users/laurinboujon/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/laurinboujon/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-03-SUMMARY.md

**API Endpoints (from Phase 1):**

POST /api/digest/{digest_id}/action
Request body:
{
  "content_id": "uuid",
  "action": "read" | "save" | "not_interested" | "undo"
}

Response: DigestActionResponse
{
  "success": true,
  "content_id": "uuid",
  "action": "read",
  "applied_at": "2026-01-01T...",
  "message": "Article marqué comme lu"
}

**Existing patterns to reuse:**

From apps/mobile/lib/features/feed/widgets/personalization_sheet.dart:
- Mute source pattern: ref.read(feedProvider.notifier).muteSource(content)
- Mute theme pattern: ref.read(feedProvider.notifier).muteTheme(theme)
- Notification pattern: NotificationService.showInfo/showError
- Bottom sheet UI pattern with rounded top corners

From apps/mobile/lib/shared/widgets/buttons/:
- PrimaryButton, SecondaryButton, GhostButton patterns
- Button sizing and padding conventions

From apps/mobile/lib/config/theme.dart:
- Button styles and color tokens
- PhosphorIcons for iconography

**Existing action states model:**
DigestItem has boolean flags:
- is_read: true/false
- is_saved: true/false  
- is_dismissed: true/false

**Personalization integration:**
When user taps "Not Interested":
1. Show confirmation sheet explaining what happens
2. On confirm, call /api/digest/{id}/action with action="not_interested"
3. Backend automatically mutes the source via Personalization system
4. Show success notification

**UI Design for action bar:**
- Position: bottom of each DigestCard
- Layout: Row with 3 buttons
- Button styles:
  - Read: Ghost button, PhosphorIcons.check
  - Save: Ghost button, PhosphorIcons.bookmark
  - Not Interested: Ghost button, PhosphorIcons.eyeSlash
- Active state: Primary color background, white text
- Default state: Transparent background, textSecondary text
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add action methods to digest repository</name>
  <files>apps/mobile/lib/features/digest/repositories/digest_repository.dart</files>
  <action>
Extend digest_repository.dart with action endpoints:

1. Add methods to DigestRepository class:
   ```dart
   Future&lt;DigestActionResponse&gt; applyAction({
     required String digestId,
     required String contentId,
     required String action, // 'read', 'save', 'not_interested', 'undo'
   })
   
   Future&lt;DigestCompletionResponse&gt; completeDigest(String digestId)
   ```

2. Implement applyAction:
   - POST /api/digest/{digestId}/action
   - Body: {content_id, action}
   - Return parsed DigestActionResponse
   - Handle errors and throw domain exceptions

3. Implement completeDigest:
   - POST /api/digest/{digestId}/complete
   - Return parsed DigestCompletionResponse
   - Extract streak info from response

4. Reuse patterns from:
   - apps/mobile/lib/features/feed/repositories/feed_repository.dart
   - Use same error handling patterns
   - Same Dio client usage via constructor
  </action>
  <verify>Repository methods have no analysis errors and follow existing patterns</verify>
  <done>Repository has applyAction and completeDigest methods ready for use</done>
</task>

<task type="auto">
  <name>Task 2: Add action state management to provider</name>
  <files>apps/mobile/lib/features/digest/providers/digest_provider.dart</files>
  <action>
Extend digest_provider.dart with action handling:

1. Add action methods to DigestNotifier:
   ```dart
   Future&lt;void&gt; applyAction(String contentId, String action)
   Future&lt;void&gt; completeDigest()
   Future&lt;void&gt; undoAction(String contentId)
   ```

2. Implement applyAction logic:
   - Optimistically update local state first (for instant feedback)
   - Call repository.applyAction()
   - Update DigestItem in state (is_read, is_saved, is_dismissed)
   - Show notification on success via NotificationService
   - Show error and rollback on failure

3. Track processed count:
   - Computed property: int get processedCount
   - Count items where is_read || is_dismissed
   - Use for progress bar and completion detection

4. Add completion detection:
   - When all 5 items processed (is_read or is_dismissed)
   - Auto-trigger completeDigest() or set isCompletePending flag
   - Navigate to closure screen (handled in UI layer)

5. Use AsyncValue.guard for async operations
   - Keep existing digest data while loading
   - Only update state on success
  </action>
  <verify>Provider generates .g.dart without errors and methods are accessible</verify>
  <done>Provider handles all 4 action types with optimistic updates and completion tracking</done>
</task>

<task type="auto">
  <name>Task 3: Create article action bar widget</name>
  <files>apps/mobile/lib/features/digest/widgets/article_action_bar.dart</files>
  <action>
Create 3-button action bar for digest cards:

1. Create article_action_bar.dart with:
   ```dart
   class ArticleActionBar extends StatelessWidget {
     final DigestItem item;
     final ValueChanged&lt;String&gt; onAction;
     
     const ArticleActionBar({
       required this.item,
       required this.onAction,
     });
   }
   ```

2. Button layout:
   - Row with 3 Expanded buttons
   - Spacing: space2 between buttons
   - Height: 40px
   - BorderRadius: small radius

3. Button styles (all Ghost/secondary style):
   - Read button:
     - Icon: PhosphorIcons.check()
     - Label: "Lu"
     - Active: background = colors.success, icon/text = white
     - Inactive: transparent background, textSecondary colors
   
   - Save button:
     - Icon: PhosphorIcons.bookmark()
     - Label: "Sauver"
     - Active: background = colors.primary, icon/text = white
     - Inactive: transparent background, textSecondary colors
   
   - Not Interested button:
     - Icon: PhosphorIcons.eyeSlash()
     - Label: "Pas pour moi"
     - Active: background = colors.textSecondary, icon/text = white
     - Inactive: transparent background, textSecondary colors

4. Animation:
   - AnimatedContainer for state changes
   - Duration: 200ms
   - Scale effect on tap (InkWell)

5. Callback behavior:
   - onTap: call onAction with action name
   - Prevent multiple rapid taps (debounce or loading state)
  </action>
  <verify>Action bar renders with 3 buttons and responds to taps</verify>
  <done>Action bar shows 3 buttons with visual state changes based on item flags</done>
</task>

<task type="auto">
  <name>Task 4: Create not interested confirmation sheet</name>
  <files>apps/mobile/lib/features/digest/widgets/not_interested_sheet.dart</files>
  <action>
Create bottom sheet for not_interested confirmation:

1. Create not_interested_sheet.dart with:
   ```dart
   class NotInterestedSheet extends StatelessWidget {
     final DigestItem item;
     final VoidCallback onConfirm;
     final VoidCallback onCancel;
   }
   ```

2. Sheet design (reuse personalization_sheet.dart patterns):
   - Container with rounded top corners (radius 20)
   - Background: colors.backgroundSecondary
   - Padding: top 24, horizontal 20, bottom 40

3. Content:
   - Icon: PhosphorIcons.eyeSlash(bold) in colors.textSecondary
   - Title: "Masquer ce type de contenu ?"
   - Description: "${item.source.name} sera temporairement moins visible dans votre flux."
   - Source logo + name display
   - Primary button: "Confirmer" (colors.primary)
   - Secondary button: "Annuler" (ghost style)

4. Behavior:
   - Show via showModalBottomSheet
   - isScrollControlled: true
   - UseDraggable: false (fixed height)
   - Dismiss on background tap = cancel

5. Reuse notification patterns:
   - On confirm: show "Source masquée" via NotificationService
   - On error: show error message
  </action>
  <verify>Sheet opens and closes correctly, confirms action on button tap</verify>
  <done>Bottom sheet provides confirmation before muting source</done>
</task>

<task type="auto">
  <name>Task 5: Integrate action bar into digest card</name>
  <files>apps/mobile/lib/features/digest/widgets/digest_card.dart</files>
  <action>
Update DigestCard to include ArticleActionBar:

1. Modify DigestCard constructor:
   ```dart
   const DigestCard({
     required this.item,
     this.onTap,
     this.onAction, // Add this callback
   });
   ```

2. Add action bar to card layout:
   - Position: after footer (source row)
   - Container with top border (divider style)
   - Background: same as footer (backgroundSecondary with 0.5 alpha)
   - Padding: horizontal space3, vertical space2

3. Wire up callbacks:
   - Pass onAction to ArticleActionBar
   - Handle action in parent (DigestScreen)

4. Special handling for "not_interested":
   - Don't call onAction directly
   - Show NotInterestedSheet first
   - Only apply action on user confirmation

5. Visual feedback:
   - Card opacity 0.6 if is_read or is_dismissed
   - Add "Lu" or "Masqué" badge when processed
   - Use same badge style as FeedCard's "Lu" badge
  </action>
  <verify>Digest card shows action bar and responds to all 3 actions</verify>
  <done>Digest card integrates action bar with proper state handling</done>
</task>

<task type="auto">
  <name>Task 6: Wire actions in digest screen</name>
  <files>apps/mobile/lib/features/digest/screens/digest_screen.dart</files>
  <action>
Update DigestScreen to handle action callbacks:

1. Modify itemBuilder in ListView:
   ```dart
   DigestCard(
     item: items[index],
     onTap: () => _openDetail(items[index]),
     onAction: (action) => _handleAction(items[index], action),
   )
   ```

2. Implement _handleAction method:
   ```dart
   void _handleAction(DigestItem item, String action) {
     if (action == 'not_interested') {
       _showNotInterestedSheet(item);
     } else {
       ref.read(digestProvider.notifier).applyAction(item.contentId, action);
     }
   }
   ```

3. Implement _showNotInterestedSheet:
   - Show modal bottom sheet with NotInterestedSheet
   - On confirm: apply not_interested action
   - On cancel: do nothing

4. Add completion detection:
   - Listen to digestProvider in build method
   - When all 5 items processed AND not already completed
   - Trigger completion API call
   - Navigate to closure screen

5. Show action notifications:
   - Use NotificationService.showInfo for success
   - Messages: "Article marqué comme lu", "Article sauvegardé", "Source masquée"
   - Duration: short (2 seconds)
  </action>
  <verify>All 3 actions work and trigger appropriate API calls and UI updates</verify>
  <done>Digest screen handles all actions with proper flow and feedback</done>
</task>

<task type="auto">
  <name>Task 7: Add haptic feedback for actions</name>
  <files>apps/mobile/lib/features/digest/providers/digest_provider.dart</files>
  <action>
Add haptic feedback for improved UX:

1. Import: import 'package:flutter/services.dart';

2. Add haptic feedback in applyAction:
   - Light impact on button tap
   - Medium impact on action success
   - Use: HapticFeedback.lightImpact() / mediumImpact()

3. Add to digest_provider.dart:
   ```dart
   void _triggerHaptic(String action) {
     switch (action) {
       case 'read':
         HapticFeedback.mediumImpact();
       case 'save':
         HapticFeedback.lightImpact();
       case 'not_interested':
         HapticFeedback.lightImpact();
     }
   }
   ```

4. Call _triggerHaptic after successful API call
   - Only on success, not on error
   - Provides tactile confirmation

5. Also add haptic on completion:
   - Success haptic when all 5 articles processed
   - Celebratory feel for completing digest
  </action>
  <verify>Haptic feedback triggers on action success (test on device)</verify>
  <done>Haptic feedback provides tactile confirmation for actions</done>
</task>

</tasks>

<verification>
1. Run `flutter analyze` - must pass with 0 errors
2. Test actions in emulator:
   - Read: card dims, "Lu" badge appears
   - Save: button shows active state
   - Not Interested: sheet opens, confirms, source muted
3. Verify API calls in network inspector:
   - POST /api/digest/{id}/action called correctly
   - Correct content_id and action in body
4. Check notifications appear for each action
5. Verify haptic feedback (test on physical device)
</verification>

<success_criteria>
- Each digest card shows 3 action buttons (Read, Save, Not Interested)
- Read action marks article as consumed with visual feedback
- Save action bookmarks article and shows active state
- Not Interested shows confirmation sheet and mutes source
- Actions have immediate visual feedback (button state, card opacity)
- API calls succeed and update backend state
- Notifications confirm action success
- Haptic feedback provides tactile confirmation
</success_criteria>

<output>
After completion, create `.planning/phases/02-frontend/02-02-SUMMARY.md`
</output>
