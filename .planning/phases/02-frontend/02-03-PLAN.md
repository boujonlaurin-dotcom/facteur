---
phase: 02-frontend
plan: 03
type: execute
wave: 2
depends_on: ["02-02"]
files_modified:
  - apps/mobile/lib/features/digest/screens/closure_screen.dart
  - apps/mobile/lib/features/digest/widgets/streak_celebration.dart
  - apps/mobile/lib/features/digest/widgets/digest_summary.dart
  - apps/mobile/lib/config/routes.dart
  - apps/mobile/lib/features/digest/providers/digest_provider.dart
  - apps/mobile/lib/features/gamification/widgets/streak_indicator.dart
autonomous: true
must_haves:
  truths:
    - "Closure screen displays after user processes all 5 articles"
    - "Screen shows 'Tu es inform√©(e) !' message with animation"
    - "Streak celebration displays with flame animation and count"
    - "Digest summary shows stats (read, saved, skipped counts)"
    - "'Explorer plus' button navigates to relegated feed"
    - "Screen auto-navigates after delay or manual dismissal"
  artifacts:
    - path: "apps/mobile/lib/features/digest/screens/closure_screen.dart"
      provides: "Closure screen with celebration and summary"
      exports: ["ClosureScreen"]
    - path: "apps/mobile/lib/features/digest/widgets/streak_celebration.dart"
      provides: "Animated streak display with flame"
      exports: ["StreakCelebration"]
    - path: "apps/mobile/lib/features/digest/widgets/digest_summary.dart"
      provides: "Summary of digest completion stats"
      exports: ["DigestSummary"]
  key_links:
    - from: "digest_screen.dart"
      to: "closure_screen.dart"
      via: "GoRouter navigation on completion"
      pattern: "context\\.go.*closure"
    - from: "closure_screen.dart"
      to: "digest_provider.dart"
      via: "ref.watch for completion data"
      pattern: "ref\\.watch\\(digestProvider"
    - from: "streak_celebration.dart"
      to: "streak_indicator.dart"
      via: "Streak data model reuse"
      pattern: "StreakModel"
---

<objective>
Create the closure screen with celebration animation, streak display, and digest summary.

Purpose: Provide positive closure to the digest experience, celebrating completion and showing progress stats. This reinforces the habit loop and encourages return visits.

Output: Complete closure screen with animations, streak celebration, and navigation to the feed.
</objective>

<execution_context>
@/Users/laurinboujon/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/laurinboujon/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
@.planning/phases/02-frontend/02-02-PLAN.md

**API Response for completion (from Phase 1):**

POST /api/digest/{id}/complete returns DigestCompletionResponse:
{
  "success": true,
  "digest_id": "uuid",
  "completed_at": "2026-01-01T...",
  "articles_read": 3,
  "articles_saved": 1,
  "articles_dismissed": 1,
  "closure_time_seconds": 180,
  "closure_streak": 5,
  "streak_message": "5 jours d'affil√©e ! üî•"
}

**Existing patterns to reuse:**

From apps/mobile/lib/features/onboarding/screens/conclusion_animation_screen.dart:
- Full-screen scaffold with centered content
- Animation controller patterns
- Success/loading/error state handling
- Background color: colors.backgroundPrimary

From apps/mobile/lib/features/gamification/widgets/streak_indicator.dart:
- Flame icon: PhosphorIcons.fire(PhosphorIconsStyle.fill)
- Streak number display pattern
- Color: orange for active streak
- Container styling with backgroundSecondary

From apps/mobile/lib/features/onboarding/widgets/animated_message_text.dart:
- Sequential text animation pattern
- Fading text transitions
- Delayed appearance effects

**Existing Streak model:**
- apps/mobile/lib/features/gamification/models/streak_model.dart
- StreakModel with currentStreak, lastActivityDate, etc.

**Requirements (from REQUIREMENTS.md):**
- UI-05: Closure screen with animation, "Tu es inform√© !" message
- UI-06: Streak celebration display (closure streak)
- GMF-01: Closure streak tracking (separate from reading streak)
- GMF-02: Streak UI integration in digest and closure screens

**Design notes:**
- Screen should feel celebratory but not overwhelming
- Animation duration: 2-3 seconds total
- Auto-dismiss after 4-5 seconds OR manual dismiss via button
- Show digest stats in a subtle, non-cluttered way
- "Explorer plus" is secondary action (feed relegation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create streak celebration widget</name>
  <files>apps/mobile/lib/features/digest/widgets/streak_celebration.dart</files>
  <action>
Create animated streak celebration component:

1. Create streak_celebration.dart with:
   ```dart
   class StreakCelebration extends StatefulWidget {
     final int streakCount;
     final String? streakMessage;
     final VoidCallback? onAnimationComplete;
   }
   ```

2. Visual design:
   - Large flame icon (size: 64 or 80)
   - Icon: PhosphorIcons.fire(PhosphorIconsStyle.fill)
   - Color: orange (Colors.orange or custom flame gradient)
   - Streak number: large bold text (48-64px)
   - Message: smaller text below (streak_message or default)

3. Animation sequence (total 2 seconds):
   - 0-300ms: Scale flame from 0.5 to 1.2 with bounce
   - 300-500ms: Scale to 1.0 (settle)
   - 500-800ms: Number fades in and counts up
   - 800-1200ms: Message fades in below
   - Use AnimatedBuilder or explicit AnimationController

4. Flame effects:
   - Optional: subtle pulsing glow
   - Use BoxShadow with orange color
   - Animate shadow spread/opacity

5. Reuse patterns from:
   - apps/mobile/lib/features/onboarding/widgets/minimal_loader.dart (animation)
   - apps/mobile/lib/features/gamification/widgets/streak_indicator.dart (styling)
  </action>
  <verify>Widget shows animated flame with counting number and message</verify>
  <done>Streak celebration displays with smooth 2-second animation sequence</done>
</task>

<task type="auto">
  <name>Task 2: Create digest summary widget</name>
  <files>apps/mobile/lib/features/digest/widgets/digest_summary.dart</files>
  <action>
Create widget showing digest completion stats:

1. Create digest_summary.dart with:
   ```dart
   class DigestSummary extends StatelessWidget {
     final int articlesRead;
     final int articlesSaved;
     final int articlesDismissed;
     final int? closureTimeSeconds;
   }
   ```

2. Visual design:
   - Container with backgroundSecondary
   - BorderRadius: small (8px)
   - Padding: space4
   - Row with 3 stat columns (read, saved, dismissed)
   - Each column: icon + number + label

3. Stat display:
   - Read: PhosphorIcons.checkCircle, color = success
   - Saved: PhosphorIcons.bookmark, color = primary
   - Dismissed: PhosphorIcons.eyeSlash, color = textSecondary
   - Numbers: large bold (24px)
   - Labels: small text ("lus", "sauv.", "pass√©s")

4. Optional time display:
   - If closureTimeSeconds provided
   - Show formatted time: "2 min 30s"
   - Small text below stats row

5. Reuse patterns from existing stat displays:
   - apps/mobile/lib/features/progress/widgets/progression_card.dart
   - apps/mobile/lib/features/gamification/widgets/daily_progress_indicator.dart
  </action>
  <verify>Summary displays 3 stats with correct icons and counts</verify>
  <done>Digest summary shows read/saved/dismissed counts with clear visuals</done>
</task>

<task type="auto">
  <name>Task 3: Create closure screen</name>
  <files>apps/mobile/lib/features/digest/screens/closure_screen.dart</files>
  <action>
Create full closure screen with celebration flow:

1. Create closure_screen.dart with:
   ```dart
   class ClosureScreen extends ConsumerStatefulWidget {
     final String digestId; // Pass from navigation
   }
   ```

2. Screen structure:
   - Scaffold with backgroundPrimary
   - SafeArea with centered Column
   - Spacer at top for vertical centering
   - Animated content area
   - Bottom button area

3. Content layout (top to bottom):
   - Spacer(flex: 2) for top spacing
   - "Tu es inform√©(e) !" headline (fade in)
   - SizedBox(height: space6)
   - StreakCelebration widget (animated)
   - SizedBox(height: space4)
   - DigestSummary widget (fade in after streak)
   - Spacer(flex: 3) for middle spacing
   - PrimaryButton: "Explorer plus" (fade in last)
   - SizedBox(height: space3)
   - TextButton: "Fermer" (optional quick dismiss)
   - SizedBox(height: space4) for bottom safe area

4. Animation orchestration:
   - Use staggered animations
   - StaggeredAnimationBuilder or custom controller
   - Sequence: headline (0ms) ‚Üí streak (400ms) ‚Üí summary (1000ms) ‚Üí buttons (1400ms)
   - Each element fades + slides up slightly

5. Auto-dismiss timer:
   - 5 second countdown
   - Show subtle progress indicator or "Se ferme dans Xs"
   - Allow manual dismiss to cancel timer

6. Data loading:
   - Get digest data from provider (passed via navigation or from provider)
   - If digestId passed, fetch completion data
   - Otherwise use cached data from digestProvider
  </action>
  <verify>Screen shows all elements with staggered animation and auto-dismiss</verify>
  <done>Closure screen displays with animated celebration and digest summary</done>
</task>

<task type="auto">
  <name>Task 4: Add closure route to navigation</name>
  <files>apps/mobile/lib/config/routes.dart</files>
  <action>
Add closure screen route to router:

1. Update RouteNames:
   - Add: static const String digestClosure = 'digest-closure'

2. Update RoutePaths:
   - Add: static const String digestClosure = '/digest/closure'

3. Add GoRoute:
   ```dart
   GoRoute(
     path: RoutePaths.digestClosure,
     name: RouteNames.digestClosure,
     builder: (context, state) {
       // Optional: pass digestId via extra
       final digestId = state.extra as String?;
       return ClosureScreen(digestId: digestId ?? '');
     },
   ),
   ```

4. Route placement:
   - Add after digest route in ShellRoute
   - Or as separate route outside ShellRoute (full screen)
   - Recommended: outside ShellRoute to hide bottom nav

5. Import ClosureScreen at top of file
  </action>
  <verify>Route registered and ClosureScreen import resolved</verify>
  <done>Closure screen accessible at /digest/closure route</done>
</task>

<task type="auto">
  <name>Task 5: Wire completion navigation in digest screen</name>
  <files>apps/mobile/lib/features/digest/screens/digest_screen.dart
apps/mobile/lib/features/digest/providers/digest_provider.dart</files>
  <action>
Connect digest completion to closure screen navigation:

1. Update DigestScreen to listen for completion:
   ```dart
   ref.listen&lt;AsyncValue&lt;DigestResponse&gt;&gt;(digestProvider, (prev, next) {
     next.whenData((digest) {
       if (digest.isCompleted && !_navigatedToClosure) {
         _navigatedToClosure = true;
         _navigateToClosure();
       }
     });
   });
   ```

2. Add completion detection logic:
   - Track whether navigation already happened (bool flag)
   - Check if all 5 items processed OR digest.isCompleted flag
   - Call completion API if not already done
   - Navigate to closure screen

3. Implement _navigateToClosure:
   ```dart
   void _navigateToClosure() {
     final digest = ref.read(digestProvider).value;
     if (digest != null) {
       context.go(
         RoutePaths.digestClosure,
         extra: digest.digestId,
       );
     }
   }
   ```

4. Update digest provider completion method:
   - completeDigest() should return completion data
   - Store completion response in provider state
   - Make accessible via getter: DigestCompletionResponse? get completionData

5. Handle edge cases:
   - Don't navigate if already on closure screen
   - Don't double-complete if already completed
   - Handle navigation errors gracefully
  </action>
  <verify>Completing all 5 articles navigates to closure screen automatically</verify>
  <done>Digest screen navigates to closure when all articles processed</done>
</task>

<task type="auto">
  <name>Task 6: Add "Explorer plus" navigation to feed</name>
  <files>apps/mobile/lib/features/digest/screens/closure_screen.dart</files>
  <action>
Implement "Explorer plus" button to navigate to feed:

1. In ClosureScreen, implement onExplorerPlusPressed:
   ```dart
   void _onExplorerPlusPressed() {
     // Cancel auto-dismiss timer
     _cancelAutoDismiss();
     
     // Navigate to feed
     context.go(RoutePaths.feed);
   }
   ```

2. Button styling:
   - PrimaryButton with full width
   - Icon: PhosphorIcons.compass() or PhosphorIcons.article()
   - Text: "Explorer plus"
   - Use existing button patterns

3. Alternative: "Fermer" text button:
   - Navigate to digest (next day's or same)
   - Or navigate to feed based on context
   - context.go(RoutePaths.digest) or context.go(RoutePaths.feed)

4. Navigation behavior:
   - Replace current route (don't allow back to closure)
   - Use context.go() not context.push()
   - Clear closure from navigation stack

5. Analytics (optional):
   - Track "explorer_plus_clicked" event
   - Include digest completion data
   - Use existing analytics service
  </action>
  <verify>Button navigates to feed screen and replaces closure in stack</verify>
  <done>"Explorer plus" button successfully navigates to relegated feed</done>
</task>

</tasks>

<verification>
1. Run `flutter analyze` - must pass with 0 errors
2. Test completion flow:
   - Process all 5 articles in digest
   - Verify auto-navigation to closure screen
   - Check animation plays correctly
3. Verify streak celebration shows:
   - Flame animation with count
   - Streak message displayed
4. Check digest summary shows correct stats:
   - Read count, saved count, dismissed count
5. Test "Explorer plus" button navigates to feed
6. Verify auto-dismiss timer works (or manual dismiss)
</verification>

<success_criteria>
- Closure screen displays after completing all 5 articles
- Screen shows "Tu es inform√©(e) !" with staggered animation
- Streak celebration displays flame animation with count
- Digest summary shows accurate stats (read/saved/dismissed)
- "Explorer plus" button navigates to relegated feed
- Auto-dismiss timer works or manual dismiss available
- Navigation replaces closure screen (no back button to return)
</success_criteria>

<output>
After completion, create `.planning/phases/02-frontend/02-03-SUMMARY.md`
</output>
