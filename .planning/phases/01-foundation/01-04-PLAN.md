---
phase: 01-foundation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/api/app/services/recommendation/scoring_config.py
  - packages/api/app/services/digest_selector.py
  - packages/api/app/services/digest_service.py
autonomous: true
must_haves:
  truths:
    - "Digest searches 168h for user sources (extended from 48h)"
    - "6 recency bonuses added with aligned +X pts display"
    - "Fallback to curated ONLY when user sources < 3 articles"
    - "User sources rank above curated even with recency penalty"
    - "Comprehensive logging for debugging source selection"
  artifacts:
    - path: "packages/api/app/services/recommendation/scoring_config.py"
      provides: "6 recency bonus constants in ScoringWeights"
      contains: "RECENT_VERY_BONUS = 30.0"
    - path: "packages/api/app/services/digest_selector.py"
      provides: "Extended lookback and improved fallback logic"
      contains: "hours_lookback: int = 168"
    - path: "packages/api/app/services/digest_service.py"
      provides: "Pass-through for hours_lookback parameter"
      contains: "hours_lookback=168"
  key_links:
    - from: "digest_selector.py select_for_user()"
      to: "_get_candidates()"
      via: "hours_lookback parameter propagation"
      pattern: "hours_lookback=168"
    - from: "_get_candidates()"
      to: "ScoringWeights recency bonuses"
      via: "_score_candidates recency calculation"
      pattern: "RECENT_.*_BONUS"
---

<objective>
Extend digest algorithm to search 168h (7 days) for user sources with tiered recency bonuses, and restrict fallback to curated sources only when user has fewer than 3 articles.

Purpose: Fix the critical bug where users receive articles NOT from their followed sources because the 48h window is too narrow, causing premature fallback to curated content.
Output: Updated scoring_config.py, digest_selector.py, and digest_service.py with extended lookback, recency bonus system, and improved fallback logic.
</objective>

<execution_context>
@/Users/laurinboujon/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/laurinboujon/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/api/app/services/recommendation/scoring_config.py
@packages/api/app/services/digest_selector.py
@packages/api/app/services/digest_service.py
@packages/api/app/services/recommendation/layers/core.py

## Critical Bug Context
Current digest algorithm only searches 48h for user sources then falls back to curated sources. This causes users to receive articles NOT from their followed sources. The fix extends lookback to 168h (7 days) and adds tiered recency bonuses so older user-source articles can still rank well.

## Current Implementation
- `scoring_config.py`: Has `recency_base = 30.0` but no tiered bonuses
- `digest_selector.py`: `hours_lookback: int = 48` in `select_for_user()`, fallback triggers when pool < 5
- `core.py`: Uses smooth decay formula `30.0 / (hours_old / 24.0 + 1.0)` - needs tiered replacement

## Required Changes
1. Add 6 recency bonus constants to ScoringWeights
2. Change default hours_lookback from 48 to 168
3. Modify fallback: only use curated if user sources < 3
4. Apply recency bonuses during scoring
5. Ensure user sources rank above curated
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add recency bonus constants to ScoringWeights</name>
  <files>packages/api/app/services/recommendation/scoring_config.py</files>
  <action>
Add 6 new recency bonus constants to the ScoringWeights class after the existing `recency_base = 30.0` line. Each constant should have a descriptive comment in French explaining the time window and bonus value.

Add these constants:
- RECENT_VERY_BONUS = 30.0  # < 6h: "Article très récent (< 6h): +30 pts"
- RECENT_BONUS = 25.0  # 6-24h: "Article récent (< 24h): +25 pts"
- RECENT_DAY_BONUS = 15.0  # 24-48h: "Publié aujourd'hui: +15 pts"
- RECENT_YESTERDAY_BONUS = 8.0  # 48-72h: "Publié hier: +8 pts"
- RECENT_WEEK_BONUS = 3.0  # 72-120h: "Article de la semaine: +3 pts"
- RECENT_OLD_BONUS = 1.0  # 120-168h: "Article ancien: +1 pt"

Keep the existing `recency_base = 30.0` for backward compatibility with other code that might reference it. Add the new constants in a new section labeled "# --- DIGEST RECENCY BONUSES (Tiered) ---".

The format should align with existing code style - use uppercase constants with descriptive French comments.
  </action>
  <verify>
    grep -n "RECENT_VERY_BONUS\|RECENT_BONUS\|RECENT_DAY_BONUS\|RECENT_YESTERDAY_BONUS\|RECENT_WEEK_BONUS\|RECENT_OLD_BONUS" packages/api/app/services/recommendation/scoring_config.py
    # Should show all 6 constants defined
  </verify>
  <done>
    All 6 recency bonus constants (30.0, 25.0, 15.0, 8.0, 3.0, 1.0) added to ScoringWeights class with French comments explaining each time window.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend hours_lookback and modify fallback logic</name>
  <files>packages/api/app/services/digest_selector.py</files>
  <action>
Modify the `select_for_user()` method and `_get_candidates()` method in digest_selector.py:

1. Change default parameter in `select_for_user()`:
   - From: `hours_lookback: int = 48`
   - To: `hours_lookback: int = 168`

2. Modify `_get_candidates()` fallback logic:
   - Current: Fallback triggers when `len(candidates) < min_pool_size` (which is 5)
   - New: Create TWO separate pools - user_sources_candidates and all_candidates
   - First, fetch ONLY from user followed sources (no fallback during this phase)
   - Track count of user source articles: `user_source_count = len(user_candidates)`
   - Only fetch from curated sources if `user_source_count < 3` AND we need more to reach min_pool_size
   - This ensures user sources are ALWAYS prioritized

3. Update the fallback loop logic:
   - Keep the `max_lookback = 168` (already correct)
   - But change condition: only enter fallback if user sources < 3 AND total < min_pool_size
   - Add clear logging to distinguish user sources vs curated sources

4. Add logging improvements:
   - Log user_source_count separately from total candidates
   - Log when fallback to curated is triggered and why
   - Log the ratio of user sources to curated in final selection

The key insight: We should search 168h for user sources FIRST, then only supplement with curated if we have fewer than 3 user articles. This ensures users see their followed sources even if articles are a week old.
  </action>
  <verify>
    grep -n "hours_lookback: int = 168" packages/api/app/services/digest_selector.py
    grep -n "user_source_count\|user_sources_candidates" packages/api/app/services/digest_selector.py
    # Should show the new logic tracking user sources separately
  </verify>
  <done>
    Default hours_lookback changed to 168, fallback logic modified to only use curated when user sources < 3, with clear logging distinguishing user vs curated sources.
  </done>
</task>

<task type="auto">
  <name>Task 3: Apply recency bonuses during scoring</name>
  <files>packages/api/app/services/digest_selector.py</files>
  <action>
Modify the `_score_candidates()` method to apply tiered recency bonuses instead of relying solely on the smooth decay from CoreLayer.

1. Import the new ScoringWeights constants at the top of the file:
   - Add to existing import: `from app.services.recommendation.scoring_config import ScoringWeights`

2. In `_score_candidates()`, after getting the base score from scoring_engine, ADD a tiered recency bonus based on article age:
   - Calculate hours_old from content.published_at (same as CoreLayer)
   - Apply bonus based on time window:
     * hours_old < 6: +RECENT_VERY_BONUS (30.0)
     * 6 <= hours_old < 24: +RECENT_BONUS (25.0)
     * 24 <= hours_old < 48: +RECENT_DAY_BONUS (15.0)
     * 48 <= hours_old < 72: +RECENT_YESTERDAY_BONUS (8.0)
     * 72 <= hours_old < 120: +RECENT_WEEK_BONUS (3.0)
     * 120 <= hours_old < 168: +RECENT_OLD_BONUS (1.0)
     * hours_old >= 168: +0 (no bonus beyond window)

3. Add the bonus to the reason string:
   - Modify the DigestItem.reason to include the recency bonus info
   - Format: "Source suivie : {name} (+30 pts)" or similar
   - This aligns with the existing reason format but adds the bonus display

4. Ensure the bonus is logged:
   - Add debug logging showing hours_old and applied bonus per article
   - This helps verify the tiered system is working

Note: The existing CoreLayer will still apply its smooth recency decay (30.0 / (hours_old/24 + 1)). The new tiered bonuses are ADDITIONAL to ensure user-source articles get a meaningful boost even at 7 days old. The combined effect should be: smooth decay (diminishing) + tiered bonus (stepped), giving older user-source articles a fighting chance against fresh curated content.
  </action>
  <verify>
    grep -n "RECENT_.*_BONUS\|hours_old < 6\|hours_old < 24" packages/api/app/services/digest_selector.py
    grep -n "score.*+.*RECENT" packages/api/app/services/digest_selector.py
    # Should show tiered recency bonus logic
  </verify>
  <done>
    Tiered recency bonuses applied during scoring with 6 tiers (<6h, 6-24h, 24-48h, 48-72h, 72-120h, 120-168h), bonus amounts added to reason strings, and debug logging for verification.
  </done>
</task>

<task type="auto">
  <name>Task 4: Update digest_service.py to pass hours_lookback</name>
  <files>packages/api/app/services/digest_service.py</files>
  <action>
Update the `get_or_create_digest()` method in digest_service.py to pass the extended hours_lookback to the selector:

1. Add optional parameter to `get_or_create_digest()`:
   - Add: `hours_lookback: int = 168` parameter
   - This allows API endpoint to override if needed while defaulting to 168

2. Pass the parameter to selector.select_for_user():
   - Current: `digest_items = await self.selector.select_for_user(user_id, limit=5)`
   - New: `digest_items = await self.selector.select_for_user(user_id, limit=5, hours_lookback=hours_lookback)`

3. Add logging to show the lookback window being used:
   - Log: `logger.info("digest_lookback_window", hours=hours_lookback)`
   - This helps verify the extended window is active

4. Update docstring to document the new parameter:
   - Add parameter documentation for hours_lookback
   - Explain default is 168h (7 days) for comprehensive user source search

This change ensures the extended lookback flows from service → selector → candidate query.
  </action>
  <verify>
    grep -n "hours_lookback: int = 168\|hours_lookback=hours_lookback" packages/api/app/services/digest_service.py
    # Should show the parameter added and passed through
  </verify>
  <done>
    DigestService updated to accept and pass hours_lookback parameter (default 168) to DigestSelector, with logging and docstring updates.
  </done>
</task>

</tasks>

<verification>
Run these checks to verify all changes work correctly:

1. **Syntax check:**
   ```bash
   cd packages/api && python -m py_compile app/services/digest_selector.py app/services/digest_service.py app/services/recommendation/scoring_config.py
   ```

2. **Import check:**
   ```bash
   cd packages/api && python -c "from app.services.digest_selector import DigestSelector; from app.services.recommendation.scoring_config import ScoringWeights; print('Imports OK')"
   ```

3. **Constants verification:**
   ```bash
   cd packages/api && python -c "from app.services.recommendation.scoring_config import ScoringWeights; print([a for a in dir(ScoringWeights) if 'RECENT' in a])"
   # Should show all 6 RECENT_* constants
   ```

4. **Logic verification:**
   - Check that `hours_lookback` defaults to 168 in both DigestSelector.select_for_user() and DigestService.get_or_create_digest()
   - Verify fallback logic checks user_source_count < 3 before fetching curated
   - Confirm tiered recency bonuses are applied in _score_candidates()
</verification>

<success_criteria>
- [ ] ScoringWeights contains 6 new recency bonus constants (30, 25, 15, 8, 3, 1)
- [ ] Default hours_lookback is 168 in both selector and service
- [ ] Fallback to curated only triggers when user sources < 3
- [ ] Tiered recency bonuses applied based on article age
- [ ] Bonus amounts displayed in article reason strings (+X pts format)
- [ ] Comprehensive logging distinguishes user vs curated sources
- [ ] All files pass Python syntax and import checks
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md` with:
- Summary of changes made
- Before/after comparison of lookback and fallback behavior
- Verification that recency bonuses are working
- Any notes for testing or deployment
</output>
