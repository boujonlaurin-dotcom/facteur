# Story 3.3: Moteur de synchronisation RSS

## Status: Done ✅

## Story

**As a** système,  
**I want** synchroniser automatiquement les contenus depuis les flux RSS,  
**so that** le feed soit toujours à jour.

## Acceptance Criteria

1. Service Python parsant RSS (articles, podcasts, YouTube) [Source: prd.md#Story 3.3] ✅
2. Gestion des 3 types de flux (mappage correct vers `ContentType`) [Source: architecture.md#6.3] ✅
3. Extraction métadonnées complètes (titre, URL, thumbnail, description, date, duration, guid) [Source: prd.md#Story 3.3] ✅
4. Déduplication robuste par `guid` et `url` [Source: prd.md#Story 3.3] ✅
5. Job planifié via APScheduler toutes les 30 minutes (configurable) [Source: prd.md#Story 3.3] ✅
6. Logging structuré des succès et échecs de synchronisation [Source: prd.md#Story 3.3] ✅
7. **Qualité Image** : Prioriser les versions haute résolution (ex: images originales vs miniatures/previews). ✅

## Tasks / Subtasks

- [x] **Task 1: Service de parsing RSS**
  - [x] Créer `packages/api/app/services/sync_service.py`
  - [x] Utiliser `feedparser` pour extraire les entrées
  - [x] Implémenter logic spécifique pour YouTube (parsing `<media:group>` pour thumbnails/descriptions)
  - [x] Gérer l'extraction des durées pour les podcasts (balise `<itunes:duration>`)

- [x] **Task 2: Logique de synchronisation et déduplication**
  - [x] Pour chaque entrée : vérifier existence via `guid` ou `url`
  - [x] Mapper les données vers le modèle SQLAlchemy `Content`
  - [x] Insérer les nouveaux contenus en masse (`bulk_insert_mappings`) pour performance

- [x] **Task 3: Planification du job (Scheduler)**
  - [x] Configurer `APScheduler` dans `packages/api/app/main.py`
  - [x] Créer une fonction `sync_all_sources()` qui boucle sur les sources actives
  - [x] Ajouter un endpoint de debug `/api/debug/sync` pour forcer une sync manuelle

- [x] **Task 4: Tests et validation**
  - [x] Tester le parsing avec une source de chaque type (Bon Pote, Les Pieds sur Terre, YouTube)
  - [x] Vérifier la déduplication : relancer la sync ne doit pas créer de doublons
  - [x] Vérifier les logs dans la console

## Dev Notes

### Parsing Details [Source: architecture.md#6.3]

#### YouTube
- Thumbnail : `media_thumbnail[0]['url']`
- Description : `media_description` ou `summary`
- ContentType : `youtube`

#### Podcast
- Duration : `itunes_duration` (convertir en secondes)
- ContentType : `podcast`

#### Article
- Published at : `published_parsed` (convertir en `datetime` UTC)
- ContentType : `article`
- **Thumbnail Optimization** : 
    - Extraire de `media:content` si présent.
    - Sinon, parser le HTML pour trouver la balise `<img>`. 
    - **CRITICAL**: Nettoyer l'URL pour obtenir la version haute-résolution (ex: remplacer `/644/` par `/original/` pour Courrier International, supprimer les suffixes de resizing Wordpress comme `-150x150.jpg`).


### Dependencies
- `feedparser` (déjà dans `requirements.txt`)
- `APScheduler` (déjà dans `requirements.txt`)

## Testing

- **Script de test manual** : `packages/api/scripts/test_sync.py`
- **Unit tests** : `packages/api/tests/test_sync_service.py`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 10/01/2026 | 1.0 | Initial Draft | BMad Master Agent |
| 11/01/2026 | 1.1 | Ajout optimisation résolution images thumbnails | Antigravity |

