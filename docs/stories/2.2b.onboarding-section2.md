# Story 2.2b: Onboarding Section 2 "App Preferences"

## Status: Done ‚úÖ

## Story

**As a** nouvel utilisateur,  
**I want** d√©finir mes pr√©f√©rences d'usage de fa√ßon indirecte,  
**so that** l'app s'adapte √† ma fa√ßon de consommer l'info.

## Acceptance Criteria

1. 4-5 √©crans avec questions indirectes couvrant les pr√©f√©rences d'usage
2. Questions formul√©es de fa√ßon engageante (choix visuels, mini-sc√©narios)
3. R√©actions contextuelles apr√®s certaines r√©ponses cl√©s
4. Indicateur de progression visible (section 2/3)
5. R√©ponses stock√©es localement pendant le flow

## Tasks / Subtasks

- [ ] **Task 1 : √âcran intro Section 2** (AC: 4)
  - [ ] Cr√©er widget `SectionTransitionScreen` r√©utilisable
  - [ ] Animation d'apparition avec emoji th√©matique (üí≠)
  - [ ] Texte : "Parlons de ta fa√ßon de consommer l'info..."
  - [ ] Indicateur "Section 2/3"
  - [ ] Auto-transition apr√®s 2 secondes ou tap

- [ ] **Task 2 : Q5 - Big-picture vs Detail-oriented** (AC: 1, 2)
  - [ ] Cr√©er widget `PerspectiveQuestion`
  - [ ] Question : "Face √† un sujet, tu pr√©f√®res..."
  - [ ] 2 options avec `BinarySelectionCard` et illustrations :
    - üåç "Avoir la vue d'ensemble" ‚Üí `perspective: "big_picture"`
    - üî¨ "Comprendre les d√©tails" ‚Üí `perspective: "detail_oriented"`
  - [ ] Descriptions engageantes sous chaque option
  - [ ] Stocker dans `answers.perspective`

- [ ] **Task 3 : Q6 - R√©ponses tranch√©es vs nuanc√©es** (AC: 1, 2)
  - [ ] Cr√©er widget `OpinionStyleQuestion`
  - [ ] Question : "Tu pr√©f√®res des analyses..."
  - [ ] 2 options avec visuels :
    - ‚ö° "Claires et tranch√©es" ‚Üí `opinion_style: "assertive"`
    - üåø "Nuanc√©es et ouvertes" ‚Üí `opinion_style: "nuanced"`
  - [ ] Mini-descriptions explicatives
  - [ ] Stocker dans `answers.opinionStyle`

- [ ] **Task 4 : Q7 - Actu r√©cente vs Analyses long-terme** (AC: 1, 2)
  - [ ] Cr√©er widget `ContentFreshnessQuestion`
  - [ ] Question : "Ce qui t'int√©resse le plus..."
  - [ ] 2 options :
    - üìÖ "L'actualit√© r√©cente" ‚Üí `content_freshness: "recent"`
    - üìö "Analyses de fond intemporelles" ‚Üí `content_freshness: "evergreen"`
  - [ ] Stocker dans `answers.contentFreshness`

- [ ] **Task 5 : √âcran r√©action apr√®s Q7** (AC: 3)
  - [ ] R√©utiliser widget `ReactionScreen` (Story 2.2)
  - [ ] Message personnalis√© selon pr√©f√©rence freshness :
    - Recent ‚Üí "Tu seras toujours √† jour ! On privil√©gie les contenus frais..."
    - Evergreen ‚Üí "On t'aide √† apprendre sur le long terme avec des analyses de fond..."
  - [ ] Animation fade-in
  - [ ] Bouton "Continuer"

- [ ] **Task 6 : Q8 - Activation gamification** (AC: 1, 2)
  - [ ] Cr√©er widget `GamificationQuestion`
  - [ ] Question : "Veux-tu suivre ta progression ?"
  - [ ] 2 options avec preview visuel :
    - üî• "Oui, motive-moi !" (montrer exemple streak + barre)
    - üßò "Non, je pr√©f√®re sans" (expliquer mode zen)
  - [ ] Stocker dans `answers.gamificationEnabled` (bool)
  - [ ] Transition conditionnelle : Si Oui ‚Üí Q8b, Si Non ‚Üí Section 3

- [ ] **Task 7 : Q8b - Objectif hebdomadaire (conditionnel)** (AC: 1, 2)
  - [ ] Cr√©er widget `WeeklyGoalQuestion`
  - [ ] Question : "Combien de contenus par semaine ?"
  - [ ] 3 options avec `SelectionCard` :
    - üå± "5 contenus/semaine (d√©butant)"
    - üìà "10 contenus/semaine (motiv√©)"
    - üöÄ "15 contenus/semaine (ambitieux)"
  - [ ] Stocker dans `answers.weeklyGoal` (int: 5, 10, 15)
  - [ ] N'afficher que si gamificationEnabled = true

- [ ] **Task 8 : Navigation et progression** (AC: 4, 5)
  - [ ] Mettre √† jour `OnboardingNotifier` pour g√©rer Section 2
  - [ ] Calculer progression : Q5 ‚Üí Q6 ‚Üí Q7 ‚Üí R√©action ‚Üí Q8 ‚Üí (Q8b) ‚Üí Section 3
  - [ ] Barre de progression anim√©e refl√©tant l'avancement dans Section 2
  - [ ] Sauvegarder toutes les r√©ponses dans Hive √† chaque √©tape

- [ ] **Task 9 : Tests** (AC: All)
  - [ ] Test : Section 2 affiche bien "Section 2/3"
  - [ ] Test : Progression bar avance correctement
  - [ ] Test : R√©action personnalis√©e selon r√©ponse Q7
  - [ ] Test : Q8b ne s'affiche que si gamification = true
  - [ ] Test : Navigation vers Section 3 apr√®s derni√®re question
  - [ ] Test : R√©ponses sauvegard√©es dans Hive

## Dev Notes

### Previous Story Context

**Story 2.2 (Section 1) :**
- `OnboardingNotifier` g√®re l'√©tat global avec `OnboardingState`
- Widgets r√©utilisables : `SelectionCard`, `BinarySelectionCard`, `ReactionScreen`, `OnboardingProgressBar`
- Mod√®le `OnboardingAnswersModel` pour s√©rialisation
- Persistence Hive pour reprendre flow interrompu

### Section 2 Questions Overview

| # | Question | Type | Options | Stores |
|---|----------|------|---------|--------|
| **Intro** | Transition anim√©e | ‚Äî | ‚Äî | ‚Äî |
| **Q5** | Big-picture vs Detail | Binary | Vue d'ensemble / D√©tails | `perspective` |
| **Q6** | Opinion tranch√©e vs nuanc√©e | Binary | Tranch√©es / Nuanc√©es | `opinion_style` |
| **Q7** | Actu vs Evergreen | Binary | R√©cente / Intemporelle | `content_freshness` |
| **R2** | R√©action personnalis√©e | ‚Äî | ‚Äî | ‚Äî |
| **Q8** | Gamification on/off | Binary | Oui / Non | `gamification_enabled` |
| **Q8b** | Objectif hebdo (conditionnel) | Multiple | 5 / 10 / 15 | `weekly_goal` |

**Total √©crans Section 2 :** 6-7 (selon gamification)

### Data Mapping

**Pr√©f√©rences stock√©es :**

```dart
// Dans OnboardingAnswersModel
class OnboardingAnswersModel {
  // Section 1
  final String? objective;
  final String? ageRange;
  final String? gender;
  final String? approach;
  
  // Section 2 (nouveau)
  final String? perspective;          // "big_picture" | "detail_oriented"
  final String? opinionStyle;         // "assertive" | "nuanced"
  final String? contentFreshness;     // "recent" | "evergreen"
  final bool gamificationEnabled;     // true | false
  final int? weeklyGoal;              // 5, 10, 15 (null si gamification = false)
  
  // Section 3 (√† venir)
  // ...
}
```

**Mapping vers API (Story 2.3) :**
```json
{
  "perspective": "big_picture",
  "opinion_style": "assertive",
  "content_freshness": "recent",
  "gamification_enabled": true,
  "weekly_goal": 10
}
```

### Questions Content Details

#### Q5 - Perspective

**Question :** "Face √† un sujet, tu pr√©f√®res..."

**Options :**

**Option 1 : Big Picture**
- Emoji : üåç
- Titre : "Avoir la vue d'ensemble"
- Description : "Comprendre le contexte global et les grandes tendances"
- Valeur : `perspective: "big_picture"`

**Option 2 : Detail Oriented**
- Emoji : üî¨
- Titre : "Comprendre les d√©tails"
- Description : "Analyser en profondeur les m√©canismes et nuances"
- Valeur : `perspective: "detail_oriented"`

---

#### Q6 - Opinion Style

**Question :** "Tu pr√©f√®res des analyses..."

**Options :**

**Option 1 : Assertive**
- Emoji : ‚ö°
- Titre : "Claires et tranch√©es"
- Description : "Des prises de position affirm√©es"
- Valeur : `opinion_style: "assertive"`

**Option 2 : Nuanced**
- Emoji : üåø
- Titre : "Nuanc√©es et ouvertes"
- Description : "Qui pr√©sentent plusieurs points de vue"
- Valeur : `opinion_style: "nuanced"`

---

#### Q7 - Content Freshness

**Question :** "Ce qui t'int√©resse le plus..."

**Options :**

**Option 1 : Recent**
- Emoji : üìÖ
- Titre : "L'actualit√© r√©cente"
- Description : "Suivre les √©v√©nements et tendances du moment"
- Valeur : `content_freshness: "recent"`

**Option 2 : Evergreen**
- Emoji : üìö
- Titre : "Analyses de fond intemporelles"
- Description : "Apprendre avec des contenus qui restent pertinents"
- Valeur : `content_freshness: "evergreen"`

**R√©action selon choix :**
- Si "recent" : "Tu seras toujours √† jour ! On privil√©gie les contenus frais pour que tu restes inform√© des derni√®res √©volutions."
- Si "evergreen" : "On t'aide √† apprendre sur le long terme ! Les analyses de fond t'aideront √† construire une compr√©hension solide."

---

#### Q8 - Gamification

**Question :** "Veux-tu suivre ta progression ?"

**Options :**

**Option 1 : Oui**
- Emoji : üî•
- Titre : "Oui, motive-moi !"
- Description : "Streak quotidien + barre de progression hebdo"
- Preview visuel : Mockup du widget progression
- Valeur : `gamification_enabled: true` ‚Üí Continue vers Q8b

**Option 2 : Non**
- Emoji : üßò
- Titre : "Non, je pr√©f√®re sans"
- Description : "Mode zen, concentre-toi juste sur les contenus"
- Valeur : `gamification_enabled: false` ‚Üí Passe directement Section 3

---

#### Q8b - Weekly Goal (Conditionnel)

**Question :** "Combien de contenus par semaine ?"

**Subtitle :** "Fixe-toi un objectif r√©aliste pour rester motiv√©"

**Options :**

**Option 1 : D√©butant**
- Emoji : üå±
- Titre : "5 contenus/semaine"
- Description : "Parfait pour commencer en douceur"
- Valeur : `weekly_goal: 5`

**Option 2 : Motiv√©**
- Emoji : üìà
- Titre : "10 contenus/semaine"
- Description : "Un bon rythme d'apprentissage r√©gulier"
- Valeur : `weekly_goal: 10` (d√©faut recommand√©)

**Option 3 : Ambitieux**
- Emoji : üöÄ
- Titre : "15 contenus/semaine"
- Description : "Pour les plus curieux et assidus"
- Valeur : `weekly_goal: 15`

### UI Components

#### SectionTransitionScreen

**Nouveau widget r√©utilisable :**
```dart
class SectionTransitionScreen extends StatelessWidget {
  final String emoji;
  final String title;
  final int sectionNumber;
  final VoidCallback onContinue;
  
  const SectionTransitionScreen({
    required this.emoji,
    required this.title,
    required this.sectionNumber,
    required this.onContinue,
  });
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Text(emoji, style: TextStyle(fontSize: 80)),
            SizedBox(height: 24),
            Text(title, style: AppTextStyles.heading),
            SizedBox(height: 16),
            Text('Section $sectionNumber/3', style: AppTextStyles.caption),
          ],
        ),
      ),
    );
  }
  
  @override
  void initState() {
    super.initState();
    // Auto-transition apr√®s 2 secondes
    Future.delayed(Duration(seconds: 2), () {
      widget.onContinue();
    });
  }
}
```

#### GamificationQuestion Preview

**Visuel pour Option "Oui" :**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                 ‚îÇ
‚îÇ  üî• 12 jours                    ‚îÇ  ‚Üê Exemple streak
‚îÇ                                 ‚îÇ
‚îÇ  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë 7/10 semaine        ‚îÇ  ‚Üê Exemple barre
‚îÇ                                 ‚îÇ
‚îÇ  "Suivi quotidien et objectifs  ‚îÇ
‚îÇ   hebdo pour rester motiv√©"     ‚îÇ
‚îÇ                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Navigation Flow Section 2

```mermaid
graph TD
    S1_END[Fin Section 1] --> S2_INTRO[Intro Section 2<br/>2s auto]
    S2_INTRO --> Q5[Q5: Perspective]
    Q5 --> Q6[Q6: Opinion Style]
    Q6 --> Q7[Q7: Freshness]
    Q7 --> R2[R√©action<br/>personnalis√©e]
    R2 --> Q8[Q8: Gamification?]
    Q8 -->|Oui| Q8B[Q8b: Weekly Goal]
    Q8 -->|Non| S3_INTRO[Section 3]
    Q8B --> S3_INTRO
    
    style S2_INTRO fill:#6B9AC4,stroke:#333,color:#fff
    style S3_INTRO fill:#E07A5F,stroke:#333,color:#fff
```

### Progress Bar Calculation

**Section 2 progression :**
- Intro : 33.3% (fin Section 1)
- Q5 : 38%
- Q6 : 43%
- Q7 : 48%
- R2 : 53%
- Q8 : 58%
- Q8b : 63% (si affich√©)
- Fin Section 2 : 66.6%

**Formule :**
```dart
double calculateProgress(int currentQuestion, int totalQuestions) {
  const sectionStart = 0.333; // Fin Section 1
  const sectionEnd = 0.666;   // Fin Section 2
  const sectionRange = sectionEnd - sectionStart;
  
  return sectionStart + (currentQuestion / totalQuestions) * sectionRange;
}
```

### Animations

**Transitions entre questions :**
- Type : `FadeTransition` + `SlideTransition`
- Dur√©e : 300ms
- Direction : Slide horizontal (‚Üí) pour avancer, (‚Üê) si retour

**Section intro :**
- Emoji : Scale animation (0.5 ‚Üí 1.0, 500ms, bounce)
- Texte : Fade-in s√©quentiel (200ms delay)

### Error Handling

**Cas 1 : Utilisateur ferme l'app pendant Section 2**
- R√©ponses sauvegard√©es dans Hive apr√®s chaque question
- Au retour : Reprendre √† la derni√®re question r√©pondue
- Indicateur de progression restaur√©

**Cas 2 : Utilisateur revient en arri√®re (swipe iOS)**
- Permettre le retour √† la question pr√©c√©dente
- R√©ponses pr√©c√©dentes pr√©-s√©lectionn√©es
- Progression bar mise √† jour en cons√©quence

### Source Tree

```
apps/mobile/lib/features/onboarding/
‚îú‚îÄ‚îÄ screens/
‚îÇ   ‚îú‚îÄ‚îÄ onboarding_screen.dart        # Main container (modifi√©)
‚îÇ   ‚îî‚îÄ‚îÄ questions/
‚îÇ       ‚îú‚îÄ‚îÄ section_transition.dart   # Nouveau
‚îÇ       ‚îú‚îÄ‚îÄ perspective_question.dart # Nouveau (Q5)
‚îÇ       ‚îú‚îÄ‚îÄ opinion_style_question.dart # Nouveau (Q6)
‚îÇ       ‚îú‚îÄ‚îÄ content_freshness_question.dart # Nouveau (Q7)
‚îÇ       ‚îú‚îÄ‚îÄ gamification_question.dart # Nouveau (Q8)
‚îÇ       ‚îî‚îÄ‚îÄ weekly_goal_question.dart # Nouveau (Q8b)
‚îú‚îÄ‚îÄ widgets/
‚îÇ   ‚îú‚îÄ‚îÄ selection_card.dart           # Existant (r√©utilis√©)
‚îÇ   ‚îú‚îÄ‚îÄ onboarding_progress_bar.dart  # Existant (r√©utilis√©)
‚îÇ   ‚îî‚îÄ‚îÄ reaction_screen.dart          # Existant (r√©utilis√©)
‚îî‚îÄ‚îÄ providers/
    ‚îî‚îÄ‚îÄ onboarding_provider.dart      # Modifi√© (ajout Section 2)
```

### Testing Strategy

**Widget Tests :**
- `test/features/onboarding/screens/section2_test.dart`
  - `test_section2_shows_correct_progress_indicator`
  - `test_perspective_question_stores_answer`
  - `test_reaction_screen_shows_correct_message`
  - `test_gamification_yes_shows_weekly_goal`
  - `test_gamification_no_skips_to_section3`
  - `test_weekly_goal_stores_correct_value`

**Integration Tests :**
- `test/features/onboarding/onboarding_flow_test.dart`
  - `test_complete_section2_with_gamification`
  - `test_complete_section2_without_gamification`
  - `test_section2_answers_persisted_in_hive`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 07/01/2026 | 1.0 | Story cr√©√©e via create-next-story task | BMad Dev Agent |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Completion Notes
La Section 2 "App Preferences" de l'onboarding a √©t√© compl√©t√©e avec succ√®s. Tous les √©crans et la logique ont √©t√© impl√©ment√©s :
- Les 6 questions de la Section 2 (Q5-Q8b) sont fonctionnelles
- La navigation conditionnelle (Q8b uniquement si gamification activ√©e) fonctionne correctement
- Le widget `SectionTransitionScreen` a √©t√© cr√©√© pour les transitions entre sections (optionnel)
- Les messages de r√©action personnalis√©s (R2) sont impl√©ment√©s dans `ReactionScreen`
- Le mod√®le `OnboardingAnswers` contient tous les champs n√©cessaires pour Section 2
- Le `OnboardingNotifier` g√®re correctement la logique de navigation et la sauvegarde Hive
- L'`OnboardingScreen` orchestre l'affichage de toutes les questions Section 2

**Note importante :** Lors de la v√©rification, il s'est av√©r√© que la Section 2 avait d√©j√† √©t√© largement impl√©ment√©e lors d'une session pr√©c√©dente. Seul le widget `SectionTransitionScreen` manquait et a √©t√© ajout√© pour compl√©ter la story selon les sp√©cifications.

### File List

**Fichiers cr√©√©s :**
- `apps/mobile/lib/features/onboarding/widgets/section_transition_screen.dart` (Nouveau widget de transition)

**Fichiers d√©j√† existants et v√©rifi√©s conformes :**
- `apps/mobile/lib/features/onboarding/screens/questions/perspective_question.dart` (Q5)
- `apps/mobile/lib/features/onboarding/screens/questions/response_style_question.dart` (Q6)
- `apps/mobile/lib/features/onboarding/screens/questions/content_recency_question.dart` (Q7)
- `apps/mobile/lib/features/onboarding/screens/questions/gamification_question.dart` (Q8)
- `apps/mobile/lib/features/onboarding/screens/questions/weekly_goal_question.dart` (Q8b)
- `apps/mobile/lib/features/onboarding/providers/onboarding_provider.dart` (Logique Section 2 compl√®te)
- `apps/mobile/lib/features/onboarding/screens/onboarding_screen.dart` (Navigation Section 2 compl√®te)
- `apps/mobile/lib/features/onboarding/widgets/reaction_screen.dart` (Messages R2 impl√©ment√©s)

**Tests :**
Les tests sont √† impl√©menter dans une story ult√©rieure selon la strat√©gie de test du projet.
