# Story 1.2: Setup Backend FastAPI + Supabase

## Status: Done ✅

## Story

**As a** développeur,  
**I want** un backend FastAPI connecté à Supabase,  
**so that** l'app puisse stocker et récupérer des données.

## Acceptance Criteria

1. ✅ Projet FastAPI initialisé avec structure de base (routers, models, services)
2. ✅ Connexion à Supabase PostgreSQL fonctionnelle
3. ✅ Route health-check `/api/health` retourne `{"status": "ok"}`
4. ✅ Variables d'environnement configurées (.env)
5. ✅ Documentation API auto-générée (Swagger UI)

## Tasks / Subtasks

- [x] Créer la structure `packages/api/app/`
  - [x] routers/ (8 routers)
  - [x] services/ (7 services)
  - [x] models/ (SQLAlchemy)
  - [x] schemas/ (Pydantic)
  - [x] workers/ (RSS sync)
  - [x] utils/
- [x] Créer `requirements.txt` et `pyproject.toml` (AC: 1)
- [x] Configurer `config.py` avec pydantic-settings (AC: 4)
- [x] Configurer `database.py` avec SQLAlchemy async (AC: 2)
- [x] Créer `main.py` avec FastAPI app (AC: 3, 5)
- [x] Implémenter tous les routers API
- [x] Implémenter tous les services métier
- [x] Créer le worker RSS sync avec APScheduler
- [x] Créer `scripts/setup_supabase.sql`

## Dev Notes

### Source Tree
```
packages/api/
├── app/
│   ├── main.py
│   ├── config.py
│   ├── database.py
│   ├── dependencies.py
│   ├── routers/
│   │   ├── auth.py
│   │   ├── users.py
│   │   ├── feed.py
│   │   ├── contents.py
│   │   ├── sources.py
│   │   ├── subscription.py
│   │   ├── streaks.py
│   │   └── webhooks.py
│   ├── services/
│   │   ├── user_service.py
│   │   ├── feed_service.py
│   │   ├── content_service.py
│   │   ├── source_service.py
│   │   ├── subscription_service.py
│   │   ├── streak_service.py
│   │   └── recommendation_service.py
│   ├── models/
│   ├── schemas/
│   ├── workers/
│   └── utils/
├── requirements.txt
├── pyproject.toml
├── Dockerfile
└── env.example
```

### Tech Stack
- FastAPI 0.109.x
- SQLAlchemy 2.0.x async
- psycopg (v3) - Pour stabilité PgBouncer
- Pydantic 2.6.x
- APScheduler 3.10.x
- feedparser 6.0.x

### API Endpoints créés
- `/api/health` - Health check
- `/api/auth/*` - Auth (placeholder, géré par Supabase client)
- `/api/users/*` - Profil, onboarding, stats
- `/api/feed` - Feed personnalisé
- `/api/contents/*` - CRUD contenus
- `/api/sources/*` - Gestion sources
- `/api/subscription` - État abonnement
- `/api/streaks` - Gamification
- `/api/webhooks/revenuecat` - Webhooks paiement

### ⚠️ Note importante
Python 3.12 requis (3.13+ non supporté par pydantic-core)

### Testing
- Framework: pytest 8.0.x + pytest-asyncio
- Localisation: `packages/api/tests/`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 07/01/2026 | 1.0 | Story créée et implémentée | Claude |
| 16/01/2026 | 1.1 | Ajustements production : Psycopg, Proxy Headers | Antigravity |

## Dev Agent Record

### Agent Model Used
Claude Opus 4

### Completion Notes
- 41 fichiers Python créés
- Architecture monolithe modulaire
- Algorithme de recommandation implémenté
- Worker RSS sync avec APScheduler
- Script SQL pour setup Supabase

### File List
- `packages/api/requirements.txt`
- `packages/api/pyproject.toml`
- `packages/api/Dockerfile`
- `packages/api/env.example`
- `packages/api/app/*.py` (4 fichiers core)
- `packages/api/app/routers/*.py` (8 routers)
- `packages/api/app/services/*.py` (7 services)
- `packages/api/app/models/*.py` (5 models)
- `packages/api/app/schemas/*.py` (7 schemas)
- `packages/api/app/workers/*.py` (3 fichiers)
- `packages/api/app/utils/*.py` (4 fichiers)
- `scripts/setup_supabase.sql`
- `scripts/import_sources.py`

