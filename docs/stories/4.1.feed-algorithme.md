# Story 4.1: Algorithme de tri et personnalisation

## Status: Ready ✅

## Story

**As a** utilisateur,  
**I want** voir un feed personnalisé selon mes préférences,  
**so that** les contenus les plus pertinents apparaissent en premier.

## Acceptance Criteria

1. Endpoint API `/api/feed` GET avec la logique de tri [Source: prd.md#Story 4.1]
2. Algorithme de scoring combinant :
    - **Thèmes préférés** (poids fort) [Source: prd.md#Story 4.1]
    - **Fraîcheur du contenu** (decay function) [Source: prd.md#Story 4.1]
    - **Type de contenu** (poids selon préférences) [Source: prd.md#Story 4.1]
3. **Filtrage** : Exclusion stricte des contenus vus (`ContentStatus.SEEN`, `CONSUMED`) et masqués (`HIDDEN`) [Source: prd.md#Story 4.1]
4. **Boost de Qualité (FQS)** : Les sources avec un `reliability_score` élevé ("High") reçoivent un bonus de visibilité SIGNIFICATIF (+15.0 pts), les rendant compétitives face aux sources suivies. [New]
5. **Pagination** : Support du limit/offset (par défaut 20 items) [Source: prd.md#Story 4.1]
6. **Diversité** : Prévenir la domination d'une source unique (Source Fatigue).
7. **Boost Visuel** : Les contenus avec une image de couverture reçoivent un bonus (+10). [New]


## Tasks / Subtasks

- [x] **Task 1: Service de Scoring (`RecommendationService`)**
  - [x] Calculer un `score` dynamique pour chaque contenu candidat.
  - [x] Implémenter la logique de poids (User Interest x Content Theme).
  - [x] Implémenter la dépréciation temporelle (Linear ou Exponential Decay).

- [x] **Task 2: Optimisation SQL**
  - [x] Créer une vue ou une requête optimisée pour joindre `Contents`, `UserSources`, `UserInterests`.
  - [x] Utiliser `NOT EXISTS` pour exclure efficacement les `UserContentStatus` existants.
  - [x] **Indexation** : Ajouter des index B-Tree sur `contents.published_at` et `contents.source_id` pour garantir un tri rapide (O(log n)).

- [ ] **Task 3: API Endpoint**
  - [ ] Implémenter `GET /api/feed` dans `routers/feed.py`.
  - [ ] Intégrer la pagination.

## Dev Notes

### Architecture Modulaire (V2)
L'algorithme utilise un `ScoringEngine` qui orchestre plusieurs couches (`BaseScoringLayer`) indépendantes.

#### 1. Couches de Scoring (`layers/`)
- **CoreLayer (V1)** : Logique de base.
    - **Theme Match** : Facteur Dominant (+70.0). Les sujets d'intérêt priment sur tout.
    - **Followed Source** : Signal fort (+30.0).
    - **Recency** : Decay temporel classique (max +30.0).
- **StaticPreferenceLayer** : Exploite le profil utilisateur issu de l'onboarding.
    - Bonus sur le `formatPreference` (ex: "Sujet court").
    - Ajustement du decay selon `contentRecency` préféré.
- **BehavioralLayer** : Adaptation dynamique selon la consommation réelle.
    - Bonus/Malus sur le poids des intérêts (`UserInterest.weight`) ajusté lors de la consommation.
- **QualityLayer (New)** : Encourage la consommation de sources fiables.
    - `ReliabilityScore.HIGH` = Bonus Score x 1.2 -> AJUSTÉ : Bonus Fixe +15.0 (Global Trust).
    - `ReliabilityScore.LOW` = Malus Score x 0.8 -> AJUSTÉ : Malus Fixe -30.0.
- **VisualLayer (New)** : Améliore l'attractivité du feed.
    - Présence d'une image = Bonus `IMAGE_BOOST` (+10.0)

#### 2. Transparence (`recommendation_reason`)
Le `RecommendationService` synthétise les scores pour générer un libellé humain (ex: "Sujet passionnant : Tech") basé sur la couche ayant eu le plus d'impact.

#### 3. Diversité (Reranking)
Pour éviter la saturation, une pénalité exponentielle est appliquée lors du tri final :
`FinalScore = Score * (PenaltyFactor ^ RepeatCount)`
- **PenaltyFactor** : ~0.85
- **RepeatCount** : Nombre de fois où la source est déjà apparue dans la liste ordonnée.

## Testing
- **Unit Tests** : `tests/test_scoring_v2.py` (Moteur modulaire) et `tests/test_perspective_service.py` (Exclusion Perspectives).
- **Validation Script** : `scripts/validate_personas.py` pour simuler des personas et valider les pondérations (Theme > Followed > Trust).

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 10/01/2026 | 1.0 | Initial Draft | BMad Master Agent |
| 11/01/2026 | 1.1 | Ajout de la logique de Diversité (Source Fatigue) | Antigravity |
| 13/01/2026 | 1.2 | Ajout du VisualLayer (Image Boost) | Antigravity |
| 18/01/2026 | 1.3 | Ajout détails techniques indexation (Performance fix) | Antigravity |
| 18/01/2026 | 1.4 | Ajustement Pondérations (Theme++ et Global Trust++) | Antigravity |
| 19/01/2026 | 1.5 | FIX Theme Matching (ThemeMapper implemented) | Antigravity |

