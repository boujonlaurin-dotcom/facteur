# Story 2.2c : Onboarding avec Sous-ThÃ¨mes (MAJ)

## Status: Ready (To Do)

## Story

**As a** nouvel utilisateur,  
**I want** prÃ©ciser mes intÃ©rÃªts via sous-thÃ¨mes lors de l'onboarding,  
**so that** mes recommendations soient plus prÃ©cises dÃ¨s le dÃ©part.

## Background

Modification de la Story 2.2c existante pour intÃ©grer les sous-thÃ¨mes granulaires. L'UX proposÃ©e utilise des "tags enfants" qui apparaissent sous chaque thÃ¨me macro sÃ©lectionnÃ©.

## Acceptance Criteria

1. **UX "Tags Enfants"** : Au clic sur un thÃ¨me macro, 3-4 sous-thÃ¨mes apparaissent comme tags cliquables
2. **Multi-sÃ©lection optionnelle** : User peut sÃ©lectionner 0-N sous-thÃ¨mes (pas obligatoire)
3. **UI fluide** : Transitions douces, max 2 lignes de tags visuellement distincts
4. **Backend API modifiÃ©e** : Accepter `subtopics` en plus de `themes` dans `OnboardingAnswers`
5. **Stockage** : Backend stocke dans nouvelle table `user_subtopics`

## Dev Notes

### Mobile - UI Component

```dart
// lib/features/onboarding/widgets/theme_with_subtopics.dart

class ThemeWithSubtopics extends StatefulWidget {
  final ThemeOption theme;
  final List<SubtopicOption> subtopics;
  final bool isSelected;
  final List<String> selectedSubtopics;
  final Function(String theme, List<String> subtopics) onChanged;
  
  // ...
}

class _ThemeWithSubtopicsState extends State<ThemeWithSubtopics> {
  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // ThÃ¨me principal (card cliquable)
        GestureDetector(
          onTap: () => widget.onChanged(
            widget.theme.slug, 
            widget.selectedSubtopics
          ),
          child: ThemeCard(
            theme: widget.theme,
            isSelected: widget.isSelected,
          ),
        ),
        
        // Sous-thÃ¨mes (tags enfants, apparaissent si thÃ¨me sÃ©lectionnÃ©)
        if (widget.isSelected)
          AnimatedOpacity(
            opacity: 1.0,
            duration: Duration(milliseconds: 300),
            child: Padding(
              padding: EdgeInsets.only(left: 16, top: 8),
              child: Wrap(
                spacing: 8,
                runSpacing: 8,
                children: widget.subtopics.map((subtopic) {
                  final isSelected = widget.selectedSubtopics.contains(subtopic.slug);
                  
                  return SubtopicChip(
                    label: subtopic.label,
                    isSelected: isSelected,
                    onTap: () {
                      final newSubtopics = List<String>.from(widget.selectedSubtopics);
                      if (isSelected) {
                        newSubtopics.remove(subtopic.slug);
                      } else {
                        newSubtopics.add(subtopic.slug);
                      }
                      widget.onChanged(widget.theme.slug, newSubtopics);
                    },
                  );
                }).toList(),
              ),
            ),
          ),
      ],
    );
  }
}

class SubtopicChip extends StatelessWidget {
  final String label;
  final bool isSelected;
  final VoidCallback onTap;
  
  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        padding: EdgeInsets.symmetric(horizontal: 12, vertical: 6),
        decoration: BoxDecoration(
          color: isSelected 
            ? Theme.of(context).colorScheme.primaryContainer
            : Theme.of(context).colorScheme.surfaceVariant,
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: isSelected
              ? Theme.of(context).colorScheme.primary
              : Colors.transparent,
            width: 1.5,
          ),
        ),
        child: Text(
          label,
          style: Theme.of(context).textTheme.labelSmall?.copyWith(
            color: isSelected
              ? Theme.of(context).colorScheme.onPrimaryContainer
              : Theme.of(context).colorScheme.onSurfaceVariant,
          ),
        ),
      ),
    );
  }
}
```

### DonnÃ©es Sous-ThÃ¨mes par ThÃ¨me

```dart
// lib/features/onboarding/data/subtopics.dart

class SubtopicOption {
  final String slug;
  final String label;
  
  const SubtopicOption({required this.slug, required this.label});
}

class AvailableSubtopics {
  static final Map<String, List<SubtopicOption>> byTheme = {
    'tech': [
      SubtopicOption(slug: 'ai', label: 'IA & Machine Learning'),
      SubtopicOption(slug: 'crypto', label: 'Crypto & Web3'),
      SubtopicOption(slug: 'space', label: 'Spatial'),
      SubtopicOption(slug: 'cybersecurity', label: 'CybersÃ©curitÃ©'),
    ],
    'society': [
      SubtopicOption(slug: 'social-justice', label: 'Justice sociale'),
      SubtopicOption(slug: 'health', label: 'SantÃ©'),
      SubtopicOption(slug: 'education', label: 'Ã‰ducation'),
      SubtopicOption(slug: 'housing', label: 'Logement'),
    ],
    'environment': [
      SubtopicOption(slug: 'climate', label: 'Climat'),
      SubtopicOption(slug: 'biodiversity', label: 'BiodiversitÃ©'),
      SubtopicOption(slug: 'energy-transition', label: 'Transition Ã©nergÃ©tique'),
    ],
    // ... 5 autres thÃ¨mes avec 3-4 subtopics chacun
  };
}
```

### State Management

```dart
// lib/features/onboarding/providers/onboarding_provider.dart

class OnboardingAnswers {
  final List<String>? themes;
  final List<String>? subtopics;  // â† NOUVEAU
  // ... other fields
  
  OnboardingAnswers copyWith({
    List<String>? themes,
    List<String>? subtopics,
    // ...
  }) {
    return OnboardingAnswers(
      themes: themes ?? this.themes,
      subtopics: subtopics ?? this.subtopics,
      // ...
    );
  }
  
  Map<String, dynamic> toJson() => {
    'themes': themes,
    'subtopics': subtopics,  // â† NOUVEAU
    // ...
  };
}

// MÃ©thode de sÃ©lection
void selectThemeWithSubtopics(String theme, List<String> subtopics) {
  final currentThemes = state.answers.themes ?? [];
  final currentSubtopics = state.answers.subtopics ?? [];
  
  final newThemes = [...currentThemes];
  if (!newThemes.contains(theme)) {
    newThemes.add(theme);
  }
  
  // Merge subtopics
  final newSubtopics = [...currentSubtopics];
  for (final subtopic in subtopics) {
    if (!newSubtopics.contains(subtopic)) {
      newSubtopics.add(subtopic);
    }
  }
  
  state = state.copyWith(
    answers: state.answers.copyWith(
      themes: newThemes,
      subtopics: newSubtopics,
    ),
  );
  _saveAnswers();
}
```

### Backend - API Schema

```python
# app/schemas/user.py

class OnboardingAnswers(BaseModel):
    # ... existing fields
    themes: Optional[list[str]] = Field(default_factory=list)
    subtopics: Optional[list[str]] = Field(default_factory=list, description="Topics granulaires sÃ©lectionnÃ©s")  # â† NOUVEAU
    # ...
```

### Backend - Service

```python
# app/services/user_service.py

async def save_onboarding(self, user_id: str, answers: OnboardingAnswers) -> dict:
    # ... existing logic pour themes â†’ user_interests
    
    # Nouveau : Sauvegarder subtopics
    subtopic_count = 0
    if answers.subtopics:
        for topic_slug in answers.subtopics:
            subtopic = UserSubtopic(
                id=uuid4(),
                user_id=UUID(user_id),
                topic_slug=topic_slug,
                weight=1.0,
            )
            self.db.add(subtopic)
            subtopic_count += 1
    
    await self.db.flush()
    return {
        "profile": profile,
        "interests_created": interest_count,
        "subtopics_created": subtopic_count,  # â† NOUVEAU
        "preferences_created": pref_count,
    }
```

## UX Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Question : Tes thÃ¨mes d'intÃ©rÃªt ?       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  [ğŸ’» Tech & Innovation]  â† sÃ©lectionnÃ© â”‚
â”‚    â””â”€ #IA  #Crypto  #Espace  #Cyber    â”‚  â† Tags enfants (3-4 max)
â”‚                                         â”‚
â”‚  [ğŸ‘¥ SociÃ©tÃ© & Vie]  â† non sÃ©lectionnÃ© â”‚
â”‚                                         â”‚
â”‚  [ğŸŒ¿ Environnement & Climat]  â† sÃ©lect.â”‚
â”‚    â””â”€ #Climat  #BiodiversitÃ©  #Ã‰nergie â”‚
â”‚                                         â”‚
â”‚  [...5 autres thÃ¨mes...]                â”‚
â”‚                                         â”‚
â”‚             [Continuer â†’]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Testing

### Test Mobile

```dart
// test/features/onboarding/theme_with_subtopics_test.dart

testWidgets('Sous-thÃ¨mes apparaissent au clic thÃ¨me', (tester) async {
  await tester.pumpWidget(/* ThemeWithSubtopics */);
  
  // Clic sur thÃ¨me
  await tester.tap(find.byType(ThemeCard));
  await tester.pumpAndSettle();
  
  // VÃ©rifier tags enfants visibles
  expect(find.byType(SubtopicChip), findsNWidgets(4));
});

testWidgets('SÃ©lection sous-thÃ¨me ajoute au state', (tester) async {
  // ...
  await tester.tap(find.text('IA & Machine Learning'));
  
  final provider = container.read(onboardingProvider);
  expect(provider.answers.subtopics, contains('ai'));
});
```

### Test Backend

```python
# tests/test_user_service.py

async def test_save_onboarding_with_subtopics():
    answers = OnboardingAnswers(
        themes=['tech', 'environment'],
        subtopics=['ai', 'climate', 'crypto'],
        # ...
    )
    
    result = await user_service.save_onboarding(user_id, answers)
    
    assert result['subtopics_created'] == 3
    
    # VÃ©rifier BDD
    subtopics = await session.execute(
        select(UserSubtopic).where(UserSubtopic.user_id == user_id)
    )
    assert len(list(subtopics)) == 3
```

## Effort & Priority

- **Effort :** 5 points (3-4 jours)
- **Priority :** ğŸŸ¢ MEDIUM (amÃ©liore UX mais pas bloquant)
- **Sprint :** +2 (parallÃ¨le Ã  4.1d)

## Dependencies

- **BloquÃ© par :** Story 4.1c (table `user_subtopics` doit exister)
- **ParallÃ¨le avec :** Story 4.1d (classification)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 19/01/2026 | 2.0 | MAJ avec sous-thÃ¨mes granulaires (UX tags enfants) | Antigravity |
