# Story 3.1: Modèle de données Sources & Contenus

## Status: Ready ✅

## Story

**As a** développeur,  
**I want** un modèle de données pour les sources et leurs contenus,  
**so that** l'app puisse stocker et servir les articles/podcasts/vidéos.

## Acceptance Criteria

1. Table `sources` créée : id, name, url, feed_url, type, theme, description, logo_url, is_curated, is_active, last_synced_at, created_at [Source: architecture.md#4.1]
2. Table `contents` créée : id, source_id, title, url, thumbnail_url, description, published_at, duration_seconds, content_type, guid, created_at [Source: architecture.md#4.1]
3. Table `user_sources` créée : user_id, source_id, is_custom, added_at [Source: architecture.md#4.1]
4. Table `user_content_status` créée : user_id, content_id, status, seen_at, time_spent_seconds, created_at, updated_at [Source: architecture.md#4.1]
5. Enumerations configurées pour `type`, `content_type` et `status` [Source: architecture.md#4.2]
6. Row Level Security (RLS) configuré pour assurer que les utilisateurs ne voient que leurs `user_sources` et `user_content_status`
7. Modèles Pydantic et SQLAlchemy créés dans le backend FastAPI

## Tasks / Subtasks

- [ ] **Task 1: SQL Migrations (PostgreSQL/Supabase)** (AC: 1-6)
  - [ ] Créer les types enum (`source_type`, `content_status`)
  - [ ] Créer la table `sources` avec index sur `is_active` et `is_curated`
  - [ ] Créer la table `contents` avec FK vers `sources(id)` et index sur `guid` pour déduplication
  - [ ] Créer la table `user_sources` avec FK vers `users(id)` et `sources(id)`
  - [ ] Créer la table `user_content_status` avec FK vers `users(id)` et `contents(id)`
  - [ ] Configurer RLS : 
    - `sources` et `contents` : Lectures publiques ou pour utilisateurs authentifiés
    - `user_sources` et `user_content_status` : `(user_id = auth.uid())`
  - [Source: architecture.md#4.1, 4.2]

- [ ] **Task 2: Backend Models (SQLAlchemy)** (AC: 7)
  - [ ] Définir les modèles SQLAlchemy dans `packages/api/models/`
  - [ ] Configurer les relations (`relationship`) entre Source, Content, et les tables de liaison
  - [ ] S'assurer que les types correspondent à la structure PG
  - [Source: architecture.md#3.2]

- [ ] **Task 3: Backend DTOs (Pydantic)** (AC: 7)
  - [ ] Créer les schémas Pydantic pour l'I/O API dans `packages/api/schemas/`
  - [ ] Schémas pour `SourceRead`, `ContentRead`, `UserContentStatusUpdate`
  - [Source: architecture.md#3.2]

- [ ] **Task 4: Basic CRUD Service & Endpoints** (AC: Optional but recommended)
  - [ ] Implémenter un service de base pour interroger les sources et contenus
  - [ ] (Note: Le feed complexe sera géré dans l'Epic 4)

## Dev Notes

### Architecture Context

#### Data Models [Source: architecture.md#4.1, 4.2]

**Table: `sources`**
| Attribut | Type |
|----------|------|
| `id` | UUID PK |
| `name` | string |
| `url` | string |
| `feed_url` | string |
| `type` | enum ("article", "podcast", "youtube") |
| `theme` | string |
| `description` | string |
| `logo_url` | string |
| `is_curated` | boolean |
| `is_active` | boolean |
| `score_independence` | float (nullable) |
| `score_rigor` | float (nullable) |
| `score_ux` | float (nullable) |
| `last_synced_at` | timestamp |

**Table: `contents`**
| Attribut | Type |
|----------|------|
| `id` | UUID PK |
| `source_id` | UUID FK |
| `title` | string |
| `url` | string |
| `thumbnail_url` | string |
| `description` | text |
| `published_at` | timestamp |
| `duration_seconds` | int |
| `content_type` | enum ("article", "podcast", "youtube") |
| `guid` | string |

**Table: `user_content_status`**
| Status |
|--------|
| `unseen` |
| `seen` |
| `consumed` |
| `saved` |
| `hidden` |

### Technical Constraints [Source: architecture.md#3.2]

- SQLAlchemy 2.0 async pour les modèles backend.
- Pydantic 2.6 pour la validation.
- Déduplication obligatoire via le champ `guid` dans la table `contents`.

### Project Structure Alignment [Source: architecture.md#2.2]

- Migration SQL à appliquer via la console Supabase ou scripts de migration.
- Modèles Python dans `packages/api/models`.
- Schémas Pydantic dans `packages/api/schemas`.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 10/01/2026 | 1.0 | Initial Draft | BMad Master Agent |
