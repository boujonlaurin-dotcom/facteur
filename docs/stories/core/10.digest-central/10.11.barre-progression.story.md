# Story 10.11 : Barre de Progression (X/5)

## Status: Draft

## Story

**As a** utilisateur,  
**I want** voir ma progression vers la closure,  
**so that** je sache combien d'articles il me reste à traiter.

## Acceptance Criteria

1. **Affichage "X/5"** avec indicateur visuel
2. **Barre de progression** animée
3. **Messages contextuels** selon la progression :
   - 0/5 : "C'est parti !"
   - 1-2/5 : "Bon début"
   - 3-4/5 : "Encore un peu..."
   - 5/5 : "Bravo !" (avant transition vers closure)
4. **Animation** de remplissage à chaque action
5. **Position fixe** en haut de l'écran (sous le header)

## Tasks / Subtasks

### Frontend Mobile

- [ ] **Task 1: Créer le widget `DigestProgressBar`**
  - [ ] Fichier `apps/mobile/lib/features/digest/widgets/digest_progress_bar.dart`
  - [ ] Props : `current`, `total`

- [ ] **Task 2: Implémenter le design**
  - [ ] Container avec fond sombre
  - [ ] Barre de remplissage (accent color)
  - [ ] Texte "X/5" centré
  - [ ] Message contextuel sous la barre

- [ ] **Task 3: Ajouter les animations**
  - [ ] AnimatedContainer pour la largeur
  - [ ] Transition de couleur proche de 5/5

- [ ] **Task 4: Messages contextuels**
  - [ ] Logique de sélection du message
  - [ ] Animation de texte (fade)

## Dev Notes

### Widget DigestProgressBar

```dart
// apps/mobile/lib/features/digest/widgets/digest_progress_bar.dart

import 'package:flutter/material.dart';

class DigestProgressBar extends StatelessWidget {
  final int current;
  final int total;

  const DigestProgressBar({
    super.key,
    required this.current,
    required this.total,
  });

  double get progress => total > 0 ? current / total : 0;

  String get message {
    if (current == 0) return "C'est parti !";
    if (current < total / 2) return "Bon début";
    if (current < total) return "Encore un peu...";
    return "Bravo !";
  }

  Color _getProgressColor(BuildContext context) {
    if (progress >= 1) return Colors.green;
    if (progress >= 0.6) return Colors.orange;
    return Theme.of(context).colorScheme.primary;
  }

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final progressColor = _getProgressColor(context);

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
      color: Colors.black.withOpacity(0.3),
      child: Column(
        children: [
          // Barre de progression
          Stack(
            children: [
              // Background
              Container(
                height: 8,
                decoration: BoxDecoration(
                  color: Colors.grey[800],
                  borderRadius: BorderRadius.circular(4),
                ),
              ),
              
              // Progress fill
              AnimatedContainer(
                duration: const Duration(milliseconds: 400),
                curve: Curves.easeOutCubic,
                height: 8,
                width: MediaQuery.of(context).size.width * progress * 0.9,
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [
                      progressColor,
                      progressColor.withOpacity(0.8),
                    ],
                  ),
                  borderRadius: BorderRadius.circular(4),
                  boxShadow: [
                    BoxShadow(
                      color: progressColor.withOpacity(0.4),
                      blurRadius: 8,
                      offset: const Offset(0, 2),
                    ),
                  ],
                  color: progressColor,
                ),
              ),
            ],
          ),
          
          const SizedBox(height: 8),
          
          // Texte progression + message
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              // Message contextuel
              AnimatedSwitcher(
                duration: const Duration(milliseconds: 200),
                child: Text(
                  message,
                  key: ValueKey(message),
                  style: theme.textTheme.bodySmall?.copyWith(
                    color: Colors.grey[400],
                  ),
                ),
              ),
              
              // Compteur X/5
              Row(
                children: [
                  Text(
                    '$current',
                    style: theme.textTheme.titleMedium?.copyWith(
                      fontWeight: FontWeight.bold,
                      color: progressColor,
                    ),
                  ),
                  Text(
                    '/$total',
                    style: theme.textTheme.titleMedium?.copyWith(
                      color: Colors.grey[500],
                    ),
                  ),
                ],
              ),
            ],
          ),
        ],
      ),
    );
  }
}
```

### Intégration dans DigestScreen

```dart
// Dans DigestContent (digest_screen.dart)

@override
Widget build(BuildContext context) {
  return Column(
    children: [
      // Header avec date et temps
      DigestHeader(...),
      
      // Barre de progression (fixe)
      DigestProgressBar(
        current: digest.itemsActioned,
        total: digest.totalItems,
      ),
      
      // Liste des articles (scrollable)
      Expanded(
        child: ListView.builder(...),
      ),
      
      // ...
    ],
  );
}
```

### Animation avancée (optionnel)

```dart
// Animation de pulse à chaque incrément

class DigestProgressBar extends StatefulWidget {
  // ...

  @override
  State<DigestProgressBar> createState() => _DigestProgressBarState();
}

class _DigestProgressBarState extends State<DigestProgressBar>
    with SingleTickerProviderStateMixin {
  late AnimationController _pulseController;
  int _previousCurrent = 0;

  @override
  void initState() {
    super.initState();
    _pulseController = AnimationController(
      duration: const Duration(milliseconds: 300),
      vsync: this,
    );
    _previousCurrent = widget.current;
  }

  @override
  void didUpdateWidget(DigestProgressBar oldWidget) {
    super.didUpdateWidget(oldWidget);
    
    // Déclencher le pulse si progression
    if (widget.current > _previousCurrent) {
      _pulseController.forward().then((_) => _pulseController.reverse());
      _previousCurrent = widget.current;
    }
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _pulseController,
      builder: (context, child) {
        return Transform.scale(
          scale: 1.0 + (_pulseController.value * 0.05),
          child: child,
        );
      },
      child: // ... widget existant
    );
  }
}
```

### Références Architecture

- [Source: 5.5.barre-progression-hebdo.md] — Barre progression existante

## Testing

- **Widget Tests** : `test/features/digest/progress_bar_test.dart`
  - Test affichage 0/5
  - Test animation vers 3/5
  - Test message correct à chaque étape

## Definition of Done

- [ ] DigestProgressBar créé
- [ ] Animation de remplissage fluide
- [ ] Messages contextuels corrects
- [ ] Intégré dans DigestScreen

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 31/01/2026 | 1.0 | Création story | BMad Master |
