# Story 10.10 : Carte Article avec Actions Lu/Sauvegard√©

## Status: Draft

## Story

**As a** utilisateur,  
**I want** voir des cartes d'articles avec des boutons d'action clairs,  
**so that** je puisse rapidement marquer chaque article comme lu ou sauvegard√©.

## Acceptance Criteria

1. **Design de carte** diff√©rent des FeedCards (plus compact, focus sur l'action)
2. **Deux boutons d'action** visibles :
   - "Lu ‚úì" (action primaire)
   - "Plus tard üìñ" (action secondaire)
3. **√âtats visuels** :
   - Pending : carte normale, boutons actifs
   - Read : carte att√©nu√©e (opacity 0.6), badge ‚úì vert
   - Saved : carte att√©nu√©e, badge üìñ orange
4. **Animation** de transition entre √©tats
5. **Tap sur carte** ouvre l'√©cran d√©tail (comme FeedCard)
6. **Badge de rang** (#1, #2, #3...) visible
7. **Tag `digest_reason`** affich√© ("√Ä la Une", "Sujet tendance"...)

## Tasks / Subtasks

### Frontend Mobile

- [ ] **Task 1: Cr√©er le widget `DigestCard`**
  - [ ] Fichier `apps/mobile/lib/features/digest/widgets/digest_card.dart`
  - [ ] Props : `DigestItem`, `onAction`, `onTap`

- [ ] **Task 2: Impl√©menter le layout**
  - [ ] Badge de rang en top-left
  - [ ] Thumbnail (si disponible) en header
  - [ ] Titre + source + dur√©e en body
  - [ ] Tag digest_reason
  - [ ] Boutons d'action en footer

- [ ] **Task 3: Cr√©er les boutons d'action**
  - [ ] Widget `DigestActionButton` r√©utilisable
  - [ ] Deux variantes : primary (Lu) et secondary (Plus tard)
  - [ ] √âtats : enabled, disabled, loading

- [ ] **Task 4: Impl√©menter les √©tats visuels**
  - [ ] Pending : normal
  - [ ] Read : opacity 0.6, badge ‚úì
  - [ ] Saved : opacity 0.6, badge üìñ

- [ ] **Task 5: Ajouter les animations**
  - [ ] AnimatedOpacity pour la transition
  - [ ] AnimatedScale pour le badge d'√©tat

- [ ] **Task 6: Int√©grer avec DigestScreen**
  - [ ] Appeler `digestProvider.actionItem()` sur action
  - [ ] Navigation vers ContentDetailScreen sur tap

## Dev Notes

### Widget DigestCard

```dart
// apps/mobile/lib/features/digest/widgets/digest_card.dart

import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

class DigestCard extends ConsumerStatefulWidget {
  final DigestItem item;
  final VoidCallback? onTap;

  const DigestCard({
    super.key,
    required this.item,
    this.onTap,
  });

  @override
  ConsumerState<DigestCard> createState() => _DigestCardState();
}

class _DigestCardState extends ConsumerState<DigestCard> 
    with SingleTickerProviderStateMixin {
  late AnimationController _animationController;
  bool _isLoading = false;

  @override
  void initState() {
    super.initState();
    _animationController = AnimationController(
      duration: const Duration(milliseconds: 300),
      vsync: this,
    );
  }

  bool get isActioned => widget.item.status != 'pending';

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final content = widget.item.content;

    return AnimatedOpacity(
      opacity: isActioned ? 0.6 : 1.0,
      duration: const Duration(milliseconds: 300),
      child: Card(
        margin: const EdgeInsets.symmetric(vertical: 8),
        child: InkWell(
          onTap: widget.onTap,
          borderRadius: BorderRadius.circular(12),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Header avec thumbnail et badge rang
              _buildHeader(content),
              
              // Body avec titre et source
              _buildBody(content, theme),
              
              // Footer avec actions
              if (!isActioned) _buildActions(),
              
              // Badge d'√©tat si actionn√©
              if (isActioned) _buildStatusBadge(),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildHeader(ContentSummary content) {
    return Stack(
      children: [
        // Thumbnail
        if (content.thumbnailUrl != null)
          ClipRRect(
            borderRadius: const BorderRadius.vertical(top: Radius.circular(12)),
            child: AspectRatio(
              aspectRatio: 16 / 9,
              child: Image.network(
                content.thumbnailUrl!,
                fit: BoxFit.cover,
                errorBuilder: (_, __, ___) => Container(
                  color: Colors.grey[800],
                  child: const Icon(Icons.article, size: 48),
                ),
              ),
            ),
          ),
        
        // Badge rang
        Positioned(
          top: 8,
          left: 8,
          child: Container(
            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
            decoration: BoxDecoration(
              color: Theme.of(context).colorScheme.primary,
              borderRadius: BorderRadius.circular(16),
            ),
            child: Text(
              '#${widget.item.rank}',
              style: const TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.bold,
                fontSize: 12,
              ),
            ),
          ),
        ),
        
        // Badge √©tat (si actionn√©)
        if (isActioned)
          Positioned(
            top: 8,
            right: 8,
            child: AnimatedScale(
              scale: isActioned ? 1.0 : 0.0,
              duration: const Duration(milliseconds: 200),
              child: _buildStatusIcon(),
            ),
          ),
      ],
    );
  }

  Widget _buildBody(ContentSummary content, ThemeData theme) {
    return Padding(
      padding: const EdgeInsets.all(12),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Tag digest_reason
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
            decoration: BoxDecoration(
              color: _getReasonColor().withOpacity(0.2),
              borderRadius: BorderRadius.circular(4),
            ),
            child: Text(
              widget.item.digestReason,
              style: TextStyle(
                color: _getReasonColor(),
                fontSize: 10,
                fontWeight: FontWeight.w600,
              ),
            ),
          ),
          const SizedBox(height: 8),
          
          // Titre
          Text(
            content.title,
            style: theme.textTheme.titleMedium?.copyWith(
              fontWeight: FontWeight.w600,
            ),
            maxLines: 2,
            overflow: TextOverflow.ellipsis,
          ),
          const SizedBox(height: 8),
          
          // Source + dur√©e
          Row(
            children: [
              // Logo source
              if (content.source.logoUrl != null)
                ClipRRect(
                  borderRadius: BorderRadius.circular(4),
                  child: Image.network(
                    content.source.logoUrl!,
                    width: 16,
                    height: 16,
                  ),
                ),
              const SizedBox(width: 6),
              Text(
                content.source.name,
                style: theme.textTheme.bodySmall?.copyWith(
                  color: Colors.grey[400],
                ),
              ),
              const Spacer(),
              Icon(
                _getContentTypeIcon(),
                size: 14,
                color: Colors.grey[400],
              ),
              const SizedBox(width: 4),
              Text(
                _formatDuration(content.durationSeconds),
                style: theme.textTheme.bodySmall?.copyWith(
                  color: Colors.grey[400],
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildActions() {
    return Padding(
      padding: const EdgeInsets.fromLTRB(12, 0, 12, 12),
      child: Row(
        children: [
          // Bouton Lu (primaire)
          Expanded(
            child: DigestActionButton(
              label: 'Lu',
              icon: Icons.check,
              isPrimary: true,
              isLoading: _isLoading,
              onPressed: () => _handleAction('read'),
            ),
          ),
          const SizedBox(width: 12),
          
          // Bouton Plus tard (secondaire)
          Expanded(
            child: DigestActionButton(
              label: 'Plus tard',
              icon: Icons.bookmark_outline,
              isPrimary: false,
              isLoading: _isLoading,
              onPressed: () => _handleAction('saved'),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildStatusBadge() {
    final isRead = widget.item.status == 'read';
    
    return Padding(
      padding: const EdgeInsets.fromLTRB(12, 0, 12, 12),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(
            isRead ? Icons.check_circle : Icons.bookmark,
            color: isRead ? Colors.green : Colors.orange,
            size: 18,
          ),
          const SizedBox(width: 6),
          Text(
            isRead ? 'Lu' : 'Sauvegard√©',
            style: TextStyle(
              color: isRead ? Colors.green : Colors.orange,
              fontWeight: FontWeight.w500,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildStatusIcon() {
    final isRead = widget.item.status == 'read';
    
    return Container(
      padding: const EdgeInsets.all(6),
      decoration: BoxDecoration(
        color: isRead ? Colors.green : Colors.orange,
        shape: BoxShape.circle,
      ),
      child: Icon(
        isRead ? Icons.check : Icons.bookmark,
        color: Colors.white,
        size: 16,
      ),
    );
  }

  Future<void> _handleAction(String action) async {
    setState(() => _isLoading = true);
    
    try {
      await ref.read(digestProvider.notifier).actionItem(
        widget.item.content.id,
        action,
      );
    } finally {
      if (mounted) {
        setState(() => _isLoading = false);
      }
    }
  }

  Color _getReasonColor() {
    switch (widget.item.digestReason) {
      case '√Ä la Une':
        return Colors.red;
      case 'Sujet tendance':
        return Colors.orange;
      case 'Th√®me favori':
        return Colors.blue;
      case 'Suggestion qualit√©':
        return Colors.purple;
      default:
        return Colors.grey;
    }
  }

  IconData _getContentTypeIcon() {
    switch (widget.item.content.contentType) {
      case 'podcast':
        return Icons.headphones;
      case 'youtube':
        return Icons.play_circle_outline;
      default:
        return Icons.article;
    }
  }

  String _formatDuration(int? seconds) {
    if (seconds == null) return '3 min';
    final minutes = (seconds / 60).round();
    return '$minutes min';
  }
}
```

### DigestActionButton

```dart
// apps/mobile/lib/features/digest/widgets/digest_action_button.dart

class DigestActionButton extends StatelessWidget {
  final String label;
  final IconData icon;
  final bool isPrimary;
  final bool isLoading;
  final VoidCallback onPressed;

  const DigestActionButton({
    super.key,
    required this.label,
    required this.icon,
    required this.isPrimary,
    this.isLoading = false,
    required this.onPressed,
  });

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    
    return ElevatedButton.icon(
      onPressed: isLoading ? null : onPressed,
      style: ElevatedButton.styleFrom(
        backgroundColor: isPrimary 
            ? theme.colorScheme.primary 
            : Colors.grey[800],
        foregroundColor: Colors.white,
        padding: const EdgeInsets.symmetric(vertical: 12),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(8),
        ),
      ),
      icon: isLoading 
          ? const SizedBox(
              width: 16,
              height: 16,
              child: CircularProgressIndicator(
                strokeWidth: 2,
                color: Colors.white,
              ),
            )
          : Icon(icon, size: 18),
      label: Text(label),
    );
  }
}
```

### R√©f√©rences Architecture

- [Source: feed_card.dart] ‚Äî Design de carte existant
- [Source: phosphor_flutter] ‚Äî Ic√¥nes

## Testing

- **Widget Tests** : `test/features/digest/digest_card_test.dart`
  - Test affichage √©tat pending
  - Test transition vers read
  - Test transition vers saved
  - Test tap sur carte

## Definition of Done

- [ ] DigestCard cr√©√© avec design distinct
- [ ] Boutons Lu/Plus tard fonctionnels
- [ ] √âtats visuels impl√©ment√©s
- [ ] Animations fluides
- [ ] Int√©gration avec provider

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 31/01/2026 | 1.0 | Cr√©ation story | BMad Master |
