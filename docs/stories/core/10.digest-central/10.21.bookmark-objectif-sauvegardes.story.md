# Story 10.21: Bookmark valide l'objectif du jour + écran "Sauvegardés"

## Status: Draft

## Story

**As a** utilisateur du digest quotidien,
**I want** que sauvegarder un article (bookmark) compte comme une interaction dans ma progression du jour, et pouvoir consulter mes articles sauvegardés dans un écran dédié,
**so that** je puisse trier rapidement mon digest tout en gardant des articles pour plus tard, sans perdre ma progression.

## Acceptance Criteria

1. **Bookmark = objectif validé** : sauvegarder un article dans le digest incrémente le compteur de progression (ex: 2/7 → 3/7)
2. Le bookmark est **déjà compté comme interaction** dans la logique existante (`isSaved` fait partie de `processedCount`) — **vérifier que c'est bien le cas**
3. Un **écran "Mes sauvegardés"** affiche la liste des articles bookmarkés, triés par date de sauvegarde (récents en premier)
4. L'écran "Sauvegardés" est accessible depuis la **navigation principale** (bottom nav ou profil)
5. Chaque article sauvegardé affiche : titre, source, date de publication, thumbnail
6. L'utilisateur peut **retirer un article** de ses sauvegardés (toggle bookmark off)
7. Le retrait d'un article sauvegardé ne fait **pas crasher** l'app et **invalide le cache feed**
8. L'écran affiche un **état vide** informatif quand il n'y a aucun article sauvegardé
9. Les analytics trackent `articles_saved` vs `articles_read` séparément dans `digest_completions` — **déjà le cas, vérifier**

## Tasks / Subtasks

- [ ] **Task 1 : Vérification — Bookmark déjà compté dans progression** (AC: 1, 2)
  - [ ] Vérifier dans `digest_provider.dart` ligne 260-267 que `isSaved` est bien dans `processedCount`
  - [ ] Vérifier dans `digest_service.py` que `articles_saved` est bien tracké séparément (AC: 9)
  - [ ] Si déjà correct → documenter, pas de code à modifier

- [ ] **Task 2 : Frontend — Écran "Sauvegardés"** (AC: 3, 5, 8)
  - [ ] Créer `apps/mobile/lib/features/saved/screens/saved_screen.dart`
  - [ ] Utiliser le endpoint existant `GET /api/feed?saved_only=true` (déjà fonctionnel)
  - [ ] Réutiliser le composant `ArticleCard` existant (ou `DigestCard` simplifié)
  - [ ] Tri par date de sauvegarde (décroissant) — déjà géré par le endpoint
  - [ ] État vide : message "Aucun article sauvegardé" + icône bookmark

- [ ] **Task 3 : Frontend — Provider pour sauvegardés** (AC: 3)
  - [ ] Créer `apps/mobile/lib/features/saved/providers/saved_provider.dart`
  - [ ] Appeler `digestRepository` ou `feedRepository` avec `saved_only=true`
  - [ ] Pagination si nécessaire (même pattern que le feed)

- [ ] **Task 4 : Frontend — Navigation vers "Sauvegardés"** (AC: 4)
  - [ ] Ajouter un accès depuis la navigation (options : bottom nav tab, Settings, ou bouton dans le profil)
  - [ ] Ajouter la route dans `go_router` configuration

- [ ] **Task 5 : Frontend — Retirer un bookmark** (AC: 6, 7)
  - [ ] Toggle bookmark off → appeler `POST /api/digest/{id}/action` avec action `undo` (si depuis digest) OU mise à jour `UserContentStatus.is_saved = false`
  - [ ] Retirer l'article de la liste locale (optimistic update)
  - [ ] Invalider le cache feed pour que l'article réapparaisse
  - [ ] Vérifier qu'il n'y a pas de crash si la liste devient vide

- [ ] **Task 6 : Tests** (AC: 1, 2, 6, 7)
  - [ ] Implémenter les 6 tests existants dans `apps/mobile/test/features/digest/bookmark_test.dart`
  - [ ] Test : bookmark incrémente la progression
  - [ ] Test : retrait du bookmark ne crash pas
  - [ ] Test : bookmark montre l'état actif (visuel)
  - [ ] Test : bookmark persiste après refresh
  - [ ] Test : retrait dans l'écran sauvegardés fonctionne
  - [ ] Test : bookmark depuis digest incrémente la progression

## Dev Notes

### Backend — Déjà Implémenté

L'essentiel du backend est **déjà fonctionnel** :

**Endpoint saved** : `GET /api/feed?saved_only=true` dans `recommendation_service.py` lignes 103-128
- Retourne les articles avec `is_saved = True`
- Triés par `saved_at` décroissant
- Fonctionne déjà, pas de modification nécessaire

**Action save** : `POST /api/digest/{id}/action` avec `action=save`
- Met à jour `UserContentStatus.is_saved = True` + `saved_at = now()`
- Tracké dans `digest_completions.articles_saved`

**Tracking** : `digest_completions` table
- Champs `articles_read`, `articles_saved`, `articles_dismissed` — déjà distincts

### Frontend — Ce qui manque

**Tests placeholder** : `apps/mobile/test/features/digest/bookmark_test.dart`
- 6 tests définis mais tous `fail('Test not implemented')` — à implémenter

**Écran "Sauvegardés"** : N'existe pas encore
- Créer dans `apps/mobile/lib/features/saved/`
- Réutiliser les composants existants (cards, layouts)

**Navigation** : La route `/saved` n'est pas configurée dans le router
- L'ancienne story 5.7 prévoyait un écran "À consulter plus tard" mais il a été remplacé par l'écran Progressions (Epic 8)
- Cette story recrée un accès dédié aux sauvegardés

### Vérification processedCount

Dans `digest_provider.dart` ligne 260-267 :
```dart
int get processedCount {
    final digest = state.value;
    if (digest == null) return 0;
    return digest.items
        .where((item) => item.isRead || item.isDismissed || item.isSaved)
        .length;
}
```
`isSaved` est **déjà inclus** dans le count. AC 1 et 2 sont donc déjà satisfaits.

### Testing

- Tests Flutter : `flutter test` depuis `apps/mobile/`
- Fichier existant : `apps/mobile/test/features/digest/bookmark_test.dart` (6 placeholders)
- Pattern : Widget tests avec `ProviderScope` et mocks

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 09/02/2026 | 1.0 | Story créée suite brainstorm CEO + BMAD experts | BMad Master |
