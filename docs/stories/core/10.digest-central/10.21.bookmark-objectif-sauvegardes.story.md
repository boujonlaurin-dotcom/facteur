# Story 10.21: Bookmark valide l'objectif du jour + écran "Sauvegardés"

## Status: Review

## Story

**As a** utilisateur du digest quotidien,
**I want** que sauvegarder un article (bookmark) compte comme une interaction dans ma progression du jour, et pouvoir consulter mes articles sauvegardés dans un écran dédié,
**so that** je puisse trier rapidement mon digest tout en gardant des articles pour plus tard, sans perdre ma progression.

## Acceptance Criteria

1. **Bookmark = objectif validé** : sauvegarder un article dans le digest incrémente le compteur de progression (ex: 2/7 → 3/7)
2. Le bookmark est **déjà compté comme interaction** dans la logique existante (`isSaved` fait partie de `processedCount`) — **vérifier que c'est bien le cas**
3. Un **écran "Mes sauvegardés"** affiche la liste des articles bookmarkés, triés par date de sauvegarde (récents en premier)
4. L'écran "Sauvegardés" est accessible depuis la **navigation principale** (bottom nav ou profil)
5. Chaque article sauvegardé affiche : titre, source, date de publication, thumbnail
6. L'utilisateur peut **retirer un article** de ses sauvegardés (toggle bookmark off)
7. Le retrait d'un article sauvegardé ne fait **pas crasher** l'app et **invalide le cache feed**
8. L'écran affiche un **état vide** informatif quand il n'y a aucun article sauvegardé
9. Les analytics trackent `articles_saved` vs `articles_read` séparément dans `digest_completions` — **déjà le cas, vérifier**

## Tasks / Subtasks

- [x] **Task 1 : Vérification — Bookmark déjà compté dans progression** (AC: 1, 2)
  - [x] Vérifier dans `digest_provider.dart` ligne 260-267 que `isSaved` est bien dans `processedCount` — **Confirmed: already included**
  - [x] Vérifier dans `digest_service.py` que `articles_saved` est bien tracké séparément (AC: 9) — **Confirmed: tracked separately**
  - [x] Si déjà correct → documenter, pas de code à modifier — **No code changes needed**

- [x] **Task 2 : Frontend — Écran "Sauvegardés"** (AC: 3, 5, 8)
  - [x] ~~Créer~~ Existing `apps/mobile/lib/features/saved/screens/saved_screen.dart` — already existed
  - [x] Utiliser le endpoint existant `GET /api/feed?saved_only=true` (déjà fonctionnel) — uses `saved_feed_provider.dart`
  - [x] Réutiliser le composant `FeedCard` existant
  - [x] Tri par date de sauvegarde (décroissant) — déjà géré par le endpoint
  - [x] État vide : message "Aucune sauvegarde" + icône bookmarkSimple (duotone) — **Updated**

- [x] **Task 3 : Frontend — Provider pour sauvegardés** (AC: 3)
  - [x] ~~Créer~~ Existing `apps/mobile/lib/features/saved/providers/saved_feed_provider.dart` — already functional
  - [x] Appelle feedRepository avec `saved_only=true`
  - [x] Pagination already implemented (same pattern as feed)

- [x] **Task 4 : Frontend — Navigation vers "Sauvegardés"** (AC: 4)
  - [x] Added "Mes sauvegardes" link in Settings screen (CONTENU section) with bookmark icon
  - [x] Added `/saved` route in `go_router` configuration (inside ShellRoute)
  - [x] Updated `shell_scaffold.dart` to map `/saved` route to settings tab

- [x] **Task 5 : Frontend — Retirer un bookmark** (AC: 6, 7)
  - [x] Toggle bookmark off via `savedFeedProvider.toggleSave()` — **Already implemented in saved_screen.dart**
  - [x] Optimistic update removes from list — **Already handled by provider**
  - [x] Feed cache invalidation — **Already functional**
  - [x] No crash when list becomes empty — **Empty state shown**

- [ ] **Task 6 : Tests** (AC: 1, 2, 6, 7)
  - [ ] Implémenter les 6 tests existants dans `apps/mobile/test/features/digest/bookmark_test.dart`
  - *Note: Flutter test environment not available — tests remain as placeholders for local implementation*

## Dev Notes

### Backend — Déjà Implémenté

L'essentiel du backend est **déjà fonctionnel** :

**Endpoint saved** : `GET /api/feed?saved_only=true` dans `recommendation_service.py` lignes 103-128
- Retourne les articles avec `is_saved = True`
- Triés par `saved_at` décroissant
- Fonctionne déjà, pas de modification nécessaire

**Action save** : `POST /api/digest/{id}/action` avec `action=save`
- Met à jour `UserContentStatus.is_saved = True` + `saved_at = now()`
- Tracké dans `digest_completions.articles_saved`

**Tracking** : `digest_completions` table
- Champs `articles_read`, `articles_saved`, `articles_dismissed` — déjà distincts

### Frontend — Ce qui manque

**Tests placeholder** : `apps/mobile/test/features/digest/bookmark_test.dart`
- 6 tests définis mais tous `fail('Test not implemented')` — à implémenter

**Écran "Sauvegardés"** : N'existe pas encore
- Créer dans `apps/mobile/lib/features/saved/`
- Réutiliser les composants existants (cards, layouts)

**Navigation** : La route `/saved` n'est pas configurée dans le router
- L'ancienne story 5.7 prévoyait un écran "À consulter plus tard" mais il a été remplacé par l'écran Progressions (Epic 8)
- Cette story recrée un accès dédié aux sauvegardés

### Vérification processedCount

Dans `digest_provider.dart` ligne 260-267 :
```dart
int get processedCount {
    final digest = state.value;
    if (digest == null) return 0;
    return digest.items
        .where((item) => item.isRead || item.isDismissed || item.isSaved)
        .length;
}
```
`isSaved` est **déjà inclus** dans le count. AC 1 et 2 sont donc déjà satisfaits.

### Testing

- Tests Flutter : `flutter test` depuis `apps/mobile/`
- Fichier existant : `apps/mobile/test/features/digest/bookmark_test.dart` (6 placeholders)
- Pattern : Widget tests avec `ProviderScope` et mocks

## Dev Agent Record

**Agent:** Claude (Dev)
**Date:** 09/02/2026
**Branch:** claude/phase-4-docs-setup-SxB6q

### Files Changed

**Frontend:**
- `apps/mobile/lib/features/saved/screens/saved_screen.dart` — Updated title to "Mes sauvegardes", empty state icon (bookmarkSimple duotone) and text
- `apps/mobile/lib/config/routes.dart` — Added `/saved` GoRoute inside ShellRoute, imported SavedScreen
- `apps/mobile/lib/features/settings/screens/settings_screen.dart` — Added "Mes sauvegardes" tile in CONTENU section
- `apps/mobile/lib/shared/widgets/navigation/shell_scaffold.dart` — Added `/saved` path mapping to settings tab (index 2)

### Implementation Notes

- Task 1 (bookmark counts in progression): **Already implemented** — `isSaved` is part of `processedCount` in `digest_provider.dart`, `articles_saved` tracked separately in `digest_completions`
- Tasks 2-3 (saved screen + provider): **Already existed** — `saved_screen.dart` and `saved_feed_provider.dart` were functional. Only updated empty state UX.
- Task 4 (navigation): Added `/saved` route accessible from Settings > CONTENU > "Mes sauvegardes"
- Task 5 (remove bookmark): **Already functional** via `toggleSave()` in saved_feed_provider
- Task 6 (Flutter tests): Placeholder tests remain — Flutter environment not available in this session

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 09/02/2026 | 1.0 | Story créée suite brainstorm CEO + BMAD experts | BMad Master |
| 09/02/2026 | 1.1 | Implementation complete — Tasks 1-5 done, Task 6 deferred (Flutter env unavailable) | Dev Agent (Claude) |
