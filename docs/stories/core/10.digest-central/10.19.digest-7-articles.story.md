# Story 10.19: Passage à 7 articles avec completion 5/7

## Status: Draft

## Story

**As a** utilisateur du digest quotidien,
**I want** recevoir 7 articles au lieu de 5, avec la possibilité d'en traiter seulement 5 pour compléter mon digest,
**so that** j'aie plus de chances de trouver des articles qui m'intéressent, tout en gardant la sensation de "finitude" en 2-4 minutes.

## Acceptance Criteria

1. Le digest quotidien contient **7 articles** au lieu de 5
2. Le seuil de completion est de **5/7 interactions** (lu, sauvegardé ou "pas intéressé") pour déclencher la closure
3. `TARGET_DIGEST_SIZE` et `COMPLETION_THRESHOLD` sont **configurables** (pas hardcodés)
4. La contrainte de diversité passe à **`MAX_PER_SOURCE=1`** pour le digest (7 sources distinctes)
5. Si l'utilisateur a **moins de 7 sources actives**, le `MAX_PER_SOURCE` relaxe à 2 en fallback
6. La **progress bar** affiche 7 segments au lieu de 5
7. L'**écran closure** est déclenché après 5 interactions (pas 7)
8. Les **stats de closure** reflètent X/7 articles traités
9. Les **tests existants** sont mis à jour pour refléter le nouveau TARGET_DIGEST_SIZE
10. Le **MIN_SOURCES** passe à 4 (au lieu de 3) pour garantir la diversité sur 7 articles

## Tasks / Subtasks

- [ ] **Task 1 : Backend — Configurer TARGET_DIGEST_SIZE et COMPLETION_THRESHOLD** (AC: 1, 2, 3)
  - [ ] Modifier `DiversityConstraints` dans `digest_selector.py`: `TARGET_DIGEST_SIZE = 7`
  - [ ] Ajouter `COMPLETION_THRESHOLD = 5` dans `DiversityConstraints`
  - [ ] Modifier `MAX_PER_SOURCE = 1` (au lieu de 2)
  - [ ] Modifier `MIN_SOURCES = 4` (au lieu de 3)
  - [ ] Mettre à jour le docstring du module (5 → 7)
  - [ ] Mettre à jour `select_for_user()` default limit: `limit: int = 7`

- [ ] **Task 2 : Backend — Fallback MAX_PER_SOURCE quand < 7 sources** (AC: 4, 5)
  - [ ] Dans `_select_with_diversity()`, compter les sources distinctes disponibles dans le pool candidat
  - [ ] Si sources_distinctes < 7 : utiliser `MAX_PER_SOURCE = 2` (fallback)
  - [ ] Logger le cas de fallback pour monitoring

- [ ] **Task 3 : Backend — Endpoint retourne le completion_threshold** (AC: 2, 3)
  - [ ] Ajouter `completion_threshold: int` au schema de réponse `GET /api/digest`
  - [ ] Valeur provient de `DiversityConstraints.COMPLETION_THRESHOLD`

- [ ] **Task 4 : Frontend — Completion à 5/7** (AC: 2, 7)
  - [ ] Modifier `_checkAndHandleCompletion()` dans `digest_provider.dart`
  - [ ] Remplacer `every((item) => item.isRead || item.isDismissed || item.isSaved)` par `processedCount >= completionThreshold`
  - [ ] Le threshold est lu depuis la réponse API (champ `completion_threshold`, fallback 5)

- [ ] **Task 5 : Frontend — Progress bar 7 segments** (AC: 6)
  - [ ] Modifier `progress_bar.dart` : nombre de segments dynamique basé sur `digest.items.length`
  - [ ] Indicateur visuel du seuil de completion (ex: marqueur à 5/7)

- [ ] **Task 6 : Frontend — Écran closure stats** (AC: 8)
  - [ ] Modifier `closure_screen.dart` pour afficher "X/7 articles traités"
  - [ ] Adapter `digest_summary.dart` si nécessaire

- [ ] **Task 7 : Tests** (AC: 9)
  - [ ] Mettre à jour `digest_selector_test.py` : TARGET_DIGEST_SIZE = 7
  - [ ] Ajouter test : completion se déclenche à 5/7 (pas 7/7)
  - [ ] Ajouter test : MAX_PER_SOURCE=1 avec 7+ sources
  - [ ] Ajouter test : fallback MAX_PER_SOURCE=2 avec < 7 sources

## Dev Notes

### Fichiers Backend Clés

**`packages/api/app/services/digest_selector.py`**
- Ligne 78-82 : `DiversityConstraints` — constantes à modifier (TARGET_DIGEST_SIZE, MAX_PER_SOURCE, MAX_PER_THEME)
- Ligne 101-105 : `select_for_user()` — paramètre `limit: int = 5` doit passer à 7
- La méthode `_select_with_diversity()` utilise déjà une boucle sur les candidats triés — pas de refacto, juste changer les constantes

**`packages/api/app/services/digest_service.py`**
- Ligne 380 : `complete_digest()` — ne vérifie pas le count, reçoit un appel explicite du frontend
- La completion est déclenchée côté frontend, pas côté backend

### Fichiers Frontend Clés

**`apps/mobile/lib/features/digest/providers/digest_provider.dart`**
- Ligne 276-286 : `_checkAndHandleCompletion()` — utilise `every()`, doit passer à `processedCount >= threshold`
- Ligne 260-267 : `processedCount` — déjà calculé correctement (compte read + dismissed + saved)
- Ligne 269-274 : `progress` — divise par `items.length`, reste correct

**`apps/mobile/lib/features/digest/widgets/progress_bar.dart`**
- Widget segmenté — le nombre de segments doit être dynamique (basé sur `items.length`)

### Note sur le Decay

Le decay factor (0.70) combiné à `MAX_PER_SOURCE=1` signifie que le decay n'a plus d'effet dans le digest (un seul article par source = pas de doublon). Le decay reste actif pour le feed. Pas besoin de modifier `apply_source_fatigue_decay()`.

### Testing

- Tests existants : `packages/api/app/services/digest_selector_test.py` (24 tests)
- Assertion à mettre à jour : `assert constraints.TARGET_DIGEST_SIZE == 5` → 7 (ligne 696)
- Framework : pytest
- Pattern : Tests unitaires synchrones sur `_select_with_diversity()` directement

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 09/02/2026 | 1.0 | Story créée suite brainstorm CEO + BMAD experts | BMad Master |
