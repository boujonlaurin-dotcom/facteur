# Story 3.5: Configuration des "Trusted Sources"

## Status: Completed ✅

## Story

**As a** Utilisateur,  
**I want** définir mes "Sources de Confiance" parmi le catalogue,  
**so that** l'algorithme privilégie ces sources dans mon feed.

## Acceptance Criteria

1. **Accès via Paramètres**: Une nouvelle entrée "Sources de confiance" est accessible depuis l'écran de réglages. [Done]
2. **Affichage du Catalogue**: La liste complète des sources curées (24 sources) est affichée, groupée par Thème ou triée par Nom. [Done]
3. **Indicateur d'État**: Chaque source affiche clairement si elle est "Trusted" (suivie) ou non (checkbox, switch, ou bouton). [Done]
4. **Interaction Toggle**:
   - Tap sur une source non suivie → Ajoute aux sources de l'utilisateur (Trust). [Done]
   - Tap sur une source suivie → Retire des sources de l'utilisateur (Untrust). [Done]
   - Feedback visuel immédiat (optimistic UI). [Done]
5. **Suppression Custom Sources (V0)**: La fonctionnalité d'ajout d'URL manuelle (Story 3.4) est reportée. [Done]
6. **Persistance**: Les choix sont sauvegardés via l'API et persistent entre les sessions. [Done]
7. **Transparence FQS** : Chaque source affiche son Note FQS globale et le détail des 3 piliers (Indépendance, Rigueur, UX) au tap. [New]
8. **Expliquer la Méthode** : Une info-bulle ou section "Comment notons-nous ?" est accessible depuis l'écran. [New]

## Tasks / Subtasks

- [x] **Task 1: Backend - API Endpoints pour User Sources**
  - [x] Modifier `GET /api/sources/catalog` pour inclure un champ `is_trusted`.
  - [x] Créer `POST /api/sources/{id}/trust`.
  - [x] Créer `DELETE /api/sources/{id}/trust`.
  - [x] Vérifier les politiques RLS sur `user_sources`.

- [x] **Task 2: Frontend - Service & State**
  - [x] Mettre à jour le modèle `Source`.
  - [x] Mettre à jour `SourcesRepository`.
  - [x] Mettre à jour `SourcesNotifier` (Provider) pour gérer les actions optimistes.

- [x] **Task 3: Frontend - UI Écran Sources**
  - [x] Utiliser/Mettre à jour `SourcesScreen`.
  - [x] Mettre à jour `SourceListTile` / `SourceListItem` avec `FacteurStamp`.
  - [x] Ajouter l'entrée dans `SettingsScreen`..

- [x] **Task 4: Tests & Validation**
  - [x] Validation manuelle de la persistance.
  - [x] Validation visuelle (tampons).
- [ ] **Task 5: FQS Transparency Integration** (AC: 7, 8)
  - [ ] Connect `SourceDetailModal` to backend granular scores (Independence, Rigor, UX).
  - [ ] Implement the explanation logic/tooltip for FQS scoring.


## Dev Notes

### Data Models [Source: architecture.md#4.2]

- **UserSources**: Table de liaison `user_id`, `source_id`.
  - `is_custom` sera `false` par défaut pour toutes les actions de cette story (catalogue uniquement).
- **Sources**: Utiliser `logo_url`, `name`, `theme` pour l'affichage.

### API Endpoints [Source: architecture.md#8.6]

- **GET /sources/catalog**: 
  - Doit maintenant retourner une liste de sources enrichie avec l'état utilisateur.
  - Alternative: Retourner la liste standard + une liste d'IDs `user_source_ids` séparée, et mapper côté client. (À décider par le dev backend, enrichir est souvent plus simple pour le client).
  
- **Actions**:
  - `POST /api/sources/{source_id}/trust`
  - `DELETE /api/sources/{source_id}/trust`
  - Codes retour: 200 OK (avec état mis à jour), 404 Not Found (si source n'existe pas).

### UI Components [Source: front-end-spec.md] (Inferred)

- **SourceListTile**:
  - Leading: `CircleAvatar` avec `logo_url`.
  - Title: `source.name`.
  - Subtitle: `source.theme`.
  - Trailing: `Switch` ou `IconButton` (coeur/étoile/check).
- **Navigation**:
  - Depuis `SettingsScreen`, ajouter une `SettingsTile` "Sources de confiance".
- **SourceDetailModal** : Affichage au tap sur une source dans la liste -> Montre le score FQS détaillé (Radar chart ou barres).

## Testing

- **Backend**: `pytest tests/test_sources.py` (à créer/compléter).
- **Frontend**: Utiliser le simulateur iOS.
- **Scenario**: Aller dans Settings -> Trusted Sources. Cocher une source. Revenir. Rouvrir. Vérifier qu'elle est toujours cochée. Vérifier en DB (`SELECT * FROM user_sources`).
