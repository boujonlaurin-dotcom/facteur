# Story 4.7 : Personnalisation du Feed

**Epic :** 4 ‚Äî Feed & Algorithme  
**Statut :** ‚úÖ Termin√©
**Date :** 24 janvier 2026

---

## User Story

**En tant qu'** utilisateur de Facteur,  
**Je veux** pouvoir indiquer les sources et th√®mes que je pr√©f√®re voir moins,  
**Afin que** mon feed soit personnalis√© selon mes pr√©f√©rences explicites et que l'algorithme apprenne de mon comportement.

---

## Contexte

Actuellement, l'action "Pas int√©ress√©" masque un contenu individuel mais n'affecte pas durablement l'algorithme. Cette story introduit un syst√®me de **personnalisation persistante** o√π l'utilisateur peut muter sources, th√®mes et sous-th√®mes, avec un impact direct sur le scoring.

---

## Acceptance Criteria

### AC1 : Bouton "‚ùì" unifi√© sur la FeedCard
- [x] Le bouton "..." est remplac√© par un bouton "‚ùì" plus visible
- [x] Le bouton "‚ùì" ouvre un bottom sheet de personnalisation

### AC2 : Bottom Sheet "Pourquoi cet article ?"
- [x] Affiche les facteurs de scoring avec leurs contributions (+70 pts, etc.)
- [x] Chaque facteur actionnable a un bouton `[Voir moins]` ou `[Retirer]`
- [x] L'action "Copier le lien" est conserv√©e dans ce bottom sheet
- [x] Les actions d√©clenchent l'API et rafra√Æchissent le feed

### AC3 : Backend Personnalisation
- [x] Table `user_personalization` avec colonnes `muted_sources`, `muted_themes`, `muted_topics`
- [x] Endpoints API pour muter/d√©muter
- [x] `PersonalizationLayer` applique les malus au scoring
- [x] Les raisons de malus apparaissent dans le breakdown

### AC4 : Nudge "3 Skips" (Front-Only)
- [x] Compteur local de skips par source (reset au clic)
- [x] Apr√®s 3 skips cons√©cutifs, afficher une ligne sous la carte :
  > `‚Üì Tu consultes rarement [Source]. [Annuler ‚úï]`
- [x] Tap sur le texte ‚Üí mute la source + toast confirmation
- [x] Tap sur `[Annuler ‚úï]` ‚Üí dismiss + reset compteur
- [x] Fr√©quence adaptative : si utilisateur r√©pond souvent "mute", nudges plus fr√©quents

### AC5 : Explication dans le Score Breakdown
- [x] Les malus de personnalisation apparaissent dans le breakdown :
  > "-40 pts : Tu vois moins de ce th√®me"

---

## Out of Scope V0

- Tracking backend des impressions/clicks
- Unmute depuis Settings (sera V1)
- Badge üîá sur les cards
- Skip ratio calcul√© c√¥t√© backend

---

## Effets de Bord Identifi√©s

| Composant | Impact | Action Requise |
|-----------|--------|----------------|
| `FeedCard.onMoreOptions` | Supprim√© | Retirer la prop, migrer vers nouveau callback |
| `_showMoreOptions()` | Fusionn√© | Migrer dans le nouveau bottom sheet unifi√© |
| `saved_screen.dart` L138 | Utilise `onMoreOptions` | Adapter ou dupliquer le bottom sheet |
| Tests `feed_card_test.dart` | Cass√©s | Mettre √† jour les tests |

---

## Estimation

| Phase | Effort |
|-------|--------|
| Backend | 2-3 jours |
| Mobile | 3-4 jours |
| **Total** | **5-7 jours** |

---

## √Ä tester (V√©rification)

### Tests Automatis√©s
- [x] **Logic Test :** `packages/api/tests/test_personalization_router.py` (New backend logic verification).
- [ ] **UI Test :** V√©rifier l'affichage du nudge apr√®s 3 skips cons√©cutifs d'une m√™me source.
- [x] **API Debug :** `apps/mobile/test/api_debug.dart` (Script de diagnostic de connexion).

### Tests Manuels
1. **Nudge 3 Skips :** [V√©rifi√©] Banni√®re appara√Æt apr√®s 3 skips.
2. **D√©sint√©r√™t Source :** [V√©rifi√©] La suppression est d√©sormais **optimiste** (imm√©diate sur le device).
3. **Bottom Sheet Personalisation :** [V√©rifi√©] Affichage d√©taill√© du score et actions de mute fonctionnelles.
4. **Persistance :** [V√©rifi√©] Les malus sont correctement appliqu√©s apr√®s red√©marrage.

## D√©tails Techniques d'Impl√©mentation (Fixes 28/01/2026)

### Backend Synchronization
- Corrig√© un crash au d√©marrage li√© √† un d√©calage de migrations Alembic (`alembic upgrade head`).
- Ajout de casts explicites `::uuid[]` et `::text[]` dans les `COALESCE` pour PostgreSQL.
- Ajout de logs de tra√ßabilit√© (`[TRACER]`) pour valider l'ex√©cution en temps r√©el.

### UX Mobile Improvement
- **Optimistic UI** : Les cartes sont retir√©es instantan√©ment de l'√©tat local `FeedProvider`.
- **Non-blocking Flow** : Suppression des `refresh()` forc√©s en cas d'erreur API pour garantir la fluidit√©.
- **Feedback** : Ajout de Toasts via `NotificationService`.
