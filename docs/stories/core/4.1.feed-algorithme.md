# Story 4.1: Algorithme de tri et personnalisation [D√âPR√âCI√â]

> ‚ö†Ô∏è **ATTENTION : Cette story est d√©pr√©ci√©e et remplac√©e par [Story 4.2 - Recommendation Engine V3](./4.2.reco-engine-v3.story.md)**
>
> La nouvelle impl√©mentation (V3) inclut :
> - Architecture 3 niveaux (47 labels + NER illimit√©)
> - Traitement asynchrone avec file d'attente
> - EntityLayer pour scoring par entit√©s (+60pts)
> - mDeBERTa et spaCy en production
>
> **Date de d√©pr√©ciation :** 29/01/2026

## Status: ~~Ready ‚úÖ~~ ‚Üí **D√âPR√âCI√â** üö´

**Remplac√©e par :** [Story 4.2 - Recommendation Engine V3](./4.2.reco-engine-v3.story.md)

## Story

**As a** utilisateur,  
**I want** voir un feed personnalis√© selon mes pr√©f√©rences,  
**so that** les contenus les plus pertinents apparaissent en premier.

## Acceptance Criteria

1. Endpoint API `/api/feed` GET avec la logique de tri [Source: prd.md#Story 4.1]
2. Algorithme de scoring combinant :
    - **Th√®mes pr√©f√©r√©s** (poids fort) [Source: prd.md#Story 4.1]
    - **Fra√Æcheur du contenu** (decay function) [Source: prd.md#Story 4.1]
    - **Type de contenu** (poids selon pr√©f√©rences) [Source: prd.md#Story 4.1]
3. **Filtrage** : Exclusion stricte des contenus vus (`ContentStatus.SEEN`, `CONSUMED`) et masqu√©s (`HIDDEN`) [Source: prd.md#Story 4.1]
4. **Boost de Qualit√© (FQS)** : Les sources avec un `reliability_score` √©lev√© ("High") re√ßoivent un bonus de visibilit√© SIGNIFICATIF (+15.0 pts), les rendant comp√©titives face aux sources suivies. [New]
5. **Pagination** : Support du limit/offset (par d√©faut 20 items) [Source: prd.md#Story 4.1]
6. **Diversit√©** : Pr√©venir la domination d'une source unique (Source Fatigue).
7. **Boost Visuel** : Les contenus avec une image de couverture re√ßoivent un bonus (+10). [New]


## Tasks / Subtasks

- [x] **Task 1: Service de Scoring (`RecommendationService`)**
  - [x] Calculer un `score` dynamique pour chaque contenu candidat.
  - [x] Impl√©menter la logique de poids (User Interest x Content Theme).
  - [x] Impl√©menter la d√©pr√©ciation temporelle (Linear ou Exponential Decay).

- [x] **Task 2: Optimisation SQL**
  - [x] Cr√©er une vue ou une requ√™te optimis√©e pour joindre `Contents`, `UserSources`, `UserInterests`.
  - [x] Utiliser `NOT EXISTS` pour exclure efficacement les `UserContentStatus` existants.
  - [x] **Indexation** : Ajouter des index B-Tree sur `contents.published_at` et `contents.source_id` pour garantir un tri rapide (O(log n)).

- [ ] **Task 3: API Endpoint**
  - [ ] Impl√©menter `GET /api/feed` dans `routers/feed.py`.
  - [ ] Int√©grer la pagination.

## Dev Notes

### Architecture Modulaire (V2)
L'algorithme utilise un `ScoringEngine` qui orchestre plusieurs couches (`BaseScoringLayer`) ind√©pendantes.

#### 1. Couches de Scoring (`layers/`)
- **CoreLayer (V1)** : Logique de base.
    - **Theme Match** : Facteur Dominant (+70.0). Les sujets d'int√©r√™t priment sur tout.
    - **Followed Source** : Signal fort (+30.0).
    - **Recency** : Decay temporel classique (max +30.0).
- **StaticPreferenceLayer** : Exploite le profil utilisateur issu de l'onboarding.
    - Bonus sur le `formatPreference` (ex: "Sujet court").
    - Ajustement du decay selon `contentRecency` pr√©f√©r√©.
- **BehavioralLayer** : Adaptation dynamique selon la consommation r√©elle.
    - Bonus/Malus sur le poids des int√©r√™ts (`UserInterest.weight`) ajust√© lors de la consommation.
- **QualityLayer (New)** : Encourage la consommation de sources fiables.
    - `ReliabilityScore.HIGH` = Bonus Score x 1.2 -> AJUST√â : Bonus Fixe +15.0 (Global Trust).
    - `ReliabilityScore.LOW` = Malus Score x 0.8 -> AJUST√â : Malus Fixe -30.0.
- **VisualLayer (New)** : Am√©liore l'attractivit√© du feed.
    - Pr√©sence d'une image = Bonus `IMAGE_BOOST` (+10.0)

#### 2. Transparence (`recommendation_reason`)
Le `RecommendationService` synth√©tise les scores pour g√©n√©rer un libell√© humain (ex: "Sujet passionnant : Tech") bas√© sur la couche ayant eu le plus d'impact.

#### 3. Diversit√© (Reranking)
Pour √©viter la saturation, une p√©nalit√© exponentielle est appliqu√©e lors du tri final :
`FinalScore = Score * (PenaltyFactor ^ RepeatCount)`
- **PenaltyFactor** : ~0.85
- **RepeatCount** : Nombre de fois o√π la source est d√©j√† apparue dans la liste ordonn√©e.

## Testing
- **Unit Tests** : `tests/test_scoring_v2.py` (Moteur modulaire) et `tests/test_perspective_service.py` (Exclusion Perspectives).
- **Validation Script** : `scripts/validate_personas.py` pour simuler des personas et valider les pond√©rations (Theme > Followed > Trust).

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 10/01/2026 | 1.0 | Initial Draft | BMad Master Agent |
| 11/01/2026 | 1.1 | Ajout de la logique de Diversit√© (Source Fatigue) | Antigravity |
| 13/01/2026 | 1.2 | Ajout du VisualLayer (Image Boost) | Antigravity |
| 18/01/2026 | 1.3 | Ajout d√©tails techniques indexation (Performance fix) | Antigravity |
| 18/01/2026 | 1.4 | Ajustement Pond√©rations (Theme++ et Global Trust++) | Antigravity |
| 19/01/2026 | 1.5 | FIX Theme Matching (ThemeMapper implemented) | Antigravity |

