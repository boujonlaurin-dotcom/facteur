# Story 4.1b : Fix Bug Critique Matching Th√®me

## Status: üî• Critical (To Do)

## Story

**As a** syst√®me,  
**I want** que le matching th√®me fonctionne correctement,  
**so that** les utilisateurs voient des contenus pertinents selon leurs int√©r√™ts.

## Problem Statement

Le matching th√®me actuel **ne fonctionne jamais** car :
- `Source.theme` contient des **labels lisibles** (ex: `"Tech & Futur"`, `"Soci√©t√© & Climat"`)
- `UserInterest.interest_slug` contient des **slugs normalis√©s** (ex: `"tech"`, `"society"`)

Le check `if content.source.theme in context.user_interests` dans [`CoreLayer.score()`](../../packages/api/app/services/recommendation/layers/core.py#L25) ne matche **JAMAIS** ‚Üí Le bonus +70 pts n'est jamais appliqu√©.

**Impact :** Les recommandations sont quasi-al√©atoires, ignorant compl√®tement les pr√©f√©rences user.

## Acceptance Criteria

1. **Table de mapping cr√©√©e** : `theme_mapper.py` avec mapping explicite `source.theme` ‚Üí `user_interest_slug`
2. **CoreLayer modifi√©** : Utiliser `get_user_slugs_for_source()` au lieu du check direct
3. **Tests unitaires** : Valider le matching pour chaque combinaison th√®me/interest
4. **Validation personas** : Avec les personas existants, ‚â•60% des articles doivent matcher un int√©r√™t user
5. **Pas de r√©gression** : Score total reste coh√©rent (pas de baisse drastique)

## Dev Notes

### Solution : Single Taxonomy (Data Alignment)

Au lieu de complexifier le code avec un mapper, on aligne les donn√©es sources sur le standard interne (Slugs).

1. **Mise √† jour `sources_master.csv`** : Remplacement des labels ("Tech & Futur") par les slugs ("tech").
2. **R√©-import** : `import_sources.py` met √† jour la base.
3. **Simplification Code** : Suppression de `theme_mapper.py`. `CoreLayer` fait une comparaison directe robustifi√©e (`slug == slug`).

**Avantages :** 
- Plus de "Magic Strings" dans le code.
- Plus de maintenance de double liste.
- Performance (comparaison string simple).


### Modification CoreLayer

```python
# Dans core.py, ligne 25

# AVANT (cass√©)
if content.source.theme in context.user_interests:
    match_score = ScoringWeights.THEME_MATCH
    ...

# APR√àS (fix√©)
from app.services.recommendation.theme_mapper import get_user_slugs_for_source

source_slugs = get_user_slugs_for_source(content.source)
matching_slugs = source_slugs & context.user_interests

if matching_slugs:
    match_score = ScoringWeights.THEME_MATCH
    score += match_score
    context.add_reason(content.id, self.name, match_score, f"Theme match: {list(matching_slugs)[0]}")
```

## Testing

### Test Unitaire

```python
# tests/test_theme_mapper.py

def test_theme_mapping():
    """V√©rifie que chaque source theme mappe vers au moins un user slug."""
    from app.models.source import Source
    
    test_cases = [
        ("Tech & Futur", {"tech", "science"}),
        ("Soci√©t√© & Climat", {"society", "environment"}),
    ]
    
    for theme, expected_slugs in test_cases:
        source = Source(theme=theme)
        result = get_user_slugs_for_source(source)
        assert result == expected_slugs
```

### Validation Persona

```python
# scripts/validate_fix_matching.py

# Simuler un user avec interests = ["tech", "society"]
# V√©rifier qu'au moins 60% des articles de sources "Tech & Futur" et "Soci√©t√© & Climat"
# re√ßoivent le bonus +70
```

## Effort & Priority

- **Effort :** 3 points (2-3h)
- **Priority :** üî• **CRITICAL** (bug bloquant)
- **Sprint :** Imm√©diat

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 19/01/2026 | 1.0 | Initial Draft | Antigravity |
