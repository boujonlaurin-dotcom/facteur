# Story 11.1 : Digest Mode Selector ‚Äî UX/UI Premium

> **Parent Epic**: [[11.epic-digest-feed-personalisation.md]]
> **Type**: Evolution (Story 1 de l'Epic 11)

## Status: In Progress

## Story

**As a** utilisateur du digest quotidien,
**I want** un s√©lecteur de mode visuellement impactant et premium qui change clairement l'ambiance de mon digest,
**so that** je per√ßoive imm√©diatement l'effet de mon choix de mode sur ma s√©lection d'articles.

## Acceptance Criteria

1. **S√©lecteur de mode** : composant de type segmented control compact (iOS-style) positionn√© en haut √† droite du header de la carte digest
2. **Identit√© visuelle par mode** : chaque mode a sa propre couleur, ic√¥ne Phosphor, gradient de carte, et couleur de fond d'√©cran
3. **Changement de mood imm√©diat** : le switch de mode provoque un changement de couleur marqu√© et anim√© (fond d'√©cran + gradient carte)
4. **Feedback de r√©g√©n√©ration** : un overlay anim√© (pulsing glow + progress indicator) appara√Æt pendant que le backend r√©g√©n√®re les articles
5. **Sous-titre lisible** : le sous-titre du mode est visible 4s apr√®s un changement, avec une taille et un contraste suffisants
6. **Titre complet** : affiche "L'Essentiel du jour" (pas juste "L'Essentiel")
7. **Feed sans emojis th√®mes** : les filtres th√®mes du feed affichent uniquement le label texte (plus d'emoji devant)

## Tasks / Subtasks

### Phase 1 : Fondations (DONE)

- [x] **Task 1 : Cr√©er l'enum `DigestMode` avec m√©tadata** (AC: 2)
  - [x] 3 modes : pourVous, serein, perspective (theme_focus d√©pr√©ci√©)
  - [x] Champs : key, label, subtitle, emoji, color, icon, gradients, backgroundColor
  - [x] Fichier : `apps/mobile/lib/features/digest/models/digest_mode.dart`

- [x] **Task 2 : Cr√©er `DigestModeProvider`** (AC: 1)
  - [x] State : `{ DigestMode mode, bool isRegenerating, String? errorMessage }`
  - [x] `setMode()` : sauvegarde pr√©f√©rence + appel `POST /api/digest/generate?mode=X&force=true`
  - [x] `initFromDigestResponse()` : synchronise le mode depuis la r√©ponse API
  - [x] Fichier : `apps/mobile/lib/features/digest/providers/digest_mode_provider.dart`

- [x] **Task 3 : Backend ‚Äî mode sur daily_digest** (AC: 1)
  - [x] Migration Alembic : colonne `mode VARCHAR(30) DEFAULT 'pour_vous'`
  - [x] DigestSelector : filtrage serein (keywords + th√®mes exclus), boost perspective (+80pts)
  - [x] Endpoint `POST /api/digest/generate` accepte `mode` et `force` params

- [x] **Task 4 : Retirer emojis des filtres th√®mes du feed** (AC: 7)
  - [x] `theme_filters_provider.dart` : labels texte uniquement (ex: "Technologie" au lieu de "üíª Tech")

### Phase 2 : UI Premium (IN PROGRESS)

- [x] **Task 5 : Cr√©er `DigestModeSegmentedControl`** (AC: 1, 2)
  - [x] Composant iOS-style segmented control compact (132√ó36px)
  - [x] Sliding indicator anim√© (AnimatedPositioned 250ms)
  - [x] Ic√¥nes Phosphor : sunDim (Pour vous), flowerLotus (Serein), detective (Perspective)
  - [x] Bordure et glow couleur du mode sur le segment s√©lectionn√©
  - [x] Fichier : `apps/mobile/lib/features/digest/widgets/digest_mode_tab_selector.dart`

- [x] **Task 6 : Int√©grer le segmented control dans le header** (AC: 1, 6)
  - [x] Positionn√© top-right du header de la carte (invers√© avec la progression)
  - [x] Progression (X/5 + barres segment√©es) inline avec le titre √† gauche
  - [x] Titre "L'Essentiel du jour" (fontSize 20, w800)
  - [x] Sous-titre du mode appara√Æt 4s apr√®s changement, puis dispara√Æt

- [x] **Task 7 : Gradient et couleurs du container** (AC: 3)
  - [x] TweenAnimationBuilder pour transitions fluides entre modes
  - [x] Gradients dark mode teint√©s par le mode (ambre, vert for√™t, bleu nuit)
  - [x] Bordure subtile avec glow adapt√©
  - [x] Support light mode (gradients semi-transparents sur fond cr√®me)

- [x] **Task 8 : Overlay de r√©g√©n√©ration** (AC: 4)
  - [x] `_RegenerationOverlay` avec shimmer puls√© (AnimationController 1500ms)
  - [x] Glow circle + CircularProgressIndicator + texte "Recomposition en cours..."
  - [x] Articles en opacit√© 0.15 + IgnorePointer pendant r√©g√©n√©ration

- [ ] **Task 9 : Polish UX/UI (prochaine it√©ration)** (AC: 1, 2, 3, 5)
  - [ ] √âvaluer si le segmented control est suffisamment "premium" et impactant
  - [ ] V√©rifier que le changement de couleur de fond est assez marqu√©
  - [ ] V√©rifier la lisibilit√© du sous-titre sur chaque couleur de mode
  - [ ] Valider le choix des ic√¥nes (sunDim, flowerLotus, detective)
  - [ ] S'assurer que le composant communique visuellement le concept de "switch de mode"

## Dev Notes

### Architecture des fichiers

| Fichier | R√¥le |
|---------|------|
| `digest_mode.dart` | Enum des 3 modes avec toute l'identit√© visuelle (couleurs, ic√¥nes, gradients dark/light) |
| `digest_mode_tab_selector.dart` | `DigestModeSegmentedControl` ‚Äî segmented control compact iOS-style |
| `digest_briefing_section.dart` | Container principal : header (titre+progression+selector), sous-titre, liste d'articles |
| `digest_screen.dart` | √âcran : connecte les providers, g√®re le fond anim√©, l'overlay de r√©g√©n√©ration |
| `digest_mode_provider.dart` | State management : `setMode()` ‚Üí pref + API regen ‚Üí UI sync |
| `digest_provider.dart` | Cache du digest, `updateFromResponse()` |

### Palette de couleurs actuelle (dark mode)

| Mode | Couleur principale | Gradient Start ‚Üí End | Background √©cran |
|------|-------------------|---------------------|-----------------|
| Pour vous | `#D4944C` (ambre dor√©) | `#261C0E ‚Üí #1A1408` | `#1A150C` |
| Serein | `#4CAF7D` (jade/for√™t) | `#0E2218 ‚Üí #0A1A10` | `#0C1A10` |
| Perspective | `#6B8FBF` (bleu acier) | `#0E1526 ‚Üí #0A101E` | `#0C1220` |

### Ic√¥nes Phosphor actuelles

| Mode | Ic√¥ne | Style |
|------|-------|-------|
| Pour vous | `PhosphorIcons.sunDim` | Fill |
| Serein | `PhosphorIcons.flowerLotus` | Fill |
| Perspective | `PhosphorIcons.detective` | Fill |

### Flow backend (fonctionnel)

```
User tap mode ‚Üí DigestModeNotifier.setMode(newMode)
  ‚Üí PUT /api/users/preferences {digest_mode: "serein"}    (fire & forget)
  ‚Üí POST /api/digest/generate?mode=serein&force=true       (attend r√©ponse)
  ‚Üí DigestService.get_or_create_digest(mode, force=true)
    ‚Üí DELETE existing digest
    ‚Üí DigestSelector.select_for_user(mode=mode)
      ‚Üí apply_serein_filter() si serein (exclut th√®mes + keywords anxiog√®nes)
      ‚Üí +80pts bias oppos√© si perspective
    ‚Üí INSERT nouveau digest en DB
  ‚Üê DigestResponse {mode, items[...]}
  ‚Üí DigestNotifier.updateFromResponse()
  ‚Üí UI refresh
```

## Dev Agent Record

**Agent 1:** Claude (Dev) ‚Äî Session initiale
**Date:** 15/02/2026
**Branch:** `claude/digest-feed-tab-selector-4hQuu`

### Contributions Agent 1
- Cr√©ation de `DigestMode` enum avec emojis, couleurs premium, backgroundColor
- Premier design des badges emojis (38px carr√©s arrondis) ‚Äî remplac√© par segmented control
- Background anim√© du digest screen (AnimatedContainer)
- Retrait des emojis des filtres th√®mes du feed

**Agent 2:** Claude (Dev) ‚Äî It√©ration UX
**Date:** 15/02/2026
**Branch:** `main` (merg√©)

### Contributions Agent 2
- Refonte compl√®te : `DigestModeSegmentedControl` (iOS-style, 132√ó36px, sliding indicator)
- TweenAnimationBuilder pour transitions gradient fluides
- Overlay de r√©g√©n√©ration puls√© (`_RegenerationOverlay`)
- Support light mode (gradients semi-transparents)
- Sous-titre temporaire (4s timer)
- Titre "L'Essentiel du jour"
- Ajout `onLike` callback
- SnackBar pour erreurs de changement de mode
- Ic√¥nes : flowerLotus (serein), detective (perspective)

### Files Changed

**Mobile (principal):**
- `apps/mobile/lib/features/digest/models/digest_mode.dart` ‚Äî Enum 3 modes, palette premium, dark+light gradients
- `apps/mobile/lib/features/digest/widgets/digest_mode_tab_selector.dart` ‚Äî DigestModeSegmentedControl
- `apps/mobile/lib/features/digest/widgets/digest_briefing_section.dart` ‚Äî StatefulWidget, TweenAnimationBuilder, header restructur√©
- `apps/mobile/lib/features/digest/screens/digest_screen.dart` ‚Äî Background anim√©, RegenerationOverlay, error SnackBar
- `apps/mobile/lib/features/digest/providers/digest_mode_provider.dart` ‚Äî State management mode
- `apps/mobile/lib/features/feed/providers/theme_filters_provider.dart` ‚Äî Labels texte sans emojis

**Backend (d√©j√† en place):**
- `packages/api/app/models/daily_digest.py` ‚Äî Colonne `mode`
- `packages/api/app/services/digest_selector.py` ‚Äî Filtres serein + boost perspective
- `packages/api/app/routers/digest.py` ‚Äî Param mode sur POST /generate
- `packages/api/app/schemas/digest.py` ‚Äî `mode` dans DigestResponse

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 15/02/2026 | 1.0 | Story cr√©√©e r√©troactivement pour documenter les travaux Epic 11 Story 1 | Dev Agent 1 (Claude) |
| 15/02/2026 | 1.1 | It√©ration UX : segmented control, transitions, overlay r√©g√©n√©ration | Dev Agent 2 (Claude) |
| 15/02/2026 | 1.2 | Documentation BMAD formalis√©e, handoff cr√©√© pour polish final | Dev Agent 1 (Claude) |
