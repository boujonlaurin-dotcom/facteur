# Story 4.1f: Like & Bookmark Algo Integration

> **Parent Story**: [[../core/4.2.reco-engine-v3/4.2.reco-engine-v3.md]]
> **Related**: [[../core/10.digest-central/10.6.endpoint-post-action.story.md]], [[../core/10.digest-central/10.21.bookmark-objectif-sauvegardes.story.md]]
> **Type**: Evolution

**As a** utilisateur du digest ou du feed,
**I want** que mes "j'aime" et mes sauvegardes influencent progressivement les recommandations futures,
**so that** le contenu propos√© correspond de mieux en mieux √† mes centres d'int√©r√™t r√©els.

## Status: Done

## Acceptance Criteria

1. [x] **Bouton Like** : Un bouton coeur (‚ù§Ô∏è) est disponible sur les cartes du feed et du digest
2. [x] **Like Backend** : `POST /contents/{id}/like` et `DELETE /contents/{id}/like` cr√©ent/suppriment le like
3. [x] **Like DB** : Colonnes `is_liked` (bool) et `liked_at` (timestamp) ajout√©es √† `user_content_status`
4. [x] **Subtopic Weight Boost (Like)** : Liker un article booste les `user_subtopics.weight` des topics de l'article (+0.15)
5. [x] **Subtopic Weight Boost (Bookmark)** : Sauvegarder un article booste les `user_subtopics.weight` (+0.05)
6. [x] **Weight Caps** : Poids plafonn√© √† 3.0, plancher √† 0.1
7. [x] **Scoring Engine** : `ArticleTopicLayer` utilise les poids pond√©r√©s (`TOPIC_MATCH * weight`) au lieu d'un score fixe
8. [x] **Score Transparency** : L'explication de scoring affiche "Renforc√© par vos j'aime" quand un topic a un poids > 1.0
9. [x] **Digest Actions** : Actions `LIKE` et `UNLIKE` ajout√©es au `DigestAction` enum et trait√©es dans `DigestService`
10. [x] **Feed Card UX** : Les cartes du feed affichent 4 boutons compacts : ‚ù§Ô∏è Like, üîñ Save, üëÅÔ∏è Voir moins, ‚ÑπÔ∏è Info
11. [x] **Digest ‚Üî Feed coh√©rence** : Le boost subtopic s'applique via les deux chemins (feed + digest)

## Tasks / Subtasks

### Backend ‚Äî Migration

- [x] **Task 1: Migration Alembic** (AC: 3)
  - [x] Ajouter `is_liked BOOLEAN NOT NULL DEFAULT false` √† `user_content_status`
  - [x] Ajouter `liked_at TIMESTAMPTZ` √† `user_content_status`
  - [x] Cr√©er index composite `ix_user_content_status_user_liked` sur `(user_id, is_liked)`
  - Migration: `b3c4d5e6f7a8_add_is_liked_to_user_content_status.py`

### Backend ‚Äî Model & Schema

- [x] **Task 2: Mod√®le ORM** (AC: 3)
  - [x] Ajouter `is_liked: Mapped[bool]` et `liked_at: Mapped[Optional[datetime]]` √† `UserContentStatus`
  - Fichier: `packages/api/app/models/content.py`

- [x] **Task 3: Sch√©mas Pydantic** (AC: 2, 9)
  - [x] Ajouter `is_liked: bool = False` √† `ContentResponse` et `ContentDetailResponse`
  - [x] Ajouter `is_liked: bool = False` √† `DigestItem`
  - [x] Ajouter `LIKE = "like"` et `UNLIKE = "unlike"` √† `DigestAction` enum
  - Fichiers: `packages/api/app/schemas/content.py`, `packages/api/app/schemas/digest.py`

### Backend ‚Äî Service

- [x] **Task 4: ContentService** (AC: 2, 4, 5, 6)
  - [x] `set_like_status(user_id, content_id, is_liked)` ‚Äî upsert like/unlike avec delta ¬±0.15
  - [x] `_adjust_subtopic_weights(user_id, content_id, delta)` ‚Äî m√©thode g√©n√©rique : charge topics du contenu, ajuste `user_subtopics.weight` avec cap [0.1, 3.0]
  - [x] Modifier `set_save_status` pour appeler `_adjust_subtopic_weights(+0.05)` au save
  - Fichier: `packages/api/app/services/content_service.py`

- [x] **Task 5: DigestService** (AC: 9, 11)
  - [x] Ajouter handling `LIKE`/`UNLIKE` dans `apply_action`
  - [x] Ajouter appel `_adjust_subtopic_weights(+0.05)` sur action `SAVE`
  - [x] Hydrater `is_liked` dans `_get_batch_action_states` et `_build_digest_response`
  - Fichier: `packages/api/app/services/digest_service.py`

### Backend ‚Äî Router

- [x] **Task 6: Endpoints Like** (AC: 2)
  - [x] `POST /contents/{content_id}/like` ‚Äî marque comme aim√©
  - [x] `DELETE /contents/{content_id}/like` ‚Äî retire le like
  - Fichier: `packages/api/app/routers/contents.py`

### Backend ‚Äî Scoring Engine

- [x] **Task 7: Scoring Config** (AC: 4, 5)
  - [x] Ajouter constantes `LIKE_TOPIC_BOOST = 0.15`, `BOOKMARK_TOPIC_BOOST = 0.05`, `LIKE_INTEREST_RATE = 0.03`
  - Fichier: `packages/api/app/services/recommendation/scoring_config.py`

- [x] **Task 8: ScoringContext** (AC: 7)
  - [x] Ajouter `user_subtopic_weights: Dict[str, float]` au constructeur
  - Fichier: `packages/api/app/services/recommendation/scoring_engine.py`

- [x] **Task 9: ArticleTopicLayer** (AC: 7, 8)
  - [x] Scoring pond√©r√© : `TOPIC_MATCH * weight` au lieu de `TOPIC_MATCH` fixe
  - [x] Annotation `[liked: topic]` quand `weight > 1.0` pour label "Renforc√© par vos j'aime"
  - Fichier: `packages/api/app/services/recommendation/layers/article_topic.py`

- [x] **Task 10: Hydratation poids** (AC: 7)
  - [x] `RecommendationService` charge `user_subtopic_weights` (Dict[str, float]) et passe au `ScoringContext`
  - [x] `DigestSelector` charge `user_subtopic_weights` dans `DigestContext`
  - [x] Label "Renforc√© par vos j'aime" dans `_determine_top_reason`
  - Fichiers: `packages/api/app/services/recommendation_service.py`, `packages/api/app/services/digest_selector.py`

### Frontend ‚Äî Mobile

- [x] **Task 11: Content Model** (AC: 1)
  - [x] Ajouter `isLiked` au mod√®le `Content` (constructeur, fromJson, copyWith)
  - Fichier: `apps/mobile/lib/features/feed/models/content_model.dart`

- [x] **Task 12: Feed Repository** (AC: 2)
  - [x] `toggleLike(contentId, isLiked)` ‚Äî appels `POST`/`DELETE /contents/{id}/like`
  - Fichier: `apps/mobile/lib/features/feed/repositories/feed_repository.dart`

- [x] **Task 13: Feed Provider** (AC: 1)
  - [x] `toggleLike(Content)` ‚Äî mise √† jour optimiste
  - Fichier: `apps/mobile/lib/features/feed/providers/feed_provider.dart`

- [x] **Task 14: Feed Card UX** (AC: 1, 10)
  - [x] Bouton ‚ù§Ô∏è Like (coeur rempli si `isLiked`, couleur terracotta)
  - [x] Bouton üîñ Save (rempli si `isSaved`)
  - [x] Bouton üëÅÔ∏è Voir moins (`onNotInterested`)
  - [x] Bouton ‚ÑπÔ∏è Info (ic√¥ne compacte, remplace l'ancien texte "Personnalisation")
  - Fichier: `apps/mobile/lib/features/feed/widgets/feed_card.dart`

- [x] **Task 15: Feed Screen Wiring** (AC: 1, 10)
  - [x] Passer `onLike`, `isLiked`, `onSave`, `isSaved`, `onNotInterested`, `onPersonalize` √† FeedCard
  - Fichier: `apps/mobile/lib/features/feed/screens/feed_screen.dart`

- [x] **Task 16: Digest Models** (AC: 9)
  - [x] Ajouter `isLiked` √† `DigestItem` (Freezed, + .freezed.dart + .g.dart)
  - Fichier: `apps/mobile/lib/features/digest/models/digest_models.dart`

- [x] **Task 17: Digest Provider & Screen** (AC: 9)
  - [x] `_handleLike()` dans `digest_screen.dart`
  - [x] Actions `like`/`unlike` dans `digest_provider.dart`
  - [x] Passer `onLike`/`isLiked` dans `digest_briefing_section.dart`
  - [x] `_convertToContent` passe `isLiked` et `isSaved` au mod√®le `Content`
  - Fichiers: `apps/mobile/lib/features/digest/screens/digest_screen.dart`, `apps/mobile/lib/features/digest/providers/digest_provider.dart`, `apps/mobile/lib/features/digest/widgets/digest_briefing_section.dart`

- [x] **Task 18: Saved Screen** (AC: 10)
  - [x] Passer `isLiked: content.isLiked` √† FeedCard
  - [x] Retirer le callback noop `onPersonalize: () {}`
  - Fichier: `apps/mobile/lib/features/saved/screens/saved_screen.dart`

### Tests

- [x] **Task 19: Tests Backend** (AC: 2, 4, 5, 6)
  - [x] 7 tests: like/unlike, subtopic weight +0.15/-0.15, weight cap 3.0, bookmark boost +0.05, cr√©ation nouveau subtopic
  - Fichier: `packages/api/tests/test_like_feature.py`

- [x] **Task 20: Tests Frontend** (AC: 1)
  - [x] 4 tests: fromJson parsing, default value, copyWith preservation, copyWith update
  - Fichier: `apps/mobile/test/features/feed/like_feature_test.dart`

## Dev Notes

### Architecture D√©cision

Le m√©canisme de "like" est s√©par√© du statut existant (`unseen/seen/consumed/saved/hidden`). `is_liked` est un **flag orthogonal** sur `user_content_status`, pas un nouveau statut ‚Äî un article peut √™tre √† la fois "consumed" et "liked".

### Deux Chemins d'Action

| Chemin | Endpoint | Service | Boost |
|--------|----------|---------|-------|
| **Feed** | `POST /contents/{id}/like` | `ContentService.set_like_status` | ¬±0.15 |
| **Feed** | `POST /contents/{id}/save` | `ContentService.set_save_status` | +0.05 |
| **Digest** | `POST /digest/{id}/action` (action=like) | `DigestService.apply_action` | ¬±0.15 |
| **Digest** | `POST /digest/{id}/action` (action=save) | `DigestService.apply_action` | +0.05 |

Les deux chemins appellent `_adjust_subtopic_weights()` pour garantir la coh√©rence.

### Formule de Scoring Modifi√©e

```
// Avant (fixe)
topic_score = TOPIC_MATCH  // 6 points par match

// Apr√®s (pond√©r√©)
topic_score = TOPIC_MATCH * user_subtopic_weight  // 6 * [0.1..3.0] = 0.6..18 pts
```

Quand `weight > 1.0`, le label "Renforc√© par vos j'aime" appara√Æt dans l'explication de scoring.

### Constantes

| Constante | Valeur | Description |
|-----------|--------|-------------|
| `LIKE_TOPIC_BOOST` | +0.15 | Delta poids topic par like |
| `BOOKMARK_TOPIC_BOOST` | +0.05 | Delta poids topic par bookmark |
| `LIKE_INTEREST_RATE` | 0.03 | R√©serv√© usage futur |
| Weight cap | 3.0 | Plafond poids subtopic |
| Weight floor | 0.1 | Plancher poids subtopic |

## Dev Agent Record

**Agent:** Claude (Dev)
**Dates:** 15/02/2026
**Branch:** `claude/add-like-bookmark-signals-xh8Wj`

### Files Created

| Fichier | Description |
|---------|-------------|
| `packages/api/alembic/versions/b3c4d5e6f7a8_add_is_liked_to_user_content_status.py` | Migration Alembic |
| `packages/api/tests/test_like_feature.py` | 7 tests backend |
| `apps/mobile/test/features/feed/like_feature_test.dart` | 4 tests frontend |

### Files Modified

**Backend:**
| Fichier | Modification |
|---------|-------------|
| `packages/api/app/models/content.py` | +`is_liked`, `liked_at` columns |
| `packages/api/app/schemas/content.py` | +`is_liked` field |
| `packages/api/app/schemas/digest.py` | +`is_liked` field, +`LIKE`/`UNLIKE` enum |
| `packages/api/app/services/content_service.py` | +`set_like_status`, `_adjust_subtopic_weights` |
| `packages/api/app/services/digest_service.py` | +like/unlike handling, +bookmark boost, +`is_liked` hydration |
| `packages/api/app/routers/contents.py` | +`POST/DELETE /{id}/like` |
| `packages/api/app/services/recommendation/scoring_config.py` | +`LIKE_TOPIC_BOOST`, `BOOKMARK_TOPIC_BOOST` |
| `packages/api/app/services/recommendation/scoring_engine.py` | +`user_subtopic_weights` in `ScoringContext` |
| `packages/api/app/services/recommendation/layers/article_topic.py` | Weighted scoring + `[liked:]` annotations |
| `packages/api/app/services/recommendation_service.py` | +`is_liked` hydration, weighted subtopics loading |
| `packages/api/app/services/digest_selector.py` | +`user_subtopic_weights` in `DigestContext`, weighted topic scoring |
| `packages/api/app/routers/digest.py` | +LIKE/UNLIKE messages |

**Frontend:**
| Fichier | Modification |
|---------|-------------|
| `apps/mobile/lib/features/feed/models/content_model.dart` | +`isLiked` field |
| `apps/mobile/lib/features/feed/repositories/feed_repository.dart` | +`toggleLike` |
| `apps/mobile/lib/features/feed/providers/feed_provider.dart` | +`toggleLike` optimistic |
| `apps/mobile/lib/features/feed/widgets/feed_card.dart` | +Like btn, compact ‚ÑπÔ∏è info btn |
| `apps/mobile/lib/features/feed/screens/feed_screen.dart` | +Wire onLike, onNotInterested |
| `apps/mobile/lib/features/digest/models/digest_models.dart` | +`isLiked` |
| `apps/mobile/lib/features/digest/providers/digest_provider.dart` | +like/unlike actions |
| `apps/mobile/lib/features/digest/screens/digest_screen.dart` | +`_handleLike()` |
| `apps/mobile/lib/features/digest/widgets/digest_briefing_section.dart` | +`onLike`, `isLiked`/`isSaved` in `_convertToContent` |
| `apps/mobile/lib/features/digest/widgets/article_action_bar.dart` | Like button in 4-button layout |
| `apps/mobile/lib/features/saved/screens/saved_screen.dart` | +`isLiked`, removed noop `onPersonalize` |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 15/02/2026 | 1.0 | Implementation compl√®te ‚Äî 20 tasks done, backend + frontend + tests + UX alignment | Dev Agent (Claude) |
