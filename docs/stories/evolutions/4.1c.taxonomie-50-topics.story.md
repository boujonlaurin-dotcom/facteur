# Story 4.1c : Taxonomie 50 Topics & Normalisation Th√®mes

> **Parent Story**: [[../core/4.1.feed-algorithme.md]]  
> **Type**: Evolution

## Status: Done ‚úÖ

## Story

**As a** d√©veloppeur,  
**I want** normaliser les th√®mes sources et enrichir avec 50 topics granulaires,  
**so that** le syst√®me puisse faire des recommendations pr√©cises.

## Background

Cette story **remplace Story 8.1** qui √©tait initialement dans Epic 8 (Progression). Elle a √©t√© d√©plac√©e vers Epic 4 (Algorithme) car les sous-th√®mes sont critiques pour le syst√®me de recommandation, pas uniquement pour les quiz.

## Acceptance Criteria

1. **Migration `Source.theme`** : Normalisation vers 8 valeurs fixes
   - Mapping ancien ‚Üí nouveau appliqu√©
   - Contrainte BDD : theme IN ('tech', 'society', 'environment', 'economy', 'politics', 'culture', 'science', 'international')
2. **Table `user_subtopics`** cr√©√©e avec user_id, topic_slug, weight
3. **Colonne `Content.topics TEXT[]`** ajout√©e avec index GIN
4. **Les 46 sources CURATED** ont `granular_topics` renseign√© manuellement
5. **Script de validation** v√©rifiant coh√©rence taxonomie (pas de topic orphelin)

## Dev Notes

### Migration 1 : Normalisation Source.theme

```python
# alembic/versions/xxx_normalize_source_themes.py

THEME_NORMALIZATION = {
    "Tech & Futur": "tech",
    "Soci√©t√© & Climat": "society",  
    "√âconomie": "economy",
    "G√©opolitique": "international",
    "Culture & Id√©es": "culture",
}

def upgrade():
    for old, new in THEME_NORMALIZATION.items():
        op.execute(f"UPDATE sources SET theme = '{new}' WHERE theme = '{old}'")
    
    op.create_check_constraint(
        "ck_source_theme_valid",
        "sources",
        "theme IN ('tech', 'society', 'environment', 'economy', 'politics', 'culture', 'science', 'international')"
    )

def downgrade():
    op.drop_constraint("ck_source_theme_valid", "sources")
    # Reverse mapping...
```

### Migration 2 : Content.topics

```python
# alembic/versions/xxx_add_content_topics.py

def upgrade():
    from sqlalchemy import ARRAY, Text
    
    op.add_column('contents', sa.Column('topics', ARRAY(Text), nullable=True))
    op.create_index(
        'ix_contents_topics', 
        'contents', 
        ['topics'], 
        postgresql_using='gin'
    )
```

### Migration 3 : user_subtopics

```python
# alembic/versions/xxx_create_user_subtopics.py

def upgrade():
    op.create_table(
        'user_subtopics',
        sa.Column('id', UUID, primary_key=True, default=uuid4),
        sa.Column('user_id', UUID, ForeignKey('user_profiles.user_id'), nullable=False),
        sa.Column('topic_slug', String(50), nullable=False),
        sa.Column('weight', Float, default=1.0),
        sa.Column('created_at', DateTime, default=datetime.utcnow),
        sa.UniqueConstraint('user_id', 'topic_slug', name='uq_user_subtopics')
    )
```

### Peuplement granular_topics

```csv
# sources_master.csv (mise √† jour pour 46 sources CURATED)

Name,URL,Type,Th√®me,Status,granular_topics
ScienceEtonnante,https://...,YouTube,tech,CURATED,"[ai, fundamental-research, applied-science]"
Bon Pote,https://...,Site,environment,CURATED,"[climate, biodiversity, energy-transition]"
# ... 44 autres
```

```python
# scripts/import_sources.py (modification)

if row['granular_topics']:
    topics = json.loads(row['granular_topics'])  # Parse JSON array
    source.granular_topics = topics
```

### Script de validation

```python
# scripts/validate_taxonomy.py

VALID_THEMES = {'tech', 'society', 'environment', ...}
VALID_TOPICS = {'ai', 'llm', 'crypto', ...}  # 50 topics

def validate():
    # 1. V√©rifier que tous source.theme sont valides
    invalid_themes = session.query(Source).filter(
        ~Source.theme.in_(VALID_THEMES)
    ).all()
    assert len(invalid_themes) == 0
    
    # 2. V√©rifier que tous topics dans granular_topics sont valides
    for source in session.query(Source).filter(Source.granular_topics != None):
        for topic in source.granular_topics:
            assert topic in VALID_TOPICS, f"Invalid topic: {topic}"
    
    # 3. V√©rifier mapping coh√©rent
    # ...
```

## Taxonomie 50 Topics

Voir [PRD Section Taxonomie](../prd.md#taxonomie--syst√®me-de-classification) pour la liste compl√®te.

## Testing

1. **Migration Rollback** : Tester upgrade + downgrade sans perte de donn√©es
2. **Import sources** : V√©rifier parsing JSON pour `granular_topics`
3. **Validation script** : Ex√©cuter sur BDD de dev et prod

## Effort & Priority

- **Effort :** 8 points (1 sprint)
- **Priority :** üü° HIGH (requis pour Epic 8 et scoring granulaire)
- **Sprint :** +1

## Dependencies

- **Bloque :** Story 4.1d (Classification), Story 8.2-8.6 (Progression/Quiz)
- **Bloqu√© par :** Story 4.1b (fix bug matching)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 19/01/2026 | 1.0 | D√©plac√©e depuis Epic 8 ‚Üí Epic 4 | Antigravity |
