# EPIC 11 : Personnalisation AvancÃ©e â€” Filtres ThÃ¨me Feed + Digest Configurable

> **Brainstorming BMAD** : Analyste (Mary), UX Expert (Sally), Architecte (Winston)
> **Statut** : Design Phase â€” V2 aprÃ¨s retours utilisateur
> **Date** : 2026-02-10

---

## 1. Perspective Analyste (Mary) â€” Contexte StratÃ©gique

### Contexte Ã‰conomique
Facteur est un **produit alpha en startup**, avec un objectif immÃ©diat : **crÃ©er de l'adoption chez les testeurs** en jouant sur leurs **attentes Ã©motionnelles**. Les alpha-testeurs utilisent principalement le Digest â€” c'est le coeur du produit depuis le pivot Epic 10.

### Pourquoi cet epic maintenant

**Feature 1 (Feed par ThÃ¨me) :**
- Use-case immÃ©diat et intuitif â†’ valeur perÃ§ue dÃ¨s la premiÃ¨re utilisation
- Valide le fonctionnement de la classification thÃ©matique (signal qualitatif)
- Faible complexitÃ© technique â†’ quick win pour montrer que l'app Ã©volue

**Feature 2 (Digest Configurable) :**
- Donne le **sentiment de contrÃ´le** aux early adopters â†’ levier Ã©motionnel fort
- Transforme les testeurs en **co-designers** : on observe ce qu'ils choisissent
- PrÃ©pare le terrain pour des personnalisations algorithmiques futures (data-driven)
- RÃ©intÃ¨gre "Serein" et "Changer de bord" â€” features dÃ©jÃ  comprises par les utilisateurs

### Insight ClÃ© : L'Adoption par le ContrÃ´le PerÃ§u
Les utilisateurs alpha veulent sentir que l'app **leur appartient**. Un "Standard" imposÃ© crÃ©e de l'indiffÃ©rence. Offrir 4 modes = offrir une **identitÃ© de lecteur**. MÃªme si 80% restent en "Pour vous", le simple fait d'avoir **choisi** augmente l'engagement.

### Signaux Ã  Collecter (MÃ©triques)
| Signal | Source | Insight Attendu |
|--------|--------|-----------------|
| Mode digest choisi par utilisateur | `user_preferences` | Quel mode "rÃ©sonne" le plus |
| Taux complÃ©tion par mode | `digest_completions` + `daily_digest.mode` | Quel mode engage le plus |
| Utilisation filtres thÃ¨me/feed | Analytics | Les thÃ¨mes sont-ils un besoin rÃ©el ou perÃ§u |
| Changement de mode dans le temps | `user_preferences` historique | FidÃ©litÃ© aux modes vs exploration |

### PrioritÃ© : Digest d'abord
Les alpha-testeurs vivent dans le Digest. L'impact sur l'adoption sera immÃ©diat. Le feed (Explorer Plus) est secondaire mais reste une feature "signature" pour les power users.

### PrÃ©requis Critique : Corriger les Filtres CassÃ©s
"Serein" est **non-fonctionnel** (slugs de thÃ¨mes incorrects en DB). "Changer de bord" nÃ©cessite une vÃ©rification. Sans ce fix, impossible de proposer ces modes en digest.

---

## 2. Perspective UX Expert (Sally) â€” Design & Ton

### Principes UX pour cet Epic

1. **Empowerment, pas surcharge** â€” 4 choix max, pas de curseurs, pas de menus imbriquÃ©s
2. **DÃ©couverte progressive** â€” L'utilisateur dÃ©couvre les modes naturellement via le tab selector visible
3. **Transparence** â€” L'utilisateur comprend *pourquoi* il voit ce qu'il voit (principe #5 du front-end spec)
4. **CohÃ©rence Ã©motionnelle** â€” Chaque mode a sa couleur, son emoji, son ton â†’ sentiment de "changer de prisme"
5. **Feedback immÃ©diat** â€” Le changement de mode transforme visuellement le digest instantanÃ©ment

### 2.1 Feed â€” Chips ThÃ©matiques

**Design :**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [ğŸ’» Tech] [ğŸŒ GÃ©opo] [ğŸ”¬ Science] [ğŸ¨ Culture] [ğŸ‘¥ SociÃ©tÃ©] ...  â”‚  â† Scroll horizontal
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  (sous-description alignÃ©e sous le chip sÃ©lectionnÃ©)             â”‚
â”‚  "Contenus Tech & Futur de vos sources"                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**DÃ©cisions UX :**
- **Tous les thÃ¨mes** de l'utilisateur affichÃ©s (pas de plafond), scroll horizontal si >4
- **Ordre** = `UserInterest.weight` dÃ©croissant (mÃªme logique que l'algo de recommandation â†’ transparence)
- **Format chip** : emoji + label FR court (ex: "ğŸ’» Tech", "ğŸŒ GÃ©opo", "ğŸ”¬ Science")
- **Feedback** : description courte sous le chip sÃ©lectionnÃ© (pattern dÃ©jÃ  implÃ©mentÃ© dans `filter_bar.dart`)
- **Aucun filtre actif par dÃ©faut** = le feed complet (cohÃ©rent avec l'Ã©tat actuel)
- **Re-tap** = dÃ©sÃ©lection (retour feed complet)
- **Cas limite** : <2 thÃ¨mes â†’ ne pas afficher la barre de filtres (invite Ã  complÃ©ter l'onboarding en settings)

**Transition depuis les filtres actuels :**
- Les modes "Rester serein", "Changer de perspective", "Longs formats" **disparaissent du feed**
- Leur logique migre vers les **presets Digest** (valeur relocalisÃ©e, pas perdue)
- Le front-end spec (section 4.2 "Filtres chips scrollables") montre dÃ©jÃ  un pattern scrollable â†’ on le rÃ©utilise

### 2.2 Digest â€” Tab Selector en Haut de l'Essentiel

**Principe central :** Un tab selector horizontal toujours visible en haut de l'Ã©cran digest. Chaque tab a sa couleur distincte, son icÃ´ne, et change immÃ©diatement l'apparence + le contenu du digest.

**Wireframe â€” Vue gÃ©nÃ©rale :**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”¥ 3                ğŸ“¬              âš™ï¸  â”‚  â† Header (streak + logo + settings)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [â˜€ï¸ Pour vous] [ğŸ§˜ Serein] [ğŸ­ Changer] [ğŸ” Focus]  â”‚  â† Tab selector horizontal
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  ğŸ§˜ L'Essentiel du Jour             â”‚â”‚  â† Container adaptatif (couleur = mode)
â”‚  â”‚  Sans politique ni infos anxiogÃ¨nes  â”‚â”‚  â† Sous-titre contextuel
â”‚  â”‚  â± 12 min de lecture       3/5      â”‚â”‚
â”‚  â”‚                                      â”‚â”‚
â”‚  â”‚  [Article cards...]                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                          â”‚
â”‚  â„¹ï¸ Votre essentiel de demain sera      â”‚  â† Message inline (si mode changÃ©)
â”‚     aussi en mode Serein                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**IdentitÃ© Visuelle des 4 Modes :**

| Mode | IcÃ´ne (Phosphor) | Label Tab | Couleur | DÃ©gradÃ© Container (dark) | Sous-titre Essentiel | Ã‰motion |
|------|------------------|-----------|---------|--------------------------|---------------------|---------|
| Pour vous | `SunDim` (â˜€ï¸) | Pour vous | **Primary** (Terracotta `#C0392B`) | `#1A1918 â†’ #2C2A29` (actuel obsidian) | "Votre sÃ©lection personnalisÃ©e" | Neutre, confiance |
| Serein | `Leaf` / `YinYang` (ğŸ§˜) | Serein | **Vert** (`#2ECC71` / `colors.success`) | `#1A201A â†’ #1E2C1E` (teinte verte sombre) | "Sans politique ni infos anxiogÃ¨nes" | Apaisement, zen |
| Changer de bord | `UserSwitch` / `Shuffle` (ğŸ­) | Changer | **Bleu-Rouge** (`#6B9AC4` pour le tab, dÃ©gradÃ© bicolore pour le container) | `#1A1A20 â†’ #201A1A` (teinte bleu-rouge sombre) | "DÃ©couvrir l'autre bord politique" | CuriositÃ©, empathie |
| Focus thÃ©matique | `MagnifyingGlass` (ğŸ”) | Focus | **Ambre/Or** (`#F39C12` / `colors.warning`) | `#201A14 â†’ #2C2418` (teinte dorÃ©e sombre) | "100% {thÃ¨me choisi}" | Focus, expertise |

**Comportement du Container selon le Mode :**

Le container `DigestBriefingSection` s'adapte au mode sÃ©lectionnÃ© :
- **Border** : couleur du mode (alpha 0.3) au lieu du primary fixe
- **Gradient** : dÃ©gradÃ© sombre teintÃ© par la couleur du mode (effet premium)
- **Emoji** : affichÃ© avant le titre "L'Essentiel du Jour"
- **Sous-titre** : texte contextuel spÃ©cifique au mode (remplace "X min de lecture" ou s'ajoute en dessous)
- **Transition** : `AnimatedContainer` (300ms, easeOutCubic) pour un changement fluide

**Comportement au Changement de Tab :**

Quand l'utilisateur tap un nouveau tab :

1. **Visuel immÃ©diat** (0ms) : La couleur du container, le dÃ©gradÃ©, l'emoji et le sous-titre changent instantanÃ©ment via `AnimatedContainer`. Impression de "changer de prisme/lunettes".

2. **Sauvegarde pour demain** : La prÃ©fÃ©rence est enregistrÃ©e en `user_preferences` (clÃ© `digest_mode`). Un message inline apparaÃ®t sous le digest : *"Votre essentiel de demain sera aussi en mode Serein"* â€” pas de toast/notification, juste un texte discret.

3. **RafraÃ®chissement du contenu** : Le digest est rÃ©gÃ©nÃ©rÃ© avec le nouveau mode via `POST /api/digest/generate?mode=serein&force=true`. Pendant le chargement :
   - Les articles actuels restent visibles avec une **opacitÃ© rÃ©duite** (0.5)
   - Un **shimmer overlay** ou un indicateur de chargement subtil apparaÃ®t
   - Le nouveau container (couleur/gradient) est dÃ©jÃ  appliquÃ© â†’ feedback immÃ©diat
   - Si l'API met plus de ~3s, afficher "RafraÃ®chissement en cours..." sous le tab selector

4. **Question ouverte â€” Confirmation** : Faut-il demander confirmation avant de rÃ©gÃ©nÃ©rer ? Options :
   - **Option A (recommandÃ©e)** : Pas de confirmation. Le changement est fluide et rÃ©versible (l'utilisateur peut re-taper "Pour vous"). Le coÃ»t UX d'un dialog > le coÃ»t d'une rÃ©gÃ©nÃ©ration.
   - **Option B** : Confirmation lÃ©gÃ¨re â€” snackbar avec "Annuler" pendant 3s avant de lancer la rÃ©gÃ©nÃ©ration (pattern Material "undo").

**Tab Selector â€” Design DÃ©taillÃ© :**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [â˜€ï¸ Pour vous]  [ğŸ§˜ Serein]  [ğŸ­ Changer]  [ğŸ” Focus]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **Composant** : `SingleChildScrollView` horizontal avec 4 pills
- **Pill sÃ©lectionnÃ©e** : fond = couleur du mode (alpha 0.15), border = couleur du mode, texte = couleur du mode (bold), icÃ´ne = couleur du mode
- **Pill non sÃ©lectionnÃ©e** : fond transparent, texte = `textTertiary`, icÃ´ne = `textTertiary`
- **Espacement** : 8px entre les pills, padding horizontal 16px
- **Animation** : `AnimatedContainer` sur chaque pill (200ms)
- **Scroll** : horizontal si les 4 pills ne rentrent pas (petit Ã©cran)
- **Indicateur** : pas d'underline material, style pill/capsule (border radius `pill`)

**Point d'entrÃ©e secondaire : Settings > Mon Digest**

```
Settings Screen:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CONTENU                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ“¬ Mon Essentiel              >   â”‚  â”‚  â† NOUVEAU
â”‚  â”‚    Mode : Serein ğŸ§˜              â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ ğŸ”– Mes sauvegardes         >     â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ â­ Sources de confiance     >     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Mon Digest Screen (sous-Ã©cran Settings):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Mon Essentiel                         â”‚
â”‚                                          â”‚
â”‚  Mode de mon essentiel                   â”‚
â”‚  [MÃªme 4 cards que le tab selector]      â”‚
â”‚  (mais version Ã©tendue avec description) â”‚
â”‚                                          â”‚
â”‚  â”€â”€ SÃ©parateur â”€â”€                        â”‚
â”‚                                          â”‚
â”‚  ThÃ¨me Focus (visible si mode=focus)     â”‚
â”‚  [ğŸ’» Tech] [ğŸŒ GÃ©opo] [ğŸ”¬ Science] ...   â”‚  â† Chips thÃ¨mes utilisateur
â”‚                                          â”‚
â”‚  â„¹ï¸ Ton essentiel est gÃ©nÃ©rÃ© chaque      â”‚
â”‚     matin Ã  8h avec ce mode.             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 Parcours Utilisateur Type

```
Jour 1 : L'utilisateur ouvre son Digest â†’ voit le tab selector avec 4 modes
         CuriositÃ© â†’ tap "Serein" â†’ le container passe en vert sombre, emoji ğŸ§˜
         â†’ le digest se rÃ©gÃ©nÃ¨re â†’ articles sans politique
         â†’ message : "Votre essentiel de demain sera aussi en mode Serein"

Jour 2 : Digest serein automatique â†’ l'utilisateur apprÃ©cie â†’ tab "Serein" est prÃ©-sÃ©lectionnÃ©
         Plus tard, explore le Feed â†’ voit ses thÃ¨mes en chips â†’ filtre "Tech"
         â†’ DÃ©couvre du contenu tech qu'il ne voyait pas dans le digest serein

Jour 5 : L'utilisateur tape "Changer" â†’ container bleu-rouge, emoji ğŸ­
         â†’ articles d'opinions opposÃ©es â†’ "tiens, c'est intÃ©ressant"
         â†’ revient Ã  "Pour vous" le lendemain (exploration ponctuelle)

Jour 7 : L'utilisateur va dans Settings > Mon Essentiel â†’ sÃ©lectionne "Focus"
         â†’ choisit le thÃ¨me "Tech" â†’ son digest sera 100% tech dÃ¨s demain
```

---

## 3. Perspective Architecte (Winston) â€” Design Technique

### 3.1 Audit : Ce qui est CassÃ©

**INSPIRATION Mode ("Rester serein") â€” `recommendation_service.py:539-548`**
- `Source.theme.notin_(['society_climate', 'geopolitics', 'economy'])`
- `society_climate` et `geopolitics` **n'existent pas en DB**
- ThÃ¨mes rÃ©els : `society`, `international`
- **RÃ©sultat** : seul `economy` est filtrÃ© â†’ la majoritÃ© du contenu anxiogÃ¨ne passe

**PERSPECTIVES Mode ("Changer de point de vue") â€” `recommendation_service.py:571-630`**
- Logique bias fonctionne (`_calculate_user_bias` + `_get_opposing_biases`)
- **Risque** : si l'utilisateur n'a pas de sources suivies, bias = vide â†’ mode silencieusement inactif
- **Question thÃ¨mes/sous-thÃ¨mes** : le mode ne tient pas compte des thÃ¨mes/subtopics â€” il filtre uniquement par `Source.bias_stance`. Pour le digest, c'est trop agressif (7 articles 100% opposÃ©s). Le boost soft scoring est plus adaptÃ©.

### 3.2 Architecture de la Solution

**Extraction partagÃ©e : `services/recommendation/filter_presets.py`**

```python
# Logique partagÃ©e feed â†” digest

SEREIN_EXCLUDED_THEMES = ['society', 'international', 'economy', 'politics']

SEREIN_KEYWORDS = [
    'politique', 'guerre', 'conflit', 'Ã©lections', 'inflation', 'grÃ¨ve',
    'drame', 'fait divers', 'faits divers', 'crise', 'scandale',
    'terrorisme', 'corruption', 'procÃ¨s', 'violence', 'catastrophe',
    'manifestation', 'gÃ©opolitique',
    'trump', 'musk', 'poutine', 'macron', 'netanyahou', 'zelensky',
    'ukraine', 'gaza',
]

def apply_serein_filter(query):
    """Exclut thÃ¨mes anxiogÃ¨nes + keywords nÃ©gatifs"""
    query = query.where(Source.theme.notin_(SEREIN_EXCLUDED_THEMES))
    keywords_pattern = '|'.join(SEREIN_KEYWORDS)
    query = query.where(~Content.title.op('~*')(keywords_pattern))
    query = query.where(~Content.description.op('~*')(keywords_pattern))
    return query

def calculate_perspective_boost(content, user_bias, opposing_biases):
    """Retourne un bonus de scoring pour les contenus de biais opposÃ©"""
    if content.source.bias_stance in opposing_biases:
        return +80  # Boost significatif mais pas exclusif
    return 0

def apply_theme_focus_filter(query, theme_slug):
    """Filtre SQL pour 100% d'un thÃ¨me"""
    return query.where(Source.theme == theme_slug)
```

**DigestMode Enum :**
```python
class DigestMode(str, Enum):
    POUR_VOUS = "pour_vous"      # ex-Standard
    SEREIN = "serein"
    PERSPECTIVE = "perspective"   # "Changer de bord"
    THEME_FOCUS = "theme_focus"
```

**Modification DigestSelector :**
- `select_for_user(user_id, mode=DigestMode.POUR_VOUS, focus_theme=None)`
- POUR_VOUS : algo actuel inchangÃ©
- SEREIN : `apply_serein_filter()` sur la query candidates
- PERSPECTIVE : scoring boost (+80) sur biais opposÃ©, pas de filtre hard â†’ le scoring naturel Ã©quilibre (~3-4 articles opposÃ©s sur 7)
- THEME_FOCUS : `apply_theme_filter()` + relaxe contrainte max 2 articles/thÃ¨me

**Modification Feed :**
- `GET /api/feed/` : nouveau param `theme: str | None`
- `_get_candidates()` : `WHERE source.theme = :theme` si fourni
- Le param `mode` reste pour rÃ©tro-compatibilitÃ© mais est dÃ©prÃ©ciÃ©
- Le mode `INSPIRATION` du feed est corrigÃ© avec les bons slugs (`apply_serein_filter()`)

**Endpoint Top Themes :**
- `GET /api/users/top-themes` ou intÃ©grÃ© dans le user profile existant
- Retourne la liste ordonnÃ©e par `UserInterest.weight` DESC (exacte mÃªme logique que le scoring de recommandation)
- Format : `[{slug, label_fr, emoji, weight}]`

**Stockage PrÃ©fÃ©rences Digest :**
- `user_preferences` : key=`digest_mode`, value=`serein` (ou `pour_vous`, `perspective`, `theme_focus`)
- `user_preferences` : key=`digest_focus_theme`, value=`tech` (seulement si mode=`theme_focus`)
- `daily_digest` : nouvelle colonne `mode` (String, nullable) â†’ tracking du mode utilisÃ© Ã  la gÃ©nÃ©ration

**Migration Alembic :**
- `ALTER TABLE daily_digest ADD COLUMN mode VARCHAR(20) DEFAULT 'pour_vous'`

### 3.3 RÃ©gÃ©nÃ©ration On-Demand (Changement de Mode)

Le changement de mode dans le tab selector doit rÃ©gÃ©nÃ©rer le digest immÃ©diatement. Cela implique :

**Endpoint existant rÃ©utilisÃ© :** `POST /api/digest/generate`
- Ajouter param `mode: str | None = Query(None)` et `focus_theme: str | None = Query(None)`
- Si `force=true` + `mode` fourni â†’ rÃ©gÃ©nÃ©rer avec ce mode
- Stocker le mode sur le `DailyDigest` record crÃ©Ã©

**Flow de rÃ©gÃ©nÃ©ration :**
```
[Mobile] Tap tab "Serein"
  â†’ PUT /api/users/preferences  {digest_mode: "serein"}   â† sauvegarde pour demain
  â†’ POST /api/digest/generate?mode=serein&force=true       â† rÃ©gÃ©nÃ¨re maintenant
  â† DigestResponse {mode: "serein", items: [...]}
  â†’ UI met Ã  jour les articles + le design container
```

**Performance :** La sÃ©lection de 7 articles prend ~200-500ms cÃ´tÃ© backend (query SQL + scoring en mÃ©moire). Acceptable pour un changement de mode occasionnel. Pas besoin de mÃ©canisme de confirmation.

### 3.4 RÃ©utilisation du Code Existant

| Feed (actuel) | â†’ Extraction | â†’ Digest (nouveau) |
|---------------|-------------|---------------------|
| `INSPIRATION` keywords/themes | `filter_presets.apply_serein_filter()` | `SEREIN` preset |
| `_calculate_user_bias()` + `_get_opposing_biases()` | `filter_presets.calculate_perspective_boost()` | `PERSPECTIVE` preset (boost, pas filtre hard) |
| `Source.theme` SQL filter | `filter_presets.apply_theme_focus_filter()` | `THEME_FOCUS` preset |
| `PersonalizedFiltersProvider` (mobile) | SupprimÃ© | RemplacÃ© par `ThemeFiltersProvider` |
| `FilterBar` widget (mobile) | Pattern rÃ©utilisÃ© | Nouveau `DigestModeTabSelector` dÃ©diÃ© |

---

## 4. Plan d'ImplÃ©mentation DÃ©taillÃ©

### Ordre d'exÃ©cution
```
Story 0 (fix filtres) â†’ Story 1 (digest tab selector + modes) â†’ Story 2 (feed thÃ¨mes)
    Ã€ implÃ©menter        â†‘ prioritÃ© alpha testers                 â†‘ rÃ©utilise filter_presets
```

---

### Story 0 : Fix des filtres cassÃ©s

| Fichier | Changement |
|---------|-----------|
| `packages/api/app/services/recommendation/filter_presets.py` | **CrÃ©er** : `apply_serein_filter()`, `get_opposing_biases()`, `apply_theme_focus_filter()`, constantes `SEREIN_EXCLUDED_THEMES` et `SEREIN_KEYWORDS` |
| `packages/api/app/models/enums.py` | **Ajouter** : `DigestMode(str, Enum)` avec `pour_vous`, `serein`, `perspective`, `theme_focus` |
| `packages/api/app/services/recommendation_service.py` | **Fix** : INSPIRATION mode utilise `apply_serein_filter()` (corrige slugs `society_climate`â†’`society`, `geopolitics`â†’`international`). PERSPECTIVES utilise `get_opposing_biases()` partagÃ©. |

**VÃ©rification** : `_calculate_user_bias()` gÃ¨re le cas "aucune source suivie" â†’ retourne `BiasStance.CENTER` â†’ `get_opposing_biases(CENTER)` retourne une liste large. OK.

---

### Story 1 : Digest Configurable â€” Tab Selector + Modes

#### Backend (7 fichiers)

**1. `packages/api/app/services/recommendation/filter_presets.py`** (modifier)
- Ajouter `calculate_user_bias(session, user_id) -> BiasStance` : extraire la logique de `RecommendationService._calculate_user_bias()` en fonction async standalone (query `Source.bias_stance` join `UserSource`, score -1/+1, retourne LEFT/RIGHT/CENTER)
- L'ancienne mÃ©thode `_calculate_user_bias` dÃ©lÃ¨gue Ã  cette nouvelle fonction

**2. `packages/api/app/services/digest_selector.py`** (modifier â€” fichier critique)
- `DigestContext` dataclass : ajouter `user_bias_stance: BiasStance | None = None`
- `_build_digest_context(user_id)` : ajouter param `mode`, si PERSPECTIVE â†’ appeler `calculate_user_bias()`, stocker dans context
- `select_for_user(user_id, ...)` : ajouter params `mode: str = "pour_vous"`, `focus_theme: str | None = None`
- `_get_candidates(context, limit)` : ajouter params `mode`, `focus_theme`
  - Si `mode == "serein"` â†’ `query = apply_serein_filter(query)` (sur query sources utilisateur ET fallback)
  - Si `mode == "theme_focus"` et `focus_theme` â†’ `query = apply_theme_focus_filter(query, focus_theme)`
  - Si `mode == "theme_focus"` â†’ relaxer `DiversityConstraints.max_per_theme` (passer de 2 Ã  7)
  - PERSPECTIVE : pas de filtre SQL, boost au scoring
- `_score_candidates(candidates, context)` : si mode PERSPECTIVE et `context.user_bias_stance` â†’ ajouter +80 pts aux articles de biais opposÃ© (`get_opposing_biases(context.user_bias_stance)`)

**3. `packages/api/app/models/daily_digest.py`** (modifier)
- Ajouter colonne : `mode: Mapped[str | None] = mapped_column(String(30), nullable=True, default="pour_vous")`

**4. Migration Alembic** (crÃ©er)
- `alembic revision --autogenerate -m "add_mode_to_daily_digest"`
- OpÃ©ration : `ADD COLUMN mode VARCHAR(30) DEFAULT 'pour_vous'` â€” safe, pas de rewrite table

**5. `packages/api/app/jobs/digest_generation_job.py`** (modifier)
- Dans `_generate_digest_for_user()` : lire `digest_mode` et `digest_focus_theme` depuis `UserPreference` pour cet utilisateur
- Passer `mode=digest_mode, focus_theme=digest_focus_theme` Ã  `selector.select_for_user()`
- Stocker `mode` sur le `DailyDigest` record crÃ©Ã©

**6. `packages/api/app/schemas/digest.py`** (modifier)
- `DigestResponse` : ajouter `mode: str = Field(default="pour_vous")`

**7. `packages/api/app/routers/digest.py`** (modifier)
- `POST /api/digest/generate` : ajouter params `mode: str | None = Query(None)` et `focus_theme: str | None = Query(None)`
- Passer `mode` et `focus_theme` au service de gÃ©nÃ©ration
- Dans la construction de `DigestResponse` : inclure `mode=digest.mode or "pour_vous"`

**Note** : `UserPreference` key-value stocke dÃ©jÃ  des prÃ©fÃ©rences. On ajoute `digest_mode` et `digest_focus_theme` comme clÃ©s. L'endpoint `PUT /api/users/preferences` existe-t-il dÃ©jÃ  ? Ã€ vÃ©rifier â€” sinon crÃ©er un endpoint simple d'upsert dans `routers/users.py`.

#### Mobile (8 fichiers)

**8. `apps/mobile/lib/features/digest/models/digest_models.dart`** (modifier)
- Ajouter `@Default('pour_vous') String mode` dans `DigestResponse`
- Puis : `dart run build_runner build --delete-conflicting-outputs`

**9. `apps/mobile/lib/features/digest/models/digest_mode.dart`** (crÃ©er)
- Enum `DigestMode` avec les 4 valeurs + mÃ©tadata :
```dart
enum DigestMode {
  pourVous(
    key: 'pour_vous',
    label: 'Pour vous',
    icon: PhosphorIcons.sunDim,     // â˜€ï¸
    color: null,                    // utilise colors.primary (Terracotta)
    gradientStart: Color(0xFF1A1918),
    gradientEnd: Color(0xFF2C2A29),
    subtitle: 'Votre sÃ©lection personnalisÃ©e',
    emoji: 'â˜€ï¸',
  ),
  serein(
    key: 'serein',
    label: 'Serein',
    icon: PhosphorIcons.leaf,       // ğŸ§˜ (ou YinYang)
    color: Color(0xFF2ECC71),       // Vert (= success)
    gradientStart: Color(0xFF1A201A),
    gradientEnd: Color(0xFF1E2C1E),
    subtitle: 'Sans politique ni infos anxiogÃ¨nes',
    emoji: 'ğŸ§˜',
  ),
  perspective(
    key: 'perspective',
    label: 'Changer',
    icon: PhosphorIcons.userSwitch, // ğŸ­ "se mettre dans la peau de"
    color: Color(0xFF6B9AC4),       // Bleu (secondary-ish)
    gradientStart: Color(0xFF1A1A20),
    gradientEnd: Color(0xFF201A1A),
    subtitle: "DÃ©couvrir l'autre bord politique",
    emoji: 'ğŸ­',
  ),
  themeFocus(
    key: 'theme_focus',
    label: 'Focus',
    icon: PhosphorIcons.magnifyingGlass, // ğŸ”
    color: Color(0xFFF39C12),       // Ambre/Or (= warning)
    gradientStart: Color(0xFF201A14),
    gradientEnd: Color(0xFF2C2418),
    subtitle: '100% {thÃ¨me}',       // Dynamique, remplacÃ© Ã  l'affichage
    emoji: 'ğŸ”',
  );

  // ... constructeur, mÃ©thodes helper
}
```

**10. `apps/mobile/lib/features/digest/providers/digest_mode_provider.dart`** (crÃ©er)
- `DigestModeState` : `{ DigestMode mode, String? focusTheme }`
- `digestModeProvider` (AsyncNotifier) :
  - `build()` : charge `digest_mode` et `digest_focus_theme` depuis les prefs API
  - `setMode(DigestMode mode, {String? focusTheme})` :
    1. Met Ã  jour l'Ã©tat local immÃ©diatement (UI rÃ©active)
    2. Sauvegarde via `PUT /api/users/preferences` (pour demain)
    3. RÃ©gÃ©nÃ¨re le digest via `POST /api/digest/generate?mode=X&force=true`
    4. Invalide `digestProvider` pour recharger les articles
  - Getter `effectiveColor(FacteurColors colors)` â†’ retourne la couleur du mode (ou `colors.primary` pour "Pour vous")

**11. `apps/mobile/lib/features/digest/widgets/digest_mode_tab_selector.dart`** (crÃ©er)
- Widget `DigestModeTabSelector` :
  - `SingleChildScrollView` horizontal avec 4 pills
  - Chaque pill : `AnimatedContainer` (200ms) avec icÃ´ne Phosphor + label court
  - Pill sÃ©lectionnÃ©e : `background = modeColor.withValues(alpha: 0.15)`, `border = modeColor`, `text = modeColor` (bold)
  - Pill non sÃ©lectionnÃ©e : transparent, `text = textTertiary`
  - Border radius : `FacteurRadius.pill` (capsule)
  - `onModeChanged(DigestMode mode)` callback
  - Si `themeFocus` sÃ©lectionnÃ© sans `focusTheme` configurÃ© â†’ ouvre un bottom sheet de sÃ©lection de thÃ¨me

**12. `apps/mobile/lib/features/digest/widgets/digest_briefing_section.dart`** (modifier)
- Ajouter paramÃ¨tre `DigestMode mode` au constructeur
- Les couleurs du container s'adaptent au mode :
  - `gradient` : utilise `mode.gradientStart` / `mode.gradientEnd` au lieu de l'obsidian fixe
  - `border` : utilise `modeColor.withValues(alpha: 0.3)` au lieu de `primary`
  - Titre "L'Essentiel du Jour" prÃ©cÃ©dÃ© de l'emoji du mode
  - Sous-titre contextuel ajoutÃ© sous le titre (mode.subtitle)
- Tout via `AnimatedContainer` (duration: 300ms, curve: easeOutCubic) pour transitions fluides

**13. `apps/mobile/lib/features/digest/screens/digest_screen.dart`** (modifier)
- InsÃ©rer `DigestModeTabSelector` entre le header (streak/logo) et le `DigestBriefingSection`
- Ã‰couter `digestModeProvider` pour passer le mode actif au tab selector et au container
- Ajouter le message inline conditionnel : "Votre essentiel de demain sera aussi en mode {X}"
  - AffichÃ© pendant 5s aprÃ¨s un changement de mode, puis fondu
  - Style : `bodySmall`, `textSecondary`, italic, centrÃ©
- Lors du rechargement : les articles passent en opacitÃ© 0.5 + shimmer, le container garde la nouvelle couleur

**14. `apps/mobile/lib/features/settings/screens/digest_settings_screen.dart`** (crÃ©er)
- Ã‰cran "Mon Essentiel" : 4 cards Ã©tendues (icÃ´ne + titre + description longue)
- Section conditionnelle "ThÃ¨me Focus" (visible si mode=theme_focus) : chips thÃ¨mes utilisateur
- Texte info : "Ton essentiel est gÃ©nÃ©rÃ© chaque matin Ã  8h avec ce mode."
- Pattern : AppBar + SingleChildScrollView, comme `account_screen.dart`

**15. `apps/mobile/lib/features/settings/screens/settings_screen.dart`** (modifier)
- Section CONTENU : ajouter tile "Mon Essentiel" en premiÃ¨re position (avant "Mes sauvegardes")
- `_buildTile(icon: PhosphorIcons.sliders, title: 'Mon Essentiel', subtitle: 'Mode : ${mode}')`
- `onTap: () => context.pushNamed(RouteNames.digestSettings)`

**16. `apps/mobile/lib/config/routes.dart`** (modifier)
- `RouteNames.digestSettings = 'digest-settings'`
- `RoutePaths.digestSettings = '/settings/digest'`
- Ajouter `GoRoute` sous le settings ShellRoute children

---

### Story 2 : Filtrer le Feed par ThÃ¨me

#### Backend (3 fichiers)

**17. `packages/api/app/routers/feed.py`** (modifier)
- Ajouter param `theme: str | None = Query(None)` sur `get_personalized_feed()`
- Passer `theme=theme` Ã  `service.get_feed()`

**18. `packages/api/app/services/recommendation_service.py`** (modifier)
- `get_feed()` : ajouter param `theme: str | None = None`
- `_get_candidates()` : ajouter param `theme: str | None = None`
- AprÃ¨s les filtres de mode : `if theme: query = apply_theme_focus_filter(query, theme)`

**19. `packages/api/app/routers/users.py`** (modifier)
- Ajouter `GET /api/users/top-themes` : query `UserInterest` pour l'utilisateur, `ORDER BY weight DESC`
- Retourne `[{interest_slug, weight}]`

#### Mobile (5 fichiers)

**20. `apps/mobile/lib/features/feed/providers/theme_filters_provider.dart`** (crÃ©er)
- `themeFiltersProvider` (FutureProvider) : fetch `GET /api/users/top-themes`, map vers `ThemeFilterConfig(slug, label, emoji, weight)`
- Metadata emoji/label depuis une map statique (rÃ©utilise `AvailableThemes.all` data)
- Fallback : thÃ¨mes sÃ©lectionnÃ©s Ã  l'onboarding si l'API Ã©choue

**21. `apps/mobile/lib/features/feed/widgets/filter_bar.dart`** (modifier)
- `FilterConfig` : ajouter champ optionnel `emoji`
- `_buildFilterChip()` : afficher emoji + label dans le chip text
- Supprimer les `_keys` hardcodÃ©s (`inspiration`, `perspectives`, `deep_dive`) â†’ clÃ©s dynamiques

**22. `apps/mobile/lib/features/feed/providers/feed_provider.dart`** (modifier)
- Renommer sÃ©mantiquement `_selectedFilter` â†’ passe `theme` au lieu de `mode` au repository
- `setFilter(String? theme)` â†’ appel API avec `theme=theme`

**23. `apps/mobile/lib/features/feed/repositories/feed_repository.dart`** (modifier)
- `getFeed()` : remplacer param `mode` par `theme`, passer en query param `?theme=tech`

**24. `apps/mobile/lib/features/feed/screens/feed_screen.dart`** (modifier)
- Remplacer `personalizedFiltersProvider` par `themeFiltersProvider`
- Convertir `ThemeFilterConfig` â†’ `FilterConfig` avec emoji
- Le reste du wiring `FilterBar` â†’ `feedProvider.setFilter()` reste identique

**25. `apps/mobile/lib/features/feed/providers/personalized_filters_provider.dart`** (dÃ©prÃ©cier)
- Ajouter `@Deprecated('Replaced by theme_filters_provider')` sur le provider
- Garder `FilterConfig` class (importÃ©e par `filter_bar.dart`)
- Ne pas supprimer le fichier tant qu'on confirme qu'il n'est plus importÃ©

---

## 5. VÃ©rification

### Story 0
- `curl -H "Authorization: Bearer $TOKEN" "$API/feed/?mode=inspiration"` â†’ ne retourne aucun article de thÃ¨me `society`, `international`, `economy`, `politics`

### Story 1
- `curl -X PUT "$API/users/preferences" -d '{"key":"digest_mode","value":"serein"}'` â†’ 200
- `curl -X POST "$API/digest/generate?mode=serein&force=true"` â†’ DigestResponse avec `"mode": "serein"` et articles filtrÃ©s
- `curl "$API/digest"` â†’ retourne `"mode": "serein"` et aucun article de thÃ¨me anxiogÃ¨ne
- Sur mobile : tab selector visible en haut du digest â†’ tap "Serein" â†’ container passe en vert sombre â†’ articles se rechargent â†’ message inline "Votre essentiel de demain sera aussi en mode Serein"
- Sur mobile : tap "Pour vous" â†’ container revient en obsidian/terracotta â†’ articles se rechargent
- Settings > Mon Essentiel â†’ mÃªme sÃ©lecteur + thÃ¨me focus si applicable

### Story 2
- `curl "$API/feed/?theme=tech"` â†’ uniquement des articles de sources `theme=tech`
- `curl "$API/users/top-themes"` â†’ liste ordonnÃ©e par weight DESC
- Sur mobile : chips thÃ¨me dans le feed â†’ tap "Tech" â†’ feed filtrÃ© â†’ re-tap â†’ feed complet

---

## 6. Risques & Mitigations

| Risque | Mitigation |
|--------|-----------|
| Feed vide sur filtre thÃ¨me | Message "Peu de contenu rÃ©cent" + CTA retour feed complet |
| Perte modes feed sans remplacement | Story 0+1 livrÃ©es **avant** Story 2 |
| Serein exclut trop de contenu | Fallback : complÃ©ter avec articles standard si <7 candidats |
| Perspective boost insuffisant | Calibrer +80 â†’ vÃ©rifier 2-3 articles opposÃ©s en rÃ©sultat |
| Migration Alembic | Colonne nullable + DEFAULT â†’ pas de lock timeout |
| RÃ©gÃ©nÃ©ration lente (>3s) | Feedback immÃ©diat via container animÃ© + shimmer sur articles |
| Tab selector trop Ã©troit (petit Ã©cran) | `SingleChildScrollView` horizontal avec scroll |
| Changement de mode accidentel | Option B (snackbar undo 3s) si les tests montrent un problÃ¨me â€” sinon pas de confirmation |

## 7. Questions Ouvertes

1. **Endpoint PUT /api/users/preferences** : existe-t-il dÃ©jÃ  ? Si non, crÃ©er un upsert simple
2. **Roadmap NLP pour Serein** : scoring tonalitÃ© quand ML_ENABLED (hors scope cet epic)
3. **Notifications** : mentionner le mode dans la push du matin ? (hors scope, Ã  traiter sÃ©parÃ©ment)
4. **IcÃ´ne "Changer de bord"** : `PhosphorIcons.userSwitch` vs `PhosphorIcons.shuffle` vs `PhosphorIcons.maskHappy` â€” Ã  valider avec UX/UI Designer
5. **IcÃ´ne "Serein"** : `PhosphorIcons.leaf` (zen/nature) vs `PhosphorIcons.yinYang` (Ã©quilibre) â€” Ã  valider
6. **Couleur "Changer de bord"** : tab en bleu (`#6B9AC4`), container en dÃ©gradÃ© bleuâ†’rouge subtil â€” ou une couleur unique (violet ?) â€” Ã  valider avec UX/UI Designer
7. **Focus thÃ©matique sans thÃ¨me configurÃ©** : si l'utilisateur tap "Focus" sans avoir de thÃ¨me, ouvrir un bottom sheet de sÃ©lection immÃ©diat ? Ou rediriger vers Settings > Mon Essentiel ?
