# Story 4.7b: D√©tection et filtrage des articles payants

**Parent Story:** [[4.7.feed-personalization.story.md]]
**Epic:** 4 - Feed & Algorithme
**Classification:** EVOLUTION
**Status:** Completed
**Branch:** `boujonlaurin-dotcom/paywall-filter`
**PR:** #78

---

## Description

**En tant qu'** utilisateur de Facteur,
**Je veux** que les articles derri√®re un paywall soient automatiquement d√©tect√©s et filtr√©s,
**afin de** ne recevoir dans mon digest et mon feed que des contenus r√©ellement accessibles.

---

## Contexte

Le RSS ne signale pas syst√©matiquement les articles payants. Les utilisateurs recevaient des articles tronqu√©s ou inaccessibles (Le Monde, Le Figaro, etc.), d√©gradant l'exp√©rience Slow Media. Le PRD mentionne les paywalls comme crit√®re UX du FQS (25% du score).

---

## Crit√®res d'acceptation

1. ‚úÖ D√©tection automatique des articles payants au sync RSS via scoring algorithmique
2. ‚úÖ Configuration paywall par source (JSONB) avec fallback sur config globale
3. ‚úÖ Toggle utilisateur "Masquer les articles payants" dans Settings (d√©faut: activ√©)
4. ‚úÖ Filtrage appliqu√© dans le digest selector ET le feed de recommandation
5. ‚úÖ Persistance du toggle via Hive (local) + sync API (remote)
6. ‚úÖ Les articles existants (is_paid=NULL) ne sont PAS masqu√©s (NULL-safe query)

---

## Architecture technique

### Algorithme de scoring PaywallDetector

| Signal | Points | Exemples |
|--------|--------|----------|
| Keyword dans titre/description | +3 | "R√©serv√© aux abonn√©s", "üîí", "Article premium" |
| URL pattern | +3 | `/premium/`, `/abonnes/`, `/subscribers/` |
| Contenu trop court | +2 | < `min_content_length` (d√©faut: 200 chars) |
| **Seuil de d√©tection** | **‚â• 5** | Combinaison de signaux requise |

### Config par source

```python
# sources.paywall_config (JSONB, NULL = utilise DEFAULT_PAYWALL_CONFIG)
{
    "keywords": ["R√©serv√© aux abonn√©s", "üîí"],
    "url_patterns": ["/premium/"],
    "min_content_length": 200
}
```

### Sch√©ma DB (Migration `q1r2s3t4u5v6`)

| Table | Colonne | Type | Default |
|-------|---------|------|---------|
| `sources` | `paywall_config` | JSONB | NULL |
| `contents` | `is_paid` | BOOLEAN | false |
| `user_personalization` | `hide_paid_content` | BOOLEAN | true |

---

## Tasks

### Backend

- [x] **T1: Migration Alembic** (`q1r2s3t4u5v6_add_paywall_detection.py`)
  - [x] 3 colonnes ajout√©es avec retry pattern PgBouncer-safe
  - [x] Fix: DEFAULT NULL pour paywall_config (pas JSONB litt√©ral)

- [x] **T2: Mod√®les SQLAlchemy**
  - [x] `Source.paywall_config` (JSONB, nullable)
  - [x] `Content.is_paid` (Boolean, default False)
  - [x] `UserPersonalization.hide_paid_content` (Boolean, default True)

- [x] **T3: PaywallDetector service**
  - [x] Scoring algorithm avec cache in-memory (TTL 1h)
  - [x] DEFAULT_PAYWALL_CONFIG FR (8 keywords, 3 URL patterns)
  - [x] `detect_paywall()` et `clear_cache()`

- [x] **T4: Int√©gration sync_service**
  - [x] Appel `detect_paywall()` dans `_parse_entry` loop
  - [x] `is_paid` persist√© sur Content √† la cr√©ation

- [x] **T5: Filtrage digest + feed**
  - [x] `digest_selector.py`: filtre user sources + fallback curated
  - [x] `recommendation_service.py`: filtre `_get_candidates`
  - [x] Fix: `is_not(True)` au lieu de `== False` (NULL-safe)

- [x] **T6: API endpoint toggle**
  - [x] `POST /personalization/toggle-paid-content`
  - [x] `hide_paid_content` dans `PersonalizationResponse`

### Mobile (Flutter)

- [x] **T7: Mod√®les Flutter**
  - [x] `ContentModel.isPaid` (fromJson, copyWith)
  - [x] `DigestItem.isPaid` (Freezed + JsonKey)

- [x] **T8: UI Settings**
  - [x] `HidePaidContent` Riverpod provider avec Hive persistence
  - [x] Toggle "Masquer les articles payants" dans section CONTENU
  - [x] Sync API via `PersonalizationRepository.togglePaidContent()`

---

## Fichiers modifi√©s

### Backend (packages/api/)
| Fichier | Modification |
|---------|-------------|
| `alembic/versions/q1r2s3t4u5v6_add_paywall_detection.py` | **Nouveau** - Migration 3 colonnes |
| `app/services/paywall_detector.py` | **Nouveau** - Service d√©tection (137 lignes) |
| `app/models/source.py` | Ajout `paywall_config` JSONB |
| `app/models/content.py` | Ajout `is_paid` Boolean |
| `app/models/user_personalization.py` | Ajout `hide_paid_content` Boolean |
| `app/services/sync_service.py` | Int√©gration PaywallDetector |
| `app/services/digest_selector.py` | Filtre `is_not(True)` sur 2 queries |
| `app/services/recommendation_service.py` | Filtre `is_not(True)` sur candidates |
| `app/routers/personalization.py` | Endpoint toggle + response field |
| `app/schemas/content.py` | `is_paid` dans ContentResponse |
| `app/schemas/digest.py` | `is_paid` dans DigestItem |

### Mobile (apps/mobile/)
| Fichier | Modification |
|---------|-------------|
| `lib/features/feed/models/content_model.dart` | Ajout `isPaid` field |
| `lib/features/digest/models/digest_models.dart` | Ajout `isPaid` Freezed |
| `lib/features/feed/repositories/personalization_repository.dart` | `togglePaidContent()` |
| `lib/features/settings/providers/paid_content_provider.dart` | **Nouveau** - Provider Hive + API |
| `lib/features/settings/screens/settings_screen.dart` | Toggle UI |

### Generated (build_runner)
- `paid_content_provider.g.dart`
- `digest_models.freezed.dart`, `digest_models.g.dart`

---

## Bugs d√©tect√©s et corrig√©s

| Bug | S√©v√©rit√© | Fix | Doc |
|-----|----------|-----|-----|
| SQL quoting error migration DEFAULT JSONB | CRITICAL | `DEFAULT NULL` | [bug-paywall-migration-sql-quoting.md](../../bugs/bug-paywall-migration-sql-quoting.md) |
| `== False` exclut NULL ‚Üí feeds vides | CRITICAL | `is_not(True)` | [bug-paywall-null-filter.md](../../bugs/bug-paywall-null-filter.md) |

---

## Post-d√©ploiement (manuel)

### 1. Seed paywall_config pour sources FR majeures

```sql
UPDATE sources SET paywall_config = '{"keywords":["R√©serv√© aux abonn√©s","Article r√©serv√©","Contenu premium","üîí"],"url_patterns":["/abonnes/","/premium/"],"min_content_length":200}'::jsonb
WHERE name IN ('Le Monde', 'Le Figaro', 'Les √âchos', 'Le Point');
```

### 2. Backfill is_paid sur articles existants

```sql
UPDATE contents SET is_paid = true
WHERE (title ILIKE '%r√©serv√© aux abonn√©s%' OR title ILIKE '%üîí%' OR title ILIKE '%article premium%')
AND is_paid IS NOT true;
```

---

## V√©rification

- [x] `flutter analyze` : 0 nouvelles erreurs
- [x] Syntax check Python : OK
- [ ] Test end-to-end post-deploy : toggle settings ‚Üí digest filtr√©
- [ ] V√©rifier backfill SQL en Supabase

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-15 | 1.0 | Cr√©ation story + impl√©mentation compl√®te | @dev (Claude) |
| 2026-02-15 | 1.1 | Fix migration SQL quoting (commit `77b8418`) | @dev (Claude) |
| 2026-02-15 | 1.2 | Fix NULL filter `is_not(True)` (commit `439092d`) | @dev (Claude) |
