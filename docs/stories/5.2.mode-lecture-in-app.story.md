# Story 5.2 : Mode Lecture In-App

**As a** utilisateur,
**I want** consulter les contenus directement dans l'app sans ouvrir le navigateur,
**so that** j'ai une expérience de lecture fluide, sans pubs, paywalls ou latence.

## Contexte

Actuellement, le tap sur le CTA "Lire l'article" ouvre une WebView qui charge l'URL originale. Cette approche présente plusieurs problèmes :
- Expérience dégradée (cookies, paywalls, lenteur, publicités)
- Temps de chargement variable
- UX incohérente selon les sites

La solution : un **mode lecture natif** qui affiche le contenu RSS directement dans l'app, avec un FAB discret pour accéder à l'article original si besoin.

## Maquettes / Design

### Vue Article
- **Header** : Titre (H1), Source (Logo + Nom), Date de publication
- **Body** : Contenu HTML formaté (`content:encoded` ou `description`) avec images inline
- **FAB** : "Voir l'original" (icône `ArrowSquareOut`) en position bottom-right

### Vue Podcast
- **Header** : Titre de l'épisode, Podcast (Logo + Nom), Date
- **Player** : Player audio natif avec contrôles (play/pause, seek, durée)
- **Body** : Description de l'épisode
- **FAB** : "Voir l'original"

### Vue YouTube
- **Player** : Lecteur vidéo embarqué (YouTube iframe ou package `youtube_player_flutter`)
- **Body** : Titre + Description
- **FAB** : "Ouvrir sur YouTube"

## Acceptance Criteria

- [ ] **Articles** : Le contenu s'affiche en mode lecture natif avec texte formaté + images inline
- [ ] **Podcasts** : Un player audio fonctionnel permet d'écouter l'épisode
- [ ] **Vidéos YouTube** : Le player vidéo embarqué affiche la vidéo avec contrôles
- [ ] **FAB** : Le bouton "Voir l'original" est présent et fonctionnel sur les 3 formats
- [ ] **Fallback** : Si le contenu RSS est insuffisant (< 100 caractères ou parsing échoué), afficher la WebView classique
- [ ] **Thème** : Respect du dark/light mode sur toutes les vues
- [ ] **Performance** : Chargement instantané du contenu RSS (pas de fetch réseau supplémentaire)

## Tasks

### Task 1: Extension Backend

- [ ] Ajouter `html_content` (Text) et `audio_url` (Text) au modèle `Content`
- [ ] Créer la migration Alembic
- [ ] Modifier `rss_parser.py` pour extraire :
  - `content:encoded` → `html_content`
  - `enclosure[audio]` → `audio_url`
- [ ] Modifier `sync_service.py` pour stocker ces champs
- [ ] Étendre `ContentDetailResponse` avec `html_content` et `audio_url`

### Task 2: Extension Model Mobile

- [ ] Ajouter `htmlContent` et `audioUrl` au modèle `Content` Dart
- [ ] Mettre à jour le parsing JSON `fromJson`

### Task 3: Widget Article Reader

- [ ] Créer `ArticleReaderWidget` avec `flutter_widget_from_html_core`
- [ ] Gérer le rendu HTML avec images inline
- [ ] Appliquer le thème (couleurs, typographie)
- [ ] Gérer le scroll et la lisibilité

### Task 4: Widget Audio Player

- [ ] Créer `AudioPlayerWidget` avec `just_audio` ou `audioplayers`
- [ ] UI : bouton play/pause, slider de progression, durée
- [ ] Afficher la description de l'épisode sous le player

### Task 5: Widget YouTube Player

- [ ] Créer `YouTubePlayerWidget` avec `youtube_player_flutter` ou `youtube_player_iframe`
- [ ] Extraire l'ID vidéo depuis l'URL YouTube
- [ ] Afficher le player + titre/description

### Task 6: Refactor ContentDetailScreen

- [ ] Router vers le bon widget selon `contentType`:
  - `article` → `ArticleReaderWidget`
  - `audio` → `AudioPlayerWidget`
  - `youtube`/`video` → `YouTubePlayerWidget`
- [ ] Implémenter le fallback WebView si contenu insuffisant
- [ ] Ajouter le FAB "Voir l'original" avec animation d'apparition

## Technical Notes

### Dépendances Flutter à ajouter
```yaml
dependencies:
  flutter_widget_from_html_core: ^0.14.0  # Rendu HTML
  just_audio: ^0.9.36                      # Player audio
  youtube_player_flutter: ^8.1.2           # Player YouTube
```

### Critère de fallback
```dart
bool shouldFallbackToWebView(Content content) {
  final hasContent = (content.htmlContent?.length ?? 0) > 100 ||
                     content.audioUrl != null;
  return !hasContent;
}
```

### Extraction ID YouTube
```dart
String? extractYouTubeId(String url) {
  final regex = RegExp(
    r'(?:youtube\.com/(?:watch\?v=|embed/)|youtu\.be/)([a-zA-Z0-9_-]{11})'
  );
  return regex.firstMatch(url)?.group(1);
}
```

## Hors Scope (v1)

- Téléchargement offline des contenus
- Mode sombre automatique basé sur l'heure
- Personnalisation de la taille de police
- Partage direct depuis la vue lecture
