# Story 5.2 : Mode Lecture In-App

**As a** utilisateur,
**I want** consulter les contenus directement dans l'app sans ouvrir le navigateur,
**so that** j'ai une expérience de lecture fluide, sans pubs, paywalls ou latence.

## Contexte

Actuellement, le tap sur le CTA "Lire l'article" ouvre une WebView qui charge l'URL originale. Cette approche présente plusieurs problèmes :
- Expérience dégradée (cookies, paywalls, lenteur, publicités)
- Temps de chargement variable
- UX incohérente selon les sites

La solution : un **mode lecture natif** qui affiche le contenu RSS directement dans l'app, avec un FAB discret pour accéder à l'article original si besoin.

> [!WARNING]
> **DEPRECATION (Story 4.3b - 2026-01-19)** : Le mode lecture in-app a été désactivé temporairement. Tous les articles sont maintenant affichés via WebView pour éviter les bugs liés à l'affichage de la description RSS au lieu de l'article complet. Cette fonctionnalité pourra être ré-implémentée lorsque le bypass des publicités et cookies redeviendra prioritaire.

## Contexte Historique

### Vue Article
- **Header** : Titre (H1), Source (Logo + Nom), Date de publication
- **Body** : Contenu HTML formaté (`content:encoded` ou `description`) avec images inline
- **FAB** : "Voir l'original" (icône `ArrowSquareOut`) en position bottom-right

### Vue Podcast
- **Header** : Titre de l'épisode, Podcast (Logo + Nom), Date
- **Player** : Player audio natif avec contrôles (play/pause, seek, durée)
- **Body** : Description de l'épisode
- **FAB** : "Voir l'original"

### Vue YouTube
- **Player** : Lecteur vidéo embarqué (YouTube iframe ou package `youtube_player_flutter`)
- **Body** : Titre + Description
- **FAB** : "Ouvrir sur YouTube"

## Acceptance Criteria

- [x] **Articles** : ~~Le contenu s'affiche en mode lecture natif avec texte formaté + images inline~~ **[DEPRECATED]** Toujours afficher via WebView
- [x] **Podcasts** : ~~Un player audio fonctionnel permet d'écouter l'épisode~~ **[DEPRECATED]** Toujours afficher via WebView
- [x] **Vidéos YouTube** : ~~Le player vidéo embarqué affiche la vidéo avec contrôles~~ **[DEPRECATED]** Toujours afficher via WebView
- [x] **FAB** : Le bouton "Voir l'original" est présent et fonctionnel sur les 3 formats
- [x] **Fallback** : Si le contenu RSS est insuffisant (<100 caractères ou parsing échoué), afficher la WebView classique (ou UI de redirection sur Web)
- [x] **Thème** : Respect du dark/light mode sur toutes les vues
- [x] **Performance** : Chargement instantané du contenu RSS (pas de fetch réseau supplémentaire)
- [x] **Deprecation** : La logique `hasInAppContent` a été dépréciée pour toujours retourner `false`, forçant l'utilisation du WebView pour tous les types de contenu.

## Tasks

### Task 1: Extension Backend

- [x] Ajouter `html_content` (Text) et `audio_url` (Text) au modèle `Content`
- [x] Créer la migration Alembic
- [x] Modifier `rss_parser.py` pour extraire :
  - `content:encoded` → `html_content`
  - `enclosure[audio]` → `audio_url`
- [x] Modifier `sync_service.py` pour stocker ces champs
- [x] Étendre `ContentDetailResponse` avec `html_content` et `audio_url`

### Task 2: Extension Model Mobile

- [x] Ajouter `htmlContent` et `audioUrl` au modèle `Content` Dart
- [x] Mettre à jour le parsing JSON `fromJson`

### Task 3: Widget Article Reader

- [x] Créer `ArticleReaderWidget` avec `flutter_html`
- [x] Gérer le rendu HTML avec images inline
- [x] Appliquer le thème (couleurs, typographie)
- [x] Gérer le scroll et la lisibilité

### Task 4: Widget Audio Player

- [x] Créer `AudioPlayerWidget` avec `just_audio`
- [x] UI : bouton play/pause, slider de progression, durée
- [x] Afficher la description de l'épisode sous le player

### Task 5: Widget YouTube Player

- [x] Créer `YouTubePlayerWidget` avec `youtube_player_flutter`
- [x] Extraire l'ID vidéo depuis l'URL YouTube
- [x] Afficher le player + titre/description

### Task 6: Refactor ContentDetailScreen

- [x] Router vers le bon widget selon `contentType`:
  - `article` → `ArticleReaderWidget`
  - `audio` → `AudioPlayerWidget`
  - `youtube`/`video` → `YouTubePlayerWidget`
- [x] Implémenter le fallback WebView si contenu insuffisant (et UI alternative sur Web)
- [x] Ajouter le FAB "Voir l'original" avec animation d'apparition

### Task 7: Restaurer les fonctionnalités de ArticleViewerModal (2026-01-17)

> [!NOTE]
> Le refactoring initial avait omis certaines fonctionnalités présentes dans l'ancien `ArticleViewerModal`. Ces fonctionnalités ont été restaurées.

- [x] Convertir en `ConsumerStatefulWidget` pour accès aux providers Riverpod
- [x] Restaurer le **badge de biais politique** (Gauche/Centre/Droite)
- [x] Restaurer l'**indicateur de fiabilité** (icône checkmark bleu ou warning orange)
- [x] Restaurer le **bouton "Comparer"** avec `PerspectivesBottomSheet`
- [x] Restaurer le **tracking analytics** (durée de lecture à la fermeture)
- [x] Implémenter le **bookmark toggle** (état visuel fonctionnel)

### Task 8: UI Refinement (Header)

- [x] Déplacer le bouton "Comparer" dans la ligne de la source
- [x] Réorganiser les infos source (Nom + Badges) et Récence en colonne


## Technical Notes

### Dépendances Flutter ajoutées
```yaml
dependencies:
  flutter_html: ^3.0.0-beta.2     # Rendu HTML
  just_audio: ^0.9.36              # Player audio
  youtube_player_flutter: ^9.1.1   # Player YouTube
```

### Critère de fallback
```dart
bool shouldFallbackToWebView(Content content) {
  final hasContent = (content.htmlContent?.length ?? 0) > 100 ||
                     content.audioUrl != null;
  return !hasContent;
}
```

### Extraction ID YouTube
```dart
String? extractYouTubeId(String url) {
  final regex = RegExp(
    r'(?:youtube\.com/(?:watch\?v=|embed/)|youtu\.be/)([a-zA-Z0-9_-]{11})'
  );
  return regex.firstMatch(url)?.group(1);
}
```

## Déploiement & Troubleshooting (2026-01-17)

### Correction Erreur 500 (Production)
Une erreur 500 persistante sur le feed a été résolue. 
- **Causes** : 
  1. Conflit entre `psycopg` v3 et PgBouncer (résolu par `prepare_threshold: None`).
  2. Mismatch de schéma : la colonne `html_content` n'avait pas été migrée en production.
- **Action de Fix** : Application de la migration `f8a2b3c4d5e6` via `railway run ./venv/bin/alembic upgrade head`.

### Configuration Requise
Pour assurer la stabilité des connexions avec Supabase/Railway :
- `DATABASE_URL` doit inclure `sslmode=require`.
- `poolclass=NullPool` doit être utilisé avec SQLAlchemy pour respecter le mode transactionnel de PgBouncer.

## Hors Scope (v1)
...
