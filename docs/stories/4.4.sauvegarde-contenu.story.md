# Story 4.4: Action "Sauvegarder pour plus tard"

## Status: In Progress ðŸš§ (Update Requested)

## Story

**As a** utilisateur,
**I want** sauvegarder un contenu pour plus tard,
**so that** je puisse y revenir quand j'ai le temps.

- [ ] **Archive on Save**:
    - [ ] AprÃ¨s une sauvegarde rÃ©ussie, l'article disparaÃ®t automatiquement du feed principal pour simuler un "triage".
    - [ ] Un message (SnackBar) confirme l'ajout Ã  la section "Watch Later".
    - [ ] Une option "Annuler" (Undo) est disponible dans le SnackBar pour restaurer l'article.
- [ ] **Persistence**:
    - [ ] L'Ã©tat est sauvegardÃ© via l'API.
    - [ ] L'Ã©tat persiste au rechargement de l'app.
- [ ] **Data Integrity**:
    - [ ] Sauvegarder un contenu ne doit PAS effacer son statut de lecture (vu/consommÃ©).
    - [ ] Un contenu peut Ãªtre Ã  la fois "ConsommÃ©" et "SauvegardÃ©".

## Tasks / Subtasks

- [x] **Task 1: Backend - Data Model Refactoring**
    - [x] Modify `UserContentStatus` model in `packages/api/app/models/content.py`:
        - Add `is_saved` (Boolean, default=False).
        - Add `is_hidden` (Boolean, default=False) [Pre-work for Story 4.5].
        - `status` field remains for consumption tracking (UNSEEN, SEEN, CONSUMED).
    - [x] Generate Alembic migration to update database schema.
    - [x] Update `ContentStatus` enum (remove SAVED/HIDDEN if they existed, or ensure they are not used).

- [x] **Task 2: Backend - API Implementation**
    - [x] Update `ContentSchema` and `UserContentStatusSchema` to include `is_saved` field.
    - [x] Implement `POST /api/contents/{id}/save` in `routers/contents.py`.
        - Logic: Toggle `is_saved` = true/false.
        - Should NOT affecting `status` field.
    - [x] Implement `DELETE /api/contents/{id}/save` (or use POST toggle).
    - [x] Update `GET /api/feed` response to populate `is_saved` status for each item.

- [x] **Task 3: Frontend - Repository & State**
    - [x] Update `Content` model in `models/content_model.dart` to add `bool isSaved`.
    - [x] Update `FeedRepository` to parse new field.
    - [x] Add `toggleSave(String contentId)` method in `FeedRepository`.
    - [x] Update `FeedProvider` / `ContentNotifier` to handle optimistic update.

- [x] **Task 4: Frontend - UI Integration**
    - [x] Update `FeedCard` widget:
        - Bind Icon `onPressed` to `toggleSave`.
        - Use `isSaved` for Icon state (filled/outlined).
    - [x] Update `DetailScreen` (if bookmark icon exists there).

- [x] **Task 5: Testing**
    - [x] Test Backend: Call save, verify DB `is_saved=true`. Call status update (seen), verify `is_saved` is still true.
    - [x] Test Frontend: Tap save, verify UI update, reload app, verify specific item is still saved.
- [ ] **Task 6: Archive-on-Save Enhancement**
    - [ ] [Backend] Update `RecommendationService` to filter out `is_saved == True` from feed.
    - [ ] [Frontend] Update `FeedNotifier.toggleSave` to remove item from state on save.
    - [ ] [Frontend] Implement SnackBar with "Undo" action in `FeedScreen`.

## Dev Notes

### Architecture Change [Refactoring]
The initial design using a single `status` Enum for both Consumption (Seen/Consumed) and Interaction (Saved/Hidden) was flawed because these states are not mutually exclusive.
- **New Approach**:
    - `status`: Enum (UNSEEN, SEEN, CONSUMED) -> Exclusive states of consumption.
    - `is_saved`: Boolean -> Orthogonal state.
    - `is_hidden`: Boolean -> Orthogonal state.
- **Migration**: Schema change required.

### API Specifications [Source: architecture.md#8.5]
- Endpoint: `POST /contents/{id}/save`
- Response: Updated Content Object or Status Object `{is_saved: true}`.

### Component Specifications [Source: Mobile App]
- `FeedCard`: Needs to handle the optimistic update carefully to feel "native". Use `setState` locally if strictly necessary for animation, but provider update is preferred.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 11/01/2026 | 1.1 | Updated to Ready + Refactoring Model | BMad Agent |
| 09/01/2026 | 1.0 | Initial Draft | Architect Agent |
