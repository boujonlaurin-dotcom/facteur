# EPIC 11 : Personnalisation AvancÃ©e â€” Filtres ThÃ¨me Feed + Digest Configurable

> **Brainstorming BMAD** : Analyste (Mary), UX Expert (Sally), Architecte (Winston)
> **Statut** : Design Phase â€” En attente validation utilisateur
> **Date** : 2026-02-10

---

## 1. Perspective Analyste (Mary) â€” Contexte StratÃ©gique

### Contexte Ã‰conomique
Facteur est un **produit alpha en startup**, avec un objectif immÃ©diat : **crÃ©er de l'adoption chez les testeurs** en jouant sur leurs **attentes Ã©motionnelles**. Les alpha-testeurs utilisent principalement le Digest â€” c'est le coeur du produit depuis le pivot Epic 10.

### Pourquoi cet epic maintenant

**Feature 1 (Feed par ThÃ¨me) :**
- Use-case immÃ©diat et intuitif â†’ valeur perÃ§ue dÃ¨s la premiÃ¨re utilisation
- Valide le fonctionnement de la classification thÃ©matique (signal qualitatif)
- Faible complexitÃ© technique â†’ quick win pour montrer que l'app Ã©volue

**Feature 2 (Digest Configurable) :**
- Donne le **sentiment de contrÃ´le** aux early adopters â†’ levier Ã©motionnel fort
- Transforme les testeurs en **co-designers** : on observe ce qu'ils choisissent
- PrÃ©pare le terrain pour des personnalisations algorithmiques futures (data-driven)
- RÃ©intÃ¨gre "Rester serein" et "Changer de point de vue" â€” features dÃ©jÃ  comprises par les utilisateurs

### Insight ClÃ© : L'Adoption par le ContrÃ´le PerÃ§u
Les utilisateurs alpha veulent sentir que l'app **leur appartient**. Un "Standard" imposÃ© crÃ©e de l'indiffÃ©rence. Offrir 4 modes = offrir une **identitÃ© de lecteur**. MÃªme si 80% restent en "Standard", le simple fait d'avoir **choisi** augmente l'engagement.

### Signaux Ã  Collecter (MÃ©triques)
| Signal | Source | Insight Attendu |
|--------|--------|-----------------|
| Mode digest choisi par utilisateur | `user_preferences` | Quel mode "rÃ©sonne" le plus |
| Taux complÃ©tion par mode | `digest_completions` + `daily_digest.mode` | Quel mode engage le plus |
| Utilisation filtres thÃ¨me/feed | Analytics | Les thÃ¨mes sont-ils un besoin rÃ©el ou perÃ§u |
| Changement de mode dans le temps | `user_preferences` historique | FidÃ©litÃ© aux modes vs exploration |

### PrioritÃ© : Digest d'abord
Les alpha-testeurs vivent dans le Digest. L'impact sur l'adoption sera immÃ©diat. Le feed (Explorer Plus) est secondaire mais reste une feature "signature" pour les power users.

### PrÃ©requis Critique : Corriger les Filtres CassÃ©s
"Rester serein" est **non-fonctionnel** (slugs de thÃ¨mes incorrects en DB). "Changer de point de vue" nÃ©cessite une vÃ©rification. Sans ce fix, impossible de proposer ces modes en digest.

---

## 2. Perspective UX Expert (Sally) â€” Design & Ton

### Principes UX pour cet Epic

1. **Empowerment, pas surcharge** â€” 4 choix max, pas de curseurs, pas de menus imbriquÃ©s
2. **DÃ©couverte progressive** â€” L'utilisateur dÃ©couvre les modes naturellement, pas via un mur de settings
3. **Transparence** â€” L'utilisateur comprend *pourquoi* il voit ce qu'il voit (principe #5 du front-end spec)
4. **CohÃ©rence Ã©motionnelle** â€” Le ton de chaque preset doit reflÃ©ter son intention (apaisant pour Serein, stimulant pour Perspective)

### 2.1 Feed â€” Chips ThÃ©matiques

**Design :**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [ğŸ’» Tech] [ğŸŒ GÃ©opo] [ğŸ”¬ Science] [ğŸ¨ Culture] [ğŸ‘¥ SociÃ©tÃ©] ...  â”‚  â† Scroll horizontal
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  (sous-description alignÃ©e sous le chip sÃ©lectionnÃ©)             â”‚
â”‚  "Contenus Tech & Futur de vos sources"                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**DÃ©cisions UX :**
- **Tous les thÃ¨mes** de l'utilisateur affichÃ©s (pas de plafond), scroll horizontal si >4
- **Ordre** = `UserInterest.weight` dÃ©croissant (mÃªme logique que l'algo de recommandation â†’ transparence)
- **Format chip** : emoji + label FR court (ex: "ğŸ’» Tech", "ğŸŒ GÃ©opo", "ğŸ”¬ Science")
- **Feedback** : description courte sous le chip sÃ©lectionnÃ© (pattern dÃ©jÃ  implÃ©mentÃ© dans `filter_bar.dart`)
- **Aucun filtre actif par dÃ©faut** = le feed complet (cohÃ©rent avec l'Ã©tat actuel)
- **Re-tap** = dÃ©sÃ©lection (retour feed complet)
- **Cas limite** : <2 thÃ¨mes â†’ ne pas afficher la barre de filtres (invite Ã  complÃ©ter l'onboarding en settings)

**Transition depuis les filtres actuels :**
- Les modes "Rester serein", "Changer de perspective", "Longs formats" **disparaissent du feed**
- Leur logique migre vers les **presets Digest** (valeur relocalisÃ©e, pas perdue)
- Le front-end spec (section 4.2 "Filtres chips scrollables") montre dÃ©jÃ  un pattern scrollable â†’ on le rÃ©utilise

### 2.2 Digest â€” Configuration par Presets

**Point d'entrÃ©e principal : Bottom Sheet depuis l'Ã©cran Digest**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¬ Mon Essentiel       âš™ï¸               â”‚  â† IcÃ´ne param (ouvre bottom sheet)
â”‚  Mode : Rester serein                    â”‚  â† Label subtil du mode actif
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘  3/7                     â”‚
â”‚                                          â”‚
â”‚  [Article cards...]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Bottom Sheet â€” SÃ©lecteur de Mode**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”€â”€â”€ (drag handle)                       â”‚
â”‚                                          â”‚
â”‚  Personnaliser mon digest                â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â˜€ï¸  Standard                       â”‚  â”‚  â† Mode actif = highlight terracotta
â”‚  â”‚ Mon digest Ã©quilibrÃ© du quotidien  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ›¡ï¸  Rester serein                  â”‚  â”‚
â”‚  â”‚ Sans politique ni infos anxiogÃ¨nes â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ”„  Changer de point de vue        â”‚  â”‚
â”‚  â”‚ DÃ©couvrir d'autres perspectives    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ¯  Focus thÃ©matique               â”‚  â”‚
â”‚  â”‚ 100% Tech (modifier dans param.)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                          â”‚
â”‚  Prend effet dÃ¨s demain matin            â”‚  â† Feedback timing
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Point d'entrÃ©e secondaire : Settings > Mon Digest**

```
Settings Screen:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CONTENU                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ“¬ Mon Digest              >       â”‚  â”‚  â† NOUVEAU
â”‚  â”‚    Mode : Rester serein            â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ ğŸ”– Mes sauvegardes         >       â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ â­ Sources de confiance     >       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Mon Digest Screen (sous-Ã©cran Settings):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Mon Digest                            â”‚
â”‚                                          â”‚
â”‚  Mode de mon digest                      â”‚
â”‚  [MÃªme sÃ©lecteur que le bottom sheet]    â”‚
â”‚                                          â”‚
â”‚  â”€â”€ SÃ©parateur â”€â”€                        â”‚
â”‚                                          â”‚
â”‚  ThÃ¨me Focus (visible si mode=focus)     â”‚
â”‚  [ğŸ’» Tech] [ğŸŒ GÃ©opo] [ğŸ”¬ Science] ...   â”‚  â† Chips thÃ¨mes utilisateur
â”‚                                          â”‚
â”‚  â„¹ï¸ Ton digest est gÃ©nÃ©rÃ© chaque matin   â”‚
â”‚     Ã  8h avec ce mode.                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ton de chaque preset :**

| Preset | IcÃ´ne | Titre | Description (bottom sheet) | Ã‰motion |
|--------|-------|-------|---------------------------|---------|
| Standard | â˜€ï¸ | Standard | Mon digest Ã©quilibrÃ© du quotidien | Neutre, confiance |
| Rester serein | ğŸ›¡ï¸ | Rester serein | Sans politique ni infos anxiogÃ¨nes | Apaisement, protection |
| Changer de point de vue | ğŸ”„ | Changer de point de vue | DÃ©couvrir d'autres perspectives | CuriositÃ©, ouverture |
| Focus thÃ©matique | ğŸ¯ | Focus thÃ©matique | 100% [thÃ¨me] (modifier dans param.) | Focus, expertise |

**DÃ©cisions UX :**
- Le bottom sheet est le **chemin principal** (faible friction, dÃ©couverte naturelle via l'icÃ´ne âš™ï¸)
- Settings = chemin secondaire pour **config avancÃ©e** (choix du thÃ¨me focus, explication dÃ©taillÃ©e)
- **"Prend effet dÃ¨s demain matin"** â€” Feedback essentiel pour Ã©viter la confusion (le digest du jour ne change pas)
- **Mode par dÃ©faut = Standard** pour tous les utilisateurs existants (aucun changement de comportement)
- Le label du mode actif sur l'Ã©cran digest sert de **rappel subtil** et de **CTA implicite** (tap â†’ ouvre le bottom sheet)

### 2.3 Parcours Utilisateur Type

```
Jour 1 : L'utilisateur ouvre son Digest â†’ voit "ğŸ“¬ Mon Essentiel" avec icÃ´ne âš™ï¸
         CuriositÃ© â†’ tap âš™ï¸ â†’ dÃ©couvre les 4 modes â†’ choisit "Rester serein"
         â†’ Toast "Ton digest sera en mode Rester serein dÃ¨s demain â˜€ï¸"

Jour 2 : Digest serein â†’ l'utilisateur apprÃ©cie â†’ reste sur ce mode
         Plus tard, explore le Feed â†’ voit ses thÃ¨mes en chips â†’ filtre "Tech"
         â†’ DÃ©couvre du contenu tech qu'il ne voyait pas dans le digest serein

Jour 7 : L'utilisateur va dans Settings > Mon Digest â†’ change vers "Focus Tech"
         â†’ Personnalisation approfondie
```

---

## 3. Perspective Architecte (Winston) â€” Design Technique

### 3.1 Audit : Ce qui est CassÃ©

**INSPIRATION Mode ("Rester serein") â€” `recommendation_service.py:539-548`**
- `Source.theme.notin_(['society_climate', 'geopolitics', 'economy'])`
- `society_climate` et `geopolitics` **n'existent pas en DB**
- ThÃ¨mes rÃ©els : `society`, `international`
- **RÃ©sultat** : seul `economy` est filtrÃ© â†’ la majoritÃ© du contenu anxiogÃ¨ne passe

**PERSPECTIVES Mode ("Changer de point de vue") â€” `recommendation_service.py:571-630`**
- Logique bias fonctionne (`_calculate_user_bias` + `_get_opposing_biases`)
- **Risque** : si l'utilisateur n'a pas de sources suivies, bias = vide â†’ mode silencieusement inactif
- **Question thÃ¨mes/sous-thÃ¨mes** : le mode ne tient pas compte des thÃ¨mes/subtopics â€” il filtre uniquement par `Source.bias_stance`. Pour le digest, c'est trop agressif (7 articles 100% opposÃ©s). Le boost soft scoring est plus adaptÃ©.

### 3.2 Architecture de la Solution

**Extraction partagÃ©e : `services/recommendation/filter_presets.py`**

```python
# Logique partagÃ©e feed â†” digest

SEREIN_EXCLUDED_THEMES = ['society', 'international', 'economy', 'politics']

SEREIN_KEYWORDS = [
    'politique', 'guerre', 'conflit', 'Ã©lections', 'inflation', 'grÃ¨ve',
    'drame', 'fait divers', 'faits divers', 'crise', 'scandale',
    'terrorisme', 'corruption', 'procÃ¨s', 'violence', 'catastrophe',
    'manifestation', 'gÃ©opolitique',
    'trump', 'musk', 'poutine', 'macron', 'netanyahou', 'zelensky',
    'ukraine', 'gaza',
]

def apply_serein_filter(query):
    """Exclut thÃ¨mes anxiogÃ¨nes + keywords nÃ©gatifs"""
    query = query.where(Source.theme.notin_(SEREIN_EXCLUDED_THEMES))
    keywords_pattern = '|'.join(SEREIN_KEYWORDS)
    query = query.where(~Content.title.op('~*')(keywords_pattern))
    query = query.where(~Content.description.op('~*')(keywords_pattern))
    return query

def calculate_perspective_boost(content, user_bias, opposing_biases):
    """Retourne un bonus de scoring pour les contenus de biais opposÃ©"""
    if content.source.bias_stance in opposing_biases:
        return +80  # Boost significatif mais pas exclusif
    return 0

def apply_theme_focus_filter(query, theme_slug):
    """Filtre SQL pour 100% d'un thÃ¨me"""
    return query.where(Source.theme == theme_slug)
```

**DigestMode Enum :**
```python
class DigestMode(str, Enum):
    STANDARD = "standard"
    SEREIN = "serein"
    PERSPECTIVE = "perspective"
    THEME_FOCUS = "theme_focus"
```

**Modification DigestSelector :**
- `select_for_user(user_id, mode=DigestMode.STANDARD, focus_theme=None)`
- STANDARD : algo actuel inchangÃ©
- SEREIN : `apply_serein_filter()` sur la query candidates
- PERSPECTIVE : scoring boost (+80) sur biais opposÃ©, pas de filtre hard â†’ le scoring naturel Ã©quilibre (~3-4 articles opposÃ©s sur 7)
- THEME_FOCUS : `apply_theme_filter()` + relaxe contrainte max 2 articles/thÃ¨me

**Modification Feed :**
- `GET /api/feed/` : nouveau param `theme: str | None`
- `_get_candidates()` : `WHERE source.theme = :theme` si fourni
- Le param `mode` reste pour rÃ©tro-compatibilitÃ© mais est dÃ©prÃ©ciÃ©
- Le mode `INSPIRATION` du feed est corrigÃ© avec les bons slugs (`apply_serein_filter()`)

**Endpoint Top Themes :**
- `GET /api/users/top-themes` ou intÃ©grÃ© dans le user profile existant
- Retourne la liste ordonnÃ©e par `UserInterest.weight` DESC (exacte mÃªme logique que le scoring de recommandation)
- Format : `[{slug, label_fr, emoji, weight}]`

**Stockage PrÃ©fÃ©rences Digest :**
- `user_preferences` : key=`digest_mode`, value=`serein` (ou `standard`, `perspective`, `theme_focus`)
- `user_preferences` : key=`digest_focus_theme`, value=`tech` (seulement si mode=`theme_focus`)
- `daily_digest` : nouvelle colonne `mode` (String, nullable) â†’ tracking du mode utilisÃ© Ã  la gÃ©nÃ©ration

**Migration Alembic :**
- `ALTER TABLE daily_digest ADD COLUMN mode VARCHAR(20) DEFAULT 'standard'`

### 3.3 RÃ©utilisation du Code Existant

| Feed (actuel) | â†’ Extraction | â†’ Digest (nouveau) |
|---------------|-------------|---------------------|
| `INSPIRATION` keywords/themes | `filter_presets.apply_serein_filter()` | `SEREIN` preset |
| `_calculate_user_bias()` + `_get_opposing_biases()` | `filter_presets.calculate_perspective_boost()` | `PERSPECTIVE` preset (boost, pas filtre hard) |
| `Source.theme` SQL filter | `filter_presets.apply_theme_focus_filter()` | `THEME_FOCUS` preset |
| `PersonalizedFiltersProvider` (mobile) | SupprimÃ© | RemplacÃ© par `ThemeFiltersProvider` |
| `FilterBar` widget (mobile) | RefactorÃ© | RÃ©utilisÃ© avec chips thÃ¨me au lieu de chips mode |

---

## 4. Plan d'ImplÃ©mentation DÃ©taillÃ©

### Ordre d'exÃ©cution
```
Story 0 (fix filtres) â†’ Story 1 (digest config) â†’ Story 2 (feed thÃ¨mes)
    Ã€ implÃ©menter        â†‘ prioritÃ© alpha testers     â†‘ rÃ©utilise filter_presets
```

---

### Story 0 : Fix des filtres cassÃ©s

| Fichier | Changement |
|---------|-----------|
| `packages/api/app/services/recommendation/filter_presets.py` | **CrÃ©er** : `apply_serein_filter()`, `get_opposing_biases()`, `apply_theme_focus_filter()`, constantes `SEREIN_EXCLUDED_THEMES` et `SEREIN_KEYWORDS` |
| `packages/api/app/models/enums.py` | **Ajouter** : `DigestMode(str, Enum)` avec `standard`, `serein`, `perspective`, `theme_focus` |
| `packages/api/app/services/recommendation_service.py` | **Fix** : INSPIRATION mode utilise `apply_serein_filter()` (corrige slugs `society_climate`â†’`society`, `geopolitics`â†’`international`). PERSPECTIVES utilise `get_opposing_biases()` partagÃ©. |

**VÃ©rification** : `_calculate_user_bias()` gÃ¨re le cas "aucune source suivie" â†’ retourne `BiasStance.CENTER` â†’ `get_opposing_biases(CENTER)` retourne une liste large. OK.

---

### Story 1 : Digest Configurable par Presets

#### Backend (7 fichiers)

**1. `packages/api/app/services/recommendation/filter_presets.py`** (modifier)
- Ajouter `calculate_user_bias(session, user_id) -> BiasStance` : extraire la logique de `RecommendationService._calculate_user_bias()` en fonction async standalone (query `Source.bias_stance` join `UserSource`, score -1/+1, retourne LEFT/RIGHT/CENTER)
- L'ancienne mÃ©thode `_calculate_user_bias` dÃ©lÃ¨gue Ã  cette nouvelle fonction

**2. `packages/api/app/services/digest_selector.py`** (modifier â€” fichier critique)
- `DigestContext` dataclass : ajouter `user_bias_stance: BiasStance | None = None`
- `_build_digest_context(user_id)` : ajouter param `mode`, si PERSPECTIVE â†’ appeler `calculate_user_bias()`, stocker dans context
- `select_for_user(user_id, ...)` : ajouter params `mode: str = "standard"`, `focus_theme: str | None = None`
- `_get_candidates(context, limit)` : ajouter params `mode`, `focus_theme`
  - Si `mode == "serein"` â†’ `query = apply_serein_filter(query)` (sur query sources utilisateur ET fallback)
  - Si `mode == "theme_focus"` et `focus_theme` â†’ `query = apply_theme_focus_filter(query, focus_theme)`
  - Si `mode == "theme_focus"` â†’ relaxer `DiversityConstraints.max_per_theme` (passer de 2 Ã  7)
  - PERSPECTIVE : pas de filtre SQL, boost au scoring
- `_score_candidates(candidates, context)` : si mode PERSPECTIVE et `context.user_bias_stance` â†’ ajouter +80 pts aux articles de biais opposÃ© (`get_opposing_biases(context.user_bias_stance)`)

**3. `packages/api/app/models/daily_digest.py`** (modifier)
- Ajouter colonne : `mode: Mapped[str | None] = mapped_column(String(30), nullable=True, default="standard")`

**4. Migration Alembic** (crÃ©er)
- `alembic revision --autogenerate -m "add_mode_to_daily_digest"`
- OpÃ©ration : `ADD COLUMN mode VARCHAR(30) DEFAULT 'standard'` â€” safe, pas de rewrite table

**5. `packages/api/app/jobs/digest_generation_job.py`** (modifier)
- Dans `_generate_digest_for_user()` : lire `digest_mode` et `digest_focus_theme` depuis `UserPreference` pour cet utilisateur
- Passer `mode=digest_mode, focus_theme=digest_focus_theme` Ã  `selector.select_for_user()`
- Stocker `mode` sur le `DailyDigest` record crÃ©Ã©

**6. `packages/api/app/schemas/digest.py`** (modifier)
- `DigestResponse` : ajouter `mode: str = Field(default="standard")`

**7. `packages/api/app/routers/digest.py`** (modifier)
- Dans la construction de `DigestResponse` : inclure `mode=digest.mode or "standard"`

**Note** : `UserPreference` key-value stocke dÃ©jÃ  des prÃ©fÃ©rences. On ajoute `digest_mode` et `digest_focus_theme` comme clÃ©s. L'endpoint `PUT /api/users/preferences` existe-t-il dÃ©jÃ  ? Ã€ vÃ©rifier â€” sinon crÃ©er un endpoint simple d'upsert dans `routers/users.py`.

#### Mobile (7 fichiers)

**8. `apps/mobile/lib/features/digest/models/digest_models.dart`** (modifier)
- Ajouter `@Default('standard') String mode` dans `DigestResponse`
- Puis : `dart run build_runner build --delete-conflicting-outputs`

**9. `apps/mobile/lib/features/digest/providers/digest_mode_provider.dart`** (crÃ©er)
- Enum `DigestMode` avec `standard`, `serein`, `perspective`, `themeFocus` + labels FR, descriptions, icÃ´nes
- `DigestModeState` : `mode` + `focusTheme`
- `digestModeProvider` (AsyncNotifier) : `build()` charge les prefs depuis l'API, `setMode()` sauvegarde + invalide le digest provider

**10. `apps/mobile/lib/features/digest/widgets/digest_mode_sheet.dart`** (crÃ©er)
- Bottom sheet avec 4 cards de mode (pattern de `digest_personalization_sheet.dart` : Container, drag handle, border radius 24)
- Chaque card : icÃ´ne Phosphor + titre (Fraunces 16 w600) + description (DM Sans 13)
- Mode actif = highlight terracotta (`colors.primary.withValues(alpha: 0.1)` + border `colors.primary`)
- Si THEME_FOCUS sÃ©lectionnÃ© â†’ afficher chips thÃ¨mes sous la card
- Footer : "Prend effet dÃ¨s demain matin" en `textSecondary` italic

**11. `apps/mobile/lib/features/digest/screens/digest_screen.dart`** (modifier)
- Ajouter icÃ´ne âš™ï¸ (`PhosphorIcons.gear`) dans le header (remplacer le `SizedBox(width: 48)` spacer)
- `onPressed` â†’ ouvre `DigestModeSheet` en bottom sheet
- Ajouter label subtil sous le titre "Mon Essentiel" montrant le mode actif (ex: "Mode : Rester serein")

**12. `apps/mobile/lib/features/settings/screens/digest_settings_screen.dart`** (crÃ©er)
- Ã‰cran "Mon Digest" : mÃªme sÃ©lecteur 4 cards que le bottom sheet
- Section conditionnelle "ThÃ¨me Focus" (visible si mode=theme_focus) : chips thÃ¨mes utilisateur
- Texte info : "Ton digest est gÃ©nÃ©rÃ© chaque matin Ã  8h avec ce mode."
- Pattern : AppBar + SingleChildScrollView, comme `account_screen.dart`

**13. `apps/mobile/lib/features/settings/screens/settings_screen.dart`** (modifier)
- Section CONTENU : ajouter tile "Mon Essentiel" en premiÃ¨re position (avant "Mes sauvegardes")
- `_buildTile(icon: PhosphorIcons.sliders, title: 'Mon Essentiel', subtitle: 'Mode : ${mode}')`
- `onTap: () => context.pushNamed(RouteNames.digestSettings)`

**14. `apps/mobile/lib/config/routes.dart`** (modifier)
- `RouteNames.digestSettings = 'digest-settings'`
- `RoutePaths.digestSettings = '/settings/digest'`
- Ajouter `GoRoute` sous le settings ShellRoute children

---

### Story 2 : Filtrer le Feed par ThÃ¨me

#### Backend (3 fichiers)

**15. `packages/api/app/routers/feed.py`** (modifier)
- Ajouter param `theme: str | None = Query(None)` sur `get_personalized_feed()`
- Passer `theme=theme` Ã  `service.get_feed()`

**16. `packages/api/app/services/recommendation_service.py`** (modifier)
- `get_feed()` : ajouter param `theme: str | None = None`
- `_get_candidates()` : ajouter param `theme: str | None = None`
- AprÃ¨s les filtres de mode : `if theme: query = apply_theme_focus_filter(query, theme)`

**17. `packages/api/app/routers/users.py`** (modifier)
- Ajouter `GET /api/users/top-themes` : query `UserInterest` pour l'utilisateur, `ORDER BY weight DESC`
- Retourne `[{interest_slug, weight}]`

#### Mobile (5 fichiers)

**18. `apps/mobile/lib/features/feed/providers/theme_filters_provider.dart`** (crÃ©er)
- `themeFiltersProvider` (FutureProvider) : fetch `GET /api/users/top-themes`, map vers `ThemeFilterConfig(slug, label, emoji, weight)`
- Metadata emoji/label depuis une map statique (rÃ©utilise `AvailableThemes.all` data)
- Fallback : thÃ¨mes sÃ©lectionnÃ©s Ã  l'onboarding si l'API Ã©choue

**19. `apps/mobile/lib/features/feed/widgets/filter_bar.dart`** (modifier)
- `FilterConfig` : ajouter champ optionnel `emoji`
- `_buildFilterChip()` : afficher emoji + label dans le chip text
- Supprimer les `_keys` hardcodÃ©s (`inspiration`, `perspectives`, `deep_dive`) â†’ clÃ©s dynamiques

**20. `apps/mobile/lib/features/feed/providers/feed_provider.dart`** (modifier)
- Renommer sÃ©mantiquement `_selectedFilter` â†’ passe `theme` au lieu de `mode` au repository
- `setFilter(String? theme)` â†’ appel API avec `theme=theme`

**21. `apps/mobile/lib/features/feed/repositories/feed_repository.dart`** (modifier)
- `getFeed()` : remplacer param `mode` par `theme`, passer en query param `?theme=tech`

**22. `apps/mobile/lib/features/feed/screens/feed_screen.dart`** (modifier)
- Remplacer `personalizedFiltersProvider` par `themeFiltersProvider`
- Convertir `ThemeFilterConfig` â†’ `FilterConfig` avec emoji
- Le reste du wiring `FilterBar` â†’ `feedProvider.setFilter()` reste identique

**23. `apps/mobile/lib/features/feed/providers/personalized_filters_provider.dart`** (dÃ©prÃ©cier)
- Ajouter `@Deprecated('Replaced by theme_filters_provider')` sur le provider
- Garder `FilterConfig` class (importÃ©e par `filter_bar.dart`)
- Ne pas supprimer le fichier tant qu'on confirme qu'il n'est plus importÃ©

---

## 5. VÃ©rification

### Story 0
- `curl -H "Authorization: Bearer $TOKEN" "$API/feed/?mode=inspiration"` â†’ ne retourne aucun article de thÃ¨me `society`, `international`, `economy`, `politics`

### Story 1
- `curl -X PUT "$API/users/preferences" -d '{"key":"digest_mode","value":"serein"}'` â†’ 200
- `curl "$API/digest"` â†’ retourne `"mode": "serein"` et aucun article de thÃ¨me anxiogÃ¨ne
- Sur mobile : tap âš™ï¸ sur digest â†’ bottom sheet 4 modes â†’ sÃ©lection â†’ toast feedback
- Settings > Mon Essentiel â†’ mÃªme sÃ©lecteur + thÃ¨me focus si applicable

### Story 2
- `curl "$API/feed/?theme=tech"` â†’ uniquement des articles de sources `theme=tech`
- `curl "$API/users/top-themes"` â†’ liste ordonnÃ©e par weight DESC
- Sur mobile : chips thÃ¨me dans le feed â†’ tap "Tech" â†’ feed filtrÃ© â†’ re-tap â†’ feed complet

---

## 6. Risques & Mitigations

| Risque | Mitigation |
|--------|-----------|
| Feed vide sur filtre thÃ¨me | Message "Peu de contenu rÃ©cent" + CTA retour feed complet |
| Perte modes feed sans remplacement | Story 0+1 livrÃ©es **avant** Story 2 |
| Serein exclut trop de contenu | Fallback : complÃ©ter avec articles standard si <7 candidats |
| Perspective boost insuffisant | Calibrer +80 â†’ vÃ©rifier 2-3 articles opposÃ©s en rÃ©sultat |
| Migration Alembic | Colonne nullable + DEFAULT â†’ pas de lock timeout |

## 7. Questions Ouvertes

1. **Endpoint PUT /api/users/preferences** : existe-t-il dÃ©jÃ  ? Si non, crÃ©er un upsert simple
2. **Roadmap NLP pour Serein** : scoring tonalitÃ© quand ML_ENABLED (hors scope cet epic)
3. **Notifications** : mentionner le mode dans la push du matin ? (hors scope, Ã  traiter sÃ©parÃ©ment)
