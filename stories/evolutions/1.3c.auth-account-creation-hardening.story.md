# Story 1.3c: Durcissement Account Creation - Stale JWT & Infra Resilience

> **Parent Story**: [[../evolutions/1.3b.auth-email-confirmation.story.md]]
> **Type**: Bug Fix / Hardening
> **Linked Issue**: Issue: "Création de compte - 3 problèmes"

## Status: RESOLVED ✅

> [!NOTE]
> **Fixed by**: Claude Code Agent
> **Branch**: `claude/fix-account-creation-EUMXu` (merged via `Maj-documentation-ClaudeCode`)
> **Date**: 2026-02-15

## Story

**As a** nouvel utilisateur complétant l'onboarding après confirmation email,
**I want** que mon compte soit créé sans erreur même si mon JWT est "stale" ou en cas de problème d'infrastructure,
**so that** l'inscription soit fiable et ne se bloque pas sur des timeouts ou des JWT périmés.

## Acceptance Criteria

**Issue #3: "Exception: Serveur rencontre difficultés" après onboarding**
- ✅ Le POST `/api/users/onboarding` ne renvoit plus 403 quand `_check_email_confirmed_with_retry()` timeout
- ✅ L'appel API retry automatiquement après un `refreshUser()` en cas d'erreur auth (JWT stale)
- ✅ Les utilisateurs confirmés en DB ne sont plus bloqués par des timeouts Supabase

**Issue #2: Redirection vers localhost:3000**
- ✅ Sur Flutter web, `emailRedirectTo` utilise l'URL web de production, pas un deep link
- ✅ Sur native, conservation du deep link `io.supabase.facteur://login-callback`

**Issue #1: Emails pas toujours envoyés (Documentation)**
- ✅ Documented: Probable rate limiting Supabase free tier
- ✅ Documented: Dashboard config changes needed for reliability

## Tasks / Subtasks

### Fix #3: Backend Infrastructure Resilience
- [x] **Backend** : `_check_email_confirmed_with_retry()` returns `None` on DB unreachable (instead of `False`)
  - File: `packages/api/app/dependencies.py:30-107`
  - Changes: Return type `bool | None`, fail-open logic
- [x] **Backend** : `get_current_user_id()` handles tri-state return properly
  - File: `packages/api/app/dependencies.py:193-211`
  - Changes: Distinguish between `True` (confirmed), `False` (not confirmed), `None` (couldn't check)

### Fix #3: Mobile JWT Refresh & Retry
- [x] **Mobile** : `ConclusionNotifier._saveOnboarding()` retries after session refresh on 403
  - File: `apps/mobile/lib/features/onboarding/providers/conclusion_notifier.dart:73-114`
  - Changes: Add auth error detection + `refreshUser()` + retry logic
- [x] **Mobile** : Replace raw `print()` with `debugPrint()` per style guide
  - File: `apps/mobile/lib/features/onboarding/providers/conclusion_notifier.dart`
  - Changes: Consolidate logging to `debugPrint()`

### Fix #2: Platform-Aware Email Redirect URL
- [x] **Mobile** : `signUpWithEmail()` uses platform-aware `emailRedirectTo`
  - File: `apps/mobile/lib/core/auth/auth_state.dart:284-287`
  - Changes: Web → HTTPS URL, Native → deep link scheme
- [x] **Import** : Ensure `kIsWeb` from `package:flutter/foundation.dart` available
  - Already imported line 2

### Fix #1: Documentation - Email Reliability & Supabase Config
- [x] **Documented**: Root cause analysis and Supabase dashboard changes needed
  - See section "Supabase Dashboard Configuration" below

## Dev Notes

### Backend: Fail-Open on DB Unreachable

**Problem**: When `_check_email_confirmed_with_retry()` encounters timeout/connection errors, it returned `False`, blocking legitimate users whose JWT is stale (from before email confirmation).

**Solution**: Return `None` to signal "couldn't check", allowing `get_current_user_id()` to fail-open:

```python
async def _check_email_confirmed_with_retry(...) -> bool | None:
    # Returns:
    # True: confirmed in DB
    # False: definitely not confirmed
    # None: couldn't reach DB (fail-open)

    except (asyncio.TimeoutError, ...) as timeout_err:
        logger.warning("auth_db_check_unreachable", reason="timeout", ...)
        return None  # CHANGED: was return False
```

**Caller handles tri-state**:

```python
is_confirmed = await _check_email_confirmed_with_retry(user_id)

if is_confirmed is True:
    return user_id  # Confirmed
elif is_confirmed is None:
    # DB unreachable — fail-open
    logger.warning("auth_db_unreachable_fail_open", user_id=user_id)
    return user_id  # Allow access (user has valid JWT)
else:
    # is_confirmed is False
    raise HTTPException(403, "Email not confirmed")
```

### Mobile: Retry With JWT Refresh

**Problem**: After email confirmation, user's JWT might still lack `email_confirmed_at` (stale token from before confirmation). Backend returns 403. Mobile immediately shows error.

**Solution**: `ConclusionNotifier` detects auth error and retries:

```dart
Future<void> _saveOnboarding() async {
    var result = await userService.saveOnboarding(answers);

    // Retry on auth error after refreshing session
    if (!result.success && result.errorType == ErrorType.auth) {
        debugPrint('Onboarding: erreur auth, tentative de refresh session...');
        try {
            await _ref.read(authStateProvider.notifier).refreshUser();
            await Future<void>.delayed(const Duration(milliseconds: 200));
            result = await userService.saveOnboarding(answers);
        } catch (e) {
            debugPrint('Onboarding: échec refresh session: $e');
        }
    }

    if (result.success) {
        // Success path
    } else {
        throw Exception(result.friendlyErrorMessage);
    }
}
```

### Mobile: Platform-Aware Email Redirect

**Problem**: Deep link `io.supabase.facteur://login-callback` doesn't work on Flutter web. Supabase falls back to "Site URL" (default `http://localhost:3000`).

**Solution**: Check platform in `signUpWithEmail()`:

```dart
Future<void> signUpWithEmail({
    required String email,
    required String password,
    required String firstName,
    required String lastName,
}) async {
    final redirectUrl = kIsWeb
        ? '${Uri.base.origin}/email-confirmation'
        : 'io.supabase.facteur://login-callback';

    await _supabase.auth.signUp(
        email: email,
        password: password,
        emailRedirectTo: redirectUrl,
        data: {
            'first_name': firstName,
            'last_name': lastName,
        },
    );
}
```

## Supabase Dashboard Configuration

**Manual steps required for full fix (Issues #1 & #2)**:

### Issue #2: Email Redirect URL
Navigate to [Supabase Dashboard > Auth > URL Configuration](https://supabase.com/dashboard/project/ykuadtelnzavrqzbfdve/auth/url-configuration):

1. **Site URL** (fallback): Change from `http://localhost:3000` to production URL (e.g., `https://facteur.app`)
2. **Redirect URLs** (whitelist):
   - Add: `io.supabase.facteur://login-callback` (for mobile)
   - Add: `https://[production-domain]/email-confirmation` (for web)

### Issue #1: Email Reliability
Navigate to [Supabase Dashboard > Auth > Email Templates & Settings](https://supabase.com/dashboard/project/ykuadtelnzavrqzbfdve/auth/templates):

1. Check **Email rate limits**: Free tier limits ~4 emails/hour per email address
2. Consider **Custom SMTP** (Resend, Postmark, SendGrid) to exceed free tier limits:
   - Dashboard > Auth > SMTP Settings > Enable Custom SMTP
   - Configure credentials (API keys)
3. Verify **email template SPF/DKIM** if using custom domain

## File Changes

| File | Change | Type |
|------|--------|------|
| `packages/api/app/dependencies.py` | Fail-open logic in `_check_email_confirmed_with_retry()` & caller | Backend Fix |
| `apps/mobile/lib/features/onboarding/providers/conclusion_notifier.dart` | Retry + refresh on 403, replace `print()` with `debugPrint()` | Mobile Fix |
| `apps/mobile/lib/core/auth/auth_state.dart` | Platform-aware `emailRedirectTo` in `signUpWithEmail()` | Mobile Fix |

## Verification

### One-Liner Proofs

**Backend**: User with stale JWT but confirmed in DB gets access
```bash
# Simulated: 403 won't be returned if DB is unreachable (returns user_id)
# Check logs: "auth_db_unreachable_fail_open" should appear instead of "auth_user_blocked"
```

**Mobile**: Onboarding completes even with stale JWT
```bash
# Manual test: Sign up → confirm email → complete onboarding
# Should succeed, not show "Exception: Serveur rencontre difficultés"
```

**Mobile Web**: Email redirect uses production URL
```bash
# Code: kIsWeb check in auth_state.dart line 285-287
# Web users get HTTPS redirect, native users get deep link
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 15/02/2026 | 1.0 | Fix stale JWT handling + DB resilience + platform-aware redirects | Claude Code |
| 15/02/2026 | 1.0 | Documentation of account creation hardening | Claude Code |

## Blocking Issues Resolved

This story resolves:
- ~~Users confirmed in DB still get 403 in App~~ → Fixed in backend
- ~~"Exception: Serveur rencontre difficultés" on post-onboarding~~ → Fixed with retry + JWT refresh
- ~~Email confirmation redirects to localhost:3000~~ → Fixed with platform-aware URL

## Next Steps (Future)

- [ ] Add E2E tests for account creation flow (including stale JWT scenario)
- [ ] Monitor email delivery metrics in Supabase dashboard
- [ ] Consider implementing custom SMTP if email delivery remains unreliable
- [ ] Add deep link configuration to native projects (Android/iOS) if not already done
