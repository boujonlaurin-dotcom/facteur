# Story 1.3b: Validation Email & Sécurisation Inscription

> **Parent Story**: [[../core/1.3.auth-supabase.md]]  
> **Type**: Evolution

## Status: IN PROGRESS (Regression)

> [!WARNING]
> Blocked by critical issue: Users confirmed in DB (manually) still get 403 in App. See `docs/bugs/bug-auth-bounced-silent.md`.

## Story

**As a** nouvel utilisateur (inscription par email),  
**I want** être guidé pour valider mon adresse email avant d'accéder à l'application,  
**so that** mon compte soit sécurisé et que je ne puisse pas accéder au feed sans identité vérifiée.

## Acceptance Criteria

1. ✅ **Blocage au niveau du Backend** : L'API rejette les requêtes avec un token dont l'email n'est pas confirmé (HTTP 403).
2. ✅ **Redirection Automatique** : Si l'utilisateur est connecté mais n'a pas validé son email, l'application le redirige systématiquement vers l'écran `/email-confirmation`.
3. ✅ **Écran de Confirmation Dédié** :
    - Affiche l'adresse email utilisée.
    - Permet de renvoyer l'email de validation.
    - Permet de se déconnecter (pour changer d'email ou sortir du verrouillage).
    - Permet de rafraîchir manuellement la session après validation.
4. ✅ **Traductions UX** : Les erreurs liées à l'email (lien expiré, invalide) sont traduites en français.
5. ✅ **Exemption Social Login** : Les utilisateurs inscrits via Google/Apple ne sont pas soumis à cette validation (considérée comme acquise).
6. [ ] **Champs Nom / Prénom** : Le formulaire d'inscription inclut des champs pour saisir le prénom et le nom, stockés dans les métadonnées de l'utilisateur.
7. [ ] **UX Inscription** : Une fois le bouton "Créer un compte" cliqué, une transition visuelle claire (loader + écran de succès) informe l'utilisateur que l'email a été envoyé.
8. [ ] **Deep Linking** : Le lien de confirmation d'email redirige vers l'application mobile et déclenche la connexion automatique.
9. [ ] **Redirection Supabase** : La page de redirection intermédiaire de Supabase affiche un message clair de succès avant de basculer vers l'app.

## Tasks / Subtasks

- [x] **Backend** : Mettre à jour `dependencies.py` pour vérifier `email_confirmed_at`.
- [x] **Auth State** : Ajouter le getter `isEmailConfirmed` et la méthode `refreshUser()`.
- [x] **Router** : Configurer la route `/email-confirmation` et la logique de redirection forcée.
- [x] **UI** : Mettre à jour `EmailConfirmationScreen` (Logout, Refresh Session).
- [ ] **Traductions** : Compléter `AuthErrorMessages.dart`.
- [ ] **UI** : Ajouter les champs `firstName` et `lastName` dans `LoginScreen`.
- [ ] **Infrastructure** : Configurer les Deep Links (Android & iOS).
- [ ] **Supabase** : Configurer `Redirect URLs` et potentiellement les templates d'email.

## Dev Notes

### Redirection Logic (`routes.dart`)
```dart
if (!isEmailConfirmed) {
  if (isOnEmailConfirmation) return null;
  return RoutePaths.emailConfirmation;
}
```

### Backend Enforcement (`dependencies.py`)
```python
email_confirmed_at = payload.get("email_confirmed_at")
if not email_confirmed_at:
    if payload.get("app_metadata", {}).get("provider") == "email":
        raise HTTPException(status_code=403, detail="Email not confirmed")
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 19/01/2026 | 1.0 | Création de la story pour documenter le workflow de validation | Antigravity |
