# Story 11.1 : Digest Mode Selector — UX/UI Premium

> **Parent Epic**: [[11.epic-digest-feed-personalisation.md]]
> **Type**: Evolution (Story 1 de l'Epic 11)

## Status: In Progress

## Story

**As a** utilisateur du digest quotidien,
**I want** un sélecteur de mode visuellement impactant et premium qui change clairement l'ambiance de mon digest,
**so that** je perçoive immédiatement l'effet de mon choix de mode sur ma sélection d'articles.

## Acceptance Criteria

1. **Sélecteur de mode** : composant de type segmented control compact (iOS-style) positionné en haut à droite du header de la carte digest
2. **Identité visuelle par mode** : chaque mode a sa propre couleur, icône Phosphor, gradient de carte, et couleur de fond d'écran
3. **Changement de mood immédiat** : le switch de mode provoque un changement de couleur marqué et animé (fond d'écran + gradient carte)
4. **Feedback de régénération** : un overlay animé (pulsing glow + progress indicator) apparaît pendant que le backend régénère les articles
5. **Sous-titre lisible** : le sous-titre du mode est visible 4s après un changement, avec une taille et un contraste suffisants
6. **Titre complet** : affiche "L'Essentiel du jour" (pas juste "L'Essentiel")
7. **Feed sans emojis thèmes** : les filtres thèmes du feed affichent uniquement le label texte (plus d'emoji devant)

## Tasks / Subtasks

### Phase 1 : Fondations (DONE)

- [x] **Task 1 : Créer l'enum `DigestMode` avec métadata** (AC: 2)
  - [x] 3 modes : pourVous, serein, perspective (theme_focus déprécié)
  - [x] Champs : key, label, subtitle, emoji, color, icon, gradients, backgroundColor
  - [x] Fichier : `apps/mobile/lib/features/digest/models/digest_mode.dart`

- [x] **Task 2 : Créer `DigestModeProvider`** (AC: 1)
  - [x] State : `{ DigestMode mode, bool isRegenerating, String? errorMessage }`
  - [x] `setMode()` : sauvegarde préférence + appel `POST /api/digest/generate?mode=X&force=true`
  - [x] `initFromDigestResponse()` : synchronise le mode depuis la réponse API
  - [x] Fichier : `apps/mobile/lib/features/digest/providers/digest_mode_provider.dart`

- [x] **Task 3 : Backend — mode sur daily_digest** (AC: 1)
  - [x] Migration Alembic : colonne `mode VARCHAR(30) DEFAULT 'pour_vous'`
  - [x] DigestSelector : filtrage serein (keywords + thèmes exclus), boost perspective (+80pts)
  - [x] Endpoint `POST /api/digest/generate` accepte `mode` et `force` params

- [x] **Task 4 : Retirer emojis des filtres thèmes du feed** (AC: 7)
  - [x] `theme_filters_provider.dart` : labels texte uniquement

### Phase 2 : UI Premium (IN PROGRESS)

- [x] **Task 5 : Créer `DigestModeSegmentedControl`** (AC: 1, 2)
  - [x] Composant iOS-style segmented control compact (132×36px)
  - [x] Sliding indicator animé (AnimatedPositioned 250ms)
  - [x] Icônes Phosphor : sunDim (Pour vous), flowerLotus (Serein), detective (Perspective)
  - [x] Bordure et glow couleur du mode sur le segment sélectionné
  - [x] Fichier : `apps/mobile/lib/features/digest/widgets/digest_mode_tab_selector.dart`

- [x] **Task 6 : Intégrer le segmented control dans le header** (AC: 1, 6)
  - [x] Positionné top-right du header de la carte (inversé avec la progression)
  - [x] Progression (X/5 + barres segmentées) inline avec le titre à gauche
  - [x] Titre "L'Essentiel du jour" (fontSize 20, w800)
  - [x] Sous-titre du mode apparaît 4s après changement, puis disparaît

- [x] **Task 7 : Gradient et couleurs du container** (AC: 3)
  - [x] TweenAnimationBuilder pour transitions fluides entre modes
  - [x] Gradients dark mode teintés par le mode (ambre, vert forêt, bleu nuit)
  - [x] Bordure subtile avec glow adapté
  - [x] Support light mode (gradients semi-transparents sur fond crème)

- [x] **Task 8 : Overlay de régénération** (AC: 4)
  - [x] `_RegenerationOverlay` avec shimmer pulsé (AnimationController 1500ms)
  - [x] Glow circle + CircularProgressIndicator + texte "Recomposition en cours..."
  - [x] Articles en opacité 0.15 + IgnorePointer pendant régénération

- [ ] **Task 9 : Polish UX/UI (prochaine itération)** (AC: 1, 2, 3, 5)
  - [ ] Évaluer si le segmented control est suffisamment "premium" et impactant
  - [ ] Vérifier que le changement de couleur de fond est assez marqué
  - [ ] Vérifier la lisibilité du sous-titre sur chaque couleur de mode
  - [ ] Valider le choix des icônes (sunDim, flowerLotus, detective)
  - [ ] S'assurer que le composant communique visuellement le concept de "switch de mode"

## Dev Notes

### Architecture des fichiers

| Fichier | Rôle |
|---------|------|
| `digest_mode.dart` | Enum des 3 modes avec toute l'identité visuelle (couleurs, icônes, gradients dark/light) |
| `digest_mode_tab_selector.dart` | `DigestModeSegmentedControl` — segmented control compact iOS-style |
| `digest_briefing_section.dart` | Container principal : header (titre+progression+selector), sous-titre, liste d'articles |
| `digest_screen.dart` | Écran : connecte les providers, gère le fond animé, l'overlay de régénération |
| `digest_mode_provider.dart` | State management : `setMode()` → pref + API regen → UI sync |
| `digest_provider.dart` | Cache du digest, `updateFromResponse()` |

### Palette de couleurs actuelle (dark mode)

| Mode | Couleur principale | Gradient Start → End | Background écran |
|------|-------------------|---------------------|-----------------|
| Pour vous | `#D4944C` (ambre doré) | `#261C0E → #1A1408` | `#1A150C` |
| Serein | `#4CAF7D` (jade/forêt) | `#0E2218 → #0A1A10` | `#0C1A10` |
| Perspective | `#6B8FBF` (bleu acier) | `#0E1526 → #0A101E` | `#0C1220` |

### Icônes Phosphor actuelles

| Mode | Icône | Style |
|------|-------|-------|
| Pour vous | `PhosphorIcons.sunDim` | Fill |
| Serein | `PhosphorIcons.flowerLotus` | Fill |
| Perspective | `PhosphorIcons.detective` | Fill |

### Flow backend (fonctionnel)

```
User tap mode → DigestModeNotifier.setMode(newMode)
  → PUT /api/users/preferences {digest_mode: "serein"}    (fire & forget)
  → POST /api/digest/generate?mode=serein&force=true       (attend réponse)
  → DigestService.get_or_create_digest(mode, force=true)
    → DELETE existing digest
    → DigestSelector.select_for_user(mode=mode)
      → apply_serein_filter() si serein (exclut thèmes + keywords anxiogènes)
      → +80pts bias opposé si perspective
    → INSERT nouveau digest en DB
  ← DigestResponse {mode, items[...]}
  → DigestNotifier.updateFromResponse()
  → UI refresh
```

## Dev Agent Record

**Agent 1:** Claude (Dev) — Session initiale
**Date:** 15/02/2026
**Branch:** `claude/digest-feed-tab-selector-4hQuu`

### Contributions Agent 1
- Création de `DigestMode` enum avec emojis, couleurs premium, backgroundColor
- Premier design des badges emojis (38px carrés arrondis) — remplacé par segmented control
- Background animé du digest screen (AnimatedContainer)
- Retrait des emojis des filtres thèmes du feed

**Agent 2:** Claude (Dev) — Itération UX
**Date:** 15/02/2026
**Branch:** `main` (mergé)

### Contributions Agent 2
- Refonte complète : `DigestModeSegmentedControl` (iOS-style, 132×36px, sliding indicator)
- TweenAnimationBuilder pour transitions gradient fluides
- Overlay de régénération pulsé (`_RegenerationOverlay`)
- Support light mode (gradients semi-transparents)
- Sous-titre temporaire (4s timer)
- Titre "L'Essentiel du jour"
- Ajout `onLike` callback
- SnackBar pour erreurs de changement de mode
- Icônes : flowerLotus (serein), detective (perspective)

### Files Changed

**Mobile (principal):**
- `apps/mobile/lib/features/digest/models/digest_mode.dart` — Enum 3 modes, palette premium, dark+light gradients
- `apps/mobile/lib/features/digest/widgets/digest_mode_tab_selector.dart` — DigestModeSegmentedControl
- `apps/mobile/lib/features/digest/widgets/digest_briefing_section.dart` — StatefulWidget, TweenAnimationBuilder, header restructuré
- `apps/mobile/lib/features/digest/screens/digest_screen.dart` — Background animé, RegenerationOverlay, error SnackBar
- `apps/mobile/lib/features/digest/providers/digest_mode_provider.dart` — State management mode
- `apps/mobile/lib/features/feed/providers/theme_filters_provider.dart` — Labels texte sans emojis

**Backend (déjà en place):**
- `packages/api/app/models/daily_digest.py` — Colonne `mode`
- `packages/api/app/services/digest_selector.py` — Filtres serein + boost perspective
- `packages/api/app/routers/digest.py` — Param mode sur POST /generate
- `packages/api/app/schemas/digest.py` — `mode` dans DigestResponse

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 15/02/2026 | 1.0 | Story créée rétroactivement pour documenter les travaux Epic 11 Story 1 | Dev Agent 1 (Claude) |
| 15/02/2026 | 1.1 | Itération UX : segmented control, transitions, overlay régénération | Dev Agent 2 (Claude) |
| 15/02/2026 | 1.2 | Documentation BMAD formalisée, handoff créé pour polish final | Dev Agent 1 (Claude) |
