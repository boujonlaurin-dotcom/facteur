# Story 5.3: Tracking automatique "Contenu consommé"

## Status: Completed ✅

## Story

**As a** utilisateur,  
**I want** que mes contenus soient automatiquement marqués comme lus,  
**so that** je voie ma progression sans effort.

## Acceptance Criteria

1. Endpoint API `POST /api/contents/{id}/status` pour maj statut (SEEN, CONSUMED).
2. **Navigation interne** : L'ouverture du contenu doit se faire via un **Navigateur Intégré (In-App Browser)** pour ne pas perdre le contexte de l'application.
3. **Trigger de validation** : L'appel API de confirmation (`CONSUMED` + temps passé) doit être déclenché **au retour** de l'utilisateur (fermeture de la WebView).
4. Logique de seuil de consommation gérée par le client (Mobile) :
    - `CONSUMED` = Lu en entier / vu (selon temps passé > seuil).
    - `SEEN` = Vue rapide / abandon.
5. Mise à jour de la table `user_content_status` (upsert).
6. Impact sur l'algo : Les contenus consommés ne réapparaissent plus.

## Tasks / Subtasks

- [x] **Task 1: Content Interaction API**
  - [x] Mettre à jour `schemas/content.py` pour inclure `ContentStatusUpdate` (déjà partiellement fait ? à vérifier).
  - [x] Implémenter `POST /api/contents/{content_id}/status` dans `routers/contents.py`.
  - [x] Gérer l'upsert dans `user_content_status` (créer si existe pas, update sinon).

- [x] **Task 2: Service Layer**
  - [x] Ajouter une méthode `update_content_status(user_id, content_id, status, time_spent)` dans `RecommendationService` ou `ContentService`.
  - [x] Gérer la date `seen_at`.

- [x] **Task 3: Tests**
  - [x] Test unitaire : marquer un contenu comme `CONSUMED`.
  - [x] Vérifier qu'il est bien sauvegardé en base.
  - [x] Vérifier qu'il est exclu du prochain appel `/api/feed` (Test d'intégration).

## Dev Notes

### Différence SEEN vs CONSUMED
- **SEEN** : L'item a été affiché à l'écran (impression) ou survolé. L'algo pourra choisir de le déprioriser sans l'exclure totalement, ou l'exclure. (Actuellement Story 4.1 exclut `SEEN`).
- **CONSUMED** : L'utilisateur a cliqué/lu. Exclusion stricte + Compte pour les Streaks (Story future).

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 10/01/2026 | 1.0 | Initial Draft | BMad Master Agent |
| 12/01/2026 | 2.0 | Completed with WebView integration and "Lu" animation | BMad Agent |
