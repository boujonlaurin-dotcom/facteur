# Story 1.3: Authentification Supabase

## Status: Done ✅

## Story

**As a** utilisateur,  
**I want** créer un compte et me connecter via email ou Apple/Google,  
**so that** mes données soient sauvegardées et sécurisées.

## Acceptance Criteria

1. ✅ Supabase Auth configuré avec providers Email, Apple, Google
2. ✅ Écran de connexion Flutter avec options Email + Social
3. ✅ Flow de création de compte email (email + password)
4. ✅ Flow de connexion sociale (Apple Sign-In, Google Sign-In)
5. ✅ Token JWT stocké de manière sécurisée sur le device
6. ✅ Déconnexion fonctionnelle
7. ✅ L'utilisateur authentifié est créé dans la table `users` Supabase

## Tasks / Subtasks

- [x] Créer `auth_state.dart` avec Riverpod (AC: 1-6)
  - [x] AuthState class avec user, isLoading, needsOnboarding
  - [x] signInWithEmail()
  - [x] signUpWithEmail()
  - [x] signInWithApple()
  - [x] signInWithGoogle()
  - [x] signOut()
- [x] Créer `login_screen.dart` (AC: 2, 3, 4)
  - [x] Formulaire email/password
  - [x] Boutons social login (Apple, Google)
  - [x] Toggle inscription/connexion
  - [x] Affichage erreurs
- [x] Configurer Supabase dans `main.dart` (AC: 1)
- [x] Configurer la redirection auth dans `routes.dart` (AC: 5, 6)
- [x] Créer trigger SQL pour créer profil auto (AC: 7)

## Dev Notes

### Source Tree
```
apps/mobile/lib/
├── core/auth/
│   └── auth_state.dart      # AuthStateNotifier + authStateProvider
├── features/auth/
│   └── screens/
│       └── login_screen.dart
├── config/
│   ├── constants.dart       # SupabaseConstants
│   └── routes.dart          # Redirect logic
└── main.dart                # Supabase.initialize()

scripts/
└── setup_supabase.sql       # Trigger on_auth_user_created
```

### Supabase Auth Flow
1. Client Flutter appelle `supabase.auth.signUp/signIn`
2. Supabase retourne JWT + User
3. Trigger SQL crée automatiquement user_profile, user_subscription, user_streak
4. `auth_state.dart` écoute les changements via `onAuthStateChange`
5. Router redirige selon l'état (login, onboarding, feed)

### Sécurité
- JWT vérifié côté backend via `dependencies.py`
- Token stocké via flutter_secure_storage (à configurer)
- RLS activé sur toutes les tables user_*

### Testing
- Tester les flows email et social
- Vérifier la création automatique du profil
- Tester la déconnexion et reconnexion

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 07/01/2026 | 1.0 | Story créée et implémentée | Claude |

## Dev Agent Record

### Agent Model Used
Claude Opus 4

### Completion Notes
- AuthStateNotifier complet avec tous les flows
- LoginScreen avec UI email + social
- Trigger SQL pour création auto du profil
- Redirect logic dans go_router

### File List
- `apps/mobile/lib/core/auth/auth_state.dart`
- `apps/mobile/lib/features/auth/screens/login_screen.dart`
- `apps/mobile/lib/config/routes.dart` (redirect logic)
- `apps/mobile/lib/main.dart` (Supabase.initialize)
- `scripts/setup_supabase.sql` (trigger on_auth_user_created)

