# Story 4.2: Écran Feed principal

## Status: Done ✅

## Story

**As a** utilisateur,  
**I want** voir mon feed de contenus personnalisés,  
**so that** je puisse découvrir ce qui m'intéresse.

## Acceptance Criteria

1. **Liste Scrollable** : Affichage d'une liste verticale de cards de contenu [Source: prd.md#Story 4.2]
2. **Pull-to-refresh** : Geste pour actualiser le feed manuellement [Source: prd.md#Story 4.2]
3. **Infinite Scroll** : Chargement automatique de la page suivante (20 items) au scroll [Source: prd.md#Story 4.2]
4. **États UI** :
    - Loading Shimmer (squelette) initial [Source: prd.md#Story 4.2]
    - État Vide (si aucun contenu) [Source: prd.md#Story 4.2]
    - Erreur (avec bouton "Réessayer")
5. **Caching** : Affichage instantané du cache (Hive) si < 5min [Source: architecture.md#7.2 Workflow : Feed personnalisé]
6. **Navigation** : Intégration dans le Bottom Navigation Bar [Source: prd.md#Story 4.2]

## Tasks / Subtasks

- [ ] **Task 1: Update Repository & Models**
    - [ ] **Refactor** `FeedRepository.getFeed` to handle the JSON envelope `{ items: [...], pagination: {...} }` instead of expecting a direct List.
    - [ ] Create/Update model to parse the pagination metadata if needed, or just extract `items`.
    - [ ] Ensure `Content.fromJson` matches the strict API response (check `content_type` enums).

- [ ] **Task 2: Upgrade State Management (Infinite Scroll)**
    - [ ] **Refactor** `feedProvider` from simple `FutureProvider` to `AsyncNotifier<List<Content>>`.
    - [ ] Implémenter la logique de pagination :
        - [ ] `loadNextPage()`: Fetch page N+1 and append to current list.
        - [ ] `refresh()`: Reset to page 1.
        - [ ] Gérer l'état `isLoadingMore` distinct du loading initial.

- [ ] **Task 3: Refactor FeedScreen**
    - [ ] **Update** `FeedScreen.dart` to use the new provider methods.
    - [ ] Add `NotificationListener<ScrollNotification>` (or use `ScrollController`) to trigger `loadNextPage` when near bottom.
    - [ ] Preserve the existing "Welcome" logic and header/shimmer UI.

- [ ] **Task 4: Testing**
    - [ ] Update `test/features/feed/feed_provider_test.dart`.
    - [ ] Verify infinite scroll behavior manually.

## Dev Notes

### Existing Codebase (Avoid Duplication)
- **CRITICAL**: A complete `FeedScreen` already exists in `lib/features/feed/screens/feed_screen.dart`. **DO NOT CREATE A NEW FILE.** Modify the existing one.
- **Provider**: `feedProvider` exists in `lib/features/feed/providers/feed_provider.dart`. Refactor it.
- **Repository**: `FeedRepository` exists in `lib/features/feed/repositories/feed_repository.dart`. Fix the parsing logic.
- **Models**: `Content` model exists. Verify it matches the API response from Story 4.1.

### Technical Details
- **API Response**: Expecting `{ "items": [...], "pagination": { "has_next": true, "page": 1 } }`.
- **State Management**: Use `AsyncNotifier` (Riverpod 2.x) to handle the list state.
  ```dart
  class FeedNotifier extends AsyncNotifier<List<Content>> {
    Future<void> loadMore() async { ... state = AsyncData([...old, ...new]); }
  }
  ```
- **Pagination**: Parameters `limit=20` (default) and `page` (or `offset`). Check if API uses page number or offset. Story 4.1 mentions `limit/offset`.

## Testing
- **Unit Tests**: `test/features/feed/feed_provider_test.dart`
- **Widget Tests**: `test/features/feed/feed_screen_test.dart`
- **Mocks**: Mocker `FeedRepository` et `HiveInterface`.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 11/01/2026 | 1.0 | Initial Draft | BMad Agent |
