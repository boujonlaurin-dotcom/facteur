# Story 2.7: AmÃ©lioration Onboarding - ThÃ¨mes avant Sources avec PrÃ©-sÃ©lection

## Status: Done

## Story

**As a** nouvel utilisateur,  
**I want** d'abord indiquer mes thÃ¨mes d'intÃ©rÃªt, puis voir des sources prÃ©-sÃ©lectionnÃ©es en fonction de ces choix,  
**so that** je puisse configurer mon feed plus rapidement et dÃ©couvrir des sources pertinentes que je ne connaissais pas.

## Context

### ProblÃ¨me actuel
L'utilisateur doit actuellement :
1. D'abord choisir manuellement ses sources (sans contexte sur ses intÃ©rÃªts)
2. Ensuite indiquer ses thÃ¨mes prÃ©fÃ©rÃ©s

Cette approche prÃ©sente plusieurs frictions :
- **Charge cognitive Ã©levÃ©e** : L'utilisateur ne connaÃ®t pas forcÃ©ment les sources avant de dÃ©finir ses intÃ©rÃªts
- **Ordre contre-intuitif** : Il est plus naturel de partir de "ce qui m'intÃ©resse" â†’ "qui en parle bien"
- **Onboarding plus long** : L'utilisateur doit examiner chaque source individuellement

### Solution proposÃ©e
1. **Inverser l'ordre** dans Section 3 : ThÃ¨mes (Q9) â†’ Sources (Q10)
2. **PrÃ©-sÃ©lection intelligente** : En fonction des thÃ¨mes/sous-thÃ¨mes choisis, proposer une liste de sources CURATED dÃ©jÃ  cochÃ©es
3. **Message informatif** : Afficher "âœ¨ Nous avons sÃ©lectionnÃ© ces sources basÃ©es sur vos intÃ©rÃªts"

### BÃ©nÃ©fices attendus
- **RÃ©duction friction** : L'utilisateur part de ses centres d'intÃ©rÃªt (familier)
- **Onboarding plus rapide** : PrÃ©-sÃ©lection intelligente = moins de clics
- **Meilleure confiance** : L'app "comprend" et propose des sources pertinentes
- **DÃ©couverte** : L'utilisateur peut dÃ©couvrir des sources de qualitÃ© qu'il ne connaissait pas

## Acceptance Criteria

1. âœ… L'ordre de Section 3 est inversÃ© : ThÃ¨mes (Q9) puis Sources (Q10)
2. âœ… Les sources sont prÃ©-sÃ©lectionnÃ©es automatiquement en fonction des thÃ¨mes choisis
3. âœ… Un message informatif est affichÃ© sur l'Ã©cran Sources : "âœ¨ SÃ©lection basÃ©e sur vos intÃ©rÃªts"
4. âœ… L'utilisateur peut modifier la prÃ©-sÃ©lection (ajouter/retirer des sources)
5. âœ… La navigation back fonctionne correctement (Sources â†’ ThÃ¨mes)
6. âœ… Les donnÃ©es sont sauvegardÃ©es correctement (mÃªme structure qu'avant)
7. âœ… Aucun impact sur le backend/DB/algorithme

## Tasks / Subtasks

### Phase 1 : Data Layer

- [ ] **Task 1 : CrÃ©er le mapping ThÃ¨mes â†’ Sources** (AC: 2)
  - [ ] CrÃ©er `lib/features/onboarding/data/theme_to_sources_mapping.dart`
  - [ ] ImplÃ©menter le mapping pour les 8 thÃ¨mes macro
  - [ ] ImplÃ©menter le mapping optionnel pour les sous-thÃ¨mes granulaires
  - [ ] Limiter Ã  3-5 sources par thÃ¨me (max 15 total)

### Phase 2 : Provider Logic

- [ ] **Task 2 : Inverser l'enum Section3Question** (AC: 1)
  - [ ] Modifier `enum Section3Question` : `themes`, `sources`, `finalize`
  - [ ] Adapter `selectThemesAndSubtopics()` â†’ navigue vers `sources`
  - [ ] Adapter `selectSources()` â†’ navigue vers `finalize`
  - [ ] VÃ©rifier/adapter la mÃ©thode `goBack()` pour Section 3

### Phase 3 : UI Updates

- [ ] **Task 3 : Mettre Ã  jour l'Ã©cran Sources** (AC: 2, 3, 4)
  - [ ] Charger les thÃ¨mes sÃ©lectionnÃ©s depuis le state
  - [ ] Calculer les sources recommandÃ©es via le mapping
  - [ ] Convertir les noms de sources en IDs (via API)
  - [ ] PrÃ©-cocher automatiquement les sources recommandÃ©es
  - [ ] Afficher le message informatif "âœ¨ SÃ©lection basÃ©e sur vos intÃ©rÃªts"
  - [ ] Permettre la modification (ajouter/retirer)

- [ ] **Task 4 : Mettre Ã  jour l'Ã©cran principal** (AC: 1)
  - [ ] Modifier `_buildSection3Content()` dans `onboarding_screen.dart`
  - [ ] VÃ©rifier que les animations de transition fonctionnent

### Phase 4 : Testing

- [ ] **Task 5 : Tests unitaires Provider**
  - [ ] Test "Section 3 Question 0 = themes"
  - [ ] Test "selectThemesAndSubtopics navigue vers sources"
  - [ ] Test "selectSources navigue vers finalize"
  - [ ] Test "goBack fonctionne Section 3"

- [ ] **Task 6 : Tests widgets**
  - [ ] Test "SourcesQuestion prÃ©-sÃ©lectionne des sources"
  - [ ] Test "Message informatif est affichÃ©"

- [ ] **Task 7 : Tests manuels**
  - [ ] Flow complet onboarding
  - [ ] Back navigation Section 3
  - [ ] Sauvegarde backend correcte

## Dev Notes

### Impact Analysis

| Composant | Impact | CriticitÃ© |
|-----------|--------|-----------|
| `onboarding_provider.dart` | Inversion enum + navigation | ğŸ”´ HIGH |
| `onboarding_screen.dart` | Inversion ordre switch | ğŸŸ¡ MEDIUM |
| `sources_question.dart` | PrÃ©-sÃ©lection + message | ğŸ”´ HIGH |
| `themes_question.dart` | Aucun changement | âœ… SAFE |
| Backend API | Aucun changement | âœ… SAFE |
| Base de donnÃ©es | Aucun changement | âœ… SAFE |
| Algorithme Feed | Aucun changement | âœ… SAFE |

### Mapping ThÃ¨mes â†’ Sources

BasÃ© sur l'analyse de `sources_master.csv` (sources CURATED uniquement) :

| ThÃ¨me | Sources recommandÃ©es (max 5) |
|-------|------------------------------|
| **tech** | ScienceEtonnante, Epsiloon, Monsieur Bidouille, TechTrash, Socialter |
| **international** | Le Dessous des Cartes, Le Collimateur, Le Grand Continent, Politico Europe, Le Monde Diplomatique |
| **science** | ScienceEtonnante, La Science CQFD, Epsiloon, The Conversation |
| **culture** | Le 1 Hebdo, Philosophie Magazine, The Conversation, Revue Commentaire |
| **politics** | Le Monde, Mediapart, Le Figaro, Politico Europe, Le Canard EnchaÃ®nÃ© |
| **society** | Les Pieds sur Terre, Transfert, France Info, France Inter, Blast |
| **environment** | Bon Pote, Reporterre, Sismique |
| **economy** | Heu?reka, Alternatives Ã‰conomiques, Nouveau DÃ©part, Guerres de Business, Les Ã‰chos |

### Algorithme de prÃ©-sÃ©lection

```dart
Set<String> computeRecommendedSources(
  Set<String> selectedThemes,
  Set<String> selectedSubtopics,
) {
  Set<String> recommended = {};
  
  // 1. Mapping thÃ¨mes â†’ sources (max 5 par thÃ¨me)
  for (final theme in selectedThemes) {
    final sourcesForTheme = ThemeToSourcesMapping.byTheme[theme] ?? [];
    recommended.addAll(sourcesForTheme.take(5));
  }
  
  // 2. Raffinage optionnel par sous-thÃ¨mes
  for (final subtopic in selectedSubtopics) {
    final sourcesForSubtopic = ThemeToSourcesMapping.bySubtopic[subtopic] ?? [];
    recommended.addAll(sourcesForSubtopic.take(3));
  }
  
  // 3. Limiter Ã  15 sources max
  return recommended.take(15).toSet();
}
```

### Conversion noms â†’ IDs

Le mapping utilise des **noms** de sources, mais l'API retourne des **IDs** UUID.
Solution : utiliser le provider `userSourcesProvider` pour rÃ©cupÃ©rer la liste des sources,
puis faire la conversion name.toLowerCase() â†’ source.id.

### Message informatif (AC: 3)

Afficher au-dessus de la liste des sources :
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¡ PrÃ©-sÃ©lection basÃ©e sur vos thÃ¨mes           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Style : Container avec `colors.surface`, padding 12px, border-radius 8px.

### File Locations

```
apps/mobile/lib/features/onboarding/
â”œâ”€â”€ data/
â”‚   â””â”€â”€ theme_to_sources_mapping.dart  # NOUVEAU
â”œâ”€â”€ providers/
â”‚   â””â”€â”€ onboarding_provider.dart       # MODIFIÃ‰
â”œâ”€â”€ screens/
â”‚   â”œâ”€â”€ onboarding_screen.dart         # MODIFIÃ‰
â”‚   â””â”€â”€ questions/
â”‚       â”œâ”€â”€ themes_question.dart       # NON MODIFIÃ‰
â”‚       â””â”€â”€ sources_question.dart      # MODIFIÃ‰
```

## Testing

### Test Cases

1. **test_section3_order_themes_first** : VÃ©rifier que Q9 = themes, Q10 = sources
2. **test_themes_navigates_to_sources** : SÃ©lectionner themes â†’ Ã©cran sources
3. **test_sources_navigates_to_finalize** : SÃ©lectionner sources â†’ Ã©cran finalize
4. **test_sources_preselection** : VÃ©rifier que des sources sont prÃ©-cochÃ©es aprÃ¨s thÃ¨mes
5. **test_back_navigation_section3** : Sources â†’ retour â†’ ThÃ¨mes (thÃ¨mes toujours sÃ©lectionnÃ©s)
6. **test_preselection_message_displayed** : VÃ©rifier l'affichage du message informatif
7. **test_user_can_modify_preselection** : VÃ©rifier que l'utilisateur peut changer les sources

### Manual QA Script

```bash
#!/bin/bash
# docs/qa/scripts/verify_onboarding_themes_first.sh

echo "=== TEST ONBOARDING THEMES FIRST ==="
echo ""
echo "âœ… TEST 1: Ordre des questions Section 3"
echo "1. Lancer l'app et crÃ©er un nouveau compte"
echo "2. ComplÃ©ter Sections 1 et 2"
echo "3. VÃ©rifier que la premiÃ¨re question de Section 3 est THEMES"
echo "4. SÃ©lectionner 2-3 thÃ¨mes (ex: Tech, Science)"
echo "5. Continuer â†’ VÃ©rifier que l'Ã©cran suivant est SOURCES"
echo ""
echo "âœ… TEST 2: PrÃ©-sÃ©lection des sources"
echo "1. Sur l'Ã©cran Sources, vÃ©rifier que des sources sont PRÃ‰-COCHÃ‰ES"
echo "2. VÃ©rifier le message 'âœ¨ SÃ©lection basÃ©e sur vos intÃ©rÃªts'"
echo "3. VÃ©rifier que les sources correspondent aux thÃ¨mes choisis"
echo ""
echo "âœ… TEST 3: Modification de la prÃ©-sÃ©lection"
echo "1. DÃ©cocher une source prÃ©-sÃ©lectionnÃ©e"
echo "2. Cocher une nouvelle source"
echo "3. Continuer â†’ Finaliser l'onboarding"
echo "4. VÃ©rifier dans le feed que les sources correspondent"
echo ""
echo "âœ… TEST 4: Navigation retour"
echo "1. Sur l'Ã©cran Sources, appuyer sur le bouton Retour"
echo "2. VÃ©rifier qu'on retourne sur l'Ã©cran ThÃ¨mes"
echo "3. VÃ©rifier que les thÃ¨mes sÃ©lectionnÃ©s sont toujours cochÃ©s"
echo "4. Revenir sur Sources â†’ VÃ©rifier que la prÃ©-sÃ©lection est conservÃ©e"
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 24/01/2026 | 1.0 | Story crÃ©Ã©e | Claude (Opus 4.5) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Completion Notes
ImplÃ©mentation complÃ¨te de l'inversion ThÃ¨mes â†’ Sources avec prÃ©-sÃ©lection automatique :

1. **Data Layer** : CrÃ©Ã© le mapping `ThemeToSourcesMapping` avec 8 thÃ¨mes et ~40 sources CURATED
2. **Provider** : InversÃ© l'enum `Section3Question` (themes=0, sources=1, finalize=2) et adaptÃ© la navigation
3. **UI** : 
   - ModifiÃ© `onboarding_screen.dart` pour afficher themes avant sources
   - AjoutÃ© la logique de prÃ©-sÃ©lection dans `sources_question.dart`
   - AjoutÃ© le message informatif "âœ¨ SÃ©lection basÃ©e sur vos intÃ©rÃªts"
4. **Tests** : Mis Ã  jour avec 7 tests couvrant le nouvel ordre et la navigation

Aucun impact backend/DB/algorithme confirmÃ©.

### File List

**CrÃ©Ã©s :**
- `apps/mobile/lib/features/onboarding/data/theme_to_sources_mapping.dart`
- `docs/qa/scripts/verify_onboarding_themes_first.sh`

**ModifiÃ©s :**
- `apps/mobile/lib/features/onboarding/providers/onboarding_provider.dart` (enum + navigation)
- `apps/mobile/lib/features/onboarding/screens/onboarding_screen.dart` (ordre switch)
- `apps/mobile/lib/features/onboarding/screens/questions/sources_question.dart` (prÃ©-sÃ©lection + message)
- `apps/mobile/lib/features/onboarding/onboarding_strings.dart` (nouvelles strings)
- `apps/mobile/test/features/onboarding/providers/onboarding_provider_test.dart` (nouveaux tests)
- `docs/prd.md` (Story 2.2c + changelog)
- `docs/front-end-spec.md` (flow Section 3 + changelog)
- `docs/architecture.md` (Section 18.2 + changelog)
