# Story 10.3 : Contraintes de Diversité

## Status: Draft

## Story

**As a** utilisateur,  
**I want** que mon digest quotidien soit diversifié,  
**so that** je ne reçoive pas 5 articles de la même source ou du même thème.

## Acceptance Criteria

1. **Maximum 2 articles par source** dans le digest
2. **Maximum 2 articles par thème macro** (tech, society, etc.)
3. **Application après scoring** — les contraintes s'appliquent sur les candidats triés
4. **Pas de perte de qualité** — si contrainte non satisfaisable, prendre le meilleur disponible
5. **Logging** des contraintes appliquées pour debugging

## Tasks / Subtasks

### Backend

- [ ] **Task 1: Étendre `DigestSelector` avec contraintes**
  - [ ] Ajouter méthode `_apply_diversity_constraints(scored: list) -> list`
  - [ ] Implémenter compteurs par source et par thème
  - [ ] Modifier `select_digest()` pour appeler les contraintes

- [ ] **Task 2: Implémenter la logique de diversité**
  - [ ] Parcourir les candidats triés par score
  - [ ] Pour chaque candidat, vérifier :
    - `source_count[source_id] < 2`
    - `theme_count[theme] < 2`
  - [ ] Si OK → ajouter au digest et incrémenter compteurs
  - [ ] Sinon → passer au candidat suivant
  - [ ] Arrêter quand 5 articles sélectionnés

- [ ] **Task 3: Logging des contraintes**
  - [ ] Logger quand un article est exclu par contrainte
  - [ ] Logger la distribution finale (sources, thèmes)

## Dev Notes

### Extension du DigestSelector

```python
# Ajout dans packages/api/app/services/digest_selector.py

class DigestSelector:
    # ... (code existant) ...
    
    # Diversity constraints
    MAX_PER_SOURCE = 2
    MAX_PER_THEME = 2
    TARGET_DIGEST_SIZE = 5
    
    async def select_digest(self, user_id: UUID) -> list[DigestItem]:
        """
        Sélectionne les 5 meilleurs articles avec contraintes de diversité.
        """
        # ... (étapes 1-5 existantes) ...
        
        # 6. Apply diversity constraints (NOUVEAU)
        diverse_selection = self._apply_diversity_constraints(scored)
        
        # 7. Build DigestItem list
        return [
            DigestItem(
                content_id=item["content"].id,
                rank=idx + 1,
                status="pending",
                digest_reason=self._determine_reason(item),
            )
            for idx, item in enumerate(diverse_selection)
        ]
    
    def _apply_diversity_constraints(self, scored: list[dict]) -> list[dict]:
        """
        Applique les contraintes de diversité sur les candidats triés.
        
        Contraintes:
        - Max 2 articles par source
        - Max 2 articles par thème macro
        
        Returns:
            Liste de max 5 candidats respectant les contraintes.
        """
        selected = []
        source_count: dict[UUID, int] = {}
        theme_count: dict[str, int] = {}
        
        for item in scored:
            content = item["content"]
            source_id = content.source_id
            theme = content.source.theme
            
            # Check source constraint
            if source_count.get(source_id, 0) >= self.MAX_PER_SOURCE:
                logger.debug(
                    "Skipped by source constraint",
                    content_id=str(content.id),
                    source_id=str(source_id),
                    current_count=source_count.get(source_id, 0)
                )
                continue
            
            # Check theme constraint
            if theme_count.get(theme, 0) >= self.MAX_PER_THEME:
                logger.debug(
                    "Skipped by theme constraint",
                    content_id=str(content.id),
                    theme=theme,
                    current_count=theme_count.get(theme, 0)
                )
                continue
            
            # Add to selection
            selected.append(item)
            source_count[source_id] = source_count.get(source_id, 0) + 1
            theme_count[theme] = theme_count.get(theme, 0) + 1
            
            # Stop when target reached
            if len(selected) >= self.TARGET_DIGEST_SIZE:
                break
        
        # Log final distribution
        logger.info(
            "Diversity constraints applied",
            selected_count=len(selected),
            source_distribution=dict(source_count),
            theme_distribution=dict(theme_count)
        )
        
        return selected
```

### Exemple de sélection avec contraintes

**Candidats triés par score :**

| # | Titre | Source | Thème | Score |
|---|-------|--------|-------|-------|
| 1 | "GPT-5 lancé" | TechCrunch | tech | 150 |
| 2 | "OpenAI lève $10B" | TechCrunch | tech | 140 |
| 3 | "Macron en Chine" | Le Monde | international | 130 |
| 4 | "Apple Vision Pro 2" | TechCrunch | tech | 125 |
| 5 | "Climat: record" | France Info | environment | 120 |
| 6 | "Élections UK" | Le Monde | international | 115 |
| 7 | "Start-up Française" | Les Échos | economy | 110 |

**Après contraintes (max 2/source, max 2/thème) :**

| Rang | Titre | Source | Thème | Inclus? | Raison |
|------|-------|--------|-------|---------|--------|
| 1 | "GPT-5 lancé" | TechCrunch | tech | ✅ | — |
| 2 | "OpenAI lève $10B" | TechCrunch | tech | ✅ | — |
| 3 | "Macron en Chine" | Le Monde | international | ✅ | — |
| 4 | "Apple Vision Pro 2" | TechCrunch | tech | ❌ | Max 2/source |
| 5 | "Climat: record" | France Info | environment | ✅ | — |
| 6 | "Élections UK" | Le Monde | international | ✅ | — (5 atteint) |

**Digest final :** 5 articles, 3 sources, 3 thèmes.

### Références Architecture

- [Source: 4.4.top3-briefing-quotidien.story.md#constraints] — Contrainte 1/source existante

## Testing

- **Unit Tests** : `tests/services/test_digest_selector.py`
  - Test max 2 par source respecté
  - Test max 2 par thème respecté
  - Test fallback quand contraintes non satisfaisables
  - Test logging correct

## Definition of Done

- [ ] Contraintes de diversité implémentées
- [ ] Logging en place
- [ ] Tests unitaires passent
- [ ] Documentation mise à jour

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 31/01/2026 | 1.0 | Création story | BMad Master |
