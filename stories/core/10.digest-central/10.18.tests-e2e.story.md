# Story 10.18 : Tests E2E Flow Digest → Closure

## Status: Draft

## Story

**As a** QA,  
**I want** des tests E2E validant le flow complet,  
**so that** je puisse m'assurer que l'expérience utilisateur fonctionne de bout en bout.

## Acceptance Criteria

1. **Test flow complet** : Login → Digest → Actions → Closure
2. **Test progression** : Barre se remplit correctement
3. **Test closure** : Animation et stats affichées
4. **Test streak** : Mise à jour correcte
5. **Test navigation** : "Explorer plus" fonctionne

## Tasks / Subtasks

### QA

- [ ] **Task 1: Setup testing environment**
  - [ ] Flutter integration tests ou Patrol
  - [ ] Backend de test avec données

- [ ] **Task 2: Test scenario principal**
  - [ ] Login utilisateur test
  - [ ] Vérifier affichage 5 articles
  - [ ] Actionner chaque article
  - [ ] Vérifier closure screen

- [ ] **Task 3: Test scénarios alternatifs**
  - [ ] Digest déjà complété → afficher état terminé
  - [ ] Pas de digest → message approprié
  - [ ] Erreur réseau → gestion gracieuse

- [ ] **Task 4: Documentation des tests**
  - [ ] Scénarios documentés
  - [ ] Résultats tracés

## Dev Notes

### Test Scenario Principal

```dart
// test/integration/digest_flow_test.dart

import 'package:flutter_test/flutter_test.dart';
import 'package:integration_test/integration_test.dart';

void main() {
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();

  group('Digest Flow E2E', () {
    testWidgets('Complete digest flow triggers closure', (tester) async {
      // 1. Launch app
      await tester.pumpApp();
      
      // 2. Login (if needed)
      await tester.login('test@facteur.app', 'password');
      
      // 3. Verify digest screen is shown
      expect(find.text("L'Essentiel"), findsOneWidget);
      expect(find.byType(DigestCard), findsNWidgets(5));
      
      // 4. Verify progress starts at 0/5
      expect(find.text('0/5'), findsOneWidget);
      
      // 5. Action each article
      for (var i = 0; i < 5; i++) {
        // Find the first pending card
        final card = find.byType(DigestCard).at(i);
        
        // Tap "Lu" button
        final luButton = find.descendant(
          of: card,
          matching: find.text('Lu'),
        );
        await tester.tap(luButton);
        await tester.pumpAndSettle();
        
        // Verify progress updates
        expect(find.text('${i + 1}/5'), findsOneWidget);
      }
      
      // 6. Verify closure screen appears
      await tester.pumpAndSettle(const Duration(seconds: 1));
      expect(find.text('Tu es informé !'), findsOneWidget);
      
      // 7. Verify confetti is playing (check for ConfettiWidget)
      expect(find.byType(ConfettiWidget), findsOneWidget);
      
      // 8. Verify streak is shown
      expect(find.byIcon(Icons.local_fire_department), findsOneWidget);
      
      // 9. Close and verify digest shows completed state
      await tester.tap(find.text('Fermer'));
      await tester.pumpAndSettle();
      
      // All cards should be actioned (opacity reduced)
      // Progress should be 5/5
      expect(find.text('5/5'), findsOneWidget);
    });

    testWidgets('Save action works correctly', (tester) async {
      await tester.pumpApp();
      await tester.login('test@facteur.app', 'password');
      
      // Tap "Plus tard" on first card
      final saveButton = find.text('Plus tard').first;
      await tester.tap(saveButton);
      await tester.pumpAndSettle();
      
      // Verify card shows saved state
      expect(find.byIcon(Icons.bookmark), findsWidgets);
    });

    testWidgets('Explore more navigates to feed', (tester) async {
      await tester.pumpApp();
      await tester.login('test@facteur.app', 'password');
      
      // Tap "Explorer plus"
      await tester.tap(find.text('Explorer plus'));
      await tester.pumpAndSettle();
      
      // Verify feed screen is shown
      expect(find.byType(FeedScreen), findsOneWidget);
    });

    testWidgets('Already completed digest shows completed state', (tester) async {
      // Setup: Mock API to return completed digest
      await mockApiResponse('/api/digest', {
        'digest_date': DateTime.now().toIso8601String(),
        'items': List.generate(5, (i) => {
          'content_id': 'content-$i',
          'rank': i + 1,
          'status': 'read',
          'digest_reason': 'Source suivie',
          'content': {/* mock content */},
        }),
        'progress': '5/5',
        'is_complete': true,
        'completed_at': DateTime.now().toIso8601String(),
      });
      
      await tester.pumpApp();
      await tester.login('completed_user@facteur.app', 'password');
      await tester.pumpAndSettle();
      
      // Verify digest shows 5/5 and completion badge
      expect(find.text('5/5'), findsOneWidget);
      expect(find.text('Digest complété'), findsOneWidget);
      expect(find.text('Lu'), findsNothing);
      expect(find.text('Plus tard'), findsNothing);
      
      // Verify all cards have reduced opacity (actioned state)
      final cards = find.byType(DigestCard);
      expect(cards, findsNWidgets(5));
    });

    testWidgets('Network error shows retry option', (tester) async {
      // Setup: Mock network failure for digest endpoint
      await mockApiError('/api/digest', statusCode: 500, message: 'Internal Server Error');
      
      await tester.pumpApp();
      await tester.login('test@facteur.app', 'password');
      await tester.pumpAndSettle();
      
      // Verify error state
      expect(find.text('Une erreur est survenue'), findsOneWidget);
      expect(find.text('Réessayer'), findsOneWidget);
      
      // Mock success for retry
      await mockApiResponse('/api/digest', {
        'digest_date': DateTime.now().toIso8601String(),
        'items': List.generate(5, (i) => /* mock items */),
        'progress': '0/5',
        'is_complete': false,
      });
      
      // Tap retry
      await tester.tap(find.text('Réessayer'));
      await tester.pumpAndSettle();
      
      // Verify digest now loads
      expect(find.byType(DigestCard), findsNWidgets(5));
    });
  });
}

extension TesterExtensions on WidgetTester {
  Future<void> pumpApp() async {
    await pumpWidget(const ProviderScope(child: FacteurApp()));
    await pumpAndSettle();
  }

  Future<void> login(String email, String password) async {
    // Implement login flow
  }
}
```

### Test Plan Document

```markdown
# Test Plan - Digest Central

## Scenarios à tester

### P0 - Critiques
1. [ ] Flow complet digest → closure
2. [ ] Action "Lu" sur article
3. [ ] Action "Sauvegardé" sur article  
4. [ ] Progression 0/5 → 5/5
5. [ ] Écran closure avec stats

### P1 - Importants
6. [ ] Streak incrémenté à la closure
7. [ ] Navigation "Explorer plus"
8. [ ] Digest déjà complété
9. [ ] Pull-to-refresh

### P2 - Secondaires
10. [ ] Tap sur carte ouvre détail
11. [ ] Fallback sources curées visible
12. [ ] Notification push (si implémenté)

## Résultats

| # | Scénario | Status | Notes |
|---|----------|--------|-------|
| 1 | Flow complet | - | - |
| ... | ... | - | - |
```

## Definition of Done

- [ ] Tests E2E passent
- [ ] Scénarios documentés
- [ ] Edge cases couverts
- [ ] Rapport de test généré

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 31/01/2026 | 1.0 | Création story | BMad Master |
