# Story 10.16 : Analytics Events Closure

## Status: Draft

## Story

**As a** product owner,  
**I want** tracker les événements de closure,  
**so that** je puisse mesurer le succès du pivot Digest-First.

## Acceptance Criteria

1. **Event "digest_viewed"** quand l'utilisateur ouvre le digest
2. **Event "digest_item_actioned"** pour chaque action (read/saved)
3. **Event "digest_completed"** à la closure avec métriques
4. **Event "closure_screen_viewed"** quand l'écran de closure s'affiche
5. **Event "closure_action"** pour les actions post-closure (saved/feed/close)
6. **Dashboard** des métriques MoC

## Tasks / Subtasks

### Backend

- [ ] **Task 1: Créer les events analytics**
  - [ ] Table `analytics_events` ou service externe (Mixpanel, Amplitude)
  - [ ] Schéma des events

- [ ] **Task 2: Implémenter dans DigestService**
  - [ ] Log event à chaque action
  - [ ] Inclure context (user_id, timestamp, properties)

### Frontend Mobile

- [ ] **Task 3: Tracker côté Flutter**
  - [ ] Service analytics centralisé
  - [ ] Events au bon moment

- [ ] **Task 4: Dashboard (optionnel)**
  - [ ] Visualisation des métriques MoC

## Dev Notes

### Events Schema

```typescript
// Event: digest_viewed
{
  event: "digest_viewed",
  user_id: "uuid",
  timestamp: "2026-01-31T08:00:00Z",
  properties: {
    digest_date: "2026-01-31",
    total_items: 5,
    has_curated_fallback: false,
  }
}

// Event: digest_item_actioned
{
  event: "digest_item_actioned",
  user_id: "uuid",
  timestamp: "2026-01-31T08:05:00Z",
  properties: {
    content_id: "uuid",
    action: "read", // ou "saved"
    rank: 1,
    digest_reason: "À la Une",
    progress: "1/5",
  }
}

// Event: digest_completed
{
  event: "digest_completed",
  user_id: "uuid",
  timestamp: "2026-01-31T08:10:00Z",
  properties: {
    digest_date: "2026-01-31",
    time_to_complete_seconds: 245,
    articles_read: 3,
    articles_saved: 2,
    closure_streak: 4,
  }
}

// Event: closure_screen_viewed
{
  event: "closure_screen_viewed",
  user_id: "uuid",
  timestamp: "2026-01-31T08:10:05Z",
  properties: {
    streak: 4,
    articles_saved: 2,
  }
}

// Event: closure_action
{
  event: "closure_action",
  user_id: "uuid",
  timestamp: "2026-01-31T08:10:30Z",
  properties: {
    action: "view_saved", // ou "explore_feed", "close"
  }
}
```

### Implémentation Service Analytics

```dart
// apps/mobile/lib/core/analytics/analytics_service.dart

class AnalyticsService {
  void trackDigestViewed({
    required String digestDate,
    required int totalItems,
    required bool hasCuratedFallback,
  }) {
    _track('digest_viewed', {
      'digest_date': digestDate,
      'total_items': totalItems,
      'has_curated_fallback': hasCuratedFallback,
    });
  }

  void trackDigestItemActioned({
    required String contentId,
    required String action,
    required int rank,
    required String digestReason,
    required String progress,
  }) {
    _track('digest_item_actioned', {
      'content_id': contentId,
      'action': action,
      'rank': rank,
      'digest_reason': digestReason,
      'progress': progress,
    });
  }

  void trackDigestCompleted({
    required String digestDate,
    required int timeToCompleteSeconds,
    required int articlesRead,
    required int articlesSaved,
    required int closureStreak,
  }) {
    _track('digest_completed', {
      'digest_date': digestDate,
      'time_to_complete_seconds': timeToCompleteSeconds,
      'articles_read': articlesRead,
      'articles_saved': articlesSaved,
      'closure_streak': closureStreak,
    });
  }

  void _track(String event, Map<String, dynamic> properties) {
    // Implémenter avec Mixpanel, Amplitude, ou analytics_events table
    print('Analytics: $event $properties');
  }
}
```

### Métriques MoC Dashboard

| Métrique | Définition | Cible |
|----------|-----------|-------|
| MoC Completion Rate | digest_completed / digest_viewed | >60% |
| Avg Time to Closure | avg(time_to_complete_seconds) | 120-240s |
| Read vs Saved Ratio | articles_read / (articles_read + articles_saved) | ~60% |
| Weekly Consistency | users avec >=5 completions/semaine | >40% |
| Streak Distribution | % users par tranche de streak | - |

## Definition of Done

- [ ] Events définis et documentés
- [ ] Tracking implémenté backend + frontend
- [ ] Dashboard ou requêtes SQL disponibles

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 31/01/2026 | 1.0 | Création story | BMad Master |
