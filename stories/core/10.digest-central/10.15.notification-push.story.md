# Story 10.15 : Notification Push "Digest Prêt"

## Status: Draft

## Story

**As a** utilisateur,  
**I want** recevoir une notification quand mon digest est prêt,  
**so that** je sache quand je peux consulter l'essentiel du jour.

## Acceptance Criteria

1. **Notification à 8h** (heure locale ou Paris)
2. **Message** : "Ton essentiel du jour est prêt"
3. **Tap** ouvre l'app sur DigestScreen
4. **Opt-out possible** dans les paramètres
5. **Pas de notification si digest déjà complété**

## Tasks / Subtasks

### Backend

- [ ] **Task 1: Intégrer un service push**
  - [ ] Firebase Cloud Messaging ou alternative
  - [ ] Stocker les tokens dans `user_push_tokens`

- [ ] **Task 2: Créer le job de notification**
  - [ ] Job à 8h Paris (après génération digest)
  - [ ] Filtrer users avec notifications activées
  - [ ] Exclure users avec digest déjà complété

### Frontend Mobile

- [ ] **Task 3: Intégrer FCM Flutter**
  - [ ] Demander permission
  - [ ] Enregistrer le token au backend

- [ ] **Task 4: Gérer le tap notification**
  - [ ] Ouvrir sur DigestScreen

- [ ] **Task 5: Setting opt-out**
  - [ ] Toggle dans paramètres notifications

## Dev Notes

### Cette story peut être reportée en V2 si le scope est trop large.

Alternative plus simple pour MVP :
- Notification locale Flutter (sans backend)
- Planifier à l'installation de l'app

```dart
// Alternative: Notification locale

import 'package:flutter_local_notifications/flutter_local_notifications.dart';

Future<void> scheduleDailyDigestNotification() async {
  final notificationsPlugin = FlutterLocalNotificationsPlugin();
  
  await notificationsPlugin.zonedSchedule(
    0, // ID
    'L\'Essentiel du Jour',
    'Ton digest quotidien est prêt',
    _nextInstanceOf8AM(),
    const NotificationDetails(
      android: AndroidNotificationDetails(
        'digest_channel',
        'Digest Quotidien',
        importance: Importance.high,
      ),
      iOS: DarwinNotificationDetails(),
    ),
    matchDateTimeComponents: DateTimeComponents.time,
    uiLocalNotificationDateInterpretation:
        UILocalNotificationDateInterpretation.absoluteTime,
  );
}

tz.TZDateTime _nextInstanceOf8AM() {
  final now = tz.TZDateTime.now(tz.local);
  var scheduledDate = tz.TZDateTime(tz.local, now.year, now.month, now.day, 8);
  if (scheduledDate.isBefore(now)) {
    scheduledDate = scheduledDate.add(const Duration(days: 1));
  }
  return scheduledDate;
}
```

## Definition of Done

- [ ] Notification planifiée à 8h
- [ ] Tap ouvre DigestScreen
- [ ] Opt-out fonctionnel

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 31/01/2026 | 1.0 | Création story | BMad Master |
